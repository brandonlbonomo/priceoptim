<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Property Pigeon</title>
  <link rel="manifest" href="/manifest.json"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"/>
  <meta name="apple-mobile-web-app-title" content="Pigeon"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="theme-color" content="#1a1a2e"/>
  <link rel="apple-touch-icon" href="/icon-192.png"/>
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png"/>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <style>
    :root {
      /* ── Dark-first palette ── */
      --bg: #06091a;
      --bg2: #0d1124;
      --glass: rgba(255,255,255,0.09);
      --glass-border: rgba(255,255,255,0.13);
      --green: #32d74b;
      --green-dim: rgba(50,215,75,0.18);
      --red: #ff453a;
      --red-dim: rgba(255,69,58,0.18);
      --blue: #0a84ff;
      --blue-dim: rgba(10,132,255,0.18);
      --purple: #bf5af2;
      --yellow: #ffd60a;
      --text: #f2f4ff;
      --text-2: rgba(242,244,255,0.58);
      --text-3: rgba(242,244,255,0.34);
      --card-bg: rgba(255,255,255,0.09);
      --header-bg: rgba(6,9,26,0.72);
      --radius: 20px;
      --radius-sm: 12px;
      --specular: inset 0 1px 0 rgba(255,255,255,0.16);
      --card-shadow: 0 4px 40px rgba(0,0,0,0.55), 0 1px 6px rgba(0,0,0,0.30);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    /* ── Deep dark background with vivid color orbs ── */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(ellipse 72% 65% at 6% 8%,    rgba(108,55,240,0.45) 0%, transparent 52%),
        radial-gradient(ellipse 65% 58% at 96% 6%,   rgba(20,90,255,0.38) 0%, transparent 52%),
        radial-gradient(ellipse 68% 60% at 90% 94%,  rgba(20,180,110,0.30) 0%, transparent 52%),
        radial-gradient(ellipse 55% 55% at 6% 95%,   rgba(210,40,150,0.28) 0%, transparent 52%),
        radial-gradient(ellipse 50% 46% at 50% 50%,  rgba(80,60,180,0.14) 0%, transparent 58%),
        linear-gradient(168deg, #06091a 0%, #080c22 35%, #060917 65%, #09061c 100%);
      pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(circle 680px at 18% 48%, rgba(80,100,255,0.22) 0%, transparent 62%),
        radial-gradient(circle 560px at 82% 22%, rgba(30,180,130,0.18) 0%, transparent 62%),
        radial-gradient(circle 500px at 58% 88%, rgba(160,80,255,0.20) 0%, transparent 58%),
        radial-gradient(circle 340px at 40% 14%, rgba(255,110,60,0.10) 0%, transparent 52%);
      animation: driftOrbs 26s ease-in-out infinite alternate;
      pointer-events: none;
    }

    @keyframes driftOrbs {
      0%   { transform: translate(0, 0) scale(1); }
      25%  { transform: translate(28px, -16px) scale(1.04); }
      50%  { transform: translate(-10px, 26px) scale(0.97); }
      75%  { transform: translate(20px, 8px) scale(1.02); }
      100% { transform: translate(-6px, -12px) scale(1.01); }
    }

    #root { position: relative; z-index: 1; }

    button { cursor: pointer; font-family: inherit; }
    * { -ms-overflow-style: none; scrollbar-width: none; }
    ::-webkit-scrollbar { display: none; }

    /* ── Glass card base classes ── */
    .glass {
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: var(--radius);
      backdrop-filter: blur(48px) saturate(1.8);
      -webkit-backdrop-filter: blur(48px) saturate(1.8);
      box-shadow: var(--card-shadow), var(--specular);
    }
    .glass-sm {
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: var(--radius-sm);
      backdrop-filter: blur(32px) saturate(1.6);
      -webkit-backdrop-filter: blur(32px) saturate(1.6);
      box-shadow: var(--card-shadow), var(--specular);
    }

    /* ── Top header ── */
    .top-header {
      position: sticky; top: 0; z-index: 100;
      padding: 12px 16px 10px;
      background: rgba(6,9,26,0.68);
      backdrop-filter: blur(56px) saturate(1.9);
      -webkit-backdrop-filter: blur(56px) saturate(1.9);
      border-bottom: 0.5px solid rgba(255,255,255,0.10);
      box-shadow: 0 1px 0 rgba(0,0,0,0.30), inset 0 1px 0 rgba(255,255,255,0.07);
      display: flex; align-items: center; justify-content: space-between;
    }

    /* ── Top pill navigation ── */
    .top-nav {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px 0 10px;
      background: rgba(6,9,26,0.68);
      backdrop-filter: blur(56px) saturate(1.9);
      -webkit-backdrop-filter: blur(56px) saturate(1.9);
      overflow: hidden;
      border-bottom: 0.5px solid rgba(255,255,255,0.09);
      box-shadow: 0 1px 0 rgba(0,0,0,0.24);
      height: 52px;
    }
    .top-nav.has-subnav {
      border-bottom: none;
      height: auto;
      padding-bottom: 2px;
    }
    .top-nav-track {
      display: flex;
      align-items: center;
      gap: 0;
      will-change: transform;
    }
    .top-nav-pill {
      background: transparent;
      border: none;
      color: var(--text-2);
      font-size: 15px;
      font-weight: 500;
      padding: 7px 22px;
      border-radius: 22px;
      cursor: pointer;
      white-space: nowrap;
      transition: opacity 0.3s cubic-bezier(0.34,1.3,0.64,1),
                  transform 0.3s cubic-bezier(0.34,1.3,0.64,1),
                  background 0.3s cubic-bezier(0.34,1.3,0.64,1),
                  box-shadow 0.3s cubic-bezier(0.34,1.3,0.64,1),
                  color 0.3s cubic-bezier(0.34,1.3,0.64,1);
      flex-shrink: 0;
      opacity: 0.38;
      transform: scale(0.82);
    }
    .top-nav-pill.active {
      background: rgba(255,255,255,0.18);
      color: #ffffff;
      font-weight: 700;
      font-size: 15px;
      opacity: 1;
      transform: scale(1);
      backdrop-filter: blur(24px) saturate(1.8);
      -webkit-backdrop-filter: blur(24px) saturate(1.8);
      border: 0.5px solid rgba(255,255,255,0.26);
      box-shadow: 0 2px 16px rgba(0,0,0,0.40), inset 0 1px 0 rgba(255,255,255,0.42);
    }

    /* ── Property sub-nav ── */
    .top-sub-nav {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2px 16px 10px;
      gap: 8px;
      background: rgba(6,9,26,0.68);
      backdrop-filter: blur(56px) saturate(1.9);
      -webkit-backdrop-filter: blur(56px) saturate(1.9);
      border-bottom: 0.5px solid rgba(255,255,255,0.09);
      overflow-x: auto;
      flex-wrap: nowrap;
    }
    .sub-nav-pill {
      background: transparent;
      border: none;
      color: var(--text-2);
      font-size: 13px;
      font-weight: 500;
      padding: 5px 16px;
      border-radius: 18px;
      cursor: pointer;
      white-space: nowrap;
      flex-shrink: 0;
      transition: all 0.28s cubic-bezier(0.34,1.3,0.64,1);
      opacity: 0.46;
    }
    .sub-nav-pill.active {
      background: rgba(255,255,255,0.16);
      color: #ffffff;
      font-weight: 700;
      opacity: 1;
      border: 0.5px solid rgba(255,255,255,0.24);
      box-shadow: 0 1px 12px rgba(0,0,0,0.36), inset 0 1px 0 rgba(255,255,255,0.38);
    }

    /* Fade edges on nav */
    .top-nav::before, .top-nav::after {
      content: "";
      position: absolute;
      top: 0; bottom: 0;
      width: 48px;
      z-index: 2;
      pointer-events: none;
    }
    .top-nav::before { left: 0; background: linear-gradient(to right, rgba(6,9,26,0.68), transparent); }
    .top-nav::after  { right: 0; background: linear-gradient(to left, rgba(6,9,26,0.68), transparent); }

    .nav-tab {
      background: transparent; color: var(--text-3); border: none;
      padding: 7px 16px; border-radius: 20px; font-size: 13px;
      font-weight: 500; transition: all 0.2s; position: relative;
    }
    .nav-tab.active { background: rgba(255,255,255,0.10); color: var(--text); font-weight: 600; }

    /* ── Pills ── */
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 11px;
      font-family: ui-monospace, 'SF Mono', SFMono-Regular, monospace;
      font-weight: 500;
    }
    .pill-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }

    /* ── Big stat ── */
    .stat-num {
      font-family: ui-monospace, 'SF Mono', SFMono-Regular, monospace;
      font-size: 36px;
      font-weight: 700;
      letter-spacing: -0.03em;
      line-height: 1;
    }
    .stat-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-3);
      font-family: ui-monospace, 'SF Mono', SFMono-Regular, monospace;
    }

    /* ── Chart tooltip ── */
    .chart-tooltip {
      position: absolute;
      background: rgba(8,12,32,0.90);
      border: 0.5px solid rgba(255,255,255,0.18);
      border-radius: 14px;
      padding: 10px 14px;
      font-size: 12px;
      color: var(--text);
      pointer-events: none;
      backdrop-filter: blur(48px) saturate(1.6);
      -webkit-backdrop-filter: blur(48px) saturate(1.6);
      white-space: nowrap;
      z-index: 50;
      transform: translateX(-50%);
      box-shadow: 0 8px 40px rgba(0,0,0,0.60), inset 0 1px 0 rgba(255,255,255,0.12);
    }

    /* ── Direction badges ── */
    .dir-in  { color: var(--green); font-size: 15px; text-shadow: 0 0 18px rgba(50,215,75,0.50); }
    .dir-out { color: var(--red);   font-size: 15px; }

    /* ── Property badge ── */
    .prop-badge {
      display: inline-block;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 10px;
      font-family: ui-monospace, 'SF Mono', SFMono-Regular, monospace;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    /* ── Segment control ── */
    .seg-ctrl {
      display: inline-flex;
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 10px;
      padding: 3px;
      gap: 2px;
    }
    .seg-btn {
      background: transparent;
      border: none;
      color: var(--text-3);
      border-radius: 7px;
      padding: 5px 14px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.18s;
    }
    .seg-btn.active {
      background: rgba(255,255,255,0.13);
      color: var(--text);
      font-weight: 600;
    }

    /* ── Action buttons ── */
    .btn-ghost {
      background: rgba(255,255,255,0.10);
      border: 1px solid rgba(255,255,255,0.16);
      color: var(--text-2);
      border-radius: 10px;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.18s;
    }
    .btn-ghost:hover { background: rgba(255,255,255,0.18); color: var(--text); }
    .btn-primary {
      background: var(--green);
      border: none;
      color: #000;
      border-radius: 10px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 700;
      transition: all 0.18s;
    }
    .btn-primary:hover { filter: brightness(1.1); }

    /* ── Modal overlay ── */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.60);
      backdrop-filter: blur(28px) saturate(1.4);
      -webkit-backdrop-filter: blur(28px) saturate(1.4);
      display: flex; align-items: center; justify-content: center;
    }

    /* ── Tx row ── */
    .tx-row {
      display: grid;
      grid-template-columns: 76px 28px 1fr 100px 96px 120px;
      padding: 11px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .tx-row:hover { background: rgba(255,255,255,0.04); }
    .tx-row:last-child { border-bottom: none; }

    /* ── Swipe container ── */
    .page-outer {
      position: fixed;
      top: 100px;
      left: 0; right: 0; bottom: 0;
      overflow: hidden;
      background: transparent;
      touch-action: pan-y;
    }

    /* ── Sync spinner ── */
    .sync-spinner-wrap {
      position: fixed;
      top: 56px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 200;
      pointer-events: none;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px;
      background: rgba(255,255,255,0.12);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 50%;
      box-shadow: 0 2px 12px rgba(0,0,0,0.40);
    }
    .sync-spinner {
      width: 20px; height: 20px;
      border: 2px solid rgba(255,255,255,0.12);
      border-top-color: rgba(255,255,255,0.85);
      border-radius: 50%;
      animation: spinClear 0.65s linear infinite;
    }
    @keyframes spinClear { to { transform: rotate(360deg); } }

    .swipe-track {
      display: flex;
      width: 100%;
      height: 100%;
      will-change: transform;
      transform: translate3d(0, 0, 0);
      transition: none;
    }
    .swipe-pane {
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0 16px 40px;
      box-sizing: border-box;
      background: transparent;
    }
    .pull-spinner {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 24px;
      border: 2.5px solid rgba(255,255,255,0.12);
      border-top-color: rgba(255,255,255,0.60);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      z-index: 50;
    }
    @keyframes spin { to { transform: translateX(-50%) rotate(360deg); } }

    .page { padding: 0; }
    .page-header { padding: 20px 0 16px; }
    .section-title {
      font-size: 10px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--text-3);
      font-family: ui-monospace, 'SF Mono', SFMono-Regular, monospace;
      margin-bottom: 10px; margin-top: 22px;
    }

    /* ── Cards — frosted glass on dark ── */
    .card {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 20px;
      overflow: hidden;
      backdrop-filter: blur(56px) saturate(2.0);
      -webkit-backdrop-filter: blur(56px) saturate(2.0);
      box-shadow: var(--card-shadow), var(--specular);
    }
    .card-padded { padding: 16px 18px; }
    .stat-row { display: flex; align-items: baseline; gap: 8px; }
    .big-num {
      font-size: 32px; font-weight: 700; letter-spacing: -0.03em; line-height: 1;
      font-family: ui-monospace, 'SF Mono', SFMono-Regular, monospace;
    }
    .sub-num { font-size: 13px; color: var(--text-3); }
    @media (max-width: 420px) {
      .big-num { font-size: 26px; }
      .stat-num { font-size: 28px; }
    }

    /* ── Metric card ── */
    .metric-card {
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius);
      padding: 16px 18px;
      backdrop-filter: blur(48px) saturate(1.9);
      -webkit-backdrop-filter: blur(48px) saturate(1.9);
      box-shadow: var(--card-shadow), var(--specular);
    }

    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    .fade-in { animation: fadeIn 0.3s ease forwards; }

    /* ── Global interaction reset ── */
    button, a { touch-action: manipulation; -webkit-tap-highlight-color: transparent; }

    /* ── Press / active states ── */
    .top-nav-pill:active  { transform: scale(0.90) !important; opacity: 0.6 !important;
      transition: transform 0.08s ease, opacity 0.08s ease !important; }
    .sub-nav-pill:active  { transform: scale(0.92) !important; opacity: 0.6 !important;
      transition: transform 0.08s ease, opacity 0.08s ease !important; }
    .btn-ghost:active     { transform: scale(0.96) !important; opacity: 0.72; }
    .btn-primary:active   { transform: scale(0.96) !important; filter: brightness(0.88); }
    button:active:not(:disabled):not(.top-nav-pill):not(.sub-nav-pill):not(.btn-ghost):not(.btn-primary) {
      opacity: 0.68;
    }
    .drawer-row           { transition: background 0.14s, color 0.14s; }
    .drawer-row:active    { background: rgba(255,255,255,0.13) !important; }
    .tx-row-wrap:active   { background: rgba(255,255,255,0.07) !important; }

    /* ── Skeleton shimmer ── */
    @keyframes shimmer {
      0%   { background-position: -300% 0; }
      100% { background-position:  300% 0; }
    }
    .skeleton {
      background: linear-gradient(90deg,
        rgba(255,255,255,0.04) 0%,
        rgba(255,255,255,0.11) 45%,
        rgba(255,255,255,0.04) 100%);
      background-size: 300% 100%;
      animation: shimmer 1.6s ease-in-out infinite;
      border-radius: 8px;
      display: block;
    }

    /* ── Staggered card entrance ── */
    @keyframes fadeInUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0);    }
    }
    .stagger > * { animation: fadeInUp 0.38s cubic-bezier(0.34,1.28,0.64,1) both; }
    .stagger > *:nth-child(1) { animation-delay:   0ms; }
    .stagger > *:nth-child(2) { animation-delay:  55ms; }
    .stagger > *:nth-child(3) { animation-delay: 110ms; }
    .stagger > *:nth-child(4) { animation-delay: 165ms; }
    .stagger > *:nth-child(5) { animation-delay: 220ms; }
    .stagger > *:nth-child(n+6) { animation-delay: 275ms; }

    /* ── Tag row pulse ── */
    @keyframes rowPulse {
      0%   { background: rgba(50,215,75,0.22); }
      60%  { background: rgba(50,215,75,0.06); }
      100% { background: transparent; }
    }
    .row-pulse { animation: rowPulse 0.65s ease-out forwards !important; }

    /* ── Error shake ── */
    @keyframes shake {
      0%,100% { transform: translateX(0); }
      15%  { transform: translateX(-5px); }
      30%  { transform: translateX( 5px); }
      45%  { transform: translateX(-3px); }
      60%  { transform: translateX( 3px); }
      75%  { transform: translateX(-2px); }
    }
    .shake { animation: shake 0.40s cubic-bezier(0.36,0.07,0.19,0.97) both; }

    /* ── Toast notification ── */
    @keyframes toastIn {
      from { transform: translateX(-50%) translateY(-60px) scale(0.90); opacity: 0; }
      to   { transform: translateX(-50%) translateY(0)     scale(1);    opacity: 1; }
    }
    @keyframes toastOut {
      from { transform: translateX(-50%) translateY(0)     scale(1);    opacity: 1; }
      to   { transform: translateX(-50%) translateY(-60px) scale(0.90); opacity: 0; }
    }
    .toast-wrap {
      position: fixed; top: 20px; left: 50%; z-index: 2000; pointer-events: none;
    }
    .toast-pill {
      background: rgba(12,16,42,0.97);
      backdrop-filter: blur(32px) saturate(1.8);
      -webkit-backdrop-filter: blur(32px) saturate(1.8);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 28px; padding: 10px 20px;
      font-size: 13px; font-weight: 600; color: var(--text);
      box-shadow: 0 8px 40px rgba(0,0,0,0.55), inset 0 1px 0 rgba(255,255,255,0.10);
      white-space: nowrap;
      animation: toastIn 0.44s cubic-bezier(0.34,1.28,0.64,1) forwards;
      display: flex; align-items: center; gap: 8px;
    }
    .toast-pill.exiting { animation: toastOut 0.28s ease-in forwards; }

    /* ── Bottom sheet entrance ── */
    @keyframes sheetUp {
      from { transform: translateY(100%); opacity: 0.7; }
      to   { transform: translateY(0);    opacity: 1; }
    }
    .sheet-enter { animation: sheetUp 0.46s cubic-bezier(0.34,1.22,0.64,1) forwards; }

    /* ── SettingsPage entrance ── */
    @keyframes pageUp {
      from { opacity: 0.3; transform: translateY(24px); }
      to   { opacity: 1;   transform: translateY(0);    }
    }
    .settings-enter { animation: pageUp 0.38s cubic-bezier(0.34,1.28,0.64,1) forwards; }

    /* ── Sync checkmark draw ── */
    @keyframes checkDraw {
      from { stroke-dashoffset: 22; }
      to   { stroke-dashoffset: 0; }
    }
    .check-path {
      stroke-dasharray: 22; stroke-dashoffset: 22;
      animation: checkDraw 0.34s ease-out 0.06s forwards;
    }

  </style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useMemo, useEffect, useCallback, useRef } = React;
if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});
const BACKEND = "";

// ── Formatters ────────────────────────────────────────────────
const fmt$ = n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(n||0);
const fmtD = n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.abs(n||0));
const fmtPct = n => (n==null||isNaN(n)||!isFinite(n))?"—":`${n.toFixed(1)}%`;
const fmtDate = d => { try { return new Date(d+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"}); } catch { return d||""; } };
const moLabel = s => { try { if(s&&/^\d{4}-Q\d$/.test(s)){const[y,q]=s.split("-");return `${q} '${y.slice(2)}`;} const [y,m]=s.split("-"); return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][+m-1]+" '"+y.slice(2); } catch { return s; } };

// ── Properties ────────────────────────────────────────────────
const BASE_PROPERTIES = [
  { id:"airbnb",   label:"Airbnb (portfolio)", color:"#30d158", group:"airbnb" },
  { id:"lockwood", label:"Lockwood",            color:"#30d158", group:"airbnb" },
  { id:"everton",  label:"Everton",             color:"var(--text)", group:"airbnb" },
  { id:"bstreet",  label:"B Street",            color:"var(--text)", group:"airbnb" },
  { id:"pierce",   label:"Pierce Ave",          color:"var(--text)", group:"pierce" },
  { id:"llc",      label:"General LLC",         color:"var(--text)", group:"llc"    },
  { id:"transfer", label:"Internal Transfer",   color:"#636366", group:"transfer"},
];
let PROPERTIES = [...BASE_PROPERTIES];
// All IDs that count as Airbnb revenue/expense
const BASE_AIRBNB_IDS = ["airbnb","lockwood","everton","bstreet"];
let AIRBNB_IDS = [...BASE_AIRBNB_IDS];

// ── Storage ───────────────────────────────────────────────────
const LS = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => { try { localStorage.setItem(k,JSON.stringify(v)); } catch {} },
};
const TAGS_KEY    = "pg_tags_v2";
const AUTO_KEY    = "pg_auto_v2";
const TX_KEY      = "pg_txs_v2";
const INVEST_KEY  = "pg_invest";
const MANUAL_KEY  = "pg_manual_income"; // { "2025-10": 12550.70, "2025-11": 13972.97, ... }
const CUSTOM_PROPS_KEY = "pg_custom_props";
const LAST_SYNC_KEY   = "pg_last_sync";
const LAST_PULL_KEY   = "pg_last_pull";
const DEFAULT_AUTO = { "AIRBNB PAYMENTS":"lockwood","AIRBNB":"lockwood","HOUSING AUTHORITY":"pierce" };
const DEFAULT_INVEST = { lockwood:0, everton:0, bstreet:0, pierce:0 };

// ── Helpers ───────────────────────────────────────────────────
function sumIn(txs)  { return txs.filter(t=>t.type==="in" ).reduce((s,t)=>s+Math.abs(t.amount),0); }
function sumOut(txs) { return txs.filter(t=>t.type==="out").reduce((s,t)=>s+Math.abs(t.amount),0); }

// ── PropBadge ─────────────────────────────────────────────────
function PropBadge({ id, small }) {
  const p = PROPERTIES.find(x=>x.id===id);
  const fs = small ? 9 : 10;
  const pad = small ? "2px 7px" : "3px 9px";
  if (!p) return <span className="prop-badge" style={{fontSize:fs,padding:pad,background:"rgba(255,214,10,0.15)",color:"var(--text)",border:"1px solid rgba(255,214,10,0.25)"}}>UNTAGGED</span>;
  return <span className="prop-badge" style={{fontSize:fs,padding:pad,background:`${p.color}18`,color:p.color,border:`1px solid ${p.color}30`}}>{p.label.toUpperCase()}</span>;
}

// ── TagMenu — in vs out logic ────────────────────────────────
// Money IN:  Airbnb (portfolio) | Pierce Ave | Internal Transfer | Delete
// Money OUT: Lockwood | Everton | B Street | Pierce | LLC | Internal Transfer | Delete
function TagMenu({ tx, onTag, onClose, onDelete }) {
  const [confirmDelete, setConfirmDelete] = useState(false);
  const isIn = tx.type === "in";

  const STATIC_IDS = new Set(['airbnb','lockwood','everton','bstreet','pierce','llc','transfer']);
  const customOpts = PROPERTIES.filter(p=>!STATIC_IDS.has(p.id)).map(p=>({id:p.id,label:p.label}));
  const inOptions  = [{id:"airbnb",label:"Airbnb"},{id:"pierce",label:"Pierce Ave"},{id:"transfer",label:"Transfer"},...customOpts];
  const outOptions = [{id:"lockwood",label:"Lockwood"},{id:"everton",label:"Everton"},{id:"bstreet",label:"B Street"},
                     {id:"pierce",label:"Pierce Ave"},{id:"llc",label:"LLC"},{id:"transfer",label:"Transfer"},...customOpts];
  const opts = isIn ? inOptions : outOptions;

  const btnBase = {borderRadius:10,padding:"7px 14px",fontSize:12,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:600,cursor:"pointer",border:"1px solid rgba(255,255,255,0.14)",background:"rgba(255,255,255,0.10)",color:"var(--text)",transition:"all 0.12s"};

  return (
    <div style={{padding:"10px 0 6px"}}>
      <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:8}}>
        {opts.map(p=>(
          <button key={p.id} onClick={()=>onTag(tx.id,p.id)} style={{
            ...btnBase,
            background: tx.propId===p.id ? "rgba(255,255,255,0.22)" : btnBase.background,
            fontWeight: tx.propId===p.id ? 700 : 600,
          }}>
            {p.label}
          </button>
        ))}
      </div>
      <div style={{display:"flex",gap:6,alignItems:"center"}}>
        {confirmDelete
          ? <>
              <span style={{fontSize:11,color:"var(--text-3)"}}>Delete this transaction?</span>
              <button onClick={()=>{onDelete(tx.id);onClose();}} style={{...btnBase,background:"rgba(255,69,58,0.12)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.3)",padding:"5px 12px"}}>Confirm</button>
              <button onClick={()=>setConfirmDelete(false)} style={{...btnBase,padding:"5px 10px",fontSize:11}}>Cancel</button>
            </>
          : <button onClick={()=>setConfirmDelete(true)} style={{...btnBase,background:"rgba(255,69,58,0.07)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.2)",padding:"5px 12px",fontSize:11}}>Delete</button>
        }
        <button onClick={onClose} style={{...btnBase,padding:"5px 10px",fontSize:11,marginLeft:"auto"}}>Done</button>
      </div>
    </div>
  );
}

// ── MiniBar — compact sparkline bar chart (clickable) ─────────
function MiniBar({ months, valueKey, color, label, fmt=null, onBarClick=null, marginMode=false, labelFn=null }) {
  const [hov, setHov] = useState(null);
  const [tapped, setTapped] = useState(null);
  const containerRef = useRef(null);
  const instanceId = useRef(Math.random().toString(36).slice(2));
  // Dismiss tapped tooltip on any touch/click outside the chart
  // Uses pointerdown (not click) — click events don't fire reliably on non-interactive iOS elements
  useEffect(()=>{
    if(tapped===null) return;
    const handle = e => { if(!containerRef.current?.contains(e.target)) setTapped(null); };
    const id = setTimeout(()=>document.addEventListener('pointerdown', handle, {passive:true}), 80);
    return ()=>{ clearTimeout(id); document.removeEventListener('pointerdown', handle); };
  },[tapped]);
  // Close this chart's tooltip when any OTHER chart bar is tapped
  useEffect(()=>{
    const handle = e => { if(e.detail.id !== instanceId.current) setTapped(null); };
    document.addEventListener('minibar-tap', handle);
    return ()=>document.removeEventListener('minibar-tap', handle);
  },[]);
  const H = 72;
  const vals = months.map(([,v])=> {
    if(valueKey==="net") return v.rev-v.exp;
    if(valueKey==="margin") return v.rev>0?((v.rev-v.exp)/v.rev)*100:0;
    return v[valueKey]||0;
  });
  const max = Math.max(...vals.map(Math.abs), 1);
  if(months.length===0) return <div style={{height:H,display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text-3)",fontSize:11}}>No data yet</div>;
  return (
    <div ref={containerRef} style={{position:"relative",paddingTop:32}}>
      <div style={{display:"flex",gap:2,alignItems:"flex-end",height:H}}>
        {months.map(([mo,v],i)=>{
          const val = vals[i];
          const px  = Math.max(3, Math.round((Math.abs(val)/max)*H));
          const isProj = !!(v && v.projected);
          // Delta vs previous actual (non-projected) bar
          const prevActualIdx = [...Array(i)].map((_,j)=>i-1-j).find(j=>j>=0&&!(months[j][1]?.projected));
          const prevVal = prevActualIdx!==undefined?vals[prevActualIdx]:null;
          const prevMo  = prevActualIdx!==undefined?months[prevActualIdx][0]:null;
          const delta   = prevVal!==null&&Math.abs(prevVal)>0.01?((val-prevVal)/Math.abs(prevVal))*100:null;
          const c = isProj ? "#bbbbbb"
            : marginMode
            ? (val >= 30 ? "#30d158" : val >= 0 ? "#aaaaaa" : "#ff453a")
            : color || (val>=0?"#30d158":"#ff453a");
          const canClick = !!onBarClick && !isProj;
          // When any bar is tapped, only show that bar's tooltip — prevent hover-linger bleed
          const isActive = tapped !== null ? tapped===i : hov===i;
          // Position tooltip so it never clips off screen edges
          const frac = months.length > 1 ? i / (months.length - 1) : 0.5;
          const tipAnchor = frac < 0.2
            ? {left:0, transform:'none'}
            : frac > 0.8
            ? {left:'auto', right:0, transform:'none'}
            : {left:'50%'};
          return (
            <div key={mo} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",height:H,justifyContent:"flex-end",position:"relative",cursor:canClick?"pointer":"default"}}
              onMouseEnter={()=>setHov(i)} onMouseLeave={()=>setHov(null)}
              onClick={()=>{
                if(!canClick){ setTapped(null); return; } // tap non-clickable bar clears stuck tooltip
                if(navigator.vibrate) navigator.vibrate([6]);
                document.dispatchEvent(new CustomEvent('minibar-tap',{detail:{id:instanceId.current}}));
                if(tapped===i){ onBarClick(mo,valueKey); setTapped(null); }
                else { setTapped(i); }
              }}>
              <div style={{width:"100%",borderRadius:"2px 2px 0 0",height:px,transition:"height 0.3s ease",
                background:isProj?(isActive?"#aaaaaa":"#cccccc"):(isActive?c:`${c}bb`),
                opacity:isProj?0.5:1,
                backgroundImage:isProj?"repeating-linear-gradient(45deg,transparent,transparent 3px,rgba(255,255,255,0.4) 3px,rgba(255,255,255,0.4) 6px)":"none",
                outline:canClick&&isActive?"2px solid "+c:"none",outlineOffset:1}}/>
              {isActive&&(
                <div className="chart-tooltip" style={{bottom:"calc(100% + 6px)",fontSize:11,...tipAnchor}}>
                  <div style={{color:"rgba(255,255,255,0.55)",fontSize:9,marginBottom:2}}>{moLabel(mo)}{isProj?" · projected":""}</div>
                  <div style={{color:"#fff",fontWeight:700}}>{fmt ? fmt(val) : fmt$(val)}</div>
                  {delta!==null&&(
                    <div style={{fontSize:9,marginTop:3,color:delta>=0?"#30d158":"#ff453a",fontWeight:600}}>
                      {delta>=0?"▲":"▼"} {delta>=0?"+":""}{delta.toFixed(1)}% vs {moLabel(prevMo)}
                    </div>
                  )}
                  {canClick&&<div style={{color:"rgba(255,255,255,0.4)",fontSize:8,marginTop:2}}>{tapped===i?"tap again for transactions":"tap for details"}</div>}
                </div>
              )}
            </div>
          );
        })}
      </div>
      <div style={{display:"flex",marginTop:4}}>
        {months.map(([mo],i)=>(
          <div key={mo} style={{flex:1,textAlign:"center",fontSize:8,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",
            opacity: months.length>12 ? (i%3===0?1:0) : 1
          }}>{labelFn ? labelFn(mo,i,months) : moLabel(mo).split(" ")[0]}</div>
        ))}
      </div>
    </div>
  );
}

// ── MonthDrillDown — modal showing transactions for a clicked bar ──
function MonthDrillDown({ mo, type, txs, onClose, doTag, doDelete, doBulkTag, doBulkDelete, getSuggestion, title=null }) {
  const [tagging, setTagging] = useState(null);
  const [txFilter, setTxFilter] = useState(type==="rev"?"in":type==="exp"?"out":"all");
  // title is set for quarterly drill-downs — txs are pre-filtered at call site
  const moTxs = title ? txs : txs.filter(t => t.date?.slice(0,7) === mo);
  const total = moTxs.filter(t=>txFilter==="all"||(txFilter==="in"&&t.type==="in")||(txFilter==="out"&&t.type==="out"))
    .reduce((s,t)=> t.type==="in" ? s+Math.abs(t.amount) : s-Math.abs(t.amount), 0);
  const typeLabel = type==="rev"?"Revenue":type==="exp"?"Expenses":"Net";

  return (
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:1000,display:"flex",alignItems:"flex-end",justifyContent:"center"}}
      onClick={e=>{if(e.target===e.currentTarget)onClose();}}>
      <div className="sheet-enter" style={{background:"rgba(10,14,36,0.96)",backdropFilter:"blur(60px) saturate(1.9)",WebkitBackdropFilter:"blur(60px) saturate(1.9)",borderRadius:"28px 28px 0 0",width:"100%",height:"88vh",display:"flex",flexDirection:"column",overflow:"hidden",boxShadow:"0 -2px 0 rgba(255,255,255,0.08), 0 -12px 60px rgba(0,0,0,0.50)",border:"0.5px solid rgba(255,255,255,0.12)"}}>
        <div style={{width:36,height:4,background:"rgba(255,255,255,0.18)",borderRadius:2,margin:"10px auto 0",flexShrink:0,cursor:"pointer"}} onClick={onClose}/>
        {/* Header */}
        <div style={{padding:"16px 20px 12px",borderBottom:"1px solid rgba(255,255,255,0.08)",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
          <div>
            <div style={{fontSize:12,color:"var(--text-3)",marginBottom:2}}>{title||moLabel(mo)} · {typeLabel}</div>
            <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:total>=0?"var(--green)":"var(--red)"}}>{fmt$(Math.abs(total))}</div>
          </div>
          <button onClick={onClose} style={{background:"rgba(255,255,255,0.08)",border:"none",borderRadius:20,width:32,height:32,fontSize:16,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text-2)"}}>✕</button>
        </div>
        {/* Transaction list — full filter/tag/delete capability */}
        <div style={{overflowY:"auto",flex:1,padding:"8px 12px 24px"}}>
          {moTxs.length===0
            ? <div style={{textAlign:"center",padding:"40px 0",color:"var(--text-3)",fontSize:13}}>No transactions for this period</div>
            : <TxList
                txs={moTxs}
                tagging={tagging} setTagging={setTagging}
                doTag={doTag} doDelete={doDelete}
                doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
                filter={txFilter} setFilter={setTxFilter} getSuggestion={getSuggestion}
              />
          }
        </div>
      </div>
    </div>
  );
}

// ── BarChart with hover tooltip ───────────────────────────────
function BarChart({ months, colorKey="green", label="Revenue" }) {
  const [hov, setHov] = useState(null);
  const H = 90;
  const vals = months.map(([,v])=> colorKey==="green" ? v.rev : colorKey==="red" ? v.exp : v.rev-v.exp);
  const max  = Math.max(...vals, 1);

  if(months.length===0) return (
    <div style={{height:H,display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text-3)",fontSize:12}}>
      No data — sync transactions
    </div>
  );

  return (
    <div style={{position:"relative"}}>
      <div style={{display:"flex",gap:3,alignItems:"flex-end",height:H,padding:"0 4px"}}>
        {months.map(([mo,v],i)=>{
          const val  = colorKey==="green"?v.rev:colorKey==="red"?v.exp:v.rev-v.exp;
          const px   = Math.max(3, Math.round((val/max)*H));
          const color= colorKey==="green"?"#30d158":colorKey==="red"?"#ff453a":val>=0?"#30d158":"#ff453a";
          return (
            <div key={mo} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",position:"relative",height:H,justifyContent:"flex-end"}}
              onMouseEnter={()=>setHov(i)} onMouseLeave={()=>setHov(null)}>
              <div style={{
                width:"100%",borderRadius:"3px 3px 0 0",
                background: hov===i ? color : `${color}cc`,
                height:px,
                transition:"height 0.3s ease, background 0.15s",
                cursor:"pointer",
              }}/>
              {hov===i&&(
                <div className="chart-tooltip" style={{bottom:"calc(100% + 8px)",left:"50%"}}>
                  <div style={{fontSize:11,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",marginBottom:3}}>{moLabel(mo)}</div>
                  <div style={{fontSize:14,fontWeight:700,color:color}}>{fmt$(val)}</div>
                  <div style={{fontSize:10,color:"var(--text-3)",marginTop:2}}>{label}</div>
                </div>
              )}
            </div>
          );
        })}
      </div>
      <div style={{display:"flex",marginTop:6,padding:"0 4px"}}>
        {months.map(([mo])=>(
          <div key={mo} style={{flex:1,textAlign:"center",fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{moLabel(mo).slice(0,3)}</div>
        ))}
      </div>
    </div>
  );
}

// ── Smooth Projection Chart with draggable scrubber ──────────
function ProjectionChart({ data }) {
  const svgRef = useRef(null);
  const [scrubX, setScrubX] = useState(null);  // pixel x within SVG
  const [isDragging, setIsDragging] = useState(false);
  const W=600, H=220, PL=50, PR=20, PT=20, PB=30;
  const CW=W-PL-PR, CH=H-PT-PB;

  const lines=[
    {key:"rev",color:"#30d158",label:"Revenue"},
    {key:"exp",color:"#ff453a",label:"Expenses"},
    {key:"net",color:"#444",label:"Net Income"},
  ];

  const allVals=data.flatMap(d=>[d.rev,d.exp,d.net]);
  const minV=Math.min(0,...allVals), maxV=Math.max(...allVals,1);
  const scaleY=v=>PT+CH*(1-(v-minV)/(maxV-minV));
  const scaleX=i=>PL+CW*(i/(data.length-1));

  // Smooth cubic bezier path
  const smoothPath=key=>{
    const pts=data.map((d,i)=>([scaleX(i),scaleY(d[key])]));
    if(pts.length<2) return "";
    let d=`M${pts[0][0]},${pts[0][1]}`;
    for(let i=0;i<pts.length-1;i++){
      const cp1x=pts[i][0]+(pts[i+1][0]-pts[i][0])*0.4;
      const cp1y=pts[i][1];
      const cp2x=pts[i][0]+(pts[i+1][0]-pts[i][0])*0.6;
      const cp2y=pts[i+1][1];
      d+=` C${cp1x},${cp1y} ${cp2x},${cp2y} ${pts[i+1][0]},${pts[i+1][1]}`;
    }
    return d;
  };

  // Find which data point scrubX is closest to
  const activeIdx = scrubX===null ? null : Math.min(data.length-1, Math.max(0,
    Math.round((scrubX - PL) / CW * (data.length-1))
  ));

  const getSVGX = e => {
    if(!svgRef.current) return null;
    const rect=svgRef.current.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const ratio = (clientX-rect.left)/rect.width;
    return ratio*W;
  };

  const onMove = e => {
    if(e.type==="mousemove"&&!isDragging&&e.buttons===0) {
      setScrubX(getSVGX(e));
    } else if(isDragging || e.type==="mousemove") {
      setScrubX(getSVGX(e));
    } else if(e.touches) {
      setScrubX(getSVGX(e));
    }
  };

  const activeData = activeIdx!==null ? data[activeIdx] : null;
  const scrubLineX = activeIdx!==null ? scaleX(activeIdx) : null;

  return (
    <div>
      <svg ref={svgRef} viewBox={`0 0 ${W} ${H}`} style={{width:"100%",height:"auto",overflow:"visible",cursor:"crosshair",userSelect:"none"}}
        onMouseMove={onMove} onMouseLeave={()=>{setScrubX(null);setIsDragging(false);}}
        onMouseDown={()=>setIsDragging(true)} onMouseUp={()=>setIsDragging(false)}
        onTouchMove={onMove} onTouchStart={onMove} onTouchEnd={()=>setScrubX(null)}>
        <defs>
          {lines.map(l=>(
            <linearGradient key={l.key} id={`pg_${l.key}`} x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stopColor={l.color} stopOpacity="0.18"/>
              <stop offset="100%" stopColor={l.color} stopOpacity="0.02"/>
            </linearGradient>
          ))}
        </defs>

        {/* Grid */}
        {[0,0.25,0.5,0.75,1].map(f=>{
          const y=PT+CH*f;
          const val=maxV-(maxV-minV)*f;
          return (
            <g key={f}>
              <line x1={PL} y1={y} x2={W-PR} y2={y} stroke="rgba(255,255,255,0.08)" strokeWidth="1" strokeDasharray="3,4"/>
              <text x={PL-6} y={y+4} textAnchor="end" style={{fontSize:8,fill:"rgba(26,26,46,0.35)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{fmt$(val).replace("$","")}</text>
            </g>
          );
        })}

        {/* Area fills */}
        {lines.map(l=>{
          const path=smoothPath(l.key);
          const lastX=scaleX(data.length-1);
          return <path key={l.key} d={path+` L${lastX},${H-PB} L${PL},${H-PB} Z`} fill={`url(#pg_${l.key})`}/>;
        })}

        {/* Lines */}
        {lines.map(l=>(
          <path key={l.key} d={smoothPath(l.key)} fill="none" stroke={l.color} strokeWidth="2.5"
            strokeLinecap="round" strokeLinejoin="round"/>
        ))}

        {/* Scrub line */}
        {scrubLineX!==null&&(
          <line x1={scrubLineX} y1={PT} x2={scrubLineX} y2={H-PB}
            stroke="rgba(26,26,46,0.25)" strokeWidth="1.5" strokeDasharray="3,3"/>
        )}

        {/* Dots at scrub position */}
        {activeIdx!==null&&lines.map(l=>(
          <circle key={l.key} cx={scaleX(activeIdx)} cy={scaleY(activeData[l.key])} r="5"
            fill={l.color} stroke="white" strokeWidth="2"/>
        ))}

        {/* X axis labels */}
        {data.map((d,i)=>(
          <text key={i} x={scaleX(i)} y={H-4} textAnchor="middle"
            style={{fontSize:9,fill:activeIdx===i?"rgba(26,26,46,0.8)":"rgba(26,26,46,0.35)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:activeIdx===i?"700":"400"}}>
            {d.year}
          </text>
        ))}
      </svg>

      {/* Live ticker — shows active data or last year by default */}
      {(()=>{
        const d=activeData||data[data.length-1];
        const yr=activeData?d.year:`${d.year} (proj.)`;
        return (
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:8,marginTop:12}}>
            {[
              {l:"Year",     v:yr,           c:"var(--text)"},
              {l:"Revenue",  v:fmt$(d.rev),  c:"#30d158"},
              {l:"Expenses", v:fmt$(d.exp),  c:"#ff453a"},
              {l:"Net Income",v:fmt$(d.net), c:d.net>=0?"#30d158":"#ff453a"},
            ].map(item=>(
              <div key={item.l} style={{background:"rgba(255,255,255,0.08)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:10,padding:"12px 14px",textAlign:"center",transition:"all 0.1s"}}>
                <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:5}}>{item.l}</div>
                <div style={{fontSize:16,fontWeight:800,color:item.c,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",letterSpacing:"-0.02em",transition:"all 0.08s"}}>{item.v}</div>
              </div>
            ))}
          </div>
        );
      })()}

      <div style={{display:"flex",gap:16,marginTop:12,justifyContent:"center"}}>
        {lines.map(l=>(
          <div key={l.key} style={{display:"flex",alignItems:"center",gap:5}}>
            <div style={{width:20,height:2.5,background:l.color,borderRadius:2}}/>
            <span style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{l.label}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// ── ManualIncomeModal ─────────────────────────────────────────
function ManualIncomeModal({ manual, onSave, onClose }) {
  const MONTHS = [
    "2025-01","2025-02","2025-03","2025-04","2025-05","2025-06",
    "2025-07","2025-08","2025-09","2025-10","2025-11","2025-12",
    "2026-01","2026-02","2026-03","2026-04","2026-05","2026-06",
    "2026-07","2026-08","2026-09","2026-10","2026-11","2026-12",
  ];
  const [vals, setVals] = useState({...manual});

  return (
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:16}}>
      <div className="glass" style={{width:"100%",maxWidth:480,maxHeight:"80vh",overflowY:"auto",padding:24,borderRadius:20}}>
        <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>Manual Airbnb Income</div>
        <div style={{fontSize:12,color:"var(--text-3)",marginBottom:20}}>
          Enter your exact Airbnb payout totals per month from the Airbnb app. Manual entries override Plaid data for that month — no double counting.
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          {MONTHS.map(mo=>(
            <div key={mo}>
              <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",marginBottom:3}}>{moLabel(mo)}</div>
              <input
                type="number"
                placeholder="0"
                value={vals[mo]||""}
                onChange={e=>setVals(v=>({...v,[mo]:parseFloat(e.target.value)||0}))}
                style={{width:"100%",padding:"7px 10px",borderRadius:8,border:"1px solid rgba(255,255,255,0.14)",fontSize:13,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",background:"rgba(255,255,255,0.08)",color:"var(--text)",boxSizing:"border-box"}}
              />
            </div>
          ))}
        </div>
        <div style={{display:"flex",gap:8,marginTop:20,justifyContent:"flex-end"}}>
          <button onClick={onClose} style={{padding:"8px 16px",borderRadius:10,border:"1px solid rgba(255,255,255,0.14)",background:"transparent",color:"var(--text-2)",cursor:"pointer",fontSize:13}}>Cancel</button>
          <button onClick={()=>{onSave(vals);onClose();}} className="btn-primary">Save</button>
        </div>
      </div>
    </div>
  );
}

// ── InvestModal ───────────────────────────────────────────────
function InvestModal({ invest, onSave, onClose }) {
  const [vals, setVals] = useState({...invest});
  const props = PROPERTIES.filter(p=>["lockwood","everton","bstreet","pierce"].includes(p.id));
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="glass fade-in" style={{width:400,padding:28}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:17,fontWeight:700,marginBottom:6}}>Down Payments</div>
        <div style={{fontSize:12,color:"var(--text-3)",marginBottom:22}}>Enter the initial down payment for each property. Cash-on-cash return is calculated automatically from your Plaid expense data.</div>
        {props.map(p=>(
          <div key={p.id} style={{marginBottom:16}}>
            <div style={{fontSize:11,color:p.color,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:700,marginBottom:6,textTransform:"uppercase",letterSpacing:"0.08em"}}>{p.label}</div>
            <div style={{position:"relative"}}>
              <span style={{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",color:"var(--text-3)",fontSize:14}}>$</span>
              <input type="number" value={vals[p.id]||""} onChange={e=>setVals(v=>({...v,[p.id]:+e.target.value}))}
                placeholder="0"
                style={{width:"100%",background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:10,padding:"10px 12px 10px 26px",color:"var(--text)",fontSize:15,fontWeight:600,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",outline:"none"}}/>
            </div>
          </div>
        ))}
        <div style={{display:"flex",gap:10,marginTop:24,justifyContent:"flex-end"}}>
          <button onClick={onClose} className="btn-ghost">Cancel</button>
          <button onClick={()=>{onSave(vals);onClose();}} className="btn-primary">Save</button>
        </div>
      </div>
    </div>
  );
}

// ── TxList ────────────────────────────────────────────────────
// ── TxList with bulk select ───────────────────────────────────
function TxList({ txs, tagging, setTagging, doTag, doDelete, doBulkTag, doBulkDelete, filter, setFilter, getSuggestion }) {
  const [selected, setSelected] = useState(new Set());
  const [pulsedId, setPulsedId] = useState(null);
  const handleTag = (txId, propId) => {
    doTag(txId, propId);
    setPulsedId(txId);
    setTimeout(()=>setPulsedId(null), 650);
  };

  const filtered = filter==="in" ? txs.filter(t=>t.type==="in") : filter==="out" ? txs.filter(t=>t.type==="out") : txs;
  const sorted   = [...filtered].sort((a,b)=>b.date.localeCompare(a.date));
  const allSel   = sorted.length>0 && sorted.every(t=>selected.has(t.id));
  const selCount = selected.size;

  const toggle = (id,e) => { e && e.stopPropagation(); setSelected(p=>{const n=new Set(p); n.has(id)?n.delete(id):n.add(id); return n;}); setTagging(null); };
  const toggleAll = () => setSelected(allSel ? new Set() : new Set(sorted.map(t=>t.id)));
  const clearSel  = () => setSelected(new Set());

  const handleBulkTag = pid => { doBulkTag([...selected], pid); clearSel(); };
  const handleBulkDel = ()  => { doBulkDelete([...selected]); clearSel(); };

  const Checkbox = ({id, checked, onToggle}) => (
    <div onClick={e=>{e.stopPropagation(); onToggle ? onToggle() : toggle(id,e);}} style={{width:18,height:18,borderRadius:5,border:`1.5px solid ${checked?"rgba(255,255,255,0.70)":"rgba(255,255,255,0.22)"}`,background:checked?"rgba(255,255,255,0.18)":"transparent",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all 0.12s"}}>
      {checked&&<span style={{color:"white",fontSize:10,lineHeight:1,fontWeight:700}}>✓</span>}
    </div>
  );

  return (
    <div>
      {/* Toolbar */}
      <div style={{display:"flex",gap:8,marginBottom:12,alignItems:"center",flexWrap:"wrap"}}>
        <div className="seg-ctrl">
          {[["all","All"],["in","↓ In"],["out","↑ Out"]].map(([k,l])=>(
            <button key={k} className={`seg-btn${filter===k?" active":""}`} onClick={()=>{setFilter(k);clearSel();}}>{l}</button>
          ))}
        </div>
        <span style={{fontSize:11,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{sorted.length} transactions</span>

        {selCount>0&&(
          <div style={{display:"flex",gap:5,alignItems:"center",marginLeft:"auto",flexWrap:"wrap"}}>
            <span style={{fontSize:11,fontWeight:700,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"var(--text-2)",marginRight:2}}>{selCount} selected —</span>
            {PROPERTIES.filter(p=>p.id!=="transfer").map(p=>(
              <button key={p.id} onClick={()=>handleBulkTag(p.id)}
                style={{background:"rgba(255,255,255,0.08)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.14)",borderRadius:8,padding:"4px 10px",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:600,cursor:"pointer"}}>
                {p.label}
              </button>
            ))}
            <button onClick={handleBulkDel}
              style={{background:"rgba(255,69,58,0.1)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.3)",borderRadius:8,padding:"4px 10px",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:700,cursor:"pointer"}}>
              Delete {selCount}
            </button>
            <button onClick={clearSel} style={{background:"rgba(255,255,255,0.07)",color:"var(--text-3)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,padding:"4px 8px",fontSize:10,cursor:"pointer"}}>✕</button>
          </div>
        )}
      </div>

      {sorted.length===0&&<div style={{textAlign:"center",padding:"32px 0",color:"var(--text-3)",fontSize:13}}>No transactions</div>}

      {sorted.length>0&&(
        <div className="glass" style={{overflow:"hidden"}}>
          <div style={{display:"grid",gridTemplateColumns:"36px 72px 22px 1fr 100px 120px",padding:"8px 14px",borderBottom:"1px solid rgba(255,255,255,0.07)",gap:8,alignItems:"center"}}>
            <Checkbox id="__all__" checked={allSel} onToggle={toggleAll}/>
            {["DATE","","PAYEE","AMOUNT","PROPERTY"].map(h=>(
              <span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.1em"}}>{h}</span>
            ))}
          </div>
          {sorted.map(tx=>{
            const isSel = selected.has(tx.id);
            return (
              <div key={tx.id}>
                <div className={pulsedId===tx.id?"row-pulse":""} style={{display:"grid",gridTemplateColumns:"36px 72px 22px 1fr 100px 120px",padding:"10px 14px",borderBottom:"1px solid rgba(255,255,255,0.06)",gap:8,alignItems:"center",cursor:"pointer",transition:"background 0.1s",background:isSel?"rgba(10,132,255,0.06)":"transparent"}}
                  onClick={()=>{ if(selCount>0){toggle(tx.id);return;} setTagging(t=>t===tx.id?null:tx.id); }}
                  onMouseEnter={e=>{if(!isSel)e.currentTarget.style.background="rgba(255,255,255,0.04)";}}
                  onMouseLeave={e=>{if(!isSel)e.currentTarget.style.background="transparent";}}>
                  <div onClick={e=>toggle(tx.id,e)}><Checkbox id={tx.id} checked={isSel}/></div>
                  <span style={{fontSize:11,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{fmtDate(tx.date)}</span>
                  <span className={tx.type==="in"?"dir-in":"dir-out"}>{tx.type==="in"?"↓":"↑"}</span>
                  <div style={{overflow:"hidden"}}>
                    <div style={{fontSize:13,fontWeight:500,lineHeight:1.3,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{tx.payee}</div>
                    {tx.account&&<div style={{fontSize:10,color:"var(--text-3)",marginTop:1}}>{tx.account}</div>}
                  </div>
                  <span style={{fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:700,fontSize:13,color:tx.type==="in"?"#30d158":"#ff453a"}}>
                    {tx.type==="in"?"+":"-"}{fmtD(tx.amount)}
                  </span>
                  <div onClick={e=>e.stopPropagation()} style={{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:2}}>
                    <span onClick={e=>{e.stopPropagation();setTagging(t=>t===tx.id?null:tx.id);}}>
                      <PropBadge id={tx.propId} small/>
                    </span>
                    {!tx.propId&&getSuggestion&&getSuggestion(tx)&&(
                      <span style={{fontSize:8,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",cursor:"pointer"}}
                        onClick={e=>{e.stopPropagation();doTag(tx.id,getSuggestion(tx));}}
                        title="Click to apply auto-tag suggestion">
                        💡 {getSuggestion(tx)}
                      </span>
                    )}
                  </div>
                </div>
                {tagging===tx.id&&(
                  <div style={{padding:"0 14px 12px",borderBottom:"1px solid rgba(255,255,255,0.06)"}}>
                    <TagMenu tx={tx} onTag={handleTag} onClose={()=>setTagging(null)} onDelete={doDelete}/>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}


const BASE_TABS=["Portfolio","Airbnb","Pierce","Quarterly","Projections"];


// ── Rule Prompt Modal — Copilot-style "apply to all?" ────────────
function RulePromptModal({ payee, propId, onApplyAll, onApplyName, onSkip }) {
  const label = ({lockwood:"Lockwood",everton:"Everton",bstreet:"B Street",
    pierce:"Pierce Ave",llc:"General LLC",transfer:"Internal Transfer"})[propId]||propId;
  return (
    <div style={{position:"fixed",inset:0,zIndex:300,display:"flex",flexDirection:"column",
      justifyContent:"flex-end",background:"rgba(0,0,0,0.4)",backdropFilter:"blur(8px)"}}>
      <div className="sheet-enter" style={{background:"rgba(16,20,48,0.96)",backdropFilter:"blur(48px) saturate(1.8)",WebkitBackdropFilter:"blur(48px) saturate(1.8)",border:"1px solid rgba(255,255,255,0.12)",borderBottom:"none",borderRadius:"20px 20px 0 0",padding:"24px 20px 40px"}}>
        <div style={{width:36,height:4,background:"rgba(255,255,255,0.18)",borderRadius:2,
          margin:"0 auto 20px",cursor:"pointer"}} onClick={onSkip}/>
        <div style={{fontSize:11,fontWeight:700,letterSpacing:"0.08em",color:"var(--text-3)",
          textTransform:"uppercase",marginBottom:4}}>TAG CHANGED</div>
        <div style={{fontSize:15,color:"var(--text)",marginBottom:20,lineHeight:1.4}}>
          Do you want to tag everything from <b>"{payee}"</b> as <b>{label}</b>?
        </div>
        <button onClick={onApplyAll} style={{width:"100%",padding:"15px",textAlign:"left",
          background:"none",border:"none",borderTop:"1px solid rgba(255,255,255,0.08)",
          fontSize:15,color:"var(--text)",cursor:"pointer",display:"flex",justifyContent:"space-between"}}>
          <span>Tag all "{payee}" transactions</span>
          <span style={{color:"var(--text-3)"}}>›</span>
        </button>
        <button onClick={onApplyName} style={{width:"100%",padding:"15px",textAlign:"left",
          background:"none",border:"none",borderTop:"1px solid rgba(255,255,255,0.08)",
          fontSize:15,color:"var(--text)",cursor:"pointer",display:"flex",justifyContent:"space-between"}}>
          <span>Create rule for "{payee}" going forward</span>
          <span style={{color:"var(--text-3)"}}>›</span>
        </button>
        <button onClick={onSkip} style={{width:"100%",padding:"15px",textAlign:"center",
          background:"none",border:"none",borderTop:"1px solid rgba(255,255,255,0.08)",
          fontSize:15,color:"var(--text-2)",cursor:"pointer"}}>
          No thanks
        </button>
      </div>
    </div>
  );
}


// ── Settings Page ─────────────────────────────────────────────────
function SettingsPage({ onClose, autoTags, rules, onDeleteRule, settings, onSaveSettings,
  archived, doRestore, doTag, linked, onRemoveAccount, onClearAll, customProps=[], onDeleteProp,
  onSync, onPullHistory, syncing=false, lastSync=null, lastPull=null, shakeSync=false }) {
  const [section, setSection] = React.useState("main");
  const PROP_LABEL = {lockwood:"Lockwood",everton:"Everton",bstreet:"B Street",
    pierce:"Pierce Ave",llc:"General LLC",transfer:"Internal Transfer",deleted:"Deleted"};
  const ROW_STYLE = {display:"flex",justifyContent:"space-between",alignItems:"center",
    padding:"14px 20px",borderBottom:"1px solid rgba(255,255,255,0.07)",cursor:"pointer",
    background:"rgba(255,255,255,0.06)"};
  const row = (label, right, onClick) => (
    <div onClick={onClick} style={{...ROW_STYLE,cursor:onClick?"pointer":"default"}}>
      <span style={{fontSize:15,color:onClick?"var(--text)":"var(--text-2)"}}>{label}</span>
      <span style={{fontSize:15,color:"var(--text-3)"}}>{right}</span>
    </div>
  );
  const toggle = (label, key, desc) => (
    <div style={ROW_STYLE}>
      <div style={{flex:1}}>
        <div style={{fontSize:15,color:"var(--text)"}}>{label}</div>
        {desc&&<div style={{fontSize:12,color:"var(--text-3)",marginTop:2}}>{desc}</div>}
      </div>
      <div onClick={()=>onSaveSettings({...settings,[key]:!settings[key]})}
        style={{width:48,height:28,borderRadius:14,background:settings[key]?"#32d74b":"rgba(255,255,255,0.18)",
          position:"relative",cursor:"pointer",transition:"background 0.2s",flexShrink:0}}>
        <div style={{position:"absolute",top:2,left:settings[key]?20:2,width:24,height:24,
          borderRadius:12,background:"#fff",transition:"left 0.2s",
          boxShadow:"0 1px 4px rgba(0,0,0,0.3)"}}/>
      </div>
    </div>
  );

  return (
    <div className="settings-enter" style={{position:"fixed",inset:0,zIndex:400,background:"#06091a",
      overflowY:"auto",display:"flex",flexDirection:"column"}}>
      {/* Header */}
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",
        padding:"56px 20px 12px",background:"#06091a"}}>
        {section!=="main"
          ? <button onClick={()=>setSection("main")} style={{background:"none",border:"none",
              fontSize:16,color:"var(--blue)",cursor:"pointer",padding:0}}>‹ Back</button>
          : <div/>}
        <div style={{fontSize:17,fontWeight:600,color:"var(--text)"}}>
          {section==="main"?"Settings":section==="tags"?"Tag Rules":
           section==="archive"?"Archive":section==="account"?"Account":"Settings"}
        </div>
        <button onClick={onClose} style={{background:"none",border:"none",fontSize:16,
          color:"var(--blue)",cursor:"pointer"}}>Done</button>
      </div>

      {section==="main"&&<>
        <div style={{fontSize:12,color:"var(--text-3)",textTransform:"uppercase",letterSpacing:"0.06em",
          padding:"16px 20px 6px"}}>Appearance</div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          {toggle("Dark Mode","darkMode","Always use dark appearance")}
        </div>
        <div style={{fontSize:12,color:"var(--text-3)",textTransform:"uppercase",letterSpacing:"0.06em",
          padding:"8px 20px 6px"}}>Data</div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",
            padding:"14px 20px",borderBottom:"1px solid rgba(255,255,255,0.07)",background:"rgba(255,255,255,0.06)"}}>
            <div>
              <span style={{fontSize:15,color:"var(--text)"}}>Sync Transactions</span>
              {lastSync&&<div style={{fontSize:11,color:"var(--text-3)",marginTop:2}}>
                Last synced {new Date(lastSync).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})}
              </div>}
            </div>
            <button onClick={onSync} disabled={syncing} className={shakeSync?"shake":""}
              style={{background:syncing?"rgba(255,255,255,0.04)":"rgba(255,255,255,0.16)",border:"1px solid rgba(255,255,255,0.14)",borderRadius:8,
                padding:"6px 14px",fontSize:12,fontWeight:600,color:syncing?"var(--text-3)":"var(--text)",cursor:syncing?"default":"pointer"}}>
              {syncing?"Syncing…":"Sync Now"}
            </button>
          </div>
          <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",
            padding:"14px 20px",borderBottom:"1px solid rgba(255,255,255,0.07)",background:"rgba(255,255,255,0.06)"}}>
            <div>
              <span style={{fontSize:15,color:"var(--text)"}}>Pull Full History</span>
              <div style={{fontSize:11,color:"var(--text-3)",marginTop:2}}>
                {lastPull
                  ? `Last pulled ${new Date(lastPull).toLocaleString("en-US",{month:"short",day:"numeric",hour:"numeric",minute:"2-digit"})}`
                  : "Backfills up to 2 years of transactions"}
              </div>
            </div>
            <button onClick={onPullHistory} disabled={syncing}
              style={{background:syncing?"rgba(255,255,255,0.04)":"rgba(255,255,255,0.10)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:8,
                padding:"6px 14px",fontSize:12,fontWeight:600,color:syncing?"var(--text-3)":"var(--text)",cursor:syncing?"default":"pointer"}}>
              {syncing?"Pulling…":"Pull History"}
            </button>
          </div>
          {row("Tag Rules",`${Object.keys(rules).length} rules ›`,()=>setSection("tags"))}
          {row("Archive / Deleted",`${archived.length} transactions ›`,()=>setSection("archive"))}
        </div>
        <div style={{fontSize:12,color:"var(--text-3)",textTransform:"uppercase",letterSpacing:"0.06em",
          padding:"8px 20px 6px"}}>Notifications</div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          {toggle("New transactions","notifications","Notify when transactions arrive")}
          {toggle("Daily sync at 7am","autoSync","Automatically refresh each morning")}
        </div>
        {customProps.length>0&&<>
          <div style={{fontSize:12,color:"var(--text-3)",textTransform:"uppercase",letterSpacing:"0.06em",
            padding:"8px 20px 6px"}}>Properties</div>
          <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
            {customProps.map(p=>(
              <div key={p.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",
                padding:"12px 20px",borderBottom:"1px solid rgba(255,255,255,0.07)",background:"rgba(255,255,255,0.06)"}}>
                <div>
                  <div style={{fontSize:15,color:"var(--text)",fontWeight:500}}>{p.label}</div>
                  <div style={{fontSize:12,color:"var(--text-3)"}}>{p.isAirbnb?"Airbnb property":"Non-Airbnb property"}</div>
                </div>
                <button onClick={()=>{if(window.confirm(`Delete "${p.label}"? Transactions will become untagged.`))onDeleteProp(p.id);}}
                  style={{background:"none",border:"none",color:"var(--red)",fontSize:14,cursor:"pointer",padding:"4px 8px"}}>Delete</button>
              </div>
            ))}
          </div>
        </>}
        <div style={{fontSize:12,color:"var(--text-3)",textTransform:"uppercase",letterSpacing:"0.06em",
          padding:"8px 20px 6px"}}>Account</div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          {linked.map(a=>row(`${a.name} ···${a.mask||""}`, "Remove",
            ()=>{if(window.confirm(`Remove ${a.name}?`))onRemoveAccount(a.item_id);}))}
          {row("Clear all data","›",()=>{if(window.confirm("Delete all transactions and tags?"))onClearAll();})}
        </div>
      </>}

      {section==="tags"&&<>
        <div style={{fontSize:12,color:"var(--text-3)",padding:"16px 20px 6px"}}>
          These rules auto-tag transactions from matching payees.
        </div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          {Object.keys(rules).length===0&&<div style={{padding:"20px",background:"rgba(255,255,255,0.06)",
            textAlign:"center",color:"var(--text-3)",fontSize:14}}>No rules yet — tag a transaction to create one.</div>}
          {Object.entries(rules).map(([payee,propId])=>(
            <div key={payee} style={{display:"flex",justifyContent:"space-between",alignItems:"center",
              padding:"12px 20px",borderBottom:"1px solid rgba(255,255,255,0.07)",background:"rgba(255,255,255,0.06)"}}>
              <div>
                <div style={{fontSize:14,color:"var(--text)",fontWeight:500,textTransform:"capitalize"}}>
                  {payee.charAt(0)+payee.slice(1).toLowerCase()}
                </div>
                <div style={{fontSize:12,color:"var(--text-3)"}}>{PROP_LABEL[propId]||propId}</div>
              </div>
              <button onClick={()=>onDeleteRule(payee)} style={{background:"none",border:"none",
                color:"var(--red)",fontSize:14,cursor:"pointer",padding:"4px 8px"}}>Delete</button>
            </div>
          ))}
        </div>
      </>}

      {section==="archive"&&<>
        <div style={{fontSize:12,color:"var(--text-3)",padding:"16px 20px 6px"}}>
          Deleted & internal transfers. Tap Restore to bring back.
        </div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          {archived.length===0&&<div style={{padding:"20px",background:"rgba(255,255,255,0.06)",
            textAlign:"center",color:"var(--text-3)",fontSize:14}}>Nothing archived.</div>}
          {archived.map(tx=>(
            <div key={tx.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",
              padding:"12px 20px",borderBottom:"1px solid rgba(255,255,255,0.07)",background:"rgba(255,255,255,0.06)"}}>
              <div style={{flex:1,minWidth:0,marginRight:12}}>
                <div style={{fontSize:14,fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",
                  whiteSpace:"nowrap"}}>{tx.payee||tx.name}</div>
                <div style={{fontSize:12,color:"var(--text-3)"}}>{tx.date}</div>
              </div>
              <div style={{display:"flex",alignItems:"center",gap:8}}>
                <span style={{fontSize:13,fontWeight:600,color:tx.type==="in"?"var(--green)":"var(--red)",
                  fontFamily:"monospace"}}>{tx.type==="in"?"+":"-"}{Math.abs(tx.amount).toFixed(0)}</span>
                <button onClick={()=>doRestore(tx.id)} style={{background:"rgba(10,132,255,0.14)",
                  border:"none",borderRadius:8,fontSize:12,fontWeight:600,color:"var(--blue)",
                  padding:"4px 10px",cursor:"pointer"}}>Restore</button>
              </div>
            </div>
          ))}
        </div>
      </>}
    </div>
  );
}

// ── AddPropertyModal ──────────────────────────────────────────
function AddPropertyModal({ onSave, onClose }) {
  const [name, setName] = React.useState("");
  const [isAirbnb, setIsAirbnb] = React.useState(false);
  const nameRef = React.useRef(null);
  React.useEffect(()=>{ nameRef.current?.focus(); },[]);
  const handleSave = () => {
    if(!name.trim()) return;
    const id = name.trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"") + "-" + Date.now().toString(36);
    onSave({ id, label: name.trim(), isAirbnb });
  };
  return (
    <div style={{position:"fixed",inset:0,zIndex:600,display:"flex",flexDirection:"column",
      justifyContent:"flex-end",background:"rgba(0,0,0,0.45)",backdropFilter:"blur(8px)"}}>
      <div className="sheet-enter" style={{background:"rgba(14,18,44,0.97)",backdropFilter:"blur(48px) saturate(1.8)",WebkitBackdropFilter:"blur(48px) saturate(1.8)",border:"1px solid rgba(255,255,255,0.12)",borderBottom:"none",borderRadius:"20px 20px 0 0",padding:"24px 20px 40px"}}>
        <div style={{width:36,height:4,background:"rgba(255,255,255,0.18)",borderRadius:2,
          margin:"0 auto 20px",cursor:"pointer"}} onClick={onClose}/>
        <div style={{fontSize:11,fontWeight:700,letterSpacing:"0.08em",color:"var(--text-3)",
          textTransform:"uppercase",marginBottom:8}}>Add Property</div>
        <input
          ref={nameRef}
          value={name} onChange={e=>setName(e.target.value)}
          onKeyDown={e=>{ if(e.key==="Enter") handleSave(); }}
          placeholder="Property name"
          style={{width:"100%",boxSizing:"border-box",fontSize:17,padding:"12px 14px",
            border:"1px solid rgba(255,255,255,0.14)",borderRadius:12,outline:"none",marginBottom:16,
            fontFamily:"inherit",color:"var(--text)",background:"rgba(255,255,255,0.08)"}}
        />
        <div style={{display:"flex",gap:8,marginBottom:name.trim()&&isAirbnb?8:16}}>
          {[{v:false,l:"Non-Airbnb"},{v:true,l:"Airbnb"}].map(opt=>(
            <button key={String(opt.v)} onClick={()=>setIsAirbnb(opt.v)}
              style={{flex:1,padding:"10px",border:`1.5px solid ${isAirbnb===opt.v?"var(--blue)":"rgba(255,255,255,0.16)"}`,
                borderRadius:10,fontSize:14,fontWeight:isAirbnb===opt.v?600:400,
                color:isAirbnb===opt.v?"var(--blue)":"var(--text-2)",
                background:isAirbnb===opt.v?"rgba(10,132,255,0.12)":"rgba(255,255,255,0.06)",cursor:"pointer"}}>
              {opt.l}
            </button>
          ))}
        </div>
        {isAirbnb&&<div style={{fontSize:12,color:"var(--text-3)",marginBottom:16,padding:"8px 12px",
          background:"rgba(255,255,255,0.06)",borderRadius:8}}>
          No separate tab — rolled into Airbnb aggregate
        </div>}
        <button onClick={handleSave} disabled={!name.trim()}
          style={{width:"100%",padding:"15px",borderRadius:12,fontSize:16,fontWeight:600,
            border:"none",cursor:name.trim()?"pointer":"default",
            background:name.trim()?"rgba(255,255,255,0.18)":"rgba(255,255,255,0.06)",
            color:name.trim()?"var(--text)":"var(--text-3)"}}>
          Add Property
        </button>
        <button onClick={onClose} style={{width:"100%",marginTop:8,padding:"12px",background:"none",
          border:"none",fontSize:15,color:"var(--text-2)",cursor:"pointer"}}>Cancel</button>
      </div>
    </div>
  );
}

// ── Toast system ──────────────────────────────────────────────
function ToastManager({ toasts, onRemove }) {
  return <>{toasts.map(t=><ToastItem key={t.id} toast={t} onRemove={onRemove}/>)}</>;
}
function ToastItem({ toast, onRemove }) {
  const [ex, setEx] = React.useState(false);
  React.useEffect(()=>{
    const t1=setTimeout(()=>setEx(true), 2700);
    const t2=setTimeout(()=>onRemove(toast.id), 3100);
    return ()=>{ clearTimeout(t1); clearTimeout(t2); };
  },[]);
  const isOk  = toast.type==="success";
  const isErr = toast.type==="error";
  return (
    <div className="toast-wrap">
      <div className={`toast-pill${ex?" exiting":""}`}>
        {isOk&&<svg width="14" height="14" viewBox="0 0 14 14" fill="none"
          stroke="var(--green)" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round">
          <polyline points="1.5,7.5 5.5,11 12.5,3" className="check-path"/>
        </svg>}
        {isErr&&<svg width="14" height="14" viewBox="0 0 14 14" fill="none"
          stroke="var(--red)" strokeWidth="2.2" strokeLinecap="round">
          <line x1="2" y1="2" x2="12" y2="12"/><line x1="12" y1="2" x2="2" y2="12"/>
        </svg>}
        <span style={{color:isErr?"var(--red)":"var(--text)"}}>{toast.message}</span>
      </div>
    </div>
  );
}

// ── AnimatedNum — smooth count-up/down on value change ─────────
function AnimatedNum({ value, format, style, className }) {
  const prev = React.useRef(value);
  const raf  = React.useRef(null);
  const [cur, setCur] = React.useState(value);
  React.useEffect(()=>{
    const from=prev.current, to=value;
    if(from===to){ prev.current=to; return; }
    prev.current=to;
    if(raf.current) cancelAnimationFrame(raf.current);
    const start=performance.now();
    const dur=Math.min(900, 350+Math.abs(to-from)*0.012);
    function tick(now){
      const p=Math.min((now-start)/dur,1);
      const e=1-Math.pow(1-p,3); // ease-out-cubic
      setCur(from+(to-from)*e);
      if(p<1) raf.current=requestAnimationFrame(tick);
      else { setCur(to); raf.current=null; }
    }
    raf.current=requestAnimationFrame(tick);
    return ()=>{ if(raf.current) cancelAnimationFrame(raf.current); };
  },[value]);
  return <span style={style} className={className}>{format?format(cur):Math.round(cur)}</span>;
}

// ── SkeletonPane — shimmer placeholder during initial load ──────
function SkeletonPane() {
  const bar=(w,h,mb=8)=>(
    <span className="skeleton" style={{height:h,width:w,marginBottom:mb,borderRadius:6,display:"block"}}/>
  );
  return (
    <div style={{padding:"20px 16px"}}>
      {bar("38%",11,14)}{bar("52%",34,24)}
      <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:12}}>
        {[1,2,3,4].map(i=>(
          <div key={i} className="card card-padded" style={{minHeight:76}}>
            {bar("50%",9,10)}{bar("68%",22)}
          </div>
        ))}
      </div>
      {bar("32%",9,12)}
      <div className="card" style={{padding:"16px 18px",marginBottom:8}}>
        {[1,2,3,4,5].map(i=>(
          <div key={i} style={{display:"flex",gap:10,marginBottom:10,alignItems:"center"}}>
            {bar("16%",9)}{bar("42%",9)}{bar("20%",9)}{bar("14%",9)}
          </div>
        ))}
      </div>
    </div>
  );
}

// ── Main App ──────────────────────────────────────────────────
function App() {
  const [tab, setTab]           = useState("Portfolio");
  const [tabIdx, setTabIdx]     = useState(0);
  const [customProps, setCustomProps] = useState(()=>LS.get(CUSTOM_PROPS_KEY)||[]);
  const [showAddProp, setShowAddProp] = useState(false);
  const [lastSync, setLastSync]       = useState(()=>LS.get(LAST_SYNC_KEY)||null);
  const [lastPull, setLastPull]       = useState(()=>LS.get(LAST_PULL_KEY)||null);
  const [drawerHomesExpanded, setDrawerHomesExpanded] = useState(false);
  const subNavRef  = useRef(null);
  const pullRef    = useRef({active:false, startY:0, triggered:false});
  const isFirstLayout = useRef(true);
  const [pullY, setPullY] = useState(0);
  const PULL_THRESHOLD = 72;

  // ── Toast system ──────────────────────────────────────────────
  const [toasts, setToasts]   = useState([]);
  const toastId = useRef(0);
  const addToast = useCallback((msg, type="info")=>{
    const id=++toastId.current;
    setToasts(p=>[...p,{id,message:msg,type}]);
  },[]);
  const removeToast = useCallback((id)=>{
    setToasts(p=>p.filter(t=>t.id!==id));
  },[]);
  const [syncDone, setSyncDone]     = useState(false);
  const [initialLoad, setInitialLoad] = useState(true);
  const [shakeTarget, setShakeTarget] = useState(null);

  // Dynamic tabs: base 5 + any non-Airbnb custom props
  const tabs = useMemo(()=>[...BASE_TABS,...customProps.filter(p=>!p.isAirbnb).map(p=>p.label)],[customProps]);
  const feedIdx    = tabs.length;
  const archiveIdx = tabs.length + 1;

  // Portfolio group = Portfolio overview + all property sub-panes (not Quarterly/Projections/Feed/Archive)
  const isPortfolioGroup = tabIdx < feedIdx && tabs[tabIdx] !== "Quarterly" && tabs[tabIdx] !== "Projections";
  // Index of Quarterly tab — sub-panes are all indices between 1 and this (exclusive)
  const quarterlyIdx = tabs.indexOf("Quarterly");
  // isSubPane: inside a property pane (not Portfolio overview, not Quarterly/Projections/Feed/Archive)
  const isSubPane = tabIdx >= 1 && tabIdx < quarterlyIdx;
  // Map tab index → visual pill index (Portfolio=0, Quarterly=1, Projections=2)
  const tabToPillIdx = t => {
    if(tabs[t]==="Quarterly") return 1;
    if(tabs[t]==="Projections") return 2;
    return 0; // Portfolio overview + all property sub-panes
  };

  // Sync module-level mutable arrays so PropBadge/TagMenu child components see current properties
  PROPERTIES = [...BASE_PROPERTIES,...customProps.map(p=>({id:p.id,label:p.label,color:"var(--text)",group:p.isAirbnb?"airbnb":p.id}))];
  AIRBNB_IDS = [...BASE_AIRBNB_IDS,...customProps.filter(p=>p.isAirbnb).map(p=>p.id)];
  // Set initial track position
  useEffect(()=>{
    if(trackRef.current) trackRef.current.style.transform = "translateX(0px)";
    centerNavPill(0, false);
  },[]);
  // Update page-outer top whenever the sub-nav row appears or disappears
  useEffect(()=>{
    requestAnimationFrame(()=>{
      const headerH = headerRef.current?.offsetHeight || 56;
      const mainNavH = navRef.current?.offsetHeight || 52;
      const subNavH = isPortfolioGroup && subNavRef.current ? subNavRef.current.offsetHeight : 0;
      const outer = document.querySelector(".page-outer");
      if(!outer) return;
      if(isFirstLayout.current){
        outer.style.transition = "none"; // no transition on first paint
        isFirstLayout.current = false;
      } else {
        outer.style.transition = "top 0.32s cubic-bezier(0.33, 1, 0.68, 1)";
      }
      outer.style.top = (headerH + mainNavH + subNavH) + "px";
    });
  },[isPortfolioGroup]);
  const trackRef                = useRef(null);
  const headerRef               = useRef(null);
  const navRef                  = useRef(null);
  const navTrackRef             = useRef(null);
  const drag                    = useRef({active:false,startX:0,startY:0,lastX:0,axis:null});
  const dragPillOffsets         = useRef(null);
  const pillRefs                = useRef([]);    // [Portfolio, Quarterly, Projections]
  const subPillRefs             = useRef({});    // {0:Airbnb, 1:Pierce, ...}

  const springRef       = useRef(null); // active rAF id for track spring
  const pillSnapTimerRef = useRef(null); // timeout id for snapPillsToTab cleanup
  const setTrackPos = (px, animated, initVel = 0) => {
    const el = trackRef.current; if(!el) return;
    // Cancel any in-flight spring
    if(springRef.current){ cancelAnimationFrame(springRef.current); springRef.current = null; }
    if(!animated){
      el.style.transition = 'none';
      el.style.transform  = `translate3d(${px}px, 0, 0)`;
      return;
    }
    // Read current translate from computed style
    el.style.transition = 'none';
    const mat = new DOMMatrix(window.getComputedStyle(el).transform);
    const curX = isNaN(mat.m41) ? px : mat.m41;
    // Spring state: x = displacement from target (px), v = velocity (px/s)
    let x = curX - px;
    let v = initVel * 1000; // px/ms → px/s
    // Critically-damped spring: fastest settle with zero oscillation/wobble
    const k = 380, c = 42; // ζ = c/(2√k) ≈ 1.08 — slightly overdamped, no bounce
    let last = performance.now();
    function tick(now){
      const dt = Math.min((now - last) / 1000, 1/30);
      last = now;
      v += (-k * x - c * v) * dt;
      x += v * dt;
      el.style.transform = `translate3d(${px + x}px, 0, 0)`;
      if(Math.abs(x) < 0.5 && Math.abs(v) < 0.5){
        el.style.transform = `translate3d(${px}px, 0, 0)`;
        springRef.current = null; return;
      }
      springRef.current = requestAnimationFrame(tick);
    }
    springRef.current = requestAnimationFrame(tick);
  };

  // Nav pill centering is handled by static CSS (flex justify-content:center on .top-nav).
  const centerNavPill = (_idx, _animated) => {};

  // ── Liquid pill animation helpers ─────────────────────────────────────
  // Called every touchMove to morph pills in real-time with finger drag
  const animatePillsDrag = (rawDx, clampedDx) => {
    const vw = window.innerWidth;
    const goingLeft = rawDx < 0;
    const progress = Math.min(1, Math.abs(clampedDx) / (vw * 0.35)); // 0→1

    // ── Main pills (Portfolio / Quarterly / Projections) ──
    if(!isSubPane){
      const cur = tabToPillIdx(tabIdx);
      const nxt = goingLeft ? cur + 1 : cur - 1;
      pillRefs.current.forEach((el, i) => {
        if(!el) return;
        el.style.transition = 'none';
        if(i === cur){
          el.style.transform  = `scale(${1 - progress * 0.18})`;
          el.style.opacity    = String(1 - progress * 0.62);
          el.style.background = `rgba(255,255,255,${0.78 * (1 - progress)})`;
          el.style.boxShadow  = 'none';
        } else if(i === nxt && nxt >= 0 && nxt <= 2){
          el.style.transform  = `scale(${0.82 + progress * 0.18})`;
          el.style.opacity    = String(0.36 + progress * 0.64);
          el.style.background = `rgba(255,255,255,${0.78 * progress})`;
          el.style.boxShadow  = `0 ${2*progress}px ${14*progress}px rgba(60,80,180,${0.12*progress})`;
        }
      });
    }

    // ── Sub-pills (Airbnb / Pierce / custom) ──
    if(isSubPane){
      const cur = tabIdx - 1; // sub-pill index
      const nxt = goingLeft ? cur + 1 : cur - 1;
      const total = Object.keys(subPillRefs.current).length;
      Object.entries(subPillRefs.current).forEach(([k, el]) => {
        if(!el) return;
        const i = parseInt(k);
        el.style.transition = 'none';
        if(i === cur){
          el.style.transform  = `scale(${1 - progress * 0.12})`;
          el.style.opacity    = String(1 - progress * 0.52);
          el.style.background = `rgba(255,255,255,${0.75 * (1 - progress)})`;
        } else if(i === nxt && nxt >= 0 && nxt < total){
          el.style.transform  = `scale(${0.88 + progress * 0.12})`;
          el.style.opacity    = String(0.52 + progress * 0.48);
          el.style.background = `rgba(255,255,255,${0.75 * progress})`;
        }
      });
    }
  };

  // Called on touchEnd: spring pills to their final state, then let CSS class take over
  const snapPillsToTab = (newTabIdx) => {
    // Cancel any previous cleanup timer so it doesn't fire mid-animation
    if(pillSnapTimerRef.current){ clearTimeout(pillSnapTimerRef.current); pillSnapTimerRef.current = null; }
    const SPRING = '0.32s cubic-bezier(0.34,1.3,0.64,1)';
    const newPill = newTabIdx === 0 ? 0
      : tabs[newTabIdx]==="Quarterly" ? 1
      : tabs[newTabIdx]==="Projections" ? 2 : 0;
    pillRefs.current.forEach((el, i) => {
      if(!el) return;
      el.style.transition = SPRING;
      if(i === newPill){
        el.style.transform  = 'scale(1)';
        el.style.opacity    = '1';
        el.style.background = 'rgba(255,255,255,0.78)';
        el.style.boxShadow  = '0 2px 14px rgba(60,80,180,0.12)';
      } else {
        el.style.transform  = 'scale(0.82)';
        el.style.opacity    = '0.36';
        el.style.background = 'transparent';
        el.style.boxShadow  = 'none';
      }
    });
    // Sub-pills: snap to matching sub-pane
    const newSubPill = (newTabIdx >= 1 && newTabIdx < quarterlyIdx) ? newTabIdx - 1 : -1;
    Object.entries(subPillRefs.current).forEach(([k, el]) => {
      if(!el) return;
      const i = parseInt(k);
      el.style.transition = SPRING;
      if(i === newSubPill){
        el.style.transform  = 'scale(1)';
        el.style.opacity    = '1';
        el.style.background = 'rgba(255,255,255,0.75)';
      } else {
        el.style.transform  = 'scale(0.88)';
        el.style.opacity    = '0.52';
        el.style.background = 'transparent';
      }
    });
    // After spring settles, clear inline styles so CSS class is sole authority
    pillSnapTimerRef.current = setTimeout(() => {
      pillSnapTimerRef.current = null;
      [...pillRefs.current, ...Object.values(subPillRefs.current)].forEach(el => {
        if(!el) return;
        el.style.transition = '';
        el.style.transform  = '';
        el.style.opacity    = '';
        el.style.background = '';
        el.style.boxShadow  = '';
      });
    }, 420);
  };

  const navigateTab = (t) => {
    // Pill taps: page content jumps INSTANTLY (no spring slide).
    // Only swipe gestures spring-animate the track. Pills still spring via snapPillsToTab.
    if(t === "Archive"){
      setTab("Archive"); setTabIdx(archiveIdx);
      setTrackPos(-archiveIdx * window.innerWidth, false);
      return;
    }
    if(t === "Feed"){
      setTab("Feed"); setTabIdx(feedIdx);
      setTrackPos(-feedIdx * window.innerWidth, false);
      return;
    }
    const idx = tabs.indexOf(t);
    if(idx < 0) return;
    setTab(t); setTabIdx(idx);
    setTrackPos(-idx * window.innerWidth, false);
    snapPillsToTab(idx);
  };


  // ── Pull-to-refresh (logo area) ──────────────────────────────
  const onLogoPullStart = (e) => {
    if(syncing) return;
    pullRef.current = {active:true, startY:e.touches[0].clientY, triggered:false};
  };
  const onLogoPullMove = (e) => {
    const p = pullRef.current;
    if(!p.active) return;
    const dy = e.touches[0].clientY - p.startY;
    if(dy <= 0){ setPullY(0); return; }
    setPullY(Math.min(dy * 0.45, 50));
    if(dy > PULL_THRESHOLD && !p.triggered){
      p.triggered = true;
      if(navigator.vibrate) navigator.vibrate([8, 40, 12]); // haptic "pop"
    }
  };
  const onLogoPullEnd = () => {
    const p = pullRef.current;
    if(!p.active) return;
    p.active = false;
    if(p.triggered) sync();
    setPullY(0);
  };

  const onTouchStart = (e) => {
    if(tabIdx > feedIdx) return; // block swipe navigation from Archive pane and beyond
    // Kill any running spring immediately so it doesn't fight with touch tracking
    if(springRef.current){ cancelAnimationFrame(springRef.current); springRef.current = null; }
    const d = drag.current;
    d.active = true; d.axis = null;
    d.startX = d.lastX = e.touches[0].clientX;
    d.startY = e.touches[0].clientY;
    d.velocityX = 0; d.lastTime = Date.now();
    const el = trackRef.current; if(el) el.style.transition = "none";
  };

  const onTouchMove = (e) => {
    const d = drag.current;
    if(!d.active) return;
    const dx = e.touches[0].clientX - d.startX;
    const dy = e.touches[0].clientY - d.startY;
    if(!d.axis){
      // Lock axis quickly — first 4px of clear directional movement wins
      if(Math.abs(dx) < 4 && Math.abs(dy) < 4) return;
      d.axis = Math.abs(dx) >= Math.abs(dy) ? "x" : "y";
    }
    if(d.axis !== "x") return;
    // touch-action:pan-y handles preventing browser scroll; this is kept for older browsers
    e.preventDefault();
    const now = Date.now(); const dt = now - d.lastTime;
    if(dt > 0) d.velocityX = (e.touches[0].clientX - d.lastX) / dt; // px/ms
    d.lastTime = now; d.lastX = e.touches[0].clientX;
    const base = -tabIdx * window.innerWidth;
    // Right-swipe on Portfolio → drawer gesture (slight pull feel)
    const atStart = (tabIdx===0 || tabIdx===feedIdx) && dx>0;  // Portfolio or Feed: right → drawer
    const atEnd   = tabIdx===tabs.length-1 && dx<0;
    // Truly blocked: sub-pane boundary exits — no navigation possible
    const trulyBlocked = (isSubPane && tabIdx===1 && dx>0)
                      || (isSubPane && tabIdx===quarterlyIdx-1 && dx<0);
    // Skip-nav: Portfolio↔Quarterly jumps — allow visible drag feedback
    const skipNav = (tabIdx===0 && dx<0) || (tabs[tabIdx]==="Quarterly" && dx>0);
    // Feed pane: block left swipe (nothing to the right)
    const feedLeftBlock = tabIdx===feedIdx && dx<0;
    const clampedDx = atStart        ? Math.min(dx * 0.35, 55)             // drawer pull
                    : atEnd          ? Math.max(dx * 0.06, -16)
                    : feedLeftBlock  ? Math.max(dx * 0.08, -12)
                    : trulyBlocked   ? (dx > 0 ? Math.min(dx*0.1,18) : Math.max(dx*0.1,-18))
                    : skipNav        ? (dx > 0 ? Math.min(dx*0.35,70) : Math.max(dx*0.35,-70))
                    : dx;
    setTrackPos(base + clampedDx, false);
    animatePillsDrag(dx, clampedDx);
  };

  const onTouchEnd = () => {
    const d = drag.current;
    if(!d.active) return;
    d.active = false;
    dragPillOffsets.current = null;
    if(d.axis !== "x"){ setTrackPos(-tabIdx*window.innerWidth, true); snapPillsToTab(tabIdx); return; }
    const dx = d.lastX - d.startX;
    const vel = d.velocityX || 0; // px/ms — positive = moving right
    const vw = window.innerWidth;
    const isFlick = Math.abs(vel) > 0.70; // very fast flick → instant snap (no spring)
    // A swipe "passes" if it crossed distance threshold OR was a fast flick
    const passLeft  = dx < -vw*0.18 || vel < -0.35;
    const passRight = dx >  vw*0.18 || vel >  0.35;

    // ── Feed pane: right-swipe opens drawer ──
    if(tabIdx === feedIdx){
      if(passRight){ setShowDrawer(true); }
      setTrackPos(-feedIdx*vw, true, vel);
      snapPillsToTab(feedIdx);
      return;
    }

    // ── Portfolio overview (tab 0) ──
    if(tabIdx === 0){
      if(dx > 55 || (vel > 0.35 && dx > 10)){ // right-swipe → open drawer
        setShowDrawer(true);
        setTrackPos(0, false);
        snapPillsToTab(0);
        return;
      }
      if(passLeft){ // left-swipe → jump to Quarterly (skip sub-panes)
        const qIdx = tabs.indexOf("Quarterly");
        setTab("Quarterly"); setTabIdx(qIdx);
        setTrackPos(-qIdx * vw, false); // instant skip
        snapPillsToTab(qIdx);
        return;
      }
      setTrackPos(0, true, vel); snapPillsToTab(0);
      return;
    }

    // ── Sub-pane (Airbnb, Pierce, etc.) ──
    if(isSubPane){
      let next = tabIdx;
      if(passLeft  && tabIdx < quarterlyIdx-1) next = tabIdx+1;
      if(passRight && tabIdx > 1)              next = tabIdx-1;
      setTab(tabs[next]); setTabIdx(next);
      setTrackPos(-next*vw, next===tabIdx||!isFlick, vel);
      snapPillsToTab(next);
      return;
    }

    // ── Quarterly ──
    if(tabs[tabIdx]==="Quarterly"){
      if(passRight){ // right-swipe → back to Portfolio overview (skip sub-panes)
        setTab("Portfolio"); setTabIdx(0);
        setTrackPos(0, false); // instant
        snapPillsToTab(0);
        return;
      }
      if(passLeft && tabIdx < tabs.length-1){ // left → Projections
        const next = tabIdx+1;
        setTab(tabs[next]); setTabIdx(next);
        setTrackPos(-next*vw, !isFlick, vel);
        snapPillsToTab(next);
        return;
      }
      setTrackPos(-tabIdx*vw, true, vel); snapPillsToTab(tabIdx);
      return;
    }

    // ── All other tabs (Projections, custom props after Projections) ──
    let next = tabIdx;
    if(passLeft  && tabIdx < tabs.length-1) next = tabIdx+1;
    if(passRight && tabIdx > 0)             next = tabIdx-1;
    setTab(tabs[next] !== undefined ? tabs[next] : tab); setTabIdx(next);
    setTrackPos(-next*vw, next===tabIdx||!isFlick, vel);
    snapPillsToTab(next);
  };
  const [txs, setTxs]           = useState(()=>LS.get(TX_KEY)||[]);
  const [tags, setTags]         = useState(()=>LS.get(TAGS_KEY)||{});
  const [autoTags, setAutoTags]   = useState(()=>LS.get(AUTO_KEY)||DEFAULT_AUTO);
  const [rules, setRules]         = useState({}); // payee→propId persistent rules
  const [settings, setSettings]   = useState({darkMode:false,notifications:true});
  const [showSettings, setShowSettings] = useState(false);
  const [showDrawer, setShowDrawer]     = useState(false);
  // Auto-expand Homes when drawer opens while on a property sub-pane
  useEffect(()=>{ if(showDrawer && isPortfolioGroup && tabIdx!==0) setDrawerHomesExpanded(true); },[showDrawer]);
  const [rulePrompt, setRulePrompt]     = useState(null); // {txId, payee, propId}
  const [tagging, setTagging]   = useState(null);
  const [linked, setLinked]     = useState([]);
  const [syncing, setSyncing]   = useState(false);
  // status replaced by addToast
  const [linking, setLinking]   = useState(false);
  const [invest, setInvest]     = useState(()=>LS.get(INVEST_KEY)||DEFAULT_INVEST);
  // Manual income starts empty — user fills via ✎ button in nav
  // Previously-saved entries persist in localStorage
  const [manualIncome, setManualIncome] = useState(()=>LS.get(MANUAL_KEY)||{});
  const [showManual, setShowManual] = useState(false);
  const [showInvest, setShowInvest] = useState(false);
  const [feedFilter, setFeedFilter] = useState("untagged");
  const [txFilter, setTxFilter] = useState("all");
  const [airbnbTxFilter, setAirbnbTxFilter] = useState("all");
  const [drillDown, setDrillDown] = useState(null); // {mo:"2025-11", type:"rev"|"exp"|"net", txs:[]}
  const [pierceTxFilter, setPierceTxFilter] = useState("all");

  useEffect(()=>{
    // Load bank connections
    fetch(`${BACKEND}/api/link-status`).then(r=>r.json()).then(d=>setLinked(d.accounts||[])).catch(()=>{});
    // Load server-side transactions (authoritative, deduplicated)
    fetch(`${BACKEND}/api/transactions/all`).then(r=>r.json()).then(data=>{
      if(data.transactions&&data.transactions.length>0){
        const arr=[...data.transactions].sort((a,b)=>b.date.localeCompare(a.date));
        setTxs(arr);
        LS.set(TX_KEY,arr);
      }
      setInitialLoad(false);
    }).catch(()=>{ setInitialLoad(false); });
    // Load tags from server — server wins; migrate localStorage to server if server is empty
    fetch(`${BACKEND}/api/tags`).then(r=>r.json()).then(data=>{
      if(data.tags&&Object.keys(data.tags).length>0){
        setTags(data.tags); LS.set(TAGS_KEY,data.tags);
      } else {
        const local=LS.get(TAGS_KEY)||{};
        if(Object.keys(local).length>0)
          fetch(`${BACKEND}/api/tags`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tags:local})}).catch(()=>{});
      }
    }).catch(()=>{});
    // Load manual income from server — same pattern
    // Load rules
    fetch(`${BACKEND}/api/rules`).then(r=>r.json()).then(data=>{
      if(data.rules && Object.keys(data.rules).length>0){
        setRules(data.rules);
        const merged = {...(LS.get(AUTO_KEY)||DEFAULT_AUTO), ...data.rules};
        setAutoTags(merged);
        LS.set(AUTO_KEY, merged);
      }
    }).catch(()=>{});
    // Load settings
    fetch(`${BACKEND}/api/settings`).then(r=>r.json()).then(data=>{
      if(data.settings) setSettings(s=>({...s,...data.settings}));
    }).catch(()=>{});

    fetch(`${BACKEND}/api/manual-income`).then(r=>r.json()).then(data=>{
      if(data.manual&&Object.keys(data.manual).length>0){
        setManualIncome(data.manual); LS.set(MANUAL_KEY,data.manual);
      } else {
        const local=LS.get(MANUAL_KEY)||{};
        if(Object.keys(local).length>0)
          fetch(`${BACKEND}/api/manual-income`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({manual:local})}).catch(()=>{});
      }
    }).catch(()=>{});

    // Auto-sync daily at 7am — checks every minute if it's time
    const LAST_SYNC_KEY = "pg_last_auto_sync";
    const scheduleAutoSync = () => {
      const now = new Date();
      const lastSync = parseInt(localStorage.getItem(LAST_SYNC_KEY)||"0");
      const lastSyncDate = new Date(lastSync);
      // Check if we haven't synced today at 6am yet
      const todayAt7 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 6, 0, 0);
      const shouldSync = now >= todayAt7 && lastSyncDate < todayAt7;
      if(shouldSync){
        console.log("Auto-sync: running daily 6am sync");
        localStorage.setItem(LAST_SYNC_KEY, Date.now().toString());
        fetch(`${BACKEND}/api/transactions/sync`).then(r=>r.json()).then(data=>{
          if(!data.error){
            fetch(`${BACKEND}/api/transactions/all`).then(r=>r.json()).then(d=>{
              if(d.transactions?.length>0){
                const arr=[...d.transactions].sort((a,b)=>b.date.localeCompare(a.date));
                setTxs(arr); LS.set(TX_KEY,arr);
              }
            }).catch(()=>{});
          }
        }).catch(()=>{});
      }
    };
    scheduleAutoSync(); // check immediately on load
    const ticker = setInterval(scheduleAutoSync, 60*1000); // check every minute
    return () => clearInterval(ticker);
  },[]);

  // Auto-tag: record suggestions only — user must confirm via Feed
  const applyAuto = useCallback((newTxs,at,cur)=>{
    // NO auto-application — just return existing tags unchanged
    // Auto-tag suggestions shown in Feed but not applied until user clicks
    return cur;
  },[]);

  // Get auto-tag suggestion for a tx (used in Feed to show hint)
  const getSuggestion = useCallback((tx)=>{
    if(tags[tx.id]) return null;
    const key=Object.keys(autoTags).find(k=>tx.payee?.toUpperCase().includes(k.toUpperCase()));
    return key ? autoTags[key] : null;
  },[tags,autoTags]);

  // Load all server-stored transactions (deduplicated server-side)
  const loadAll = useCallback(async(silent=false)=>{
    try {
      const res=await fetch(`${BACKEND}/api/transactions/all`);
      const data=await res.json();
      if(data.error) return;
      const arr=[...data.transactions].sort((a,b)=>b.date.localeCompare(a.date));
      setTxs(arr);
      LS.set(TX_KEY,arr);
      setTags(prev=>{ const u=applyAuto(arr,autoTags,prev); serverSaveTags(u); return u; });
      if(!silent){ addToast("Loaded "+arr.length+" transactions","success"); setInitialLoad(false); }
    } catch(e){ if(!silent) addToast("Load failed: "+e.message,"error"); }
  },[autoTags,applyAuto]);

  const sync = useCallback(async()=>{
    setSyncing(true);
    try {
      const res=await fetch(`${BACKEND}/api/transactions/sync`);
      const data=await res.json();
      if(data.error) throw new Error(data.error);
      await loadAll(true);
      const ts = new Date().toISOString(); setLastSync(ts); LS.set(LAST_SYNC_KEY,ts);
      addToast("Synced · "+data.total_stored+" transactions","success");
      setSyncDone(true); setTimeout(()=>setSyncDone(false),1800);
    } catch(e){
      addToast("Sync failed: "+e.message,"error");
      setShakeTarget("sync"); setTimeout(()=>setShakeTarget(null),500);
    }
    finally{setSyncing(false);}
  },[loadAll]);

  const pullHistory = useCallback(async()=>{
    setSyncing(true); addToast("Pulling full history…","info");
    try {
      const res=await fetch(`${BACKEND}/api/transactions/historical`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});
      const data=await res.json();
      if(data.errors&&data.errors.length) addToast("Done with errors: "+data.errors[0],"error");
      await loadAll(true);
      const ts = new Date().toISOString(); setLastPull(ts); LS.set(LAST_PULL_KEY,ts);
      addToast("✓ "+data.total_stored+" transactions loaded","success");
    } catch(e){addToast("History pull failed","error");}
    finally{setSyncing(false);}
  },[loadAll]);

  const connectBank=useCallback(async()=>{
    setLinking(true);
    try {
      const {link_token,error}=await fetch(`${BACKEND}/api/create-link-token`,{method:"POST"}).then(r=>r.json());
      if(error) throw new Error(error);
      window.Plaid.create({
        token:link_token,
        onSuccess:async(public_token,meta)=>{
          const name=meta?.institution?.name||"Bank Account";
          const ex=await fetch(`${BACKEND}/api/exchange-token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({public_token,account_name:name})}).then(r=>r.json());
          const ls=await fetch(`${BACKEND}/api/link-status`).then(r=>r.json());
          setLinked(ls.accounts||[]);
          // Pull 2 years of history immediately — this is what gets years of data like Copilot
          addToast(name+" connected — pulling history…","info");
          try {
            const hr=await fetch(`${BACKEND}/api/transactions/historical`,{
              method:"POST",headers:{"Content-Type":"application/json"},
              body:JSON.stringify({item_id:ex.item_id})
            }).then(r=>r.json());
            await loadAll(true);
            // Also run sync to catch anything from last 90 days not in historical
            await fetch(`${BACKEND}/api/transactions/sync`).then(r=>r.json());
            await loadAll(true);
            addToast("✓ "+name+" — "+(hr.total_stored||0)+" transactions loaded","success");
          } catch(e) {
            addToast(name+" connected. Hit Sync to load transactions.","info");
          }
        },
        onExit:err=>{if(err)addToast("Exited: "+err.display_message,"error");}
      }).open();
    } catch(e){addToast("Could not open Plaid: "+e.message,"error");}
    finally{setLinking(false);}
  },[sync]);

  const removeAccount=async(item_id)=>{
    await fetch(`${BACKEND}/api/remove-account`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item_id})});
    setLinked(prev=>prev.filter(a=>a.item_id!==item_id));
  };

  function doTag(txId, propId){
    const tx = txs.find(t=>t.id===txId);
    // Tag this transaction immediately
    const nextTags = {...tags, [txId]: propId};
    setTags(nextTags); serverSaveTags(nextTags); setTagging(null);
    // If payee is meaningful, show Copilot-style "apply to all?" prompt
    if(tx?.payee && propId!=="transfer" && propId!=="deleted"){
      const existingRule = rules[tx.payee.toUpperCase()];
      if(existingRule !== propId){
        // Slight delay so tag UI closes first
        setTimeout(()=>setRulePrompt({txId, payee:tx.payee, propId}), 150);
      }
    }
  }

  function applyRule(payee, propId, applyAll){
    const key = payee.toUpperCase();
    const nextAuto = {...autoTags, [key]: propId};
    const nextRules = {...rules, [key]: propId};
    setAutoTags(nextAuto); LS.set(AUTO_KEY, nextAuto);
    setRules(nextRules);
    fetch(`${BACKEND}/api/rules`,{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({rules:nextRules})}).catch(()=>{});
    if(applyAll){
      // Tag all untagged transactions with same payee
      const nextTags = {...tags};
      txs.forEach(t=>{
        if(!nextTags[t.id] && t.payee?.toUpperCase()===key) nextTags[t.id]=propId;
      });
      setTags(nextTags); serverSaveTags(nextTags);
    }
    setRulePrompt(null);
  }

  function doDelete(txId){
    // Soft-delete: tag as "deleted" so it stays visible in the archive
    const nextTags={...tags,[txId]:"deleted"};
    setTags(nextTags); serverSaveTags(nextTags); setTagging(null);
  }

  function doRestore(txId){
    const nextTags={...tags}; delete nextTags[txId];
    setTags(nextTags); serverSaveTags(nextTags);
  }

  function doBulkTag(ids, propId){
    const nextTags={...tags};
    ids.forEach(id=>{ nextTags[id]=propId; });
    setTags(nextTags); serverSaveTags(nextTags);
  }

  function doBulkDelete(ids){
    const nextTags={...tags};
    ids.forEach(id=>{ nextTags[id]="deleted"; });
    setTags(nextTags); serverSaveTags(nextTags);
  }

  const saveInvest=vals=>{ setInvest(vals); LS.set(INVEST_KEY,vals); };

  const saveCustomProp = p => {
    const next=[...customProps,p]; setCustomProps(next); LS.set(CUSTOM_PROPS_KEY,next); setShowAddProp(false);
  };
  const deleteCustomProp = id => {
    const newTags={...tags};
    Object.keys(newTags).forEach(k=>{ if(newTags[k]===id) delete newTags[k]; });
    setTags(newTags); serverSaveTags(newTags);
    const next=customProps.filter(p=>p.id!==id); setCustomProps(next); LS.set(CUSTOM_PROPS_KEY,next);
  };

  // Server sync — write to localStorage AND server. localStorage = instant fallback if server fails.
  const serverSaveTags = useCallback((nextTags) => {
    LS.set(TAGS_KEY, nextTags);
    fetch(`${BACKEND}/api/tags`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tags:nextTags})}).catch(()=>{});
  },[]);

  const saveManual = vals => {
    setManualIncome(vals);
    LS.set(MANUAL_KEY, vals);
    fetch(`${BACKEND}/api/manual-income`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({manual:vals})}).catch(()=>{});
  };

  // Deduplicate by id — Plaid can return the same transaction more than once
  const allEnriched=useMemo(()=>{
    const seen=new Set();
    return txs.filter(t=>!t.pending).filter(t=>{
      if(seen.has(t.id)) return false;
      seen.add(t.id);
      return true;
    }).map(tx=>({...tx,propId:tags[tx.id]||null}));
  },[txs,tags]);
  // Active = not deleted or transferred (for all normal financial calcs)
  const enriched = allEnriched.filter(t=>t.propId!=="deleted");
  const archived  = allEnriched.filter(t=>t.propId==="deleted"||t.propId==="transfer");
  const untagged  = enriched.filter(t=>!t.propId);
  const tagged    = enriched.filter(t=>t.propId&&t.propId!=="transfer");

  // ── Metrics ──────────────────────────────────────────────
  const M=useMemo(()=>{
    const forProp=id=>tagged.filter(t=>t.propId===id);
    const propM={};
    PROPERTIES.forEach(p=>{
      const ptxs=forProp(p.id);
      const rev=sumIn(ptxs), exp=sumOut(ptxs);
      propM[p.id]={rev,exp,cf:rev-exp,txs:ptxs};
    });

    // Manual income OVERRIDES Plaid for that month — no double counting
    // Build set of months that have manual entries
    const manualMonths = new Set(Object.keys(manualIncome).filter(k=>manualIncome[k]>0));
    // Plaid airbnb rev — exclude any month covered by manual entry
    const airbnbRevPlaid = AIRBNB_IDS.reduce((s,id)=>{
      const ptxs = propM[id].txs || [];
      return s + ptxs.filter(t=>t.type==="in"&&!manualMonths.has(t.date?.slice(0,7))).reduce((a,t)=>a+Math.abs(t.amount),0);
    }, 0);
    const manualAirbnbRev = Object.values(manualIncome).reduce((s,v)=>s+(v||0),0);
    const airbnbRev = airbnbRevPlaid + manualAirbnbRev;
    const airbnbExp=AIRBNB_IDS.reduce((s,id)=>s+propM[id].exp,0);
    const pierceRev=propM.pierce.rev, pierceExp=propM.pierce.exp;
    const llcExp   =propM.llc.exp;
    const totalRev =airbnbRev+pierceRev;
    const totalExp =airbnbExp+pierceExp+llcExp;
    const totalCF  =totalRev-totalExp;

    // Monthly data — use ALL non-transfer enriched txs + manual income entries
    const months = (() => {
      const seen = new Set();
      const mo={};
      enriched.filter(t=>t.propId!=="transfer").forEach(t=>{
        if(seen.has(t.id)) return;
        seen.add(t.id);
        const k=t.date?.slice(0,7)||"?";
        if(!mo[k])mo[k]={rev:0,exp:0,manual:false};
        if(t.type==="in")  mo[k].rev+=Math.abs(t.amount);
        if(t.type==="out") mo[k].exp+=Math.abs(t.amount);
      });
      // Manual income OVERRIDES Airbnb Plaid rev for that month only
      // Pierce revenue is already in mo[k].rev — we keep it, just swap out airbnb portion
      Object.entries(manualIncome).forEach(([k,v])=>{
        if(!v) return;
        if(!mo[k])mo[k]={rev:0,exp:0,airbnbRev:0,manual:true};
        // Subtract airbnb plaid rev for this month (already counted above), add manual
        const airbnbPlaidForMonth = AIRBNB_IDS.reduce((s,id)=>{
          return s + (propM[id]?.txs||[]).filter(t=>t.type==="in"&&t.date?.slice(0,7)===k).reduce((a,t)=>a+Math.abs(t.amount),0);
        },0);
        mo[k].rev = (mo[k].rev - airbnbPlaidForMonth) + v;
        mo[k].manual=true;
      });
      return Object.entries(mo).sort((a,b)=>a[0].localeCompare(b[0]));
    })();

    const moCount = Math.max(months.length, 1);
    const annualRev = (totalRev/moCount)*12;
    const annualExp = (totalExp/moCount)*12;

    // Real estate metrics
    const totalInvest = Object.values(invest).reduce((s,v)=>s+v,0);
    const netMargin   = totalRev>0?(totalCF/totalRev)*100:null;
    const cocReturn   = totalInvest>0?(totalCF/totalInvest)*100:null;
    const annualCoc   = totalInvest>0?((totalCF/moCount*12)/totalInvest)*100:null;

    // Per-property CoC
    const propCoc={};
    ["lockwood","everton","bstreet","pierce"].forEach(id=>{ // per-property CoC only
      const inv=invest[id]||0;
      propCoc[id]=inv>0?(propM[id].cf/inv)*100:null;
    });

    // ── Quarterly aggregation ────────────────────────────────────
    const quarters = (() => {
      const qmap = {};
      enriched.filter(t=>t.propId!=="transfer"&&t.date).forEach(t=>{
        const [yr,mo] = t.date.split("-");
        const q = Math.ceil(+mo/3);
        const key = `${yr}-Q${q}`;
        if(!qmap[key]) qmap[key]={label:`Q${q} '${yr.slice(2)}`,year:+yr,q,key,rev:0,exp:0,txCount:0};
        if(t.type==="in")  qmap[key].rev += Math.abs(t.amount);
        if(t.type==="out") qmap[key].exp += Math.abs(t.amount);
        qmap[key].txCount++;
      });
      return Object.values(qmap)
        .sort((a,b)=>a.year!==b.year?a.year-b.year:a.q-b.q)
        .map(q=>({...q, net:q.rev-q.exp, margin:q.rev>0?((q.rev-q.exp)/q.rev)*100:0, expRatio:q.rev>0?(q.exp/q.rev)*100:0}));
    })();

    // Monthly seasonal projections for rest of FY26
    // STR seasonality index by month (1.0 = average) — peaks summer/holidays, dips Jan-Feb
    const STR_SEASONAL = {
      "01":0.72,"02":0.75,"03":0.90,"04":1.00,"05":1.10,
      "06":1.18,"07":1.22,"08":1.20,"09":1.05,"10":1.02,
      "11":0.95,"12":1.08
    };
    const today = new Date();
    const currentMoKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    // Compute monthly avg from actual data (airbnb only, last 6 months with data)
    const actualAirbnbMonths = months.filter(([k])=>k<=currentMoKey&&k>="2025-01");
    const avgAirbnbRev = actualAirbnbMonths.length>0
      ? actualAirbnbMonths.reduce((s,[,v])=>s+(v.rev||0),0)/actualAirbnbMonths.length
      : airbnbRev/Math.max(moCount,1);
    const avgAirbnbExp = actualAirbnbMonths.length>0
      ? actualAirbnbMonths.reduce((s,[,v])=>s+(v.exp||0),0)/actualAirbnbMonths.length
      : airbnbExp/Math.max(moCount,1);
    // Pierce is flat — use actual monthly avg
    const avgPierceRev = pierceRev/Math.max(moCount,1);
    const avgPierceExp = pierceExp/Math.max(moCount,1);
    // Build projected months for rest of 2026
    const projMonths = [];
    for(let m=1;m<=12;m++){
      const key=`2026-${String(m).padStart(2,'0')}`;
      if(key<=currentMoKey) continue; // skip months that already have actual data
      const si = STR_SEASONAL[String(m).padStart(2,'0')]||1.0;
      const projAirbnbRev = avgAirbnbRev * si;
      const projPierceRev = avgPierceRev;
      const projExp = (avgAirbnbExp * si) + avgPierceExp;
      projMonths.push([key,{rev:projAirbnbRev+projPierceRev, exp:projExp, projected:true}]);
    }
    // Combine actual + projected for full-year chart view
    const monthsWithProjections = [...months, ...projMonths];
    // 5-year annual projections (for table)
    const currentYear=new Date().getFullYear();
    const annualBase = (avgAirbnbRev+avgPierceRev)*12;
    const annualExpBase = (avgAirbnbExp+avgPierceExp)*12;
    const projections=Array.from({length:6},(_,i)=>{
      const yr=currentYear+i;
      const rev=annualBase*Math.pow(1.03,i);
      const exp=annualExpBase*Math.pow(1.02,i);
      return {year:yr,rev,exp,net:rev-exp,margin:rev>0?((rev-exp)/rev)*100:0};
    });

    // Quarterly projections — seasonal index by quarter
    const Q_SEASONAL = {"1":0.79,"2":1.09,"3":1.16,"4":1.02};
    const curQtr = Math.ceil((today.getMonth()+1)/3);
    const curQKey = `${today.getFullYear()}-Q${curQtr}`;
    const actualQtrs = quarters.filter(q=>q.key<=curQKey);
    const avgQRev = actualQtrs.length>0 ? actualQtrs.reduce((s,q)=>s+q.rev,0)/actualQtrs.length : 0;
    const avgQExp = actualQtrs.length>0 ? actualQtrs.reduce((s,q)=>s+q.exp,0)/actualQtrs.length : 0;
    const projQuarters = [];
    for(let yr=today.getFullYear();yr<=today.getFullYear()+1;yr++){
      for(let q=1;q<=4;q++){
        const key=`${yr}-Q${q}`;
        if(key<=curQKey||quarters.find(x=>x.key===key)) continue;
        const si=Q_SEASONAL[q.toString()]||1;
        const growth=Math.pow(1.03,yr-today.getFullYear());
        const rev=avgQRev*si*growth, exp=avgQExp*si*Math.pow(1.02,yr-today.getFullYear());
        projQuarters.push({key,label:`Q${q} '${yr.toString().slice(2)}`,year:yr,q,rev,exp,net:rev-exp,margin:rev>0?((rev-exp)/rev)*100:0,projected:true});
      }
    }
    const quartersWithProjections=[...quarters,...projQuarters];

    return {propM,airbnbRev,airbnbExp,airbnbCF:airbnbRev-airbnbExp,pierceRev,pierceExp,pierceCF:pierceRev-pierceExp,llcExp,totalRev,totalExp,totalCF,netMargin,cocReturn,annualCoc,propCoc,months,monthsWithProjections,moCount,projections,annualRev,annualExp,quarters,quartersWithProjections};
  },[tagged,enriched,invest,manualIncome]);

  const hasBank=linked.length>0||txs.length>0; // show content if we have txs even if linked state not yet resolved

  const clearAllData = () => {
    if(!window.confirm("Clear all cached transactions and tags? This cannot be undone.")) return;
    LS.set(TX_KEY, []); LS.set(TAGS_KEY, {}); LS.set(AUTO_KEY, {}); LS.set(MANUAL_KEY, {});
    setTxs([]); setTags({}); setAutoTags({}); setManualIncome({});
    // Also clear from server
    fetch(`${BACKEND}/api/transactions/delete`, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:"__ALL__"})}).catch(()=>{});
    addToast("All local data cleared","info");
  };
  // Tabs: Portfolio | Airbnb | Pierce | Feed | Archive
  const feedTxs = feedFilter==="untagged"?untagged:feedFilter==="tagged"?tagged:enriched;

  // Tab icons
  const TAB_ICONS = {
    "Portfolio": <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>,
    "Airbnb":    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
    "Pierce":    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><circle cx="12" cy="13" r="2"/></svg>,
    "Feed":      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
    "Quarterly":  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    "Projections":<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
    "Archive":   <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5" rx="1"/><line x1="10" y1="12" x2="14" y2="12"/></svg>,
  };

  return (
    <div style={{minHeight:"100vh",background:"transparent"}}>

      {/* TOP HEADER — minimal 3-slot */}
      <div className="top-header" ref={headerRef} style={{position:"relative",justifyContent:"space-between"}}>
        {/* Left: hamburger */}
        <button onClick={()=>setShowDrawer(true)} style={{background:"transparent",border:"none",color:"var(--text-2)",padding:"6px 8px",borderRadius:8,cursor:"pointer",display:"flex",alignItems:"center",fontSize:22,lineHeight:1,zIndex:1,flexShrink:0}}>☰</button>
        {/* Center: logo — pull-to-refresh target */}
        <div
          onTouchStart={onLogoPullStart}
          onTouchMove={onLogoPullMove}
          onTouchEnd={onLogoPullEnd}
          style={{position:"absolute",left:"50%",transform:`translateX(-50%) translateY(${pullY * 0.4}px)`,display:"flex",alignItems:"center",gap:7,cursor:"default",userSelect:"none",transition:pullRef.current.active?"none":"transform 0.3s ease"}}>
          <svg width="22" height="22" viewBox="0 0 32 32" fill="none"><ellipse cx="16" cy="13" rx="8" ry="7" fill="rgba(255,255,255,0.92)"/><ellipse cx="16" cy="13" rx="5" ry="4.5" fill="#06091a"/><circle cx="16" cy="13" r="2" fill="rgba(255,255,255,0.92)"/><path d="M12 19c0 0-4 3-4 7h16c0-4-4-7-4-7" fill="rgba(255,255,255,0.92)"/></svg>
          <span style={{fontWeight:700,fontSize:15,letterSpacing:"-0.01em"}}>Property Pigeon</span>
        </div>
        {/* Right: spacer */}
        <div style={{width:40,flexShrink:0}}/>
      </div>
      {/* Sync spinner — floats below header when active */}
      {(syncing||syncDone)&&(
        <div className="sync-spinner-wrap" style={{top:(headerRef.current?.offsetHeight||56)+8}}>
          {syncDone
            ? <svg width="20" height="20" viewBox="0 0 20 20" fill="none"
                stroke="var(--green)" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round">
                <polyline points="3,10 8.5,15.5 17,5" className="check-path"/>
              </svg>
            : <div className="sync-spinner"/>}
        </div>
      )}
      {/* TOP NAV — 3 main pills */}
      <div className={`top-nav${isPortfolioGroup?" has-subnav":""}`} ref={navRef}>
        <div className="top-nav-track" ref={navTrackRef}>
          <button ref={el=>pillRefs.current[0]=el} className={`top-nav-pill${isPortfolioGroup?" active":""}`} onClick={()=>navigateTab("Portfolio")}>Portfolio</button>
          <button ref={el=>pillRefs.current[1]=el} className={`top-nav-pill${tabs[tabIdx]==="Quarterly"?" active":""}`} onClick={()=>navigateTab("Quarterly")}>Quarterly</button>
          <button ref={el=>pillRefs.current[2]=el} className={`top-nav-pill${tabs[tabIdx]==="Projections"?" active":""}`} onClick={()=>navigateTab("Projections")}>Projections</button>
        </div>
      </div>
      {/* SUB NAV — property pills, visible while in Portfolio group */}
      {isPortfolioGroup&&(
        <div className="top-sub-nav" ref={subNavRef}>
          {["Airbnb","Pierce",...customProps.filter(p=>!p.isAirbnb).map(p=>p.label)].map((t,i)=>(
            <button key={t} ref={el=>subPillRefs.current[i]=el} className={`sub-nav-pill${tabs[tabIdx]===t?" active":""}`} onClick={()=>navigateTab(t)}>
              {t}
            </button>
          ))}
        </div>
      )}

      {/* CONTENT */}
      <div className="page-outer" onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
        <div ref={trackRef} className="swipe-track" style={{transform:"translateX(0px)"}}>

        <div className="swipe-pane">
          {initialLoad ? <SkeletonPane/> :
          <div key={"portfolio-"+tabIdx} className="stagger" style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Total Portfolio</div>
              <div style={{display:"flex",alignItems:"baseline",gap:10}}>
                <AnimatedNum value={M.totalRev} format={fmt$} className="big-num"/>
                <div style={{fontSize:13,color:"var(--text-3)"}}>gross revenue</div>
              </div>
              <div style={{display:"flex",gap:16,marginTop:6}}>
                <span style={{fontSize:13,color:"#ff453a"}}>{fmt$(M.totalExp)} expenses</span>
                <span style={{fontSize:13,color:M.totalCF>=0?"#30d158":"#ff453a",fontWeight:600}}>{fmt$(M.totalCF)} net</span>
                {M.netMargin!==null&&<span style={{fontSize:13,color:"var(--text-3)"}}>{fmtPct(M.netMargin)} margin</span>}
              </div>
            </div>

            {/* Nudge to enter manual income if empty */}
            {Object.keys(manualIncome).length===0&&(
              <div style={{background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.10)",borderRadius:10,padding:"10px 14px",marginBottom:10,display:"flex",alignItems:"center",justifyContent:"space-between",gap:10}}>
                <span style={{fontSize:12,color:"var(--text-2)"}}>No Airbnb revenue entered yet — add monthly payouts to see accurate numbers</span>
                <button onClick={()=>setShowManual(true)} style={{fontSize:11,fontWeight:600,background:"#1a1a2e",color:"#fff",border:"none",borderRadius:8,padding:"5px 12px",cursor:"pointer",whiteSpace:"nowrap"}}>✎ Add Income</button>
              </div>
            )}

            {/* Summary cards */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
              {[
                {l:"Airbnb Revenue",  v:fmt$(M.airbnbRev), sub:"8 units"},
                {l:"Pierce Revenue",  v:fmt$(M.pierceRev), sub:"7 units"},
                {l:"Total Expenses",  v:fmt$(M.totalExp),  sub:"all properties", red:true},
                {l:"Net Income",      v:fmt$(M.totalCF),   sub:fmtPct(M.netMargin)+" margin", green:M.totalCF>=0},
              ].map(c=>(
                <div key={c.l} className="card card-padded">
                  <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>{c.l}</div>
                  <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                  <div style={{fontSize:11,color:"var(--text-3)",marginTop:2}}>{c.sub}</div>
                </div>
              ))}
            </div>

            {/* To Review — always visible, Copilot-style */}
            {(()=>{
              const toReview = untagged.slice(0, 8);
              const PROP_LABEL = {lockwood:"Lockwood",everton:"Everton",bstreet:"B Street",pierce:"Pierce Ave",llc:"General LLC",transfer:"Transfer"};
              const PROP_COLOR = {lockwood:"#30d158",everton:"#007aff",bstreet:"#ff9f0a",pierce:"#bf5af2",llc:"#636366",transfer:"#636366"};
              return (
                <div style={{marginBottom:16}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,paddingLeft:2}}>
                    <div style={{fontSize:11,fontWeight:700,letterSpacing:"0.08em",color:"var(--text-3)",textTransform:"uppercase"}}>
                      To Review
                      {toReview.length>0&&<span style={{marginLeft:6,background:"#007aff",color:"#fff",borderRadius:10,padding:"1px 7px",fontSize:9,fontWeight:700,verticalAlign:"middle"}}>{untagged.length}</span>}
                    </div>
                    <button onClick={()=>navigateTab("Feed")} style={{background:"none",border:"none",fontSize:12,color:"#007aff",cursor:"pointer",padding:0,fontWeight:500}}>View all ›</button>
                  </div>
                  <div className="card" style={{overflow:"hidden",borderRadius:16}}>
                    {toReview.length===0?(
                      <div style={{padding:"20px 16px",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                        <span style={{fontSize:13,color:"var(--text-3)"}}>Nothing to review — all caught up</span>
                        <button onClick={()=>navigateTab("Feed")} style={{background:"none",border:"1px solid rgba(255,255,255,0.14)",borderRadius:8,fontSize:11,fontWeight:600,color:"var(--text-3)",padding:"4px 10px",cursor:"pointer",whiteSpace:"nowrap"}}>View all transactions</button>
                      </div>
                    ):(
                      <>
                        {toReview.map((tx,i)=>{
                          const sug = getSuggestion(tx);
                          const sugColor = PROP_COLOR[sug] || "#636366";
                          return (
                            <div key={tx.id} style={{borderBottom:i<toReview.length-1?"1px solid rgba(255,255,255,0.07)":"none"}}>
                              <div onClick={()=>setTagging(t=>t===tx.id?null:tx.id)}
                                style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"13px 16px",cursor:"pointer"}}>
                                <div style={{flex:1,minWidth:0,marginRight:10}}>
                                  <div style={{fontSize:14,fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:"var(--text)"}}>{tx.payee||tx.name}</div>
                                  <div style={{display:"flex",alignItems:"center",gap:6,marginTop:4}}>
                                    <span style={{fontSize:11,color:"var(--text-3)"}}>{tx.date}</span>
                                    {sug
                                      ? <span style={{fontSize:11,fontWeight:700,color:sugColor,background:`${sugColor}18`,padding:"1px 8px",borderRadius:20,textTransform:"uppercase",letterSpacing:"0.04em"}}>{PROP_LABEL[sug]||sug}</span>
                                      : <span style={{fontSize:11,color:"#ff9f0a",fontWeight:600}}>needs tag</span>
                                    }
                                  </div>
                                </div>
                                <div style={{display:"flex",alignItems:"center",gap:7,flexShrink:0}}>
                                  <span style={{fontSize:14,fontWeight:700,color:tx.type==="in"?"#30d158":"#ff453a",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>
                                    {tx.type==="in"?"+":"-"}{fmt$(Math.abs(tx.amount))}
                                  </span>
                                  {sug ? (
                                    <button onClick={e=>{e.stopPropagation();if(navigator.vibrate)navigator.vibrate([6]);doTag(tx.id,sug);}}
                                      style={{background:"rgba(52,199,89,0.12)",border:"none",borderRadius:8,padding:"6px 10px",fontSize:13,fontWeight:700,color:"#30d158",cursor:"pointer",flexShrink:0,lineHeight:1}}>✓</button>
                                  ) : (
                                    <button onClick={e=>{e.stopPropagation();setTagging(t=>t===tx.id?null:tx.id);}}
                                      style={{background:"rgba(255,255,255,0.08)",border:"none",borderRadius:8,padding:"6px 10px",fontSize:11,fontWeight:600,color:"var(--text-3)",cursor:"pointer",flexShrink:0}}>Tag</button>
                                  )}
                                </div>
                              </div>
                              {tagging===tx.id&&(
                                <div style={{padding:"0 14px 12px",borderTop:"1px solid rgba(255,255,255,0.06)"}}>
                                  <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)} onDelete={doDelete}/>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </>
                    )}
                  </div>
                </div>
              );
            })()}

            {/* Month-by-month charts */}
            {M.months.length>0&&(<>
              <div className="section-title">Revenue · Month by Month <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>hatched = projected</span></div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="rev" color="#30d158" onBarClick={(mo)=>setDrillDown({mo,type:"rev",txs:enriched})}/>
              </div>

              <div className="section-title">Expenses · Month by Month</div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="exp" color="#ff453a" onBarClick={(mo)=>setDrillDown({mo,type:"exp",txs:enriched})}/>
              </div>

              <div className="section-title">Net Income · Month by Month</div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="net" color={null} onBarClick={(mo)=>setDrillDown({mo,type:"net",txs:enriched})}/>
              </div>

              <div className="section-title">Net Margin % · Month by Month <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>≥30% healthy · grey=marginal · red=negative</span></div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="margin" color={null} marginMode fmt={v=>`${v.toFixed(1)}%`}/>
              </div>
            </>)}



            {/* CoC return */}
            {M.annualCoc&&(
              <>
                <div className="section-title">Return on Investment</div>
                <div className="card card-padded" style={{marginBottom:8}}>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
                    {[
                      {l:"Cash-on-Cash",v:fmtPct(M.annualCoc),sub:"annualized"},
                      {l:"Net Margin",  v:fmtPct(M.netMargin), sub:"total revenue"},
                    ].map(c=>(
                      <div key={c.l}>
                        <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:3}}>{c.l}</div>
                        <div style={{fontSize:20,fontWeight:700,letterSpacing:"-0.02em"}}>{c.v}</div>
                        <div style={{fontSize:10,color:"var(--text-3)"}}>{c.sub}</div>
                      </div>
                    ))}
                  </div>
                  <button onClick={()=>setShowInvest(true)} style={{marginTop:12,fontSize:11,color:"var(--text-3)",background:"none",border:"none",cursor:"pointer",textDecoration:"underline",padding:0}}>
                    Edit down payments →
                  </button>
                </div>
              </>
            )}
            {!M.annualCoc&&(
              <button onClick={()=>setShowInvest(true)} style={{fontSize:12,color:"var(--text-3)",background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.10)",borderRadius:10,padding:"8px 14px",cursor:"pointer",marginBottom:8,display:"block"}}>
                + Add down payments to see CoC return
              </button>
            )}
          </div>
          }
        </div>

        {/* ── AIRBNB ─────────────────────────────────────────────── */}
        <div className="swipe-pane">
          <div key={"airbnb-"+tabIdx} className="stagger" style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Airbnb Portfolio · 8 units</div>
              <AnimatedNum value={M.airbnbRev} format={fmt$} className="big-num"/>
              <div style={{display:"flex",gap:16,marginTop:6,flexWrap:"wrap"}}>
                <span style={{fontSize:13,color:"#ff453a"}}>{fmt$(M.airbnbExp)} expenses</span>
                <span style={{fontSize:13,color:M.airbnbCF>=0?"#30d158":"#ff453a",fontWeight:600}}>{fmt$(M.airbnbCF)} net</span>
                {M.airbnbRev>0&&<span style={{fontSize:13,color:"var(--text-3)"}}>{fmtPct((M.airbnbCF/M.airbnbRev)*100)} margin</span>}
              </div>
            </div>

            {/* KPI cards */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
              {[
                {l:"Gross Revenue",  v:fmt$(M.airbnbRev),  green:true},
                {l:"Total Expenses", v:fmt$(M.airbnbExp),  red:true},
                {l:"Net Income",     v:fmt$(M.airbnbCF),   green:M.airbnbCF>=0, red:M.airbnbCF<0},
                {l:"Net Margin",     v:M.airbnbRev>0?fmtPct((M.airbnbCF/M.airbnbRev)*100):"—", green:M.airbnbCF>=0},
              ].map(c=>(
                <div key={c.l} className="card card-padded">
                  <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>{c.l}</div>
                  <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                </div>
              ))}
            </div>

            {/* Month-by-month charts */}
            {M.months.length>0&&(()=>{
              // Build airbnb-only months — manual OVERRIDES Plaid rev for that month
              const aMo={};
              const manualMos = new Set(Object.keys(manualIncome).filter(k=>manualIncome[k]>0));
              tagged.filter(t=>AIRBNB_IDS.includes(t.propId)).forEach(t=>{
                const k=t.date?.slice(0,7)||"?";
                if(!aMo[k])aMo[k]={rev:0,exp:0};
                // Only count Plaid rev for months NOT covered by manual entry
                if(t.type==="in"&&!manualMos.has(k)) aMo[k].rev+=Math.abs(t.amount);
                if(t.type==="out") aMo[k].exp+=Math.abs(t.amount);
              });
              Object.entries(manualIncome).forEach(([k,v])=>{
                if(!v)return;
                if(!aMo[k])aMo[k]={rev:0,exp:0};
                aMo[k].rev=v; // override, not additive
              });
              // Add seasonal projections for rest of 2026
              const today2=new Date();
              const curMo2=`${today2.getFullYear()}-${String(today2.getMonth()+1).padStart(2,'0')}`;
              const STR_SI={"01":0.72,"02":0.75,"03":0.90,"04":1.00,"05":1.10,"06":1.18,"07":1.22,"08":1.20,"09":1.05,"10":1.02,"11":0.95,"12":1.08};
              const aActual=Object.entries(aMo).filter(([k])=>k<=curMo2);
              const aAvgRev=aActual.length>0?aActual.reduce((s,[,v])=>s+v.rev,0)/aActual.length:0;
              const aAvgExp=aActual.length>0?aActual.reduce((s,[,v])=>s+v.exp,0)/aActual.length:0;
              for(let m=1;m<=12;m++){
                const k=`2026-${String(m).padStart(2,'0')}`;
                if(k<=curMo2||aMo[k]) continue;
                const si=STR_SI[String(m).padStart(2,'0')]||1;
                aMo[k]={rev:aAvgRev*si,exp:aAvgExp*si,projected:true};
              }
              const aMths=Object.entries(aMo).sort((a,b)=>a[0].localeCompare(b[0]));
              if(aMths.length===0) return null;
              return (
                <>
                  <div className="section-title">Revenue · Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="rev" color="#30d158" onBarClick={(mo)=>setDrillDown({mo,type:"rev",txs:enriched.filter(t=>AIRBNB_IDS.includes(t.propId)||(!t.propId&&t.type==="in"))})}/></div>
                  <div className="section-title">Expenses · Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="exp" color="#ff453a" onBarClick={(mo)=>setDrillDown({mo,type:"exp",txs:enriched.filter(t=>AIRBNB_IDS.includes(t.propId))})}/></div>
                  <div className="section-title">Net Income · Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="net" color={null} onBarClick={(mo)=>setDrillDown({mo,type:"net",txs:enriched.filter(t=>AIRBNB_IDS.includes(t.propId)||(!t.propId&&t.type==="in"))})}/></div>
                  <div className="section-title">Net Margin % · Month by Month <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>≥30% healthy · grey=ok · red=negative</span></div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="margin" color={null} marginMode fmt={v=>`${v.toFixed(1)}%`}/></div>
                </>
              );
            })()}

            {/* Per-property EXPENSES only (revenue comes in as lump sum, can't split) */}
            <div className="section-title">Expenses by Property</div>
            <div className="card" style={{marginBottom:8,overflow:"hidden"}}>
              <div style={{display:"grid",gridTemplateColumns:"1fr auto",padding:"8px 16px",borderBottom:"1px solid rgba(255,255,255,0.07)",gap:8}}>
                <span style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em"}}>Property</span>
                <span style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",textAlign:"right"}}>Expenses</span>
              </div>
              {["lockwood","everton","bstreet"].map((id,i)=>{
                const pm=M.propM[id]; const p=PROPERTIES.find(x=>x.id===id);
                const pct=M.airbnbExp>0?(pm.exp/M.airbnbExp)*100:0;
                return (
                  <div key={id} style={{padding:"12px 16px",borderBottom:i<2?"1px solid rgba(255,255,255,0.07)":"none"}}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:5}}>
                      <span style={{fontSize:13,fontWeight:600}}>{p.label}</span>
                      <span style={{fontSize:13,color:"#ff453a",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:600}}>{fmt$(pm.exp)}</span>
                    </div>
                    <div style={{height:3,background:"rgba(255,255,255,0.08)",borderRadius:2,overflow:"hidden"}}>
                      <div style={{height:"100%",width:`${pct}%`,background:"#ff453a",borderRadius:2}}/>
                    </div>
                    <div style={{fontSize:10,color:"var(--text-3)",marginTop:3}}>{pct.toFixed(0)}% of total Airbnb expenses</div>
                  </div>
                );
              })}
            </div>

            {/* Transactions — unified All/In/Out */}
            <div className="section-title">Transactions</div>
            <TxList
              txs={enriched.filter(t=>AIRBNB_IDS.includes(t.propId)||(t.type==="in"&&!t.propId)||(t.type==="out"&&!t.propId))}
              tagging={tagging} setTagging={setTagging}
              doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
              filter={airbnbTxFilter} setFilter={setAirbnbTxFilter} getSuggestion={getSuggestion}
            />
          </div>
        </div>

        {/* ── PIERCE ─────────────────────────────────────────────── */}
        <div className="swipe-pane">
          <div key={"pierce-"+tabIdx} className="stagger" style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Pierce Ave · 7 units · Section 8</div>
              <AnimatedNum value={M.pierceRev} format={fmt$} className="big-num"/>
              <div style={{display:"flex",gap:16,marginTop:6,flexWrap:"wrap"}}>
                <span style={{fontSize:13,color:"#ff453a"}}>{fmt$(M.pierceExp)} expenses</span>
                <span style={{fontSize:13,color:M.pierceCF>=0?"#30d158":"#ff453a",fontWeight:600}}>{fmt$(M.pierceCF)} net</span>
                {M.pierceRev>0&&<span style={{fontSize:13,color:"var(--text-3)"}}>{fmtPct((M.pierceCF/M.pierceRev)*100)} margin</span>}
              </div>
            </div>

            {/* KPI cards */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
              {[
                {l:"Gross Rent",    v:fmt$(M.pierceRev),  green:true},
                {l:"Expenses",     v:fmt$(M.pierceExp),   red:true},
                {l:"Net Income",   v:fmt$(M.pierceCF),    green:M.pierceCF>=0, red:M.pierceCF<0},
                {l:"Net Margin",   v:M.pierceRev>0?fmtPct((M.pierceCF/M.pierceRev)*100):"—", green:M.pierceCF>=0},
              ].map(c=>(
                <div key={c.l} className="card card-padded">
                  <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>{c.l}</div>
                  <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                </div>
              ))}
            </div>

            {/* Month-by-month charts */}
            {(()=>{
              const pMo={};
              M.propM.pierce.txs.forEach(t=>{
                const k=t.date?.slice(0,7)||"?";
                if(!pMo[k])pMo[k]={rev:0,exp:0};
                if(t.type==="in") pMo[k].rev+=Math.abs(t.amount);
                if(t.type==="out") pMo[k].exp+=Math.abs(t.amount);
              });
              // Pierce is flat — project remaining 2026 months at same run rate
              const _now=new Date(); const curMo2=`${_now.getFullYear()}-${String(_now.getMonth()+1).padStart(2,'0')}`;
              const pActual=Object.entries(pMo).filter(([k])=>k<=curMo2);
              const pAvgRev=pActual.length>0?pActual.reduce((s,[,v])=>s+v.rev,0)/pActual.length:0;
              const pAvgExp=pActual.length>0?pActual.reduce((s,[,v])=>s+v.exp,0)/pActual.length:0;
              for(let m=1;m<=12;m++){
                const k=`2026-${String(m).padStart(2,'0')}`;
                if(k<=curMo2||pMo[k]) continue;
                pMo[k]={rev:pAvgRev,exp:pAvgExp,projected:true};
              }
              const pMths=Object.entries(pMo).sort((a,b)=>a[0].localeCompare(b[0]));
              if(pMths.length===0) return null;
              return (
                <>
                  <div className="section-title">Rent · Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="rev" color="#30d158" onBarClick={(mo)=>setDrillDown({mo,type:"rev",txs:M.propM.pierce.txs})}/></div>
                  <div className="section-title">Expenses · Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="exp" color="#ff453a" onBarClick={(mo)=>setDrillDown({mo,type:"exp",txs:M.propM.pierce.txs})}/></div>
                  <div className="section-title">Net Income · Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="net" color={null} onBarClick={(mo)=>setDrillDown({mo,type:"net",txs:M.propM.pierce.txs})}/></div>
                  <div className="section-title">Net Margin % · Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="margin" color={null} marginMode fmt={v=>`${v.toFixed(1)}%`}/></div>
                </>
              );
            })()}

            {/* Transactions */}
            <div className="section-title">Transactions</div>
            <TxList
              txs={M.propM.pierce.txs}
              tagging={tagging} setTagging={setTagging}
              doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
              filter={pierceTxFilter} setFilter={setPierceTxFilter} getSuggestion={getSuggestion}
            />
          </div>
        </div>

        {/* ── ARCHIVE ─────────────────────────────────────────────── */}
        <div className="swipe-pane">
        {(()=>{
          const qData = M.quartersWithProjections;
          const qs = M.quarters;
          if(qData.length===0) return <div style={{minHeight:"100%"}}><div className="page-header"><div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>Quarterly</div></div><div className="card card-padded" style={{textAlign:"center",color:"var(--text-3)",fontSize:13}}>No data yet — sync your bank to get started.</div></div>;

          // Convert quarter objects to [key, data] pairs for MiniBar
          const qMths = qData.map(q=>[q.key,{rev:q.rev,exp:q.exp,net:q.net,margin:q.margin,projected:q.projected}]);
          // X-axis label: just the quarter number (Q1, Q2…)
          const qAxisLabel = k => { const q=qData.find(x=>x.key===k); return q?`Q${q.q}'${q.year.toString().slice(2)}`:k; };

          // Delta badge for summary table
          const Delta = ({cur, prev}) => {
            if(prev==null||prev===0) return null;
            const pct = ((cur-prev)/Math.abs(prev))*100;
            const up = pct >= 0;
            return (
              <span style={{fontSize:10,fontWeight:700,color:up?"#30d158":"#ff453a",background:up?"rgba(48,209,88,0.1)":"rgba(255,69,58,0.1)",borderRadius:6,padding:"2px 6px",marginLeft:6,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>
                {up?"+":""}{pct.toFixed(1)}%
              </span>
            );
          };

          return (
          <div style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>All Properties · Combined</div>
              <div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>Quarterly</div>
            </div>

            <div className="section-title">Revenue · Quarter by Quarter <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>hatched = projected</span></div>
            <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
              <MiniBar months={qMths} valueKey="rev" color="#30d158" labelFn={qAxisLabel} onBarClick={(qKey)=>{
                const [yr,q]=qKey.split("-Q");
                const qMs=[...Array(3)].map((_,i)=>`${yr}-${String((+q-1)*3+i+1).padStart(2,'0')}`);
                setDrillDown({mo:qKey,type:"rev",title:`Q${q} '${yr.slice(2)}`,txs:enriched.filter(t=>qMs.includes(t.date?.slice(0,7))&&t.propId!=="transfer"&&t.type==="in")});
              }}/>
            </div>

            <div className="section-title">Expenses · Quarter by Quarter</div>
            <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
              <MiniBar months={qMths} valueKey="exp" color="#ff453a" labelFn={qAxisLabel} onBarClick={(qKey)=>{
                const [yr,q]=qKey.split("-Q");
                const qMs=[...Array(3)].map((_,i)=>`${yr}-${String((+q-1)*3+i+1).padStart(2,'0')}`);
                setDrillDown({mo:qKey,type:"exp",title:`Q${q} '${yr.slice(2)}`,txs:enriched.filter(t=>qMs.includes(t.date?.slice(0,7))&&t.propId!=="transfer"&&t.type==="out")});
              }}/>
            </div>

            <div className="section-title">Net Income · Quarter by Quarter</div>
            <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
              <MiniBar months={qMths} valueKey="net" color={null} labelFn={qAxisLabel}/>
            </div>

            <div className="section-title">Net Margin % · Quarter by Quarter <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>≥30% healthy · grey=ok · red=negative</span></div>
            <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
              <MiniBar months={qMths} valueKey="margin" color={null} marginMode labelFn={qAxisLabel} fmt={v=>`${v.toFixed(1)}%`}/>
            </div>

            {/* Actual quarter history table */}
            {qs.length>0&&(
              <>
                <div className="section-title">All Quarters</div>
                <div className="card" style={{overflow:"hidden",marginBottom:8}}>
                  <div style={{display:"grid",gridTemplateColumns:"72px 1fr 1fr 1fr 60px",padding:"8px 14px",borderBottom:"1px solid rgba(255,255,255,0.07)",gap:8}}>
                    {["Quarter","Revenue","Expenses","Net","Margin"].map(h=>(
                      <span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.07em",textAlign:h==="Quarter"?"left":"right"}}>{h}</span>
                    ))}
                  </div>
                  {[...qs].reverse().map((q,i,arr)=>{
                    const prev = arr[i+1];
                    return (
                      <div key={q.key} style={{display:"grid",gridTemplateColumns:"58px 1fr 1fr 1fr 52px",padding:"10px 14px",borderBottom:"1px solid rgba(255,255,255,0.06)",gap:6,alignItems:"start",background:i===0?"rgba(48,209,88,0.03)":"transparent"}}>
                        <span style={{fontSize:12,fontWeight:700,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:i===0?"#30d158":"var(--text)",paddingTop:3}}>{q.label}</span>
                        <div style={{textAlign:"right"}}>
                          <div style={{fontSize:11,fontWeight:600,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"#30d158"}}>{fmt$(q.rev)}</div>
                          {prev&&<div style={{marginTop:3}}><Delta cur={q.rev} prev={prev.rev}/></div>}
                        </div>
                        <div style={{textAlign:"right"}}>
                          <div style={{fontSize:11,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"#ff453a"}}>{fmt$(q.exp)}</div>
                          {prev&&<div style={{marginTop:3}}><Delta cur={q.exp} prev={prev.exp}/></div>}
                        </div>
                        <div style={{textAlign:"right"}}>
                          <div style={{fontSize:11,fontWeight:700,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:q.net>=0?"#30d158":"#ff453a"}}>{fmt$(q.net)}</div>
                          {prev&&<div style={{marginTop:3}}><Delta cur={q.net} prev={prev.net}/></div>}
                        </div>
                        <div style={{textAlign:"right",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:q.margin>=30?"#30d158":q.margin>=0?"var(--text-3)":"#ff453a",paddingTop:3}}>{q.margin.toFixed(1)}%</div>
                      </div>
                    );
                  })}
                </div>
              </>
            )}
          </div>
          );
        })()}
        </div>

        <div className="swipe-pane">
        {(()=>{
          const now = new Date();
          const thisYear = now.getFullYear();
          const thisMo = now.getMonth(); // 0-indexed
          // Current year progress
          const moRemaining = 12 - thisMo;
          const moElapsed = thisMo;

          return (
          <div style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>5-Year Outlook · as of {now.toLocaleDateString("en-US",{month:"long",year:"numeric"})}</div>
              <div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>Projections</div>
              <div style={{fontSize:12,color:"var(--text-3)",marginTop:4}}>Based on actual run rate · STR seasonality applied · Pierce flat</div>
            </div>

            {/* This year callout */}
            <div className="section-title">{thisYear} · Current Year</div>
            <div className="card card-padded" style={{marginBottom:8}}>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:12}}>
                {[
                  {l:"YTD Revenue",   v:fmt$(M.totalRev),              sub:`${moElapsed} months actual`},
                  {l:"YTD Expenses",  v:fmt$(M.totalExp),              sub:"all properties", red:true},
                  {l:"YTD Net",       v:fmt$(M.totalCF),               sub:"cash flow", green:M.totalCF>=0},
                  {l:"YTD Margin",    v:M.netMargin!=null?fmtPct(M.netMargin):"—", sub:"net margin", green:M.netMargin>=30},
                ].map(c=>(
                  <div key={c.l}>
                    <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:3}}>{c.l}</div>
                    <div style={{fontSize:20,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                    <div style={{fontSize:10,color:"var(--text-3)"}}>{c.sub}</div>
                  </div>
                ))}
              </div>
              {/* Full-year {thisYear} projection */}
              {(()=>{
                const proj = M.projections[0];
                const ytdRev = M.totalRev;
                const ytdExp = M.totalExp;
                const remainRev = proj.rev - (ytdRev/Math.max(moElapsed,1))*12 + (ytdRev/Math.max(moElapsed,1))*12 - ytdRev;
                const fullYearRev = ytdRev + (M.annualRev - ytdRev) * (moRemaining/12);
                const fullYearExp = ytdExp + (M.annualExp - ytdExp) * (moRemaining/12);
                const fullYearNet = fullYearRev - fullYearExp;
                return (
                  <div style={{borderTop:"1px solid rgba(255,255,255,0.08)",paddingTop:12,marginTop:4}}>
                    <div style={{fontSize:10,color:"var(--text-3)",marginBottom:8,fontWeight:600,textTransform:"uppercase",letterSpacing:"0.06em"}}>Full Year {thisYear} Forecast</div>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
                      {[
                        {l:"Revenue",  v:fmt$(M.projections[0].rev), green:true},
                        {l:"Expenses", v:fmt$(M.projections[0].exp), red:true},
                        {l:"Net",      v:fmt$(M.projections[0].net), green:M.projections[0].net>=0},
                      ].map(c=>(
                        <div key={c.l} style={{background:"rgba(255,255,255,0.05)",borderRadius:10,padding:"8px 10px"}}>
                          <div style={{fontSize:9,color:"var(--text-3)",marginBottom:3,textTransform:"uppercase",letterSpacing:"0.06em"}}>{c.l}</div>
                          <div style={{fontSize:15,fontWeight:700,color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })()}
            </div>

            {/* 5-year table */}
            <div className="section-title">5-Year Forecast · {thisYear}–{thisYear+4}</div>
            <div className="card" style={{overflow:"hidden",marginBottom:8}}>
              <div style={{display:"grid",gridTemplateColumns:"56px 1fr 1fr 1fr 72px",borderBottom:"1px solid rgba(255,255,255,0.07)",padding:"8px 14px",gap:8}}>
                {["Year","Revenue","Expenses","Net","Margin"].map(h=>(
                  <span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",textAlign:h==="Year"?"left":"right"}}>{h}</span>
                ))}
              </div>
              {M.projections.map((d,i)=>(
                <div key={d.year} style={{display:"grid",gridTemplateColumns:"56px 1fr 1fr 1fr 72px",padding:"13px 14px",borderBottom:"1px solid rgba(255,255,255,0.06)",gap:8,alignItems:"center",background:i===0?"rgba(48,209,88,0.04)":"transparent"}}>
                  <span style={{fontSize:13,fontWeight:700,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:i===0?"#30d158":"var(--text)"}}>{d.year}{i===0?" ←":""}</span>
                  <span style={{fontSize:12,color:"#30d158",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textAlign:"right",fontWeight:600}}>{fmt$(d.rev)}</span>
                  <span style={{fontSize:12,color:"#ff453a",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textAlign:"right"}}>{fmt$(d.exp)}</span>
                  <span style={{fontSize:12,fontWeight:700,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textAlign:"right",color:d.net>=0?"#30d158":"#ff453a"}}>{fmt$(d.net)}</span>
                  <span style={{fontSize:11,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textAlign:"right",color:d.margin>=30?"#30d158":d.margin>=0?"var(--text-3)":"#ff453a"}}>{fmtPct(d.margin)}</span>
                </div>
              ))}
            </div>

            {/* Assumptions */}
            <div className="section-title">Assumptions</div>
            <div className="card card-padded" style={{marginBottom:8}}>
              {[
                {l:"Revenue growth", v:"3% / year", sub:"conservative STR market appreciation"},
                {l:"Expense growth",  v:"2% / year", sub:"maintenance + cost inflation"},
                {l:"Airbnb seasonality", v:"Applied", sub:"Jul–Aug peak 1.22x · Jan–Feb trough 0.72x"},
                {l:"Pierce Ave",    v:"Flat",    sub:"Section 8 — fixed rent, predictable"},
                {l:"Base data",     v:`${M.moCount} months`, sub:"actual transactions to date"},
              ].map(a=>(
                <div key={a.l} style={{display:"flex",justifyContent:"space-between",alignItems:"center",paddingBottom:10,marginBottom:10,borderBottom:"1px solid rgba(255,255,255,0.07)"}}>
                  <div>
                    <div style={{fontSize:13,fontWeight:500}}>{a.l}</div>
                    <div style={{fontSize:11,color:"var(--text-3)",marginTop:1}}>{a.sub}</div>
                  </div>
                  <span style={{fontSize:13,fontWeight:600,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"var(--text-2)"}}>{a.v}</span>
                </div>
              ))}
              {M.annualCoc&&(
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div>
                    <div style={{fontSize:13,fontWeight:500}}>Cash-on-Cash Return</div>
                    <div style={{fontSize:11,color:"var(--text-3)",marginTop:1}}>annualized · based on down payments</div>
                  </div>
                  <span style={{fontSize:13,fontWeight:600,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"#30d158"}}>{fmtPct(M.annualCoc)}</span>
                </div>
              )}
              {!M.annualCoc&&(
                <button onClick={()=>setShowInvest(true)} style={{fontSize:12,color:"var(--text-3)",background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.10)",borderRadius:10,padding:"8px 14px",cursor:"pointer",display:"block",width:"100%",textAlign:"left"}}>
                  + Add down payments to unlock CoC return
                </button>
              )}
            </div>
          </div>
          );
        })()}
        </div>

        {/* ── CUSTOM PROPERTY PANES ──────────────────────────────── */}
        {customProps.filter(p=>!p.isAirbnb).map(p=>{
          const cMo = {};
          enriched.filter(t=>t.propId===p.id).forEach(t=>{
            const mo=t.date?.slice(0,7); if(!mo) return;
            if(!cMo[mo]) cMo[mo]={rev:0,exp:0};
            if(t.type==="in") cMo[mo].rev+=Math.abs(t.amount); else cMo[mo].exp+=Math.abs(t.amount);
          });
          const cMths=Object.entries(cMo).sort(([a],[b])=>a<b?-1:1).map(([mo,v])=>[mo,{...v,net:v.rev-v.exp,margin:v.rev>0?((v.rev-v.exp)/v.rev)*100:0}]);
          const totRev=cMths.reduce((s,[,v])=>s+v.rev,0), totExp=cMths.reduce((s,[,v])=>s+v.exp,0), totCF=totRev-totExp;
          return (
            <div className="swipe-pane" key={p.id}>
              <div className="page-header">
                <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>{p.label}</div>
                <div className="big-num">{fmt$(totRev)}</div>
                <div style={{display:"flex",gap:16,marginTop:6}}>
                  <span style={{fontSize:13,color:"#ff453a"}}>{fmt$(totExp)} expenses</span>
                  <span style={{fontSize:13,color:totCF>=0?"#30d158":"#ff453a",fontWeight:600}}>{fmt$(totCF)} net</span>
                </div>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
                {[{l:"Gross Revenue",v:fmt$(totRev),green:true},{l:"Expenses",v:fmt$(totExp),red:true},
                  {l:"Net Income",v:fmt$(totCF),green:totCF>=0,red:totCF<0},
                  {l:"Net Margin",v:totRev>0?fmtPct((totCF/totRev)*100):"—",green:totCF>=0}].map(c=>(
                  <div key={c.l} className="card card-padded">
                    <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>{c.l}</div>
                    <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                  </div>
                ))}
              </div>
              {cMths.length>0&&<>
                <div className="section-title">Revenue · Month by Month</div>
                <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={cMths} valueKey="rev" color="#30d158"/></div>
                <div className="section-title">Expenses · Month by Month</div>
                <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={cMths} valueKey="exp" color="#ff453a"/></div>
                <div className="section-title">Net Income · Month by Month</div>
                <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={cMths} valueKey="net" color={null}/></div>
              </>}
            </div>
          );
        })}

        {/* ── FEED ───────────────────────────────────────────────── */}
        <div className="swipe-pane">
          <div style={{minHeight:"100%"}}>
            <div className="page-header" style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between"}}>
              <div>
                <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Transaction Feed</div>
                <div style={{display:"flex",gap:8,alignItems:"center"}}>
                  <div className="big-num" style={{fontSize:26}}>{untagged.length}</div>
                  <div style={{fontSize:13,color:"var(--text-3)"}}>untagged</div>
                </div>
              </div>
              <div className="seg-ctrl" style={{marginTop:4}}>
                {[["untagged",`Untagged (${untagged.length})`],["tagged","Tagged"],["all","All"]].map(([k,l])=>(
                  <button key={k} className={`seg-btn${feedFilter===k?" active":""}`} onClick={()=>setFeedFilter(k)}>{l}</button>
                ))}
              </div>
            </div>

            {txs.length===0&&linked.length===0&&(
              <div className="card card-padded" style={{textAlign:"center",padding:"48px 24px"}}>
                <div style={{fontSize:32,marginBottom:12}}>🏦</div>
                <div style={{fontSize:15,fontWeight:600,marginBottom:12}}>No bank connected</div>
                <button onClick={connectBank} className="btn-primary">Connect Bank</button>
              </div>
            )}

            {(txs.length>0||linked.length>0)&&<TxList
              txs={feedTxs}
              tagging={tagging} setTagging={setTagging}
              doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
              filter={txFilter} setFilter={setTxFilter} getSuggestion={getSuggestion}
            />}
          </div>
        </div>

        <div className="swipe-pane">
          <div style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Archive · Settings</div>
              <div style={{fontSize:15,fontWeight:600}}>Deleted & Internal Transfers</div>
              <div style={{fontSize:12,color:"var(--text-3)",marginTop:4}}>Review and re-tag any transaction below.</div>
            </div>

            {archived.length===0&&(
              <div className="card card-padded" style={{textAlign:"center",color:"var(--text-3)",padding:"48px 24px",fontSize:13}}>
                Nothing here yet — deleted and transferred transactions appear here.
              </div>
            )}

            {archived.length>0&&(
              <div className="card" style={{overflow:"hidden"}}>
                {[...archived].sort((a,b)=>b.date.localeCompare(a.date)).map((tx,i)=>(
                  <div key={tx.id} style={{borderBottom:i<archived.length-1?"1px solid rgba(255,255,255,0.07)":"none"}}>
                    <div style={{display:"grid",gridTemplateColumns:"64px 1fr auto auto",padding:"11px 14px",gap:8,alignItems:"center"}}>
                      <span style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{fmtDate(tx.date)}</span>
                      <div>
                        <div style={{fontSize:12,fontWeight:500,lineHeight:1.3}}>{tx.payee}</div>
                        <div style={{fontSize:10,color:"var(--text-3)",marginTop:1}}>
                          {tx.propId==="deleted"?"🗑 Deleted":"↔ Transfer"} · {tx.account||""}
                        </div>
                      </div>
                      <span style={{fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:600,fontSize:12,color:tx.type==="in"?"#30d158":"#ff453a"}}>
                        {tx.type==="in"?"+":"-"}{fmtD(tx.amount)}
                      </span>
                      <div style={{display:"flex",flexDirection:"column",gap:4}}>
                        <button onClick={()=>doRestore(tx.id)} style={{background:"rgba(255,255,255,0.07)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:7,padding:"4px 8px",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",cursor:"pointer",color:"var(--text-2)",fontWeight:600,whiteSpace:"nowrap"}}>
                          Restore
                        </button>
                        {tx.type==="in"?(
                          <button onClick={()=>{const p=PROPERTIES.find(x=>x.id!=="transfer"&&x.id!=="deleted"&&x.id!=="llc"&&x.group!=="airbnb"||x.id==="airbnb");doTag(tx.id,"airbnb");}} style={{background:"rgba(48,209,88,0.1)",border:"1px solid rgba(48,209,88,0.2)",borderRadius:7,padding:"4px 8px",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",cursor:"pointer",color:"#30d158",fontWeight:600}}>
                            → Airbnb
                          </button>
                        ):(
                          <button onClick={()=>setTagging(tagging===tx.id?null:tx.id)} style={{background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.10)",borderRadius:7,padding:"4px 8px",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",cursor:"pointer",color:"var(--text-2)",fontWeight:600}}>
                            Re-tag
                          </button>
                        )}
                      </div>
                    </div>
                    {tagging===tx.id&&(
                      <div style={{padding:"0 14px 12px",borderTop:"1px solid rgba(255,255,255,0.06)"}}>
                        <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)} onDelete={doDelete}/>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}

            {/* Connected banks */}
            {linked.length>0&&(
              <>
                <div className="section-title">Connected Banks</div>
                <div className="card" style={{overflow:"hidden"}}>
                  {linked.map((a,i)=>(
                    <div key={a.item_id} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 14px",borderBottom:i<linked.length-1?"1px solid rgba(255,255,255,0.07)":"none"}}>
                      <span style={{fontSize:13,fontWeight:500}}>{a.name}</span>
                      <div style={{display:"flex",gap:8}}>
                        <button onClick={()=>pullHistory()} style={{fontSize:11,color:"var(--text-3)",background:"none",border:"none",cursor:"pointer"}}>↓ Pull History</button>
                        <button onClick={()=>removeAccount(a.item_id)} style={{fontSize:11,color:"#ff453a",background:"none",border:"none",cursor:"pointer"}}>Remove</button>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            )}

            {/* Data management */}
            <div className="section-title">Data</div>
            <div className="card card-padded" style={{marginBottom:8}}>
              <div style={{fontSize:13,fontWeight:600,marginBottom:4}}>Local Cache</div>
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:12}}>{txs.length} transactions stored locally. If you see expenses with no bank connected, this is leftover data from a previous session — clear it here.</div>
              <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
                <button onClick={clearAllData} style={{background:"rgba(255,69,58,0.08)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.2)",borderRadius:10,padding:"8px 16px",fontSize:12,fontWeight:600,cursor:"pointer"}}>
                  Clear All Cached Data
                </button>
                <button onClick={()=>setShowManual(true)} style={{background:"rgba(255,255,255,0.06)",color:"var(--text)",border:"1px solid rgba(255,255,255,0.12)",borderRadius:10,padding:"8px 16px",fontSize:12,fontWeight:600,cursor:"pointer"}}>
                  ✎ Manual Income
                </button>
              </div>
            </div>

            {/* Auto-tag rules */}
            {Object.keys(autoTags).length>0&&(
              <>
                <div className="section-title">Auto-Tag Rules <span style={{fontWeight:400,textTransform:"none",fontSize:9}}>(suggestions only — not applied automatically)</span></div>
                <div className="card card-padded">
                  <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                    {Object.entries(autoTags).map(([payee,pid])=>(
                      <div key={payee} style={{display:"flex",alignItems:"center",gap:5,background:"rgba(255,255,255,0.06)",border:"1px solid rgba(255,255,255,0.09)",borderRadius:8,padding:"4px 10px"}}>
                        <span style={{fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"var(--text-3)"}}>{payee}</span>
                        <span style={{color:"var(--text-3)",fontSize:10}}>→</span>
                        <PropBadge id={pid} small/>
                        <button onClick={()=>{const n={...autoTags};delete n[payee];setAutoTags(n);LS.set(AUTO_KEY,n);}} style={{background:"none",border:"none",color:"var(--text-3)",cursor:"pointer",fontSize:12,lineHeight:1,padding:"0 2px"}}>×</button>
                      </div>
                    ))}
                  </div>
                </div>
              </>
            )}
          </div>
        </div>

        </div>{/* end .swipe-track */}
      </div>{/* end .page-outer */}



      {/* SIDE DRAWER */}
      {showDrawer&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.45)",zIndex:500}} onClick={()=>setShowDrawer(false)}/>}
      <div style={{position:"fixed",top:0,left:0,bottom:0,width:288,background:"rgba(10,14,36,0.94)",backdropFilter:"blur(60px) saturate(1.9)",WebkitBackdropFilter:"blur(60px) saturate(1.9)",borderRight:"0.5px solid rgba(255,255,255,0.10)",zIndex:501,transform:showDrawer?"translateX(0)":"translateX(-100%)",transition:"transform 0.44s cubic-bezier(0.34,1.28,0.64,1)",boxShadow:showDrawer?"6px 0 48px rgba(0,0,0,0.50), inset -1px 0 0 rgba(255,255,255,0.06)":"none",display:"flex",flexDirection:"column",overflowY:"auto"}}>
        {/* Drawer header */}
        <div style={{padding:"20px 20px 16px",borderBottom:"1px solid rgba(128,128,128,0.12)",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <svg width="20" height="20" viewBox="0 0 32 32" fill="none"><ellipse cx="16" cy="13" rx="8" ry="7" fill="rgba(255,255,255,0.9)"/><ellipse cx="16" cy="13" rx="5" ry="4.5" fill="#06091a"/><circle cx="16" cy="13" r="2" fill="rgba(255,255,255,0.9)"/><path d="M12 19c0 0-4 3-4 7h16c0-4-4-7-4-7" fill="rgba(255,255,255,0.9)"/></svg>
            <span style={{fontWeight:700,fontSize:14,letterSpacing:"-0.01em"}}>Property Pigeon</span>
          </div>
          <button onClick={()=>setShowDrawer(false)} style={{background:"rgba(255,255,255,0.08)",border:"none",borderRadius:20,width:30,height:30,fontSize:15,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text-2)"}}>
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="1" y1="1" x2="11" y2="11"/><line x1="11" y1="1" x2="1" y2="11"/></svg>
          </button>
        </div>

        {/* NAVIGATE section */}
        {(()=>{
          const ICO = {
            portfolio:   <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="8" width="3" height="6" rx="0.5"/><rect x="6.5" y="5" width="3" height="9" rx="0.5"/><rect x="12" y="2" width="3" height="12" rx="0.5"/></svg>,
            homes:       <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M1 6l7-5 7 5v8a1 1 0 01-1 1H2a1 1 0 01-1-1z"/><polyline points="6 15 6 8 10 8 10 15"/></svg>,
            quarterly:   <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="2" width="14" height="12" rx="1.5"/><line x1="1" y1="6" x2="15" y2="6"/><line x1="8" y1="2" x2="8" y2="14"/></svg>,
            projections: <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><polyline points="1 12 5 7 9 9 15 3"/><polyline points="11 3 15 3 15 7"/></svg>,
            feed:        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="4" x2="14" y2="4"/><line x1="4" y1="8" x2="14" y2="8"/><line x1="4" y1="12" x2="14" y2="12"/><circle cx="1.5" cy="4" r="0.8" fill="currentColor" stroke="none"/><circle cx="1.5" cy="8" r="0.8" fill="currentColor" stroke="none"/><circle cx="1.5" cy="12" r="0.8" fill="currentColor" stroke="none"/></svg>,
            archive:     <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="1" width="14" height="4" rx="1"/><path d="M2 5v8a1 1 0 001 1h10a1 1 0 001-1V5"/><line x1="6" y1="8" x2="10" y2="8"/></svg>,
            custom:      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="6" width="12" height="9" rx="1"/><path d="M5 6V4a3 3 0 016 0v2"/><line x1="8" y1="9" x2="8" y2="12"/></svg>,
          };
          const homeTabs = ["Airbnb","Pierce",...customProps.filter(p=>!p.isAirbnb).map(p=>p.label)];
          const isHomesActive = isPortfolioGroup && tabIdx !== 0;
          const row = (icon, label, isActive, onClick) => (
            <button onClick={onClick}
              style={{background:isActive?"rgba(128,128,128,0.08)":"transparent",border:"none",
                padding:"0 20px",height:52,display:"flex",alignItems:"center",justifyContent:"space-between",
                gap:12,cursor:"pointer",textAlign:"left",width:"100%",
                color:isActive?"var(--text)":"var(--text-2)",flexShrink:0}}>
              <div style={{display:"flex",alignItems:"center",gap:12}}>
                <span style={{flexShrink:0,opacity:isActive?1:0.7}}>{icon}</span>
                <span style={{fontSize:15,fontWeight:isActive?600:500}}>{label}</span>
              </div>
              <span style={{color:"var(--text-3)",fontSize:16}}>›</span>
            </button>
          );
          return (
            <>
              <div style={{fontSize:10,fontWeight:600,letterSpacing:"0.1em",color:"var(--text-3)",
                fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",
                padding:"14px 20px 6px",flexShrink:0}}>Navigate</div>

              {/* Portfolio */}
              {row(ICO.portfolio, "Portfolio", tabIdx===0, ()=>{navigateTab("Portfolio");setShowDrawer(false);})}

              {/* Homes — expandable accordion */}
              <button onClick={()=>setDrawerHomesExpanded(v=>!v)}
                style={{background:isHomesActive?"rgba(128,128,128,0.08)":"transparent",border:"none",
                  padding:"0 20px",height:52,display:"flex",alignItems:"center",justifyContent:"space-between",
                  gap:12,cursor:"pointer",textAlign:"left",width:"100%",
                  color:isHomesActive?"var(--text)":"var(--text-2)",flexShrink:0}}>
                <div style={{display:"flex",alignItems:"center",gap:12}}>
                  <span style={{flexShrink:0,opacity:isHomesActive?1:0.7}}>{ICO.homes}</span>
                  <span style={{fontSize:15,fontWeight:isHomesActive?600:500}}>Homes</span>
                </div>
                <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" strokeWidth="2"
                  strokeLinecap="round" strokeLinejoin="round"
                  style={{transition:"transform 0.2s",transform:drawerHomesExpanded?"rotate(90deg)":"rotate(0deg)",color:"var(--text-3)"}}>
                  <polyline points="4 2 8 6 4 10"/>
                </svg>
              </button>

              {/* Homes sub-rows */}
              {drawerHomesExpanded&&homeTabs.map(t=>{
                const active = tabs[tabIdx]===t;
                const icon = t==="Airbnb" ? ICO.homes : ICO.custom;
                return (
                  <button key={t} onClick={()=>{navigateTab(t);setShowDrawer(false);}}
                    style={{background:active?"rgba(128,128,128,0.08)":"transparent",border:"none",
                      padding:"0 20px 0 52px",height:44,display:"flex",alignItems:"center",
                      justifyContent:"space-between",gap:12,cursor:"pointer",textAlign:"left",
                      width:"100%",color:active?"var(--text)":"var(--text-3)",flexShrink:0,
                      borderTop:"1px solid rgba(128,128,128,0.05)"}}>
                    <div style={{display:"flex",alignItems:"center",gap:10}}>
                      <span style={{flexShrink:0,opacity:active?1:0.6}}>{icon}</span>
                      <span style={{fontSize:13,fontWeight:active?600:400}}>{t}</span>
                    </div>
                    {active&&<svg width="10" height="10" viewBox="0 0 10 10" fill="none" stroke="currentColor" strokeWidth="2.2" strokeLinecap="round" strokeLinejoin="round"><polyline points="1 5 3.5 8 9 2"/></svg>}
                  </button>
                );
              })}

              {row(ICO.quarterly,   "Quarterly",    tabs[tabIdx]==="Quarterly",    ()=>{navigateTab("Quarterly");setShowDrawer(false);})}
              {row(ICO.projections, "Projections",  tabs[tabIdx]==="Projections",  ()=>{navigateTab("Projections");setShowDrawer(false);})}
              {row(ICO.feed,        "Transactions",  false,                         ()=>{navigateTab("Feed");setShowDrawer(false);})}
              {row(ICO.archive,     "Archive",       false,                         ()=>{navigateTab("Archive");setShowDrawer(false);})}
            </>
          );
        })()}

        {/* ACTIONS section */}
        <div style={{fontSize:10,fontWeight:600,letterSpacing:"0.1em",color:"var(--text-3)",
          fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",
          padding:"14px 20px 6px",borderTop:"1px solid rgba(128,128,128,0.1)",flexShrink:0,marginTop:4}}>Actions</div>
        {[
          { label:"Airbnb Revenue",
            icon:<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round"><circle cx="8" cy="8" r="7"/><line x1="8" y1="4" x2="8" y2="12"/><line x1="4" y1="8" x2="12" y2="8"/></svg>,
            action:()=>{setShowManual(true);setShowDrawer(false);}},
          { label:"Add Property",
            icon:<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round"><rect x="1" y="1" width="14" height="14" rx="2"/><line x1="8" y1="5" x2="8" y2="11"/><line x1="5" y1="8" x2="11" y2="8"/></svg>,
            action:()=>{setShowAddProp(true);setShowDrawer(false);}},
          { label:"Add Bank",
            icon:<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round"><rect x="1" y="4" width="14" height="10" rx="1.5"/><line x1="1" y1="8" x2="15" y2="8"/><line x1="4" y1="11.5" x2="6" y2="11.5"/></svg>,
            action:()=>{connectBank();setShowDrawer(false);}},
          { label:"Settings",
            icon:<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round"><circle cx="8" cy="8" r="2.5"/><path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.05 3.05l1.41 1.41M11.54 11.54l1.41 1.41M3.05 12.95l1.41-1.41M11.54 4.46l1.41-1.41"/></svg>,
            action:()=>{setShowSettings(true);setShowDrawer(false);}},
        ].map((item,i,arr)=>(
          <button key={item.label} onClick={item.action} className="drawer-row"
            style={{background:"transparent",border:"none",
              borderBottom:i<arr.length-1?"1px solid rgba(128,128,128,0.07)":"none",
              padding:"0 20px",height:52,display:"flex",alignItems:"center",justifyContent:"space-between",
              gap:12,cursor:"pointer",textAlign:"left",width:"100%",
              color:"var(--text-2)",flexShrink:0}}>
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <span style={{flexShrink:0,opacity:0.7}}>{item.icon}</span>
              <span style={{fontSize:15,fontWeight:500}}>{item.label}</span>
            </div>
            <span style={{color:"var(--text-3)",fontSize:16}}>›</span>
          </button>
        ))}
      </div>

      {showAddProp&&<AddPropertyModal onSave={saveCustomProp} onClose={()=>setShowAddProp(false)}/>}
      {showInvest&&<InvestModal invest={invest} onSave={saveInvest} onClose={()=>setShowInvest(false)}/>}
      {drillDown&&<MonthDrillDown mo={drillDown.mo} type={drillDown.type} txs={drillDown.txs}
        title={drillDown.title||null}
        onClose={()=>setDrillDown(null)}
        doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
        getSuggestion={getSuggestion}
      />}
      {showManual&&<ManualIncomeModal manual={manualIncome} onSave={saveManual} onClose={()=>setShowManual(false)}/>}
      {rulePrompt&&<RulePromptModal
        payee={rulePrompt.payee} propId={rulePrompt.propId}
        onApplyAll={()=>applyRule(rulePrompt.payee,rulePrompt.propId,true)}
        onApplyName={()=>applyRule(rulePrompt.payee,rulePrompt.propId,false)}
        onSkip={()=>setRulePrompt(null)}
      />}
      <ToastManager toasts={toasts} onRemove={removeToast}/>
      {showSettings&&<SettingsPage
        onClose={()=>setShowSettings(false)}
        customProps={customProps} onDeleteProp={deleteCustomProp}
        onSync={sync} onPullHistory={pullHistory} syncing={syncing} lastSync={lastSync} lastPull={lastPull} shakeSync={shakeTarget==="sync"}
        autoTags={autoTags} rules={rules}
        onDeleteRule={payee=>{
          const nr={...rules}; delete nr[payee];
          const na={...autoTags}; delete na[payee];
          setRules(nr); setAutoTags(na);
          LS.set(AUTO_KEY,na);
          fetch(`${BACKEND}/api/rules`,{method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({rules:nr})}).catch(()=>{});
        }}
        settings={settings}
        onSaveSettings={s=>{
          setSettings(s);
          fetch(`${BACKEND}/api/settings`,{method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({settings:s})}).catch(()=>{});
          if(s.darkMode) document.documentElement.setAttribute("data-theme","dark");
          else document.documentElement.removeAttribute("data-theme");
        }}
        archived={enriched.filter(t=>tags[t.id]==="deleted")}
        doRestore={doRestore}
        doTag={doTag}
        linked={linked}
        onRemoveAccount={async(id)=>{
          await fetch(`${BACKEND}/api/remove-account`,{method:"POST",
            headers:{"Content-Type":"application/json"},body:JSON.stringify({item_id:id})});
          loadAll();
        }}
        onClearAll={()=>{
          LS.set(TX_KEY,[]); LS.set(TAGS_KEY,{}); LS.set(AUTO_KEY,{}); LS.set(MANUAL_KEY,{});
          setTxs([]); setTags({}); setAutoTags({}); setManualIncome({});
        }}
      />}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
