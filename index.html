<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Property Pigeon</title>
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=Figtree:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link rel="manifest" href="/manifest.json"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="Pigeon"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="theme-color" content="#1a1a2e"/>
  <link rel="apple-touch-icon" href="/icon-192.png"/>
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png"/>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --glass: rgba(255,255,255,0.55);
      --glass-border: rgba(255,255,255,0.75);
      --glass-hover: rgba(255,255,255,0.70);
      --green: #30d158;
      --green-dim: rgba(48,209,88,0.15);
      --red: #ff453a;
      --red-dim: rgba(255,69,58,0.15);
      --blue: #0a84ff;
      --blue-dim: rgba(10,132,255,0.15);
      --purple: #bf5af2;
      --yellow: #ffd60a;
      --text: #1a1a2e;
      --text-2: rgba(26,26,46,0.60);
      --text-3: rgba(26,26,46,0.38);
      --radius: 16px;
      --radius-sm: 10px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #f5f5f7;
      color: var(--text);
      font-family: 'Figtree', -apple-system, BlinkMacSystemFont, sans-serif;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(ellipse 60% 50% at 10% 15%,  rgba(255,255,255,0.06) 0%, transparent 60%),
        radial-gradient(ellipse 50% 45% at 90% 10%,  rgba(200,240,255,0.07) 0%, transparent 55%),
        radial-gradient(ellipse 55% 50% at 80% 85%,  rgba(180,255,200,0.05) 0%, transparent 55%),
        radial-gradient(ellipse 45% 40% at 15% 85%,  rgba(220,200,255,0.05) 0%, transparent 50%),
        linear-gradient(145deg, #f0f4f8 0%, #e8edf5 35%, #eef2f7 65%, #f2f0f8 100%);
      pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(circle 400px at 25% 55%, rgba(120,180,255,0.12) 0%, transparent 65%),
        radial-gradient(circle 350px at 75% 35%, rgba(160,220,180,0.10) 0%, transparent 65%),
        radial-gradient(circle 300px at 60% 80%, rgba(200,160,255,0.08) 0%, transparent 60%);
      animation: driftOrbs 20s ease-in-out infinite alternate;
      pointer-events: none;
    }

    @keyframes driftOrbs {
      0%   { transform: translate(0, 0) scale(1); }
      33%  { transform: translate(25px, -15px) scale(1.04); }
      66%  { transform: translate(-15px, 25px) scale(0.97); }
      100% { transform: translate(12px, -8px) scale(1.02); }
    }

    #root { position: relative; z-index: 1; }

    button { cursor: pointer; font-family: inherit; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 4px; }

    /* Glass card */
    .glass {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    .glass-sm {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm);
      backdrop-filter: blur(16px);
    }

    /* Top header */
    .top-header {
      position: sticky; top: 0; z-index: 100;
      padding: 12px 16px 10px;
      background: rgba(245,245,247,0.88);
      backdrop-filter: blur(28px) saturate(1.6);
      -webkit-backdrop-filter: blur(28px) saturate(1.6);
      border-bottom: 1px solid rgba(0,0,0,0.06);
      display: flex; align-items: center; justify-content: space-between;
    }
    /* Bottom tab bar */
    .tab-bar {
      position: fixed; bottom: 0; left: 0; right: 0; z-index: 100;
      background: rgba(245,245,247,0.92);
      backdrop-filter: blur(28px) saturate(1.6);
      -webkit-backdrop-filter: blur(28px) saturate(1.6);
      border-top: 1px solid rgba(0,0,0,0.08);
      display: flex; align-items: center; justify-content: space-around;
      padding: 8px 0 max(8px,env(safe-area-inset-bottom));
    }
    .tab-item {
      display: flex; flex-direction: column; align-items: center; gap: 3px;
      padding: 4px 12px;
      background: transparent; border: none;
      color: var(--text-3);
      font-size: 10px; font-weight: 500;
      transition: all 0.15s;
      min-width: 52px;
    }
    .tab-item.active { color: var(--text); }
    .tab-item svg { transition: all 0.15s; }
    .tab-item.active svg { transform: scale(1.05); }
    .nav-tab {
      background: transparent; color: var(--text-3); border: none;
      padding: 7px 16px; border-radius: 20px; font-size: 13px;
      font-weight: 500; transition: all 0.2s; position: relative;
    }
    .nav-tab.active { background: rgba(0,0,0,0.07); color: var(--text); font-weight: 600; }

    /* Pills */
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 11px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }
    .pill-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }

    /* Big stat */
    .stat-num {
      font-family: 'Figtree', sans-serif;
      font-size: 36px;
      font-weight: 700;
      letter-spacing: -0.03em;
      line-height: 1;
    }
    .stat-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-3);
      font-family: 'JetBrains Mono', monospace;
    }

    /* Chart tooltip */
    .chart-tooltip {
      position: absolute;
      background: rgba(20,20,28,0.95);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 12px;
      pointer-events: none;
      backdrop-filter: blur(20px);
      white-space: nowrap;
      z-index: 50;
      transform: translateX(-50%);
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    /* Direction badge */
    .dir-in  { color: var(--green); font-size: 15px; }
    .dir-out { color: var(--red);   font-size: 15px; }

    /* Property badge */
    .prop-badge {
      display: inline-block;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 10px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    /* Segment control */
    .seg-ctrl {
      display: inline-flex;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 10px;
      padding: 3px;
      gap: 2px;
    }
    .seg-btn {
      background: transparent;
      border: none;
      color: var(--text-3);
      border-radius: 7px;
      padding: 5px 14px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.18s;
    }
    .seg-btn.active {
      background: rgba(0,0,0,0.08);
      color: var(--text);
      font-weight: 600;
    }

    /* Action button */
    .btn-ghost {
      background: rgba(255,255,255,0.6);
      border: 1px solid rgba(0,0,0,0.12);
      color: var(--text-2);
      border-radius: 10px;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.18s;
    }
    .btn-ghost:hover { background: rgba(255,255,255,0.85); color: var(--text); }
    .btn-primary {
      background: var(--green);
      border: none;
      color: #000;
      border-radius: 10px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 700;
      transition: all 0.18s;
    }
    .btn-primary:hover { filter: brightness(1.1); }

    /* Modal overlay */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
    }

    /* Tx row */
    .tx-row {
      display: grid;
      grid-template-columns: 76px 28px 1fr 100px 96px 120px;
      padding: 11px 16px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .tx-row:hover { background: rgba(0,0,0,0.03); }
    .tx-row:last-child { border-bottom: none; }

    /* Page content â€” accounts for fixed bottom tab bar */
    .page { padding: 0 16px 100px; max-width: 640px; margin: 0 auto; }
    .page-header { padding: 20px 0 16px; }
    .section-title {
      font-size: 10px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--text-3);
      font-family: 'JetBrains Mono', monospace;
      margin-bottom: 10px; margin-top: 22px;
    }
    .card {
      background: rgba(255,255,255,0.72);
      border: 1px solid rgba(0,0,0,0.07);
      border-radius: 16px;
      overflow: hidden;
    }
    .card-padded { padding: 16px 18px; }
    .stat-row { display: flex; align-items: baseline; gap: 8px; }
    .big-num { font-size: 32px; font-weight: 700; letter-spacing: -0.03em; line-height: 1; }
    .sub-num { font-size: 13px; color: var(--text-3); }
    @media (max-width: 420px) {
      .big-num { font-size: 26px; }
      .stat-num { font-size: 28px; }
    }

    /* Metric card */
    .metric-card {
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.75);
      border-radius: var(--radius-sm);
      padding: 16px 18px;
      backdrop-filter: blur(16px);
    }

    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    .fade-in { animation: fadeIn 0.3s ease forwards; }
  </style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useMemo, useEffect, useCallback, useRef } = React;
if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});
const BACKEND = "";

// â”€â”€ Formatters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt$ = n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(n||0);
const fmtD = n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.abs(n||0));
const fmtPct = n => (n==null||isNaN(n)||!isFinite(n))?"â€”":`${n.toFixed(1)}%`;
const fmtDate = d => { try { return new Date(d+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"}); } catch { return d||""; } };
const moLabel = s => { try { const [y,m]=s.split("-"); return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][+m-1]+" '"+y.slice(2); } catch { return s; } };

// â”€â”€ Properties â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const PROPERTIES = [
  { id:"airbnb",   label:"Airbnb (portfolio)", color:"#30d158", group:"airbnb" },
  { id:"lockwood", label:"Lockwood",            color:"#30d158", group:"airbnb" },
  { id:"everton",  label:"Everton",             color:"var(--text)", group:"airbnb" },
  { id:"bstreet",  label:"B Street",            color:"var(--text)", group:"airbnb" },
  { id:"pierce",   label:"Pierce Ave",          color:"var(--text)", group:"pierce" },
  { id:"llc",      label:"General LLC",         color:"var(--text)", group:"llc"    },
  { id:"transfer", label:"Internal Transfer",   color:"#636366", group:"transfer"},
];
// All IDs that count as Airbnb revenue/expense
const AIRBNB_IDS = ["airbnb","lockwood","everton","bstreet"];

// â”€â”€ Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LS = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => { try { localStorage.setItem(k,JSON.stringify(v)); } catch {} },
};
const TAGS_KEY    = "pg_tags_v2";
const AUTO_KEY    = "pg_auto_v2";
const TX_KEY      = "pg_txs_v2";
const INVEST_KEY  = "pg_invest";
const MANUAL_KEY  = "pg_manual_income"; // { "2025-10": 12550.70, "2025-11": 13972.97, ... }
const DEFAULT_AUTO = { "AIRBNB PAYMENTS":"lockwood","AIRBNB":"lockwood","HOUSING AUTHORITY":"pierce" };
const DEFAULT_INVEST = { lockwood:0, everton:0, bstreet:0, pierce:0 };

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sumIn(txs)  { return txs.filter(t=>t.type==="in" ).reduce((s,t)=>s+Math.abs(t.amount),0); }
function sumOut(txs) { return txs.filter(t=>t.type==="out").reduce((s,t)=>s+Math.abs(t.amount),0); }

// â”€â”€ PropBadge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PropBadge({ id, small }) {
  const p = PROPERTIES.find(x=>x.id===id);
  const fs = small ? 9 : 10;
  const pad = small ? "2px 7px" : "3px 9px";
  if (!p) return <span className="prop-badge" style={{fontSize:fs,padding:pad,background:"rgba(255,214,10,0.15)",color:"var(--text)",border:"1px solid rgba(255,214,10,0.25)"}}>UNTAGGED</span>;
  return <span className="prop-badge" style={{fontSize:fs,padding:pad,background:`${p.color}18`,color:p.color,border:`1px solid ${p.color}30`}}>{p.label.toUpperCase()}</span>;
}

// â”€â”€ TagMenu â€” in vs out logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Money IN:  Airbnb (portfolio) | Pierce Ave | Internal Transfer | Delete
// Money OUT: Lockwood | Everton | B Street | Pierce | LLC | Internal Transfer | Delete
function TagMenu({ tx, onTag, onClose, onDelete }) {
  const [confirmDelete, setConfirmDelete] = useState(false);
  const isIn = tx.type === "in";

  const inOptions  = [
    {id:"airbnb", label:"Airbnb"},
    {id:"pierce", label:"Pierce Ave"},
    {id:"transfer",label:"Transfer"},
  ];
  const outOptions = [
    {id:"lockwood",label:"Lockwood"},
    {id:"everton", label:"Everton"},
    {id:"bstreet", label:"B Street"},
    {id:"pierce",  label:"Pierce Ave"},
    {id:"llc",     label:"LLC"},
    {id:"transfer",label:"Transfer"},
  ];
  const opts = isIn ? inOptions : outOptions;

  const btnBase = {borderRadius:10,padding:"7px 14px",fontSize:12,fontFamily:"'JetBrains Mono',monospace",fontWeight:600,cursor:"pointer",border:"1px solid rgba(0,0,0,0.1)",background:"rgba(255,255,255,0.7)",color:"var(--text)",transition:"all 0.12s"};

  return (
    <div style={{padding:"10px 0 6px"}}>
      <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:8}}>
        {opts.map(p=>(
          <button key={p.id} onClick={()=>onTag(tx.id,p.id)} style={{
            ...btnBase,
            background: tx.propId===p.id ? "rgba(0,0,0,0.1)" : btnBase.background,
            fontWeight: tx.propId===p.id ? 700 : 600,
          }}>
            {p.label}
          </button>
        ))}
      </div>
      <div style={{display:"flex",gap:6,alignItems:"center"}}>
        {confirmDelete
          ? <>
              <span style={{fontSize:11,color:"var(--text-3)"}}>Delete this transaction?</span>
              <button onClick={()=>{onDelete(tx.id);onClose();}} style={{...btnBase,background:"rgba(255,69,58,0.12)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.3)",padding:"5px 12px"}}>Confirm</button>
              <button onClick={()=>setConfirmDelete(false)} style={{...btnBase,padding:"5px 10px",fontSize:11}}>Cancel</button>
            </>
          : <button onClick={()=>setConfirmDelete(true)} style={{...btnBase,background:"rgba(255,69,58,0.07)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.2)",padding:"5px 12px",fontSize:11}}>Delete</button>
        }
        <button onClick={onClose} style={{...btnBase,padding:"5px 10px",fontSize:11,marginLeft:"auto"}}>Done</button>
      </div>
    </div>
  );
}

// â”€â”€ MiniBar â€” compact sparkline bar chart (clickable) â”€â”€â”€â”€â”€â”€â”€â”€â”€
function MiniBar({ months, valueKey, color, label, fmt=null, onBarClick=null, marginMode=false }) {
  const [hov, setHov] = useState(null);
  const H = 72;
  const vals = months.map(([,v])=> {
    if(valueKey==="net") return v.rev-v.exp;
    if(valueKey==="margin") return v.rev>0?((v.rev-v.exp)/v.rev)*100:0;
    return v[valueKey]||0;
  });
  const max = Math.max(...vals.map(Math.abs), 1);
  if(months.length===0) return <div style={{height:H,display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text-3)",fontSize:11}}>No data yet</div>;
  return (
    <div style={{position:"relative",paddingTop:32}}>
      <div style={{display:"flex",gap:2,alignItems:"flex-end",height:H}}>
        {months.map(([mo,v],i)=>{
          const val = vals[i];
          const px  = Math.max(3, Math.round((Math.abs(val)/max)*H));
          const isProj = !!(v && v.projected);
          const c = isProj ? "#bbbbbb"
            : marginMode
            ? (val >= 30 ? "#30d158" : val >= 0 ? "#aaaaaa" : "#ff453a")
            : color || (val>=0?"#30d158":"#ff453a");
          const canClick = !!onBarClick && !isProj;
          return (
            <div key={mo} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",height:H,justifyContent:"flex-end",position:"relative",cursor:canClick?"pointer":"default"}}
              onMouseEnter={()=>setHov(i)} onMouseLeave={()=>setHov(null)}
              onClick={()=>canClick&&onBarClick(mo,valueKey)}>
              <div style={{width:"100%",borderRadius:"2px 2px 0 0",height:px,transition:"height 0.3s ease",
                background:isProj?(hov===i?"#aaaaaa":"#cccccc"):(hov===i?c:`${c}bb`),
                opacity:isProj?0.5:1,
                backgroundImage:isProj?"repeating-linear-gradient(45deg,transparent,transparent 3px,rgba(255,255,255,0.4) 3px,rgba(255,255,255,0.4) 6px)":"none",
                outline:canClick&&hov===i?"2px solid "+c:"none",outlineOffset:1}}/>
              {hov===i&&(
                <div className="chart-tooltip" style={{bottom:"calc(100% + 6px)",left:"50%",fontSize:11}}>
                  <div style={{color:"rgba(255,255,255,0.55)",fontSize:9,marginBottom:2}}>{moLabel(mo)}{isProj?" Â· projected":""}</div>
                  <div style={{color:"#fff",fontWeight:700}}>{fmt ? fmt(val) : fmt$(val)}</div>
                  {canClick&&<div style={{color:"rgba(255,255,255,0.4)",fontSize:8,marginTop:2}}>tap to drill in</div>}
                </div>
              )}
            </div>
          );
        })}
      </div>
      <div style={{display:"flex",marginTop:4}}>
        {months.map(([mo],i)=>(
          <div key={mo} style={{flex:1,textAlign:"center",fontSize:8,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",
            opacity: months.length>12 ? (i%3===0?1:0) : 1
          }}>{moLabel(mo).split(" ")[0]}</div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€ MonthDrillDown â€” modal showing transactions for a clicked bar â”€â”€
function MonthDrillDown({ mo, type, txs, onClose, doTag, doDelete, doBulkTag, doBulkDelete, getSuggestion }) {
  const [tagging, setTagging] = useState(null);
  const [txFilter, setTxFilter] = useState(type==="rev"?"in":type==="exp"?"out":"all");
  // All txs for this month â€” let TxList filter handle in/out toggle
  const moTxs = txs.filter(t => t.date?.slice(0,7) === mo);
  const total = moTxs.filter(t=>txFilter==="all"||(txFilter==="in"&&t.type==="in")||(txFilter==="out"&&t.type==="out"))
    .reduce((s,t)=> t.type==="in" ? s+Math.abs(t.amount) : s-Math.abs(t.amount), 0);
  const typeLabel = type==="rev"?"Revenue":type==="exp"?"Expenses":"Net";

  return (
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:1000,display:"flex",alignItems:"center",justifyContent:"center",padding:16}}
      onClick={e=>{if(e.target===e.currentTarget)onClose();}}>
      <div style={{background:"#f5f5f7",borderRadius:20,width:"100%",maxWidth:680,maxHeight:"85vh",display:"flex",flexDirection:"column",overflow:"hidden",boxShadow:"0 24px 80px rgba(0,0,0,0.35)"}}>
        {/* Header */}
        <div style={{padding:"16px 20px 12px",borderBottom:"1px solid rgba(0,0,0,0.08)",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
          <div>
            <div style={{fontSize:12,color:"var(--text-3)",marginBottom:2}}>{moLabel(mo)} Â· {typeLabel}</div>
            <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:total>=0?"#30d158":"#ff453a"}}>{fmt$(Math.abs(total))}</div>
          </div>
          <button onClick={onClose} style={{background:"rgba(0,0,0,0.06)",border:"none",borderRadius:20,width:32,height:32,fontSize:16,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>âœ•</button>
        </div>
        {/* Transaction list â€” full filter/tag/delete capability */}
        <div style={{overflowY:"auto",flex:1,padding:"8px 12px 24px"}}>
          {moTxs.length===0
            ? <div style={{textAlign:"center",padding:"40px 0",color:"var(--text-3)",fontSize:13}}>No transactions for this period</div>
            : <TxList
                txs={moTxs}
                tagging={tagging} setTagging={setTagging}
                doTag={doTag} doDelete={doDelete}
                doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
                filter={txFilter} setFilter={setTxFilter} getSuggestion={getSuggestion}
              />
          }
        </div>
      </div>
    </div>
  );
}

// â”€â”€ BarChart with hover tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BarChart({ months, colorKey="green", label="Revenue" }) {
  const [hov, setHov] = useState(null);
  const H = 90;
  const vals = months.map(([,v])=> colorKey==="green" ? v.rev : colorKey==="red" ? v.exp : v.rev-v.exp);
  const max  = Math.max(...vals, 1);

  if(months.length===0) return (
    <div style={{height:H,display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text-3)",fontSize:12}}>
      No data â€” sync transactions
    </div>
  );

  return (
    <div style={{position:"relative"}}>
      <div style={{display:"flex",gap:3,alignItems:"flex-end",height:H,padding:"0 4px"}}>
        {months.map(([mo,v],i)=>{
          const val  = colorKey==="green"?v.rev:colorKey==="red"?v.exp:v.rev-v.exp;
          const px   = Math.max(3, Math.round((val/max)*H));
          const color= colorKey==="green"?"#30d158":colorKey==="red"?"#ff453a":val>=0?"#30d158":"#ff453a";
          return (
            <div key={mo} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",position:"relative",height:H,justifyContent:"flex-end"}}
              onMouseEnter={()=>setHov(i)} onMouseLeave={()=>setHov(null)}>
              <div style={{
                width:"100%",borderRadius:"3px 3px 0 0",
                background: hov===i ? color : `${color}cc`,
                height:px,
                transition:"height 0.3s ease, background 0.15s",
                cursor:"pointer",
              }}/>
              {hov===i&&(
                <div className="chart-tooltip" style={{bottom:"calc(100% + 8px)",left:"50%"}}>
                  <div style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",marginBottom:3}}>{moLabel(mo)}</div>
                  <div style={{fontSize:14,fontWeight:700,color:color}}>{fmt$(val)}</div>
                  <div style={{fontSize:10,color:"var(--text-3)",marginTop:2}}>{label}</div>
                </div>
              )}
            </div>
          );
        })}
      </div>
      <div style={{display:"flex",marginTop:6,padding:"0 4px"}}>
        {months.map(([mo])=>(
          <div key={mo} style={{flex:1,textAlign:"center",fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{moLabel(mo).slice(0,3)}</div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€ Smooth Projection Chart with draggable scrubber â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ProjectionChart({ data }) {
  const svgRef = useRef(null);
  const [scrubX, setScrubX] = useState(null);  // pixel x within SVG
  const [isDragging, setIsDragging] = useState(false);
  const W=600, H=220, PL=50, PR=20, PT=20, PB=30;
  const CW=W-PL-PR, CH=H-PT-PB;

  const lines=[
    {key:"rev",color:"#30d158",label:"Revenue"},
    {key:"exp",color:"#ff453a",label:"Expenses"},
    {key:"net",color:"#444",label:"Net Income"},
  ];

  const allVals=data.flatMap(d=>[d.rev,d.exp,d.net]);
  const minV=Math.min(0,...allVals), maxV=Math.max(...allVals,1);
  const scaleY=v=>PT+CH*(1-(v-minV)/(maxV-minV));
  const scaleX=i=>PL+CW*(i/(data.length-1));

  // Smooth cubic bezier path
  const smoothPath=key=>{
    const pts=data.map((d,i)=>([scaleX(i),scaleY(d[key])]));
    if(pts.length<2) return "";
    let d=`M${pts[0][0]},${pts[0][1]}`;
    for(let i=0;i<pts.length-1;i++){
      const cp1x=pts[i][0]+(pts[i+1][0]-pts[i][0])*0.4;
      const cp1y=pts[i][1];
      const cp2x=pts[i][0]+(pts[i+1][0]-pts[i][0])*0.6;
      const cp2y=pts[i+1][1];
      d+=` C${cp1x},${cp1y} ${cp2x},${cp2y} ${pts[i+1][0]},${pts[i+1][1]}`;
    }
    return d;
  };

  // Find which data point scrubX is closest to
  const activeIdx = scrubX===null ? null : Math.min(data.length-1, Math.max(0,
    Math.round((scrubX - PL) / CW * (data.length-1))
  ));

  const getSVGX = e => {
    if(!svgRef.current) return null;
    const rect=svgRef.current.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const ratio = (clientX-rect.left)/rect.width;
    return ratio*W;
  };

  const onMove = e => {
    if(e.type==="mousemove"&&!isDragging&&e.buttons===0) {
      setScrubX(getSVGX(e));
    } else if(isDragging || e.type==="mousemove") {
      setScrubX(getSVGX(e));
    } else if(e.touches) {
      setScrubX(getSVGX(e));
    }
  };

  const activeData = activeIdx!==null ? data[activeIdx] : null;
  const scrubLineX = activeIdx!==null ? scaleX(activeIdx) : null;

  return (
    <div>
      <svg ref={svgRef} viewBox={`0 0 ${W} ${H}`} style={{width:"100%",height:"auto",overflow:"visible",cursor:"crosshair",userSelect:"none"}}
        onMouseMove={onMove} onMouseLeave={()=>{setScrubX(null);setIsDragging(false);}}
        onMouseDown={()=>setIsDragging(true)} onMouseUp={()=>setIsDragging(false)}
        onTouchMove={onMove} onTouchStart={onMove} onTouchEnd={()=>setScrubX(null)}>
        <defs>
          {lines.map(l=>(
            <linearGradient key={l.key} id={`pg_${l.key}`} x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stopColor={l.color} stopOpacity="0.18"/>
              <stop offset="100%" stopColor={l.color} stopOpacity="0.02"/>
            </linearGradient>
          ))}
        </defs>

        {/* Grid */}
        {[0,0.25,0.5,0.75,1].map(f=>{
          const y=PT+CH*f;
          const val=maxV-(maxV-minV)*f;
          return (
            <g key={f}>
              <line x1={PL} y1={y} x2={W-PR} y2={y} stroke="rgba(0,0,0,0.07)" strokeWidth="1" strokeDasharray="3,4"/>
              <text x={PL-6} y={y+4} textAnchor="end" style={{fontSize:8,fill:"rgba(26,26,46,0.35)",fontFamily:"'JetBrains Mono',monospace"}}>{fmt$(val).replace("$","")}</text>
            </g>
          );
        })}

        {/* Area fills */}
        {lines.map(l=>{
          const path=smoothPath(l.key);
          const lastX=scaleX(data.length-1);
          return <path key={l.key} d={path+` L${lastX},${H-PB} L${PL},${H-PB} Z`} fill={`url(#pg_${l.key})`}/>;
        })}

        {/* Lines */}
        {lines.map(l=>(
          <path key={l.key} d={smoothPath(l.key)} fill="none" stroke={l.color} strokeWidth="2.5"
            strokeLinecap="round" strokeLinejoin="round"/>
        ))}

        {/* Scrub line */}
        {scrubLineX!==null&&(
          <line x1={scrubLineX} y1={PT} x2={scrubLineX} y2={H-PB}
            stroke="rgba(26,26,46,0.25)" strokeWidth="1.5" strokeDasharray="3,3"/>
        )}

        {/* Dots at scrub position */}
        {activeIdx!==null&&lines.map(l=>(
          <circle key={l.key} cx={scaleX(activeIdx)} cy={scaleY(activeData[l.key])} r="5"
            fill={l.color} stroke="white" strokeWidth="2"/>
        ))}

        {/* X axis labels */}
        {data.map((d,i)=>(
          <text key={i} x={scaleX(i)} y={H-4} textAnchor="middle"
            style={{fontSize:9,fill:activeIdx===i?"rgba(26,26,46,0.8)":"rgba(26,26,46,0.35)",fontFamily:"'JetBrains Mono',monospace",fontWeight:activeIdx===i?"700":"400"}}>
            {d.year}
          </text>
        ))}
      </svg>

      {/* Live ticker â€” shows active data or last year by default */}
      {(()=>{
        const d=activeData||data[data.length-1];
        const yr=activeData?d.year:`${d.year} (proj.)`;
        return (
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:8,marginTop:12}}>
            {[
              {l:"Year",     v:yr,           c:"var(--text)"},
              {l:"Revenue",  v:fmt$(d.rev),  c:"#30d158"},
              {l:"Expenses", v:fmt$(d.exp),  c:"#ff453a"},
              {l:"Net Income",v:fmt$(d.net), c:d.net>=0?"#30d158":"#ff453a"},
            ].map(item=>(
              <div key={item.l} style={{background:"rgba(255,255,255,0.5)",border:"1px solid rgba(255,255,255,0.7)",borderRadius:10,padding:"12px 14px",textAlign:"center",transition:"all 0.1s"}}>
                <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:5}}>{item.l}</div>
                <div style={{fontSize:16,fontWeight:800,color:item.c,fontFamily:"'JetBrains Mono',monospace",letterSpacing:"-0.02em",transition:"all 0.08s"}}>{item.v}</div>
              </div>
            ))}
          </div>
        );
      })()}

      <div style={{display:"flex",gap:16,marginTop:12,justifyContent:"center"}}>
        {lines.map(l=>(
          <div key={l.key} style={{display:"flex",alignItems:"center",gap:5}}>
            <div style={{width:20,height:2.5,background:l.color,borderRadius:2}}/>
            <span style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{l.label}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€ ManualIncomeModal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ManualIncomeModal({ manual, onSave, onClose }) {
  const MONTHS = [
    "2025-01","2025-02","2025-03","2025-04","2025-05","2025-06",
    "2025-07","2025-08","2025-09","2025-10","2025-11","2025-12",
    "2026-01","2026-02","2026-03","2026-04","2026-05","2026-06",
    "2026-07","2026-08","2026-09","2026-10","2026-11","2026-12",
  ];
  const [vals, setVals] = useState({...manual});

  return (
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:16}}>
      <div className="glass" style={{width:"100%",maxWidth:480,maxHeight:"80vh",overflowY:"auto",padding:24,borderRadius:20}}>
        <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>Manual Airbnb Income</div>
        <div style={{fontSize:12,color:"var(--text-3)",marginBottom:20}}>
          Enter your exact Airbnb payout totals per month from the Airbnb app. Manual entries override Plaid data for that month â€” no double counting.
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          {MONTHS.map(mo=>(
            <div key={mo}>
              <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",marginBottom:3}}>{moLabel(mo)}</div>
              <input
                type="number"
                placeholder="0"
                value={vals[mo]||""}
                onChange={e=>setVals(v=>({...v,[mo]:parseFloat(e.target.value)||0}))}
                style={{width:"100%",padding:"7px 10px",borderRadius:8,border:"1px solid rgba(0,0,0,0.12)",fontSize:13,fontFamily:"'JetBrains Mono',monospace",background:"rgba(255,255,255,0.6)",boxSizing:"border-box"}}
              />
            </div>
          ))}
        </div>
        <div style={{display:"flex",gap:8,marginTop:20,justifyContent:"flex-end"}}>
          <button onClick={onClose} style={{padding:"8px 16px",borderRadius:10,border:"1px solid rgba(0,0,0,0.1)",background:"transparent",cursor:"pointer",fontSize:13}}>Cancel</button>
          <button onClick={()=>{onSave(vals);onClose();}} className="btn-primary">Save</button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ InvestModal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function InvestModal({ invest, onSave, onClose }) {
  const [vals, setVals] = useState({...invest});
  const props = PROPERTIES.filter(p=>["lockwood","everton","bstreet","pierce"].includes(p.id));
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="glass fade-in" style={{width:400,padding:28}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:17,fontWeight:700,marginBottom:6}}>Down Payments</div>
        <div style={{fontSize:12,color:"var(--text-3)",marginBottom:22}}>Enter the initial down payment for each property. Cash-on-cash return is calculated automatically from your Plaid expense data.</div>
        {props.map(p=>(
          <div key={p.id} style={{marginBottom:16}}>
            <div style={{fontSize:11,color:p.color,fontFamily:"'JetBrains Mono',monospace",fontWeight:700,marginBottom:6,textTransform:"uppercase",letterSpacing:"0.08em"}}>{p.label}</div>
            <div style={{position:"relative"}}>
              <span style={{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",color:"var(--text-3)",fontSize:14}}>$</span>
              <input type="number" value={vals[p.id]||""} onChange={e=>setVals(v=>({...v,[p.id]:+e.target.value}))}
                placeholder="0"
                style={{width:"100%",background:"rgba(0,0,0,0.04)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:10,padding:"10px 12px 10px 26px",color:"var(--text)",fontSize:15,fontWeight:600,fontFamily:"'JetBrains Mono',monospace",outline:"none"}}/>
            </div>
          </div>
        ))}
        <div style={{display:"flex",gap:10,marginTop:24,justifyContent:"flex-end"}}>
          <button onClick={onClose} className="btn-ghost">Cancel</button>
          <button onClick={()=>{onSave(vals);onClose();}} className="btn-primary">Save</button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ TxList â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ TxList with bulk select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TxList({ txs, tagging, setTagging, doTag, doDelete, doBulkTag, doBulkDelete, filter, setFilter, getSuggestion }) {
  const [selected, setSelected] = useState(new Set());

  const filtered = filter==="in" ? txs.filter(t=>t.type==="in") : filter==="out" ? txs.filter(t=>t.type==="out") : txs;
  const sorted   = [...filtered].sort((a,b)=>b.date.localeCompare(a.date));
  const allSel   = sorted.length>0 && sorted.every(t=>selected.has(t.id));
  const selCount = selected.size;

  const toggle = (id,e) => { e && e.stopPropagation(); setSelected(p=>{const n=new Set(p); n.has(id)?n.delete(id):n.add(id); return n;}); setTagging(null); };
  const toggleAll = () => setSelected(allSel ? new Set() : new Set(sorted.map(t=>t.id)));
  const clearSel  = () => setSelected(new Set());

  const handleBulkTag = pid => { doBulkTag([...selected], pid); clearSel(); };
  const handleBulkDel = ()  => { doBulkDelete([...selected]); clearSel(); };

  const Checkbox = ({id, checked, onToggle}) => (
    <div onClick={e=>{e.stopPropagation(); onToggle ? onToggle() : toggle(id,e);}} style={{width:18,height:18,borderRadius:5,border:`1.5px solid ${checked?"#1a1a2e":"rgba(0,0,0,0.2)"}`,background:checked?"#1a1a2e":"transparent",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all 0.12s"}}>
      {checked&&<span style={{color:"white",fontSize:10,lineHeight:1,fontWeight:700}}>âœ“</span>}
    </div>
  );

  return (
    <div>
      {/* Toolbar */}
      <div style={{display:"flex",gap:8,marginBottom:12,alignItems:"center",flexWrap:"wrap"}}>
        <div className="seg-ctrl">
          {[["all","All"],["in","â†“ In"],["out","â†‘ Out"]].map(([k,l])=>(
            <button key={k} className={`seg-btn${filter===k?" active":""}`} onClick={()=>{setFilter(k);clearSel();}}>{l}</button>
          ))}
        </div>
        <span style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{sorted.length} transactions</span>

        {selCount>0&&(
          <div style={{display:"flex",gap:5,alignItems:"center",marginLeft:"auto",flexWrap:"wrap"}}>
            <span style={{fontSize:11,fontWeight:700,fontFamily:"'JetBrains Mono',monospace",color:"var(--text-2)",marginRight:2}}>{selCount} selected â€”</span>
            {PROPERTIES.filter(p=>p.id!=="transfer").map(p=>(
              <button key={p.id} onClick={()=>handleBulkTag(p.id)}
                style={{background:"rgba(0,0,0,0.06)",color:"var(--text)",border:"1px solid rgba(0,0,0,0.12)",borderRadius:8,padding:"4px 10px",fontSize:10,fontFamily:"'JetBrains Mono',monospace",fontWeight:600,cursor:"pointer"}}>
                {p.label}
              </button>
            ))}
            <button onClick={handleBulkDel}
              style={{background:"rgba(255,69,58,0.1)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.3)",borderRadius:8,padding:"4px 10px",fontSize:10,fontFamily:"'JetBrains Mono',monospace",fontWeight:700,cursor:"pointer"}}>
              Delete {selCount}
            </button>
            <button onClick={clearSel} style={{background:"rgba(0,0,0,0.05)",color:"var(--text-3)",border:"1px solid rgba(0,0,0,0.1)",borderRadius:8,padding:"4px 8px",fontSize:10,cursor:"pointer"}}>âœ•</button>
          </div>
        )}
      </div>

      {sorted.length===0&&<div style={{textAlign:"center",padding:"32px 0",color:"var(--text-3)",fontSize:13}}>No transactions</div>}

      {sorted.length>0&&(
        <div className="glass" style={{overflow:"hidden"}}>
          <div style={{display:"grid",gridTemplateColumns:"36px 72px 22px 1fr 100px 120px",padding:"8px 14px",borderBottom:"1px solid rgba(0,0,0,0.06)",gap:8,alignItems:"center"}}>
            <Checkbox id="__all__" checked={allSel} onToggle={toggleAll}/>
            {["DATE","","PAYEE","AMOUNT","PROPERTY"].map(h=>(
              <span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em"}}>{h}</span>
            ))}
          </div>
          {sorted.map(tx=>{
            const isSel = selected.has(tx.id);
            return (
              <div key={tx.id}>
                <div style={{display:"grid",gridTemplateColumns:"36px 72px 22px 1fr 100px 120px",padding:"10px 14px",borderBottom:"1px solid rgba(0,0,0,0.04)",gap:8,alignItems:"center",cursor:"pointer",transition:"background 0.1s",background:isSel?"rgba(10,132,255,0.06)":"transparent"}}
                  onClick={()=>{ if(selCount>0){toggle(tx.id);return;} setTagging(t=>t===tx.id?null:tx.id); }}
                  onMouseEnter={e=>{if(!isSel)e.currentTarget.style.background="rgba(0,0,0,0.025)";}}
                  onMouseLeave={e=>{if(!isSel)e.currentTarget.style.background="transparent";}}>
                  <div onClick={e=>toggle(tx.id,e)}><Checkbox id={tx.id} checked={isSel}/></div>
                  <span style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{fmtDate(tx.date)}</span>
                  <span className={tx.type==="in"?"dir-in":"dir-out"}>{tx.type==="in"?"â†“":"â†‘"}</span>
                  <div style={{overflow:"hidden"}}>
                    <div style={{fontSize:13,fontWeight:500,lineHeight:1.3,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{tx.payee}</div>
                    {tx.account&&<div style={{fontSize:10,color:"var(--text-3)",marginTop:1}}>{tx.account}</div>}
                  </div>
                  <span style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:13,color:tx.type==="in"?"#30d158":"#ff453a"}}>
                    {tx.type==="in"?"+":"-"}{fmtD(tx.amount)}
                  </span>
                  <div onClick={e=>e.stopPropagation()} style={{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:2}}>
                    <span onClick={e=>{e.stopPropagation();setTagging(t=>t===tx.id?null:tx.id);}}>
                      <PropBadge id={tx.propId} small/>
                    </span>
                    {!tx.propId&&getSuggestion&&getSuggestion(tx)&&(
                      <span style={{fontSize:8,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",cursor:"pointer"}}
                        onClick={e=>{e.stopPropagation();doTag(tx.id,getSuggestion(tx));}}
                        title="Click to apply auto-tag suggestion">
                        ðŸ’¡ {getSuggestion(tx)}
                      </span>
                    )}
                  </div>
                </div>
                {tagging===tx.id&&(
                  <div style={{padding:"0 14px 12px",borderBottom:"1px solid rgba(0,0,0,0.04)"}}>
                    <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)} onDelete={doDelete}/>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}


// â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [tab, setTab]           = useState("Portfolio");
  const [txs, setTxs]           = useState(()=>LS.get(TX_KEY)||[]);
  const [tags, setTags]         = useState(()=>LS.get(TAGS_KEY)||{});
  const [autoTags, setAutoTags] = useState(()=>LS.get(AUTO_KEY)||DEFAULT_AUTO);
  const [tagging, setTagging]   = useState(null);
  const [linked, setLinked]     = useState([]);
  const [syncing, setSyncing]   = useState(false);
  const [status, setStatus]     = useState(null);
  const [linking, setLinking]   = useState(false);
  const [invest, setInvest]     = useState(()=>LS.get(INVEST_KEY)||DEFAULT_INVEST);
  // Manual income starts empty â€” user fills via âœŽ button in nav
  // Previously-saved entries persist in localStorage
  const [manualIncome, setManualIncome] = useState(()=>LS.get(MANUAL_KEY)||{});
  const [showManual, setShowManual] = useState(false);
  const [showInvest, setShowInvest] = useState(false);
  const [feedFilter, setFeedFilter] = useState("untagged");
  const [txFilter, setTxFilter] = useState("all");
  const [airbnbTxFilter, setAirbnbTxFilter] = useState("all");
  const [drillDown, setDrillDown] = useState(null); // {mo:"2025-11", type:"rev"|"exp"|"net", txs:[]}
  const [pierceTxFilter, setPierceTxFilter] = useState("all");

  useEffect(()=>{
    // Load bank connections
    fetch(`${BACKEND}/api/link-status`).then(r=>r.json()).then(d=>setLinked(d.accounts||[])).catch(()=>{});
    // Load server-side transactions (authoritative, deduplicated)
    fetch(`${BACKEND}/api/transactions/all`).then(r=>r.json()).then(data=>{
      if(data.transactions&&data.transactions.length>0){
        const arr=[...data.transactions].sort((a,b)=>b.date.localeCompare(a.date));
        setTxs(arr);
        LS.set(TX_KEY,arr);
      }
    }).catch(()=>{});
  },[]);

  // Auto-tag: record suggestions only â€” user must confirm via Feed
  const applyAuto = useCallback((newTxs,at,cur)=>{
    // NO auto-application â€” just return existing tags unchanged
    // Auto-tag suggestions shown in Feed but not applied until user clicks
    return cur;
  },[]);

  // Get auto-tag suggestion for a tx (used in Feed to show hint)
  const getSuggestion = useCallback((tx)=>{
    if(tags[tx.id]) return null;
    const key=Object.keys(autoTags).find(k=>tx.payee?.toUpperCase().includes(k.toUpperCase()));
    return key ? autoTags[key] : null;
  },[tags,autoTags]);

  // Load all server-stored transactions (deduplicated server-side)
  const loadAll = useCallback(async(silent=false)=>{
    try {
      const res=await fetch(`${BACKEND}/api/transactions/all`);
      const data=await res.json();
      if(data.error) return;
      const arr=[...data.transactions].sort((a,b)=>b.date.localeCompare(a.date));
      setTxs(arr);
      LS.set(TX_KEY,arr);
      setTags(prev=>{ const u=applyAuto(arr,autoTags,prev); LS.set(TAGS_KEY,u); return u; });
      if(!silent) setStatus(`Loaded ${arr.length} transactions`);
    } catch(e){ if(!silent) setStatus("Load failed: "+e.message); }
  },[autoTags,applyAuto]);

  const sync = useCallback(async()=>{
    setSyncing(true); setStatus(null);
    try {
      const res=await fetch(`${BACKEND}/api/transactions/sync`);
      const data=await res.json();
      if(data.error) throw new Error(data.error);
      await loadAll(true);
      setStatus(`Synced Â· ${data.total_stored} transactions total`);
    } catch(e){setStatus("Sync failed: "+e.message);}
    finally{setSyncing(false);}
  },[loadAll]);

  const pullHistory = useCallback(async()=>{
    setSyncing(true); setStatus("Pulling 2 years of history â€” this may take 30s...");
    try {
      const res=await fetch(`${BACKEND}/api/transactions/historical`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});
      const data=await res.json();
      if(data.errors&&data.errors.length) setStatus(`Done with errors: ${data.errors[0]}`);
      await loadAll(true);
      setStatus(`âœ“ ${data.total_stored} transactions loaded (${data.pulled} pulled from history)`);
    } catch(e){setStatus("History pull failed: "+e.message);}
    finally{setSyncing(false);}
  },[loadAll]);

  const connectBank=useCallback(async()=>{
    setLinking(true); setStatus(null);
    try {
      const {link_token,error}=await fetch(`${BACKEND}/api/create-link-token`,{method:"POST"}).then(r=>r.json());
      if(error) throw new Error(error);
      window.Plaid.create({
        token:link_token,
        onSuccess:async(public_token,meta)=>{
          const name=meta?.institution?.name||"Bank Account";
          const ex=await fetch(`${BACKEND}/api/exchange-token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({public_token,account_name:name})}).then(r=>r.json());
          const ls=await fetch(`${BACKEND}/api/link-status`).then(r=>r.json());
          setLinked(ls.accounts||[]);
          // Pull 2 years of history immediately â€” this is what gets years of data like Copilot
          setStatus(`${name} connected â€” pulling 2 years of history...`);
          try {
            const hr=await fetch(`${BACKEND}/api/transactions/historical`,{
              method:"POST",headers:{"Content-Type":"application/json"},
              body:JSON.stringify({item_id:ex.item_id})
            }).then(r=>r.json());
            await loadAll(true);
            // Also run sync to catch anything from last 90 days not in historical
            await fetch(`${BACKEND}/api/transactions/sync`).then(r=>r.json());
            await loadAll(true);
            setStatus(`âœ“ ${name} â€” ${hr.total_stored||0} transactions loaded`);
          } catch(e) {
            setStatus(`${name} connected. Hit Sync to load transactions.`);
          }
        },
        onExit:err=>{if(err)setStatus("Exited: "+err.display_message);}
      }).open();
    } catch(e){setStatus("Could not open Plaid: "+e.message);}
    finally{setLinking(false);}
  },[sync]);

  const removeAccount=async(item_id)=>{
    await fetch(`${BACKEND}/api/remove-account`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item_id})});
    setLinked(prev=>prev.filter(a=>a.item_id!==item_id));
  };

  function doTag(txId,propId){
    const tx=txs.find(t=>t.id===txId);
    const nextTags={...tags,[txId]:propId};
    if(tx?.payee&&propId!=="transfer"&&propId!=="llc"){
      const key=tx.payee.toUpperCase();
      const nextAuto={...autoTags,[key]:propId};
      txs.forEach(t=>{if(!nextTags[t.id]&&t.payee?.toUpperCase()===key)nextTags[t.id]=propId;});
      setAutoTags(nextAuto); LS.set(AUTO_KEY,nextAuto);
    }
    setTags(nextTags); LS.set(TAGS_KEY,nextTags); setTagging(null);
  }

  function doDelete(txId){
    // Soft-delete: tag as "deleted" so it stays visible in the archive
    const nextTags={...tags,[txId]:"deleted"};
    setTags(nextTags); LS.set(TAGS_KEY,nextTags); setTagging(null);
  }

  function doRestore(txId){
    const nextTags={...tags}; delete nextTags[txId];
    setTags(nextTags); LS.set(TAGS_KEY,nextTags);
  }

  function doBulkTag(ids, propId){
    const nextTags={...tags};
    ids.forEach(id=>{ nextTags[id]=propId; });
    setTags(nextTags); LS.set(TAGS_KEY,nextTags);
  }

  function doBulkDelete(ids){
    const nextTags={...tags};
    ids.forEach(id=>{ nextTags[id]="deleted"; });
    setTags(nextTags); LS.set(TAGS_KEY,nextTags);
  }

  const saveInvest=vals=>{ setInvest(vals); LS.set(INVEST_KEY,vals); };
  const saveManual=vals=>{ setManualIncome(vals); LS.set(MANUAL_KEY,vals); };

  // Deduplicate by id â€” Plaid can return the same transaction more than once
  const allEnriched=useMemo(()=>{
    const seen=new Set();
    return txs.filter(t=>!t.pending).filter(t=>{
      if(seen.has(t.id)) return false;
      seen.add(t.id);
      return true;
    }).map(tx=>({...tx,propId:tags[tx.id]||null}));
  },[txs,tags]);
  // Active = not deleted or transferred (for all normal financial calcs)
  const enriched = allEnriched.filter(t=>t.propId!=="deleted");
  const archived  = allEnriched.filter(t=>t.propId==="deleted"||t.propId==="transfer");
  const untagged  = enriched.filter(t=>!t.propId);
  const tagged    = enriched.filter(t=>t.propId&&t.propId!=="transfer");

  // â”€â”€ Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const M=useMemo(()=>{
    const forProp=id=>tagged.filter(t=>t.propId===id);
    const propM={};
    PROPERTIES.forEach(p=>{
      const ptxs=forProp(p.id);
      const rev=sumIn(ptxs), exp=sumOut(ptxs);
      propM[p.id]={rev,exp,cf:rev-exp,txs:ptxs};
    });

    // Manual income OVERRIDES Plaid for that month â€” no double counting
    // Build set of months that have manual entries
    const manualMonths = new Set(Object.keys(manualIncome).filter(k=>manualIncome[k]>0));
    // Plaid airbnb rev â€” exclude any month covered by manual entry
    const airbnbRevPlaid = AIRBNB_IDS.reduce((s,id)=>{
      const ptxs = propM[id].txs || [];
      return s + ptxs.filter(t=>t.type==="in"&&!manualMonths.has(t.date?.slice(0,7))).reduce((a,t)=>a+Math.abs(t.amount),0);
    }, 0);
    const manualAirbnbRev = Object.values(manualIncome).reduce((s,v)=>s+(v||0),0);
    const airbnbRev = airbnbRevPlaid + manualAirbnbRev;
    const airbnbExp=AIRBNB_IDS.reduce((s,id)=>s+propM[id].exp,0);
    const pierceRev=propM.pierce.rev, pierceExp=propM.pierce.exp;
    const llcExp   =propM.llc.exp;
    const totalRev =airbnbRev+pierceRev;
    const totalExp =airbnbExp+pierceExp+llcExp;
    const totalCF  =totalRev-totalExp;

    // Monthly data â€” use ALL non-transfer enriched txs + manual income entries
    const months = (() => {
      const seen = new Set();
      const mo={};
      enriched.filter(t=>t.propId!=="transfer").forEach(t=>{
        if(seen.has(t.id)) return;
        seen.add(t.id);
        const k=t.date?.slice(0,7)||"?";
        if(!mo[k])mo[k]={rev:0,exp:0,manual:false};
        if(t.type==="in")  mo[k].rev+=Math.abs(t.amount);
        if(t.type==="out") mo[k].exp+=Math.abs(t.amount);
      });
      // Manual income OVERRIDES Airbnb Plaid rev for that month only
      // Pierce revenue is already in mo[k].rev â€” we keep it, just swap out airbnb portion
      Object.entries(manualIncome).forEach(([k,v])=>{
        if(!v) return;
        if(!mo[k])mo[k]={rev:0,exp:0,airbnbRev:0,manual:true};
        // Subtract airbnb plaid rev for this month (already counted above), add manual
        const airbnbPlaidForMonth = AIRBNB_IDS.reduce((s,id)=>{
          return s + (propM[id]?.txs||[]).filter(t=>t.type==="in"&&t.date?.slice(0,7)===k).reduce((a,t)=>a+Math.abs(t.amount),0);
        },0);
        mo[k].rev = (mo[k].rev - airbnbPlaidForMonth) + v;
        mo[k].manual=true;
      });
      return Object.entries(mo).sort((a,b)=>a[0].localeCompare(b[0]));
    })();

    const moCount = Math.max(months.length, 1);
    const annualRev = (totalRev/moCount)*12;
    const annualExp = (totalExp/moCount)*12;

    // Real estate metrics
    const totalInvest = Object.values(invest).reduce((s,v)=>s+v,0);
    const netMargin   = totalRev>0?(totalCF/totalRev)*100:null;
    const cocReturn   = totalInvest>0?(totalCF/totalInvest)*100:null;
    const annualCoc   = totalInvest>0?((totalCF/moCount*12)/totalInvest)*100:null;

    // Per-property CoC
    const propCoc={};
    ["lockwood","everton","bstreet","pierce"].forEach(id=>{ // per-property CoC only
      const inv=invest[id]||0;
      propCoc[id]=inv>0?(propM[id].cf/inv)*100:null;
    });

    // â”€â”€ Quarterly aggregation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const quarters = (() => {
      const qmap = {};
      enriched.filter(t=>t.propId!=="transfer"&&t.date).forEach(t=>{
        const [yr,mo] = t.date.split("-");
        const q = Math.ceil(+mo/3);
        const key = `${yr}-Q${q}`;
        if(!qmap[key]) qmap[key]={label:`Q${q} '${yr.slice(2)}`,year:+yr,q,key,rev:0,exp:0,txCount:0};
        if(t.type==="in")  qmap[key].rev += Math.abs(t.amount);
        if(t.type==="out") qmap[key].exp += Math.abs(t.amount);
        qmap[key].txCount++;
      });
      return Object.values(qmap)
        .sort((a,b)=>a.year!==b.year?a.year-b.year:a.q-b.q)
        .map(q=>({...q, net:q.rev-q.exp, margin:q.rev>0?((q.rev-q.exp)/q.rev)*100:0, expRatio:q.rev>0?(q.exp/q.rev)*100:0}));
    })();

    // Monthly seasonal projections for rest of FY26
    // STR seasonality index by month (1.0 = average) â€” peaks summer/holidays, dips Jan-Feb
    const STR_SEASONAL = {
      "01":0.72,"02":0.75,"03":0.90,"04":1.00,"05":1.10,
      "06":1.18,"07":1.22,"08":1.20,"09":1.05,"10":1.02,
      "11":0.95,"12":1.08
    };
    const today = new Date();
    const currentMoKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    // Compute monthly avg from actual data (airbnb only, last 6 months with data)
    const actualAirbnbMonths = months.filter(([k])=>k<=currentMoKey&&k>="2025-01");
    const avgAirbnbRev = actualAirbnbMonths.length>0
      ? actualAirbnbMonths.reduce((s,[,v])=>s+(v.rev||0),0)/actualAirbnbMonths.length
      : airbnbRev/Math.max(moCount,1);
    const avgAirbnbExp = actualAirbnbMonths.length>0
      ? actualAirbnbMonths.reduce((s,[,v])=>s+(v.exp||0),0)/actualAirbnbMonths.length
      : airbnbExp/Math.max(moCount,1);
    // Pierce is flat â€” use actual monthly avg
    const avgPierceRev = pierceRev/Math.max(moCount,1);
    const avgPierceExp = pierceExp/Math.max(moCount,1);
    // Build projected months for rest of 2026
    const projMonths = [];
    for(let m=1;m<=12;m++){
      const key=`2026-${String(m).padStart(2,'0')}`;
      if(key<=currentMoKey) continue; // skip months that already have actual data
      const si = STR_SEASONAL[String(m).padStart(2,'0')]||1.0;
      const projAirbnbRev = avgAirbnbRev * si;
      const projPierceRev = avgPierceRev;
      const projExp = (avgAirbnbExp * si) + avgPierceExp;
      projMonths.push([key,{rev:projAirbnbRev+projPierceRev, exp:projExp, projected:true}]);
    }
    // Combine actual + projected for full-year chart view
    const monthsWithProjections = [...months, ...projMonths];
    // 5-year annual projections (for table)
    const currentYear=new Date().getFullYear();
    const annualBase = (avgAirbnbRev+avgPierceRev)*12;
    const annualExpBase = (avgAirbnbExp+avgPierceExp)*12;
    const projections=Array.from({length:6},(_,i)=>{
      const yr=currentYear+i;
      const rev=annualBase*Math.pow(1.03,i);
      const exp=annualExpBase*Math.pow(1.02,i);
      return {year:yr,rev,exp,net:rev-exp,margin:rev>0?((rev-exp)/rev)*100:0};
    });

    return {propM,airbnbRev,airbnbExp,airbnbCF:airbnbRev-airbnbExp,pierceRev,pierceExp,pierceCF:pierceRev-pierceExp,llcExp,totalRev,totalExp,totalCF,netMargin,cocReturn,annualCoc,propCoc,months,monthsWithProjections,moCount,projections,annualRev,annualExp,quarters};
  },[tagged,enriched,invest,manualIncome]);

  const hasBank=linked.length>0||txs.length>0; // show content if we have txs even if linked state not yet resolved

  const clearAllData = () => {
    if(!window.confirm("Clear all cached transactions and tags? This cannot be undone.")) return;
    LS.set(TX_KEY, []); LS.set(TAGS_KEY, {}); LS.set(AUTO_KEY, {}); LS.set(MANUAL_KEY, {});
    setTxs([]); setTags({}); setAutoTags({}); setManualIncome({});
    // Also clear from server
    fetch(`${BACKEND}/api/transactions/delete`, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:"__ALL__"})}).catch(()=>{});
    setStatus("All local data cleared");
  };
  // Tabs: Portfolio | Airbnb | Pierce | Feed | Archive
  const TABS=["Portfolio","Airbnb","Pierce","Projections","Feed","Archive"];
  const feedTxs = feedFilter==="untagged"?untagged:feedFilter==="tagged"?tagged:enriched;

  // Tab icons
  const TAB_ICONS = {
    "Portfolio": <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>,
    "Airbnb":    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
    "Pierce":    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><circle cx="12" cy="13" r="2"/></svg>,
    "Feed":      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
    "Projections":<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
    "Archive":   <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5" rx="1"/><line x1="10" y1="12" x2="14" y2="12"/></svg>,
  };

  return (
    <div style={{minHeight:"100vh",background:"#f5f5f7"}}>

      {/* TOP HEADER */}
      <div className="top-header">
        <div style={{display:"flex",alignItems:"center",gap:8}}>
          <svg width="26" height="26" viewBox="0 0 32 32" fill="none"><ellipse cx="16" cy="13" rx="8" ry="7" fill="#1a1a2e"/><ellipse cx="16" cy="13" rx="5" ry="4.5" fill="#f5f5f7"/><circle cx="16" cy="13" r="2" fill="#1a1a2e"/><path d="M12 19c0 0-4 3-4 7h16c0-4-4-7-4-7" fill="#1a1a2e"/></svg>
          <span style={{fontWeight:700,fontSize:15,letterSpacing:"-0.01em"}}>Property Pigeon</span>
        </div>
        <div style={{display:"flex",gap:6,alignItems:"center"}}>
          {status&&<span style={{fontSize:10,color:"var(--text-3)",maxWidth:140,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{status}</span>}
          <button onClick={sync} disabled={syncing||!hasBank} style={{background:"transparent",border:"none",color:syncing?"var(--text-3)":"var(--text-2)",fontSize:12,fontWeight:500,padding:"4px 8px",borderRadius:8,cursor:"pointer"}}>
            {syncing?"â€¦":"â†» Sync"}
          </button>
          <button onClick={()=>setShowManual(true)} style={{background:"transparent",border:"none",color:"var(--text-3)",fontSize:12,padding:"4px 8px",borderRadius:8,cursor:"pointer"}}>âœŽ</button>
          <button onClick={connectBank} disabled={linking} style={{background:"#1a1a2e",border:"none",color:"#fff",fontSize:11,fontWeight:600,padding:"6px 12px",borderRadius:10,cursor:"pointer"}}>
            {linking?"â€¦":"+ Bank"}
          </button>
        </div>
      </div>

      {/* CONTENT */}
      <div className="page">

        {/* â”€â”€ PORTFOLIO â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        {tab==="Portfolio"&&(
          <div className="fade-in">
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Total Portfolio</div>
              <div style={{display:"flex",alignItems:"baseline",gap:10}}>
                <div className="big-num">{fmt$(M.totalRev)}</div>
                <div style={{fontSize:13,color:"var(--text-3)"}}>gross revenue</div>
              </div>
              <div style={{display:"flex",gap:16,marginTop:6}}>
                <span style={{fontSize:13,color:"#ff453a"}}>{fmt$(M.totalExp)} expenses</span>
                <span style={{fontSize:13,color:M.totalCF>=0?"#30d158":"#ff453a",fontWeight:600}}>{fmt$(M.totalCF)} net</span>
                {M.netMargin!==null&&<span style={{fontSize:13,color:"var(--text-3)"}}>{fmtPct(M.netMargin)} margin</span>}
              </div>
            </div>

            {/* Nudge to enter manual income if empty */}
            {Object.keys(manualIncome).length===0&&(
              <div style={{background:"rgba(0,0,0,0.04)",border:"1px solid rgba(0,0,0,0.08)",borderRadius:10,padding:"10px 14px",marginBottom:10,display:"flex",alignItems:"center",justifyContent:"space-between",gap:10}}>
                <span style={{fontSize:12,color:"var(--text-2)"}}>No Airbnb revenue entered yet â€” add monthly payouts to see accurate numbers</span>
                <button onClick={()=>setShowManual(true)} style={{fontSize:11,fontWeight:600,background:"#1a1a2e",color:"#fff",border:"none",borderRadius:8,padding:"5px 12px",cursor:"pointer",whiteSpace:"nowrap"}}>âœŽ Add Income</button>
              </div>
            )}

            {/* Summary cards */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
              {[
                {l:"Airbnb Revenue",  v:fmt$(M.airbnbRev), sub:"8 units"},
                {l:"Pierce Revenue",  v:fmt$(M.pierceRev), sub:"7 units"},
                {l:"Total Expenses",  v:fmt$(M.totalExp),  sub:"all properties", red:true},
                {l:"Net Income",      v:fmt$(M.totalCF),   sub:fmtPct(M.netMargin)+" margin", green:M.totalCF>=0},
              ].map(c=>(
                <div key={c.l} className="card card-padded">
                  <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>{c.l}</div>
                  <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                  <div style={{fontSize:11,color:"var(--text-3)",marginTop:2}}>{c.sub}</div>
                </div>
              ))}
            </div>

            {/* Month-by-month charts */}
            {M.months.length>0&&(<>
              <div className="section-title">Revenue Â· Month by Month <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>hatched = projected</span></div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="rev" color="#30d158" onBarClick={(mo)=>setDrillDown({mo,type:"rev",txs:enriched})}/>
              </div>

              <div className="section-title">Expenses Â· Month by Month</div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="exp" color="#ff453a" onBarClick={(mo)=>setDrillDown({mo,type:"exp",txs:enriched})}/>
              </div>

              <div className="section-title">Net Income Â· Month by Month</div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="net" color={null} onBarClick={(mo)=>setDrillDown({mo,type:"net",txs:enriched})}/>
              </div>

              <div className="section-title">Net Margin % Â· Month by Month <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>â‰¥30% healthy Â· grey=marginal Â· red=negative</span></div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="margin" color={null} marginMode fmt={v=>`${v.toFixed(1)}%`}/>
              </div>
            </>)}



            {/* CoC return */}
            {M.annualCoc&&(
              <>
                <div className="section-title">Return on Investment</div>
                <div className="card card-padded" style={{marginBottom:8}}>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
                    {[
                      {l:"Cash-on-Cash",v:fmtPct(M.annualCoc),sub:"annualized"},
                      {l:"Net Margin",  v:fmtPct(M.netMargin), sub:"total revenue"},
                    ].map(c=>(
                      <div key={c.l}>
                        <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:3}}>{c.l}</div>
                        <div style={{fontSize:20,fontWeight:700,letterSpacing:"-0.02em"}}>{c.v}</div>
                        <div style={{fontSize:10,color:"var(--text-3)"}}>{c.sub}</div>
                      </div>
                    ))}
                  </div>
                  <button onClick={()=>setShowInvest(true)} style={{marginTop:12,fontSize:11,color:"var(--text-3)",background:"none",border:"none",cursor:"pointer",textDecoration:"underline",padding:0}}>
                    Edit down payments â†’
                  </button>
                </div>
              </>
            )}
            {!M.annualCoc&&(
              <button onClick={()=>setShowInvest(true)} style={{fontSize:12,color:"var(--text-3)",background:"rgba(0,0,0,0.04)",border:"1px solid rgba(0,0,0,0.08)",borderRadius:10,padding:"8px 14px",cursor:"pointer",marginBottom:8,display:"block"}}>
                + Add down payments to see CoC return
              </button>
            )}
          </div>
        )}

        {/* â”€â”€ AIRBNB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        {tab==="Airbnb"&&(
          <div className="fade-in">
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Airbnb Portfolio Â· 8 units</div>
              <div className="big-num">{fmt$(M.airbnbRev)}</div>
              <div style={{display:"flex",gap:16,marginTop:6,flexWrap:"wrap"}}>
                <span style={{fontSize:13,color:"#ff453a"}}>{fmt$(M.airbnbExp)} expenses</span>
                <span style={{fontSize:13,color:M.airbnbCF>=0?"#30d158":"#ff453a",fontWeight:600}}>{fmt$(M.airbnbCF)} net</span>
                {M.airbnbRev>0&&<span style={{fontSize:13,color:"var(--text-3)"}}>{fmtPct((M.airbnbCF/M.airbnbRev)*100)} margin</span>}
              </div>
            </div>

            {/* KPI cards */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
              {[
                {l:"Gross Revenue",  v:fmt$(M.airbnbRev),  green:true},
                {l:"Total Expenses", v:fmt$(M.airbnbExp),  red:true},
                {l:"Net Income",     v:fmt$(M.airbnbCF),   green:M.airbnbCF>=0, red:M.airbnbCF<0},
                {l:"Net Margin",     v:M.airbnbRev>0?fmtPct((M.airbnbCF/M.airbnbRev)*100):"â€”", green:M.airbnbCF>=0},
              ].map(c=>(
                <div key={c.l} className="card card-padded">
                  <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>{c.l}</div>
                  <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                </div>
              ))}
            </div>

            {/* Month-by-month charts */}
            {M.months.length>0&&(()=>{
              // Build airbnb-only months â€” manual OVERRIDES Plaid rev for that month
              const aMo={};
              const manualMos = new Set(Object.keys(manualIncome).filter(k=>manualIncome[k]>0));
              tagged.filter(t=>AIRBNB_IDS.includes(t.propId)).forEach(t=>{
                const k=t.date?.slice(0,7)||"?";
                if(!aMo[k])aMo[k]={rev:0,exp:0};
                // Only count Plaid rev for months NOT covered by manual entry
                if(t.type==="in"&&!manualMos.has(k)) aMo[k].rev+=Math.abs(t.amount);
                if(t.type==="out") aMo[k].exp+=Math.abs(t.amount);
              });
              Object.entries(manualIncome).forEach(([k,v])=>{
                if(!v)return;
                if(!aMo[k])aMo[k]={rev:0,exp:0};
                aMo[k].rev=v; // override, not additive
              });
              // Add seasonal projections for rest of 2026
              const today2=new Date();
              const curMo2=`${today2.getFullYear()}-${String(today2.getMonth()+1).padStart(2,'0')}`;
              const STR_SI={"01":0.72,"02":0.75,"03":0.90,"04":1.00,"05":1.10,"06":1.18,"07":1.22,"08":1.20,"09":1.05,"10":1.02,"11":0.95,"12":1.08};
              const aActual=Object.entries(aMo).filter(([k])=>k<=curMo2);
              const aAvgRev=aActual.length>0?aActual.reduce((s,[,v])=>s+v.rev,0)/aActual.length:0;
              const aAvgExp=aActual.length>0?aActual.reduce((s,[,v])=>s+v.exp,0)/aActual.length:0;
              for(let m=1;m<=12;m++){
                const k=`2026-${String(m).padStart(2,'0')}`;
                if(k<=curMo2||aMo[k]) continue;
                const si=STR_SI[String(m).padStart(2,'0')]||1;
                aMo[k]={rev:aAvgRev*si,exp:aAvgExp*si,projected:true};
              }
              const aMths=Object.entries(aMo).sort((a,b)=>a[0].localeCompare(b[0]));
              if(aMths.length===0) return null;
              return (
                <>
                  <div className="section-title">Revenue Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="rev" color="#30d158" onBarClick={(mo)=>setDrillDown({mo,type:"rev",txs:enriched.filter(t=>AIRBNB_IDS.includes(t.propId)||(!t.propId&&t.type==="in"))})}/></div>
                  <div className="section-title">Expenses Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="exp" color="#ff453a" onBarClick={(mo)=>setDrillDown({mo,type:"exp",txs:enriched.filter(t=>AIRBNB_IDS.includes(t.propId))})}/></div>
                  <div className="section-title">Net Income Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="net" color={null} onBarClick={(mo)=>setDrillDown({mo,type:"net",txs:enriched.filter(t=>AIRBNB_IDS.includes(t.propId)||(!t.propId&&t.type==="in"))})}/></div>
                  <div className="section-title">Net Margin % Â· Month by Month <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>â‰¥30% healthy Â· grey=ok Â· red=negative</span></div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="margin" color={null} marginMode fmt={v=>`${v.toFixed(1)}%`}/></div>
                </>
              );
            })()}

            {/* Per-property EXPENSES only (revenue comes in as lump sum, can't split) */}
            <div className="section-title">Expenses by Property</div>
            <div className="card" style={{marginBottom:8,overflow:"hidden"}}>
              <div style={{display:"grid",gridTemplateColumns:"1fr auto",padding:"8px 16px",borderBottom:"1px solid rgba(0,0,0,0.06)",gap:8}}>
                <span style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.08em"}}>Property</span>
                <span style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.08em",textAlign:"right"}}>Expenses</span>
              </div>
              {["lockwood","everton","bstreet"].map((id,i)=>{
                const pm=M.propM[id]; const p=PROPERTIES.find(x=>x.id===id);
                const pct=M.airbnbExp>0?(pm.exp/M.airbnbExp)*100:0;
                return (
                  <div key={id} style={{padding:"12px 16px",borderBottom:i<2?"1px solid rgba(0,0,0,0.05)":"none"}}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:5}}>
                      <span style={{fontSize:13,fontWeight:600}}>{p.label}</span>
                      <span style={{fontSize:13,color:"#ff453a",fontFamily:"'JetBrains Mono',monospace",fontWeight:600}}>{fmt$(pm.exp)}</span>
                    </div>
                    <div style={{height:3,background:"rgba(0,0,0,0.06)",borderRadius:2,overflow:"hidden"}}>
                      <div style={{height:"100%",width:`${pct}%`,background:"#ff453a",borderRadius:2}}/>
                    </div>
                    <div style={{fontSize:10,color:"var(--text-3)",marginTop:3}}>{pct.toFixed(0)}% of total Airbnb expenses</div>
                  </div>
                );
              })}
            </div>

            {/* Transactions â€” unified All/In/Out */}
            <div className="section-title">Transactions</div>
            <TxList
              txs={enriched.filter(t=>AIRBNB_IDS.includes(t.propId)||(t.type==="in"&&!t.propId)||(t.type==="out"&&!t.propId))}
              tagging={tagging} setTagging={setTagging}
              doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
              filter={airbnbTxFilter} setFilter={setAirbnbTxFilter} getSuggestion={getSuggestion}
            />
          </div>
        )}

        {/* â”€â”€ PIERCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        {tab==="Pierce"&&(
          <div className="fade-in">
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Pierce Ave Â· 7 units Â· Section 8</div>
              <div className="big-num">{fmt$(M.pierceRev)}</div>
              <div style={{display:"flex",gap:16,marginTop:6,flexWrap:"wrap"}}>
                <span style={{fontSize:13,color:"#ff453a"}}>{fmt$(M.pierceExp)} expenses</span>
                <span style={{fontSize:13,color:M.pierceCF>=0?"#30d158":"#ff453a",fontWeight:600}}>{fmt$(M.pierceCF)} net</span>
                {M.pierceRev>0&&<span style={{fontSize:13,color:"var(--text-3)"}}>{fmtPct((M.pierceCF/M.pierceRev)*100)} margin</span>}
              </div>
            </div>

            {/* KPI cards */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
              {[
                {l:"Gross Rent",    v:fmt$(M.pierceRev),  green:true},
                {l:"Expenses",     v:fmt$(M.pierceExp),   red:true},
                {l:"Net Income",   v:fmt$(M.pierceCF),    green:M.pierceCF>=0, red:M.pierceCF<0},
                {l:"Net Margin",   v:M.pierceRev>0?fmtPct((M.pierceCF/M.pierceRev)*100):"â€”", green:M.pierceCF>=0},
              ].map(c=>(
                <div key={c.l} className="card card-padded">
                  <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>{c.l}</div>
                  <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                </div>
              ))}
            </div>

            {/* Month-by-month charts */}
            {(()=>{
              const pMo={};
              M.propM.pierce.txs.forEach(t=>{
                const k=t.date?.slice(0,7)||"?";
                if(!pMo[k])pMo[k]={rev:0,exp:0};
                if(t.type==="in") pMo[k].rev+=Math.abs(t.amount);
                if(t.type==="out") pMo[k].exp+=Math.abs(t.amount);
              });
              // Pierce is flat â€” project remaining 2026 months at same run rate
              const _now=new Date(); const curMo2=`${_now.getFullYear()}-${String(_now.getMonth()+1).padStart(2,'0')}`;
              const pActual=Object.entries(pMo).filter(([k])=>k<=curMo2);
              const pAvgRev=pActual.length>0?pActual.reduce((s,[,v])=>s+v.rev,0)/pActual.length:0;
              const pAvgExp=pActual.length>0?pActual.reduce((s,[,v])=>s+v.exp,0)/pActual.length:0;
              for(let m=1;m<=12;m++){
                const k=`2026-${String(m).padStart(2,'0')}`;
                if(k<=curMo2||pMo[k]) continue;
                pMo[k]={rev:pAvgRev,exp:pAvgExp,projected:true};
              }
              const pMths=Object.entries(pMo).sort((a,b)=>a[0].localeCompare(b[0]));
              if(pMths.length===0) return null;
              return (
                <>
                  <div className="section-title">Rent Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="rev" color="#30d158" onBarClick={(mo)=>setDrillDown({mo,type:"rev",txs:M.propM.pierce.txs})}/></div>
                  <div className="section-title">Expenses Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="exp" color="#ff453a" onBarClick={(mo)=>setDrillDown({mo,type:"exp",txs:M.propM.pierce.txs})}/></div>
                  <div className="section-title">Net Income Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="net" color={null} onBarClick={(mo)=>setDrillDown({mo,type:"net",txs:M.propM.pierce.txs})}/></div>
                  <div className="section-title">Net Margin % Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="margin" color={null} marginMode fmt={v=>`${v.toFixed(1)}%`}/></div>
                </>
              );
            })()}

            {/* Transactions */}
            <div className="section-title">Transactions</div>
            <TxList
              txs={M.propM.pierce.txs}
              tagging={tagging} setTagging={setTagging}
              doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
              filter={pierceTxFilter} setFilter={setPierceTxFilter} getSuggestion={getSuggestion}
            />
          </div>
        )}

        {/* â”€â”€ FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        {tab==="Feed"&&(
          <div className="fade-in">
            <div className="page-header" style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between"}}>
              <div>
                <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Transaction Feed</div>
                <div style={{display:"flex",gap:8,alignItems:"center"}}>
                  <div className="big-num" style={{fontSize:26}}>{untagged.length}</div>
                  <div style={{fontSize:13,color:"var(--text-3)"}}>untagged</div>
                </div>
              </div>
              <div className="seg-ctrl" style={{marginTop:4}}>
                {[["untagged",`Untagged (${untagged.length})`],["tagged","Tagged"],["all","All"]].map(([k,l])=>(
                  <button key={k} className={`seg-btn${feedFilter===k?" active":""}`} onClick={()=>setFeedFilter(k)}>{l}</button>
                ))}
              </div>
            </div>

            {txs.length===0&&linked.length===0&&(
              <div className="card card-padded" style={{textAlign:"center",padding:"48px 24px"}}>
                <div style={{fontSize:32,marginBottom:12}}>ðŸ¦</div>
                <div style={{fontSize:15,fontWeight:600,marginBottom:12}}>No bank connected</div>
                <button onClick={connectBank} className="btn-primary">Connect Bank</button>
              </div>
            )}

            {(txs.length>0||linked.length>0)&&<TxList
              txs={feedTxs}
              tagging={tagging} setTagging={setTagging}
              doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
              filter={txFilter} setFilter={setTxFilter} getSuggestion={getSuggestion}
            />}
          </div>
        )}

        {/* â”€â”€ ARCHIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        {tab==="Projections"&&(()=>{
          const now = new Date();
          const thisYear = now.getFullYear();
          const thisMo = now.getMonth(); // 0-indexed
          // Current year progress
          const moRemaining = 12 - thisMo;
          const moElapsed = thisMo;

          return (
          <div className="fade-in">
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>5-Year Outlook Â· as of {now.toLocaleDateString("en-US",{month:"long",year:"numeric"})}</div>
              <div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>Projections</div>
              <div style={{fontSize:12,color:"var(--text-3)",marginTop:4}}>Based on actual run rate Â· STR seasonality applied Â· Pierce flat</div>
            </div>

            {/* This year callout */}
            <div className="section-title">{thisYear} Â· Current Year</div>
            <div className="card card-padded" style={{marginBottom:8}}>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:12}}>
                {[
                  {l:"YTD Revenue",   v:fmt$(M.totalRev),              sub:`${moElapsed} months actual`},
                  {l:"YTD Expenses",  v:fmt$(M.totalExp),              sub:"all properties", red:true},
                  {l:"YTD Net",       v:fmt$(M.totalCF),               sub:"cash flow", green:M.totalCF>=0},
                  {l:"YTD Margin",    v:M.netMargin!=null?fmtPct(M.netMargin):"â€”", sub:"net margin", green:M.netMargin>=30},
                ].map(c=>(
                  <div key={c.l}>
                    <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:3}}>{c.l}</div>
                    <div style={{fontSize:20,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                    <div style={{fontSize:10,color:"var(--text-3)"}}>{c.sub}</div>
                  </div>
                ))}
              </div>
              {/* Full-year {thisYear} projection */}
              {(()=>{
                const proj = M.projections[0];
                const ytdRev = M.totalRev;
                const ytdExp = M.totalExp;
                const remainRev = proj.rev - (ytdRev/Math.max(moElapsed,1))*12 + (ytdRev/Math.max(moElapsed,1))*12 - ytdRev;
                const fullYearRev = ytdRev + (M.annualRev - ytdRev) * (moRemaining/12);
                const fullYearExp = ytdExp + (M.annualExp - ytdExp) * (moRemaining/12);
                const fullYearNet = fullYearRev - fullYearExp;
                return (
                  <div style={{borderTop:"1px solid rgba(0,0,0,0.07)",paddingTop:12,marginTop:4}}>
                    <div style={{fontSize:10,color:"var(--text-3)",marginBottom:8,fontWeight:600,textTransform:"uppercase",letterSpacing:"0.06em"}}>Full Year {thisYear} Forecast</div>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
                      {[
                        {l:"Revenue",  v:fmt$(M.projections[0].rev), green:true},
                        {l:"Expenses", v:fmt$(M.projections[0].exp), red:true},
                        {l:"Net",      v:fmt$(M.projections[0].net), green:M.projections[0].net>=0},
                      ].map(c=>(
                        <div key={c.l} style={{background:"rgba(0,0,0,0.03)",borderRadius:10,padding:"8px 10px"}}>
                          <div style={{fontSize:9,color:"var(--text-3)",marginBottom:3,textTransform:"uppercase",letterSpacing:"0.06em"}}>{c.l}</div>
                          <div style={{fontSize:15,fontWeight:700,color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })()}
            </div>

            {/* 5-year table */}
            <div className="section-title">5-Year Forecast Â· {thisYear}â€“{thisYear+4}</div>
            <div className="card" style={{overflow:"hidden",marginBottom:8}}>
              <div style={{display:"grid",gridTemplateColumns:"56px 1fr 1fr 1fr 72px",borderBottom:"1px solid rgba(0,0,0,0.06)",padding:"8px 14px",gap:8}}>
                {["Year","Revenue","Expenses","Net","Margin"].map(h=>(
                  <span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.08em",textAlign:h==="Year"?"left":"right"}}>{h}</span>
                ))}
              </div>
              {M.projections.map((d,i)=>(
                <div key={d.year} style={{display:"grid",gridTemplateColumns:"56px 1fr 1fr 1fr 72px",padding:"13px 14px",borderBottom:"1px solid rgba(0,0,0,0.04)",gap:8,alignItems:"center",background:i===0?"rgba(48,209,88,0.04)":"transparent"}}>
                  <span style={{fontSize:13,fontWeight:700,fontFamily:"'JetBrains Mono',monospace",color:i===0?"#30d158":"var(--text)"}}>{d.year}{i===0?" â†":""}</span>
                  <span style={{fontSize:12,color:"#30d158",fontFamily:"'JetBrains Mono',monospace",textAlign:"right",fontWeight:600}}>{fmt$(d.rev)}</span>
                  <span style={{fontSize:12,color:"#ff453a",fontFamily:"'JetBrains Mono',monospace",textAlign:"right"}}>{fmt$(d.exp)}</span>
                  <span style={{fontSize:12,fontWeight:700,fontFamily:"'JetBrains Mono',monospace",textAlign:"right",color:d.net>=0?"#30d158":"#ff453a"}}>{fmt$(d.net)}</span>
                  <span style={{fontSize:11,fontFamily:"'JetBrains Mono',monospace",textAlign:"right",color:d.margin>=30?"#30d158":d.margin>=0?"var(--text-3)":"#ff453a"}}>{fmtPct(d.margin)}</span>
                </div>
              ))}
            </div>

            {/* Assumptions */}
            <div className="section-title">Assumptions</div>
            <div className="card card-padded" style={{marginBottom:8}}>
              {[
                {l:"Revenue growth", v:"3% / year", sub:"conservative STR market appreciation"},
                {l:"Expense growth",  v:"2% / year", sub:"maintenance + cost inflation"},
                {l:"Airbnb seasonality", v:"Applied", sub:"Julâ€“Aug peak 1.22x Â· Janâ€“Feb trough 0.72x"},
                {l:"Pierce Ave",    v:"Flat",    sub:"Section 8 â€” fixed rent, predictable"},
                {l:"Base data",     v:`${M.moCount} months`, sub:"actual transactions to date"},
              ].map(a=>(
                <div key={a.l} style={{display:"flex",justifyContent:"space-between",alignItems:"center",paddingBottom:10,marginBottom:10,borderBottom:"1px solid rgba(0,0,0,0.05)"}}>
                  <div>
                    <div style={{fontSize:13,fontWeight:500}}>{a.l}</div>
                    <div style={{fontSize:11,color:"var(--text-3)",marginTop:1}}>{a.sub}</div>
                  </div>
                  <span style={{fontSize:13,fontWeight:600,fontFamily:"'JetBrains Mono',monospace",color:"var(--text-2)"}}>{a.v}</span>
                </div>
              ))}
              {M.annualCoc&&(
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div>
                    <div style={{fontSize:13,fontWeight:500}}>Cash-on-Cash Return</div>
                    <div style={{fontSize:11,color:"var(--text-3)",marginTop:1}}>annualized Â· based on down payments</div>
                  </div>
                  <span style={{fontSize:13,fontWeight:600,fontFamily:"'JetBrains Mono',monospace",color:"#30d158"}}>{fmtPct(M.annualCoc)}</span>
                </div>
              )}
              {!M.annualCoc&&(
                <button onClick={()=>setShowInvest(true)} style={{fontSize:12,color:"var(--text-3)",background:"rgba(0,0,0,0.04)",border:"1px solid rgba(0,0,0,0.08)",borderRadius:10,padding:"8px 14px",cursor:"pointer",display:"block",width:"100%",textAlign:"left"}}>
                  + Add down payments to unlock CoC return
                </button>
              )}
            </div>
          </div>
          );
        })()}

        {tab==="Archive"&&(
          <div className="fade-in">
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Archive Â· Settings</div>
              <div style={{fontSize:15,fontWeight:600}}>Deleted & Internal Transfers</div>
              <div style={{fontSize:12,color:"var(--text-3)",marginTop:4}}>Review and re-tag any transaction below.</div>
            </div>

            {archived.length===0&&(
              <div className="card card-padded" style={{textAlign:"center",color:"var(--text-3)",padding:"48px 24px",fontSize:13}}>
                Nothing here yet â€” deleted and transferred transactions appear here.
              </div>
            )}

            {archived.length>0&&(
              <div className="card" style={{overflow:"hidden"}}>
                {[...archived].sort((a,b)=>b.date.localeCompare(a.date)).map((tx,i)=>(
                  <div key={tx.id} style={{borderBottom:i<archived.length-1?"1px solid rgba(0,0,0,0.05)":"none"}}>
                    <div style={{display:"grid",gridTemplateColumns:"64px 1fr auto auto",padding:"11px 14px",gap:8,alignItems:"center"}}>
                      <span style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{fmtDate(tx.date)}</span>
                      <div>
                        <div style={{fontSize:12,fontWeight:500,lineHeight:1.3}}>{tx.payee}</div>
                        <div style={{fontSize:10,color:"var(--text-3)",marginTop:1}}>
                          {tx.propId==="deleted"?"ðŸ—‘ Deleted":"â†” Transfer"} Â· {tx.account||""}
                        </div>
                      </div>
                      <span style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:600,fontSize:12,color:tx.type==="in"?"#30d158":"#ff453a"}}>
                        {tx.type==="in"?"+":"-"}{fmtD(tx.amount)}
                      </span>
                      <div style={{display:"flex",flexDirection:"column",gap:4}}>
                        <button onClick={()=>doRestore(tx.id)} style={{background:"rgba(0,0,0,0.05)",border:"1px solid rgba(0,0,0,0.1)",borderRadius:7,padding:"4px 8px",fontSize:10,fontFamily:"'JetBrains Mono',monospace",cursor:"pointer",color:"var(--text-2)",fontWeight:600,whiteSpace:"nowrap"}}>
                          Restore
                        </button>
                        {tx.type==="in"?(
                          <button onClick={()=>{const p=PROPERTIES.find(x=>x.id!=="transfer"&&x.id!=="deleted"&&x.id!=="llc"&&x.group!=="airbnb"||x.id==="airbnb");doTag(tx.id,"airbnb");}} style={{background:"rgba(48,209,88,0.1)",border:"1px solid rgba(48,209,88,0.2)",borderRadius:7,padding:"4px 8px",fontSize:10,fontFamily:"'JetBrains Mono',monospace",cursor:"pointer",color:"#30d158",fontWeight:600}}>
                            â†’ Airbnb
                          </button>
                        ):(
                          <button onClick={()=>setTagging(tagging===tx.id?null:tx.id)} style={{background:"rgba(0,0,0,0.04)",border:"1px solid rgba(0,0,0,0.08)",borderRadius:7,padding:"4px 8px",fontSize:10,fontFamily:"'JetBrains Mono',monospace",cursor:"pointer",color:"var(--text-2)",fontWeight:600}}>
                            Re-tag
                          </button>
                        )}
                      </div>
                    </div>
                    {tagging===tx.id&&(
                      <div style={{padding:"0 14px 12px",borderTop:"1px solid rgba(0,0,0,0.04)"}}>
                        <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)} onDelete={doDelete}/>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}

            {/* Connected banks */}
            {linked.length>0&&(
              <>
                <div className="section-title">Connected Banks</div>
                <div className="card" style={{overflow:"hidden"}}>
                  {linked.map((a,i)=>(
                    <div key={a.item_id} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 14px",borderBottom:i<linked.length-1?"1px solid rgba(0,0,0,0.05)":"none"}}>
                      <span style={{fontSize:13,fontWeight:500}}>{a.name}</span>
                      <div style={{display:"flex",gap:8}}>
                        <button onClick={()=>pullHistory()} style={{fontSize:11,color:"var(--text-3)",background:"none",border:"none",cursor:"pointer"}}>â†“ Pull History</button>
                        <button onClick={()=>removeAccount(a.item_id)} style={{fontSize:11,color:"#ff453a",background:"none",border:"none",cursor:"pointer"}}>Remove</button>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            )}

            {/* Data management */}
            <div className="section-title">Data</div>
            <div className="card card-padded" style={{marginBottom:8}}>
              <div style={{fontSize:13,fontWeight:600,marginBottom:4}}>Local Cache</div>
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:12}}>{txs.length} transactions stored locally. If you see expenses with no bank connected, this is leftover data from a previous session â€” clear it here.</div>
              <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
                <button onClick={clearAllData} style={{background:"rgba(255,69,58,0.08)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.2)",borderRadius:10,padding:"8px 16px",fontSize:12,fontWeight:600,cursor:"pointer"}}>
                  Clear All Cached Data
                </button>
                <button onClick={()=>setShowManual(true)} style={{background:"rgba(0,0,0,0.04)",color:"var(--text)",border:"1px solid rgba(0,0,0,0.1)",borderRadius:10,padding:"8px 16px",fontSize:12,fontWeight:600,cursor:"pointer"}}>
                  âœŽ Manual Income
                </button>
              </div>
            </div>

            {/* Auto-tag rules */}
            {Object.keys(autoTags).length>0&&(
              <>
                <div className="section-title">Auto-Tag Rules <span style={{fontWeight:400,textTransform:"none",fontSize:9}}>(suggestions only â€” not applied automatically)</span></div>
                <div className="card card-padded">
                  <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                    {Object.entries(autoTags).map(([payee,pid])=>(
                      <div key={payee} style={{display:"flex",alignItems:"center",gap:5,background:"rgba(0,0,0,0.04)",border:"1px solid rgba(0,0,0,0.07)",borderRadius:8,padding:"4px 10px"}}>
                        <span style={{fontSize:10,fontFamily:"'JetBrains Mono',monospace",color:"var(--text-3)"}}>{payee}</span>
                        <span style={{color:"var(--text-3)",fontSize:10}}>â†’</span>
                        <PropBadge id={pid} small/>
                        <button onClick={()=>{const n={...autoTags};delete n[payee];setAutoTags(n);LS.set(AUTO_KEY,n);}} style={{background:"none",border:"none",color:"var(--text-3)",cursor:"pointer",fontSize:12,lineHeight:1,padding:"0 2px"}}>Ã—</button>
                      </div>
                    ))}
                  </div>
                </div>
              </>
            )}
          </div>
        )}

      </div>{/* end .page */}

      {/* BOTTOM TAB BAR */}
      <div className="tab-bar">
        {TABS.map(t=>(
          <button key={t} className={`tab-item${tab===t?" active":""}`} onClick={()=>setTab(t)}>
            {TAB_ICONS[t]}
            <span>{t==="Pierce"?"Pierce":t}</span>
            {t==="Feed"&&untagged.length>0&&(
              <div style={{position:"absolute",top:2,right:8,background:"#ff453a",borderRadius:"50%",width:14,height:14,display:"flex",alignItems:"center",justifyContent:"center",fontSize:8,fontWeight:700,color:"#fff"}}>{untagged.length>99?"99+":untagged.length}</div>
            )}
          </button>
        ))}
      </div>

      {showInvest&&<InvestModal invest={invest} onSave={saveInvest} onClose={()=>setShowInvest(false)}/>}
      {drillDown&&<MonthDrillDown mo={drillDown.mo} type={drillDown.type} txs={drillDown.txs}
        onClose={()=>setDrillDown(null)}
        doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
        getSuggestion={getSuggestion}
      />}
      {showManual&&<ManualIncomeModal manual={manualIncome} onSave={saveManual} onClose={()=>setShowManual(false)}/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
