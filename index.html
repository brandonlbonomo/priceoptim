<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Property Pigeon</title>
  <link rel="manifest" href="/manifest.json"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="Pigeon"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="theme-color" content="#1a1a2e"/>
  <link rel="apple-touch-icon" href="/icon-192.png"/>
  <link rel="icon" type="image/png" sizes="192x192" href="/icon-192.png"/>
  <link rel="icon" type="image/png" sizes="512x512" href="/icon-512.png"/>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <style>
    :root {
      --bg: #f5f5f7;
      --bg2: #ffffff;
      --glass: rgba(255,255,255,0.55);
      --glass-border: rgba(255,255,255,0.75);
      --green: #30d158;
      --green-dim: rgba(48,209,88,0.15);
      --red: #ff453a;
      --red-dim: rgba(255,69,58,0.15);
      --blue: #0a84ff;
      --blue-dim: rgba(10,132,255,0.15);
      --purple: #bf5af2;
      --yellow: #ffd60a;
      --text: #1a1a2e;
      --text-2: rgba(26,26,46,0.60);
      --text-3: rgba(26,26,46,0.38);
      --card-bg: #ffffff;
      --header-bg: rgba(245,245,247,0.92);
      --radius: 16px;
      --radius-sm: 10px;
    }
    [data-theme="dark"] {
      --bg: #1c1c1e;
      --bg2: #2c2c2e;
      --glass: rgba(44,44,46,0.85);
      --text: #f5f5f7;
      --text-2: rgba(245,245,247,0.60);
      --text-3: rgba(245,245,247,0.38);
      --card-bg: #2c2c2e;
      --header-bg: rgba(28,28,30,0.92);
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", "Helvetica Neue", Arial, sans-serif;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
      -webkit-font-smoothing: antialiased;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(ellipse 60% 50% at 10% 15%,  rgba(255,255,255,0.06) 0%, transparent 60%),
        radial-gradient(ellipse 50% 45% at 90% 10%,  rgba(200,240,255,0.07) 0%, transparent 55%),
        radial-gradient(ellipse 55% 50% at 80% 85%,  rgba(180,255,200,0.05) 0%, transparent 55%),
        radial-gradient(ellipse 45% 40% at 15% 85%,  rgba(220,200,255,0.05) 0%, transparent 50%),
        linear-gradient(145deg, #f0f4f8 0%, #e8edf5 35%, #eef2f7 65%, #f2f0f8 100%);
      pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(circle 400px at 25% 55%, rgba(120,180,255,0.12) 0%, transparent 65%),
        radial-gradient(circle 350px at 75% 35%, rgba(160,220,180,0.10) 0%, transparent 65%),
        radial-gradient(circle 300px at 60% 80%, rgba(200,160,255,0.08) 0%, transparent 60%);
      animation: driftOrbs 20s ease-in-out infinite alternate;
      pointer-events: none;
    }

    @keyframes driftOrbs {
      0%   { transform: translate(0, 0) scale(1); }
      33%  { transform: translate(25px, -15px) scale(1.04); }
      66%  { transform: translate(-15px, 25px) scale(0.97); }
      100% { transform: translate(12px, -8px) scale(1.02); }
    }

    #root { position: relative; z-index: 1; }

    button { cursor: pointer; font-family: inherit; }
    * { -ms-overflow-style: none; scrollbar-width: none; }
    ::-webkit-scrollbar { display: none; }

    /* Glass card */
    .glass {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    .glass-sm {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm);
      backdrop-filter: blur(16px);
    }

    /* Top header */
    .top-header {
      position: sticky; top: 0; z-index: 100;
      padding: 12px 16px 10px;
      background: var(--header-bg);
      backdrop-filter: blur(28px) saturate(1.6);
      -webkit-backdrop-filter: blur(28px) saturate(1.6);
      border-bottom: 1px solid rgba(128,128,128,0.12);
      display: flex; align-items: center; justify-content: space-between;
    }
    /* Top pill navigation â€” Copilot style, no scroll, active always centered */
    .top-nav {
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 6px 0 10px;
      background: var(--header-bg);
      backdrop-filter: blur(28px) saturate(1.6);
      -webkit-backdrop-filter: blur(28px) saturate(1.6);
      overflow: hidden;
      border-bottom: 1px solid rgba(128,128,128,0.10);
      height: 52px;
    }
    .top-nav-track {
      display: flex;
      align-items: center;
      gap: 0;
      will-change: transform;
    }
    .top-nav-pill {
      background: transparent;
      border: none;
      color: var(--text-3);
      font-size: 15px;
      font-weight: 500;
      padding: 7px 22px;
      border-radius: 20px;
      cursor: pointer;
      white-space: nowrap;
      transition: opacity 0.26s cubic-bezier(0.25,0.46,0.45,0.94),
                  transform 0.26s cubic-bezier(0.25,0.46,0.45,0.94),
                  background 0.26s cubic-bezier(0.25,0.46,0.45,0.94),
                  color 0.26s cubic-bezier(0.25,0.46,0.45,0.94);
      flex-shrink: 0;
      opacity: 0.38;
      transform: scale(0.82);
    }
    .top-nav-pill.active {
      background: rgba(128,128,128,0.13);
      color: var(--text);
      font-weight: 700;
      font-size: 15px;
      opacity: 1;
      transform: scale(1);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    /* Fade edges */
    .top-nav::before, .top-nav::after {
      content: "";
      position: absolute;
      top: 0; bottom: 0;
      width: 48px;
      z-index: 2;
      pointer-events: none;
    }
    .top-nav::before { left: 0; background: linear-gradient(to right, var(--header-bg), transparent); }
    .top-nav::after  { right: 0; background: linear-gradient(to left, var(--header-bg), transparent); }
    .nav-tab {
      background: transparent; color: var(--text-3); border: none;
      padding: 7px 16px; border-radius: 20px; font-size: 13px;
      font-weight: 500; transition: all 0.2s; position: relative;
    }
    .nav-tab.active { background: rgba(0,0,0,0.07); color: var(--text); font-weight: 600; }

    /* Pills */
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 11px;
      font-family: ui-monospace, 'SF Mono', SFMono-Regular, monospace;
      font-weight: 500;
    }
    .pill-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }

    /* Big stat */
    .stat-num {
      font-family: 'Figtree', sans-serif;
      font-size: 36px;
      font-weight: 700;
      letter-spacing: -0.03em;
      line-height: 1;
    }
    .stat-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-3);
      font-family: ui-monospace, 'SF Mono', SFMono-Regular, monospace;
    }

    /* Chart tooltip */
    .chart-tooltip {
      position: absolute;
      background: rgba(20,20,28,0.95);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 12px;
      pointer-events: none;
      backdrop-filter: blur(20px);
      white-space: nowrap;
      z-index: 50;
      transform: translateX(-50%);
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    /* Direction badge */
    .dir-in  { color: var(--green); font-size: 15px; }
    .dir-out { color: var(--red);   font-size: 15px; }

    /* Property badge */
    .prop-badge {
      display: inline-block;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 10px;
      font-family: ui-monospace, 'SF Mono', SFMono-Regular, monospace;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    /* Segment control */
    .seg-ctrl {
      display: inline-flex;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 10px;
      padding: 3px;
      gap: 2px;
    }
    .seg-btn {
      background: transparent;
      border: none;
      color: var(--text-3);
      border-radius: 7px;
      padding: 5px 14px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.18s;
    }
    .seg-btn.active {
      background: rgba(0,0,0,0.08);
      color: var(--text);
      font-weight: 600;
    }

    /* Action button */
    .btn-ghost {
      background: rgba(255,255,255,0.6);
      border: 1px solid rgba(0,0,0,0.12);
      color: var(--text-2);
      border-radius: 10px;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.18s;
    }
    .btn-ghost:hover { background: rgba(255,255,255,0.85); color: var(--text); }
    .btn-primary {
      background: var(--green);
      border: none;
      color: #000;
      border-radius: 10px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 700;
      transition: all 0.18s;
    }
    .btn-primary:hover { filter: brightness(1.1); }

    /* Modal overlay */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
    }

    /* Tx row */
    .tx-row {
      display: grid;
      grid-template-columns: 76px 28px 1fr 100px 96px 120px;
      padding: 11px 16px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .tx-row:hover { background: rgba(0,0,0,0.03); }
    .tx-row:last-child { border-bottom: none; }

    /* Swipe container */
    .page-outer {
      position: fixed;
      top: 100px; /* header + top-nav */
      left: 0; right: 0; bottom: 0;
      overflow: hidden;
      background: var(--bg);
    }
    .swipe-track {
      display: flex;
      width: 100%;
      height: 100%;
      will-change: transform;
      transition: none;
    }
    .swipe-track.settling {
      transition: transform 0.32s cubic-bezier(0.25,0.46,0.45,0.94);
    }
    .swipe-pane {
      flex: 0 0 100%;
      width: 100%;
      height: 100%;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      padding: 0 16px 40px;
      box-sizing: border-box;
      background: var(--bg);
    }
    .pull-spinner {
      position: absolute;
      top: 8px;
      left: 50%;
      transform: translateX(-50%);
      width: 24px;
      height: 24px;
      border: 2.5px solid rgba(128,128,128,0.2);
      border-top-color: var(--text-3);
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
      z-index: 50;
    }
    @keyframes spin { to { transform: translateX(-50%) rotate(360deg); } }
    .page { padding: 0; }
    .page-header { padding: 20px 0 16px; }
    .section-title {
      font-size: 10px; font-weight: 600; text-transform: uppercase;
      letter-spacing: 0.1em; color: var(--text-3);
      font-family: ui-monospace, 'SF Mono', SFMono-Regular, monospace;
      margin-bottom: 10px; margin-top: 22px;
    }
    .card {
      background: rgba(255,255,255,0.72);
      border: 1px solid rgba(0,0,0,0.07);
      border-radius: 16px;
      overflow: hidden;
    }
    .card-padded { padding: 16px 18px; }
    .stat-row { display: flex; align-items: baseline; gap: 8px; }
    .big-num { font-size: 32px; font-weight: 700; letter-spacing: -0.03em; line-height: 1; }
    .sub-num { font-size: 13px; color: var(--text-3); }
    @media (max-width: 420px) {
      .big-num { font-size: 26px; }
      .stat-num { font-size: 28px; }
    }

    /* Metric card */
    .metric-card {
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.75);
      border-radius: var(--radius-sm);
      padding: 16px 18px;
      backdrop-filter: blur(16px);
    }

    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    .fade-in { animation: fadeIn 0.3s ease forwards; }

  </style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useMemo, useEffect, useCallback, useRef } = React;
if ('serviceWorker' in navigator) navigator.serviceWorker.register('/sw.js').catch(()=>{});
const BACKEND = "";

// â”€â”€ Formatters â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt$ = n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(n||0);
const fmtD = n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.abs(n||0));
const fmtPct = n => (n==null||isNaN(n)||!isFinite(n))?"â€”":`${n.toFixed(1)}%`;
const fmtDate = d => { try { return new Date(d+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"}); } catch { return d||""; } };
const moLabel = s => { try { if(s&&/^\d{4}-Q\d$/.test(s)){const[y,q]=s.split("-");return `${q} '${y.slice(2)}`;} const [y,m]=s.split("-"); return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][+m-1]+" '"+y.slice(2); } catch { return s; } };

// â”€â”€ Properties â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BASE_PROPERTIES = [
  { id:"airbnb",   label:"Airbnb (portfolio)", color:"#30d158", group:"airbnb" },
  { id:"lockwood", label:"Lockwood",            color:"#30d158", group:"airbnb" },
  { id:"everton",  label:"Everton",             color:"var(--text)", group:"airbnb" },
  { id:"bstreet",  label:"B Street",            color:"var(--text)", group:"airbnb" },
  { id:"pierce",   label:"Pierce Ave",          color:"var(--text)", group:"pierce" },
  { id:"llc",      label:"General LLC",         color:"var(--text)", group:"llc"    },
  { id:"transfer", label:"Internal Transfer",   color:"#636366", group:"transfer"},
];
let PROPERTIES = [...BASE_PROPERTIES];
// All IDs that count as Airbnb revenue/expense
const BASE_AIRBNB_IDS = ["airbnb","lockwood","everton","bstreet"];
let AIRBNB_IDS = [...BASE_AIRBNB_IDS];

// â”€â”€ Storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LS = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => { try { localStorage.setItem(k,JSON.stringify(v)); } catch {} },
};
const TAGS_KEY    = "pg_tags_v2";
const AUTO_KEY    = "pg_auto_v2";
const TX_KEY      = "pg_txs_v2";
const INVEST_KEY  = "pg_invest";
const MANUAL_KEY  = "pg_manual_income"; // { "2025-10": 12550.70, "2025-11": 13972.97, ... }
const CUSTOM_PROPS_KEY = "pg_custom_props";
const DEFAULT_AUTO = { "AIRBNB PAYMENTS":"lockwood","AIRBNB":"lockwood","HOUSING AUTHORITY":"pierce" };
const DEFAULT_INVEST = { lockwood:0, everton:0, bstreet:0, pierce:0 };

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function sumIn(txs)  { return txs.filter(t=>t.type==="in" ).reduce((s,t)=>s+Math.abs(t.amount),0); }
function sumOut(txs) { return txs.filter(t=>t.type==="out").reduce((s,t)=>s+Math.abs(t.amount),0); }

// â”€â”€ PropBadge â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function PropBadge({ id, small }) {
  const p = PROPERTIES.find(x=>x.id===id);
  const fs = small ? 9 : 10;
  const pad = small ? "2px 7px" : "3px 9px";
  if (!p) return <span className="prop-badge" style={{fontSize:fs,padding:pad,background:"rgba(255,214,10,0.15)",color:"var(--text)",border:"1px solid rgba(255,214,10,0.25)"}}>UNTAGGED</span>;
  return <span className="prop-badge" style={{fontSize:fs,padding:pad,background:`${p.color}18`,color:p.color,border:`1px solid ${p.color}30`}}>{p.label.toUpperCase()}</span>;
}

// â”€â”€ TagMenu â€” in vs out logic â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Money IN:  Airbnb (portfolio) | Pierce Ave | Internal Transfer | Delete
// Money OUT: Lockwood | Everton | B Street | Pierce | LLC | Internal Transfer | Delete
function TagMenu({ tx, onTag, onClose, onDelete }) {
  const [confirmDelete, setConfirmDelete] = useState(false);
  const isIn = tx.type === "in";

  const STATIC_IDS = new Set(['airbnb','lockwood','everton','bstreet','pierce','llc','transfer']);
  const customOpts = PROPERTIES.filter(p=>!STATIC_IDS.has(p.id)).map(p=>({id:p.id,label:p.label}));
  const inOptions  = [{id:"airbnb",label:"Airbnb"},{id:"pierce",label:"Pierce Ave"},{id:"transfer",label:"Transfer"},...customOpts];
  const outOptions = [{id:"lockwood",label:"Lockwood"},{id:"everton",label:"Everton"},{id:"bstreet",label:"B Street"},
                     {id:"pierce",label:"Pierce Ave"},{id:"llc",label:"LLC"},{id:"transfer",label:"Transfer"},...customOpts];
  const opts = isIn ? inOptions : outOptions;

  const btnBase = {borderRadius:10,padding:"7px 14px",fontSize:12,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:600,cursor:"pointer",border:"1px solid rgba(0,0,0,0.1)",background:"rgba(255,255,255,0.7)",color:"var(--text)",transition:"all 0.12s"};

  return (
    <div style={{padding:"10px 0 6px"}}>
      <div style={{display:"flex",gap:6,flexWrap:"wrap",marginBottom:8}}>
        {opts.map(p=>(
          <button key={p.id} onClick={()=>onTag(tx.id,p.id)} style={{
            ...btnBase,
            background: tx.propId===p.id ? "rgba(0,0,0,0.1)" : btnBase.background,
            fontWeight: tx.propId===p.id ? 700 : 600,
          }}>
            {p.label}
          </button>
        ))}
      </div>
      <div style={{display:"flex",gap:6,alignItems:"center"}}>
        {confirmDelete
          ? <>
              <span style={{fontSize:11,color:"var(--text-3)"}}>Delete this transaction?</span>
              <button onClick={()=>{onDelete(tx.id);onClose();}} style={{...btnBase,background:"rgba(255,69,58,0.12)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.3)",padding:"5px 12px"}}>Confirm</button>
              <button onClick={()=>setConfirmDelete(false)} style={{...btnBase,padding:"5px 10px",fontSize:11}}>Cancel</button>
            </>
          : <button onClick={()=>setConfirmDelete(true)} style={{...btnBase,background:"rgba(255,69,58,0.07)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.2)",padding:"5px 12px",fontSize:11}}>Delete</button>
        }
        <button onClick={onClose} style={{...btnBase,padding:"5px 10px",fontSize:11,marginLeft:"auto"}}>Done</button>
      </div>
    </div>
  );
}

// â”€â”€ MiniBar â€” compact sparkline bar chart (clickable) â”€â”€â”€â”€â”€â”€â”€â”€â”€
function MiniBar({ months, valueKey, color, label, fmt=null, onBarClick=null, marginMode=false, labelFn=null }) {
  const [hov, setHov] = useState(null);
  const [tapped, setTapped] = useState(null);
  const containerRef = useRef(null);
  // Dismiss tapped tooltip when clicking outside the chart
  useEffect(()=>{
    if(tapped===null) return;
    const handle = e => { if(!containerRef.current?.contains(e.target)) setTapped(null); };
    const id = setTimeout(()=>document.addEventListener('click', handle), 50);
    return ()=>{ clearTimeout(id); document.removeEventListener('click', handle); };
  },[tapped]);
  const H = 72;
  const vals = months.map(([,v])=> {
    if(valueKey==="net") return v.rev-v.exp;
    if(valueKey==="margin") return v.rev>0?((v.rev-v.exp)/v.rev)*100:0;
    return v[valueKey]||0;
  });
  const max = Math.max(...vals.map(Math.abs), 1);
  if(months.length===0) return <div style={{height:H,display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text-3)",fontSize:11}}>No data yet</div>;
  return (
    <div ref={containerRef} style={{position:"relative",paddingTop:32}}>
      <div style={{display:"flex",gap:2,alignItems:"flex-end",height:H}}>
        {months.map(([mo,v],i)=>{
          const val = vals[i];
          const px  = Math.max(3, Math.round((Math.abs(val)/max)*H));
          const isProj = !!(v && v.projected);
          // Delta vs previous actual (non-projected) bar
          const prevActualIdx = [...Array(i)].map((_,j)=>i-1-j).find(j=>j>=0&&!(months[j][1]?.projected));
          const prevVal = prevActualIdx!==undefined?vals[prevActualIdx]:null;
          const prevMo  = prevActualIdx!==undefined?months[prevActualIdx][0]:null;
          const delta   = prevVal!==null&&Math.abs(prevVal)>0.01?((val-prevVal)/Math.abs(prevVal))*100:null;
          const c = isProj ? "#bbbbbb"
            : marginMode
            ? (val >= 30 ? "#30d158" : val >= 0 ? "#aaaaaa" : "#ff453a")
            : color || (val>=0?"#30d158":"#ff453a");
          const canClick = !!onBarClick && !isProj;
          const isActive = hov===i || tapped===i;
          // Position tooltip so it never clips off screen edges
          const frac = months.length > 1 ? i / (months.length - 1) : 0.5;
          const tipAnchor = frac < 0.2
            ? {left:0, transform:'none'}
            : frac > 0.8
            ? {left:'auto', right:0, transform:'none'}
            : {left:'50%'};
          return (
            <div key={mo} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",height:H,justifyContent:"flex-end",position:"relative",cursor:canClick?"pointer":"default"}}
              onMouseEnter={()=>setHov(i)} onMouseLeave={()=>setHov(null)}
              onClick={()=>{
                if(!canClick) return;
                if(tapped===i){ onBarClick(mo,valueKey); setTapped(null); }
                else { setTapped(i); }
              }}>
              <div style={{width:"100%",borderRadius:"2px 2px 0 0",height:px,transition:"height 0.3s ease",
                background:isProj?(isActive?"#aaaaaa":"#cccccc"):(isActive?c:`${c}bb`),
                opacity:isProj?0.5:1,
                backgroundImage:isProj?"repeating-linear-gradient(45deg,transparent,transparent 3px,rgba(255,255,255,0.4) 3px,rgba(255,255,255,0.4) 6px)":"none",
                outline:canClick&&isActive?"2px solid "+c:"none",outlineOffset:1}}/>
              {isActive&&(
                <div className="chart-tooltip" style={{bottom:"calc(100% + 6px)",fontSize:11,...tipAnchor}}>
                  <div style={{color:"rgba(255,255,255,0.55)",fontSize:9,marginBottom:2}}>{moLabel(mo)}{isProj?" Â· projected":""}</div>
                  <div style={{color:"#fff",fontWeight:700}}>{fmt ? fmt(val) : fmt$(val)}</div>
                  {delta!==null&&(
                    <div style={{fontSize:9,marginTop:3,color:delta>=0?"#30d158":"#ff453a",fontWeight:600}}>
                      {delta>=0?"â–²":"â–¼"} {delta>=0?"+":""}{delta.toFixed(1)}% vs {moLabel(prevMo)}
                    </div>
                  )}
                  {canClick&&<div style={{color:"rgba(255,255,255,0.4)",fontSize:8,marginTop:2}}>{tapped===i?"tap again for transactions":"tap for details"}</div>}
                </div>
              )}
            </div>
          );
        })}
      </div>
      <div style={{display:"flex",marginTop:4}}>
        {months.map(([mo],i)=>(
          <div key={mo} style={{flex:1,textAlign:"center",fontSize:8,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",
            opacity: months.length>12 ? (i%3===0?1:0) : 1
          }}>{labelFn ? labelFn(mo,i,months) : moLabel(mo).split(" ")[0]}</div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€ MonthDrillDown â€” modal showing transactions for a clicked bar â”€â”€
function MonthDrillDown({ mo, type, txs, onClose, doTag, doDelete, doBulkTag, doBulkDelete, getSuggestion }) {
  const [tagging, setTagging] = useState(null);
  const [txFilter, setTxFilter] = useState(type==="rev"?"in":type==="exp"?"out":"all");
  // All txs for this month â€” let TxList filter handle in/out toggle
  const moTxs = txs.filter(t => t.date?.slice(0,7) === mo);
  const total = moTxs.filter(t=>txFilter==="all"||(txFilter==="in"&&t.type==="in")||(txFilter==="out"&&t.type==="out"))
    .reduce((s,t)=> t.type==="in" ? s+Math.abs(t.amount) : s-Math.abs(t.amount), 0);
  const typeLabel = type==="rev"?"Revenue":type==="exp"?"Expenses":"Net";

  return (
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.5)",zIndex:1000,display:"flex",alignItems:"flex-end",justifyContent:"center"}}
      onClick={e=>{if(e.target===e.currentTarget)onClose();}}>
      <div style={{background:"#f5f5f7",borderRadius:"20px 20px 0 0",width:"100%",height:"88vh",display:"flex",flexDirection:"column",overflow:"hidden",boxShadow:"0 -8px 40px rgba(0,0,0,0.25)"}}>
        <div style={{width:36,height:4,background:"rgba(0,0,0,0.15)",borderRadius:2,margin:"10px auto 0",flexShrink:0,cursor:"pointer"}} onClick={onClose}/>
        {/* Header */}
        <div style={{padding:"16px 20px 12px",borderBottom:"1px solid rgba(0,0,0,0.08)",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
          <div>
            <div style={{fontSize:12,color:"var(--text-3)",marginBottom:2}}>{moLabel(mo)} Â· {typeLabel}</div>
            <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:total>=0?"#30d158":"#ff453a"}}>{fmt$(Math.abs(total))}</div>
          </div>
          <button onClick={onClose} style={{background:"rgba(0,0,0,0.06)",border:"none",borderRadius:20,width:32,height:32,fontSize:16,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center"}}>âœ•</button>
        </div>
        {/* Transaction list â€” full filter/tag/delete capability */}
        <div style={{overflowY:"auto",flex:1,padding:"8px 12px 24px"}}>
          {moTxs.length===0
            ? <div style={{textAlign:"center",padding:"40px 0",color:"var(--text-3)",fontSize:13}}>No transactions for this period</div>
            : <TxList
                txs={moTxs}
                tagging={tagging} setTagging={setTagging}
                doTag={doTag} doDelete={doDelete}
                doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
                filter={txFilter} setFilter={setTxFilter} getSuggestion={getSuggestion}
              />
          }
        </div>
      </div>
    </div>
  );
}

// â”€â”€ BarChart with hover tooltip â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function BarChart({ months, colorKey="green", label="Revenue" }) {
  const [hov, setHov] = useState(null);
  const H = 90;
  const vals = months.map(([,v])=> colorKey==="green" ? v.rev : colorKey==="red" ? v.exp : v.rev-v.exp);
  const max  = Math.max(...vals, 1);

  if(months.length===0) return (
    <div style={{height:H,display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text-3)",fontSize:12}}>
      No data â€” sync transactions
    </div>
  );

  return (
    <div style={{position:"relative"}}>
      <div style={{display:"flex",gap:3,alignItems:"flex-end",height:H,padding:"0 4px"}}>
        {months.map(([mo,v],i)=>{
          const val  = colorKey==="green"?v.rev:colorKey==="red"?v.exp:v.rev-v.exp;
          const px   = Math.max(3, Math.round((val/max)*H));
          const color= colorKey==="green"?"#30d158":colorKey==="red"?"#ff453a":val>=0?"#30d158":"#ff453a";
          return (
            <div key={mo} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",position:"relative",height:H,justifyContent:"flex-end"}}
              onMouseEnter={()=>setHov(i)} onMouseLeave={()=>setHov(null)}>
              <div style={{
                width:"100%",borderRadius:"3px 3px 0 0",
                background: hov===i ? color : `${color}cc`,
                height:px,
                transition:"height 0.3s ease, background 0.15s",
                cursor:"pointer",
              }}/>
              {hov===i&&(
                <div className="chart-tooltip" style={{bottom:"calc(100% + 8px)",left:"50%"}}>
                  <div style={{fontSize:11,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",marginBottom:3}}>{moLabel(mo)}</div>
                  <div style={{fontSize:14,fontWeight:700,color:color}}>{fmt$(val)}</div>
                  <div style={{fontSize:10,color:"var(--text-3)",marginTop:2}}>{label}</div>
                </div>
              )}
            </div>
          );
        })}
      </div>
      <div style={{display:"flex",marginTop:6,padding:"0 4px"}}>
        {months.map(([mo])=>(
          <div key={mo} style={{flex:1,textAlign:"center",fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{moLabel(mo).slice(0,3)}</div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€ Smooth Projection Chart with draggable scrubber â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ProjectionChart({ data }) {
  const svgRef = useRef(null);
  const [scrubX, setScrubX] = useState(null);  // pixel x within SVG
  const [isDragging, setIsDragging] = useState(false);
  const W=600, H=220, PL=50, PR=20, PT=20, PB=30;
  const CW=W-PL-PR, CH=H-PT-PB;

  const lines=[
    {key:"rev",color:"#30d158",label:"Revenue"},
    {key:"exp",color:"#ff453a",label:"Expenses"},
    {key:"net",color:"#444",label:"Net Income"},
  ];

  const allVals=data.flatMap(d=>[d.rev,d.exp,d.net]);
  const minV=Math.min(0,...allVals), maxV=Math.max(...allVals,1);
  const scaleY=v=>PT+CH*(1-(v-minV)/(maxV-minV));
  const scaleX=i=>PL+CW*(i/(data.length-1));

  // Smooth cubic bezier path
  const smoothPath=key=>{
    const pts=data.map((d,i)=>([scaleX(i),scaleY(d[key])]));
    if(pts.length<2) return "";
    let d=`M${pts[0][0]},${pts[0][1]}`;
    for(let i=0;i<pts.length-1;i++){
      const cp1x=pts[i][0]+(pts[i+1][0]-pts[i][0])*0.4;
      const cp1y=pts[i][1];
      const cp2x=pts[i][0]+(pts[i+1][0]-pts[i][0])*0.6;
      const cp2y=pts[i+1][1];
      d+=` C${cp1x},${cp1y} ${cp2x},${cp2y} ${pts[i+1][0]},${pts[i+1][1]}`;
    }
    return d;
  };

  // Find which data point scrubX is closest to
  const activeIdx = scrubX===null ? null : Math.min(data.length-1, Math.max(0,
    Math.round((scrubX - PL) / CW * (data.length-1))
  ));

  const getSVGX = e => {
    if(!svgRef.current) return null;
    const rect=svgRef.current.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const ratio = (clientX-rect.left)/rect.width;
    return ratio*W;
  };

  const onMove = e => {
    if(e.type==="mousemove"&&!isDragging&&e.buttons===0) {
      setScrubX(getSVGX(e));
    } else if(isDragging || e.type==="mousemove") {
      setScrubX(getSVGX(e));
    } else if(e.touches) {
      setScrubX(getSVGX(e));
    }
  };

  const activeData = activeIdx!==null ? data[activeIdx] : null;
  const scrubLineX = activeIdx!==null ? scaleX(activeIdx) : null;

  return (
    <div>
      <svg ref={svgRef} viewBox={`0 0 ${W} ${H}`} style={{width:"100%",height:"auto",overflow:"visible",cursor:"crosshair",userSelect:"none"}}
        onMouseMove={onMove} onMouseLeave={()=>{setScrubX(null);setIsDragging(false);}}
        onMouseDown={()=>setIsDragging(true)} onMouseUp={()=>setIsDragging(false)}
        onTouchMove={onMove} onTouchStart={onMove} onTouchEnd={()=>setScrubX(null)}>
        <defs>
          {lines.map(l=>(
            <linearGradient key={l.key} id={`pg_${l.key}`} x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stopColor={l.color} stopOpacity="0.18"/>
              <stop offset="100%" stopColor={l.color} stopOpacity="0.02"/>
            </linearGradient>
          ))}
        </defs>

        {/* Grid */}
        {[0,0.25,0.5,0.75,1].map(f=>{
          const y=PT+CH*f;
          const val=maxV-(maxV-minV)*f;
          return (
            <g key={f}>
              <line x1={PL} y1={y} x2={W-PR} y2={y} stroke="rgba(0,0,0,0.07)" strokeWidth="1" strokeDasharray="3,4"/>
              <text x={PL-6} y={y+4} textAnchor="end" style={{fontSize:8,fill:"rgba(26,26,46,0.35)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{fmt$(val).replace("$","")}</text>
            </g>
          );
        })}

        {/* Area fills */}
        {lines.map(l=>{
          const path=smoothPath(l.key);
          const lastX=scaleX(data.length-1);
          return <path key={l.key} d={path+` L${lastX},${H-PB} L${PL},${H-PB} Z`} fill={`url(#pg_${l.key})`}/>;
        })}

        {/* Lines */}
        {lines.map(l=>(
          <path key={l.key} d={smoothPath(l.key)} fill="none" stroke={l.color} strokeWidth="2.5"
            strokeLinecap="round" strokeLinejoin="round"/>
        ))}

        {/* Scrub line */}
        {scrubLineX!==null&&(
          <line x1={scrubLineX} y1={PT} x2={scrubLineX} y2={H-PB}
            stroke="rgba(26,26,46,0.25)" strokeWidth="1.5" strokeDasharray="3,3"/>
        )}

        {/* Dots at scrub position */}
        {activeIdx!==null&&lines.map(l=>(
          <circle key={l.key} cx={scaleX(activeIdx)} cy={scaleY(activeData[l.key])} r="5"
            fill={l.color} stroke="white" strokeWidth="2"/>
        ))}

        {/* X axis labels */}
        {data.map((d,i)=>(
          <text key={i} x={scaleX(i)} y={H-4} textAnchor="middle"
            style={{fontSize:9,fill:activeIdx===i?"rgba(26,26,46,0.8)":"rgba(26,26,46,0.35)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:activeIdx===i?"700":"400"}}>
            {d.year}
          </text>
        ))}
      </svg>

      {/* Live ticker â€” shows active data or last year by default */}
      {(()=>{
        const d=activeData||data[data.length-1];
        const yr=activeData?d.year:`${d.year} (proj.)`;
        return (
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:8,marginTop:12}}>
            {[
              {l:"Year",     v:yr,           c:"var(--text)"},
              {l:"Revenue",  v:fmt$(d.rev),  c:"#30d158"},
              {l:"Expenses", v:fmt$(d.exp),  c:"#ff453a"},
              {l:"Net Income",v:fmt$(d.net), c:d.net>=0?"#30d158":"#ff453a"},
            ].map(item=>(
              <div key={item.l} style={{background:"rgba(255,255,255,0.5)",border:"1px solid rgba(255,255,255,0.7)",borderRadius:10,padding:"12px 14px",textAlign:"center",transition:"all 0.1s"}}>
                <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:5}}>{item.l}</div>
                <div style={{fontSize:16,fontWeight:800,color:item.c,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",letterSpacing:"-0.02em",transition:"all 0.08s"}}>{item.v}</div>
              </div>
            ))}
          </div>
        );
      })()}

      <div style={{display:"flex",gap:16,marginTop:12,justifyContent:"center"}}>
        {lines.map(l=>(
          <div key={l.key} style={{display:"flex",alignItems:"center",gap:5}}>
            <div style={{width:20,height:2.5,background:l.color,borderRadius:2}}/>
            <span style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{l.label}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// â”€â”€ ManualIncomeModal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function ManualIncomeModal({ manual, onSave, onClose }) {
  const MONTHS = [
    "2025-01","2025-02","2025-03","2025-04","2025-05","2025-06",
    "2025-07","2025-08","2025-09","2025-10","2025-11","2025-12",
    "2026-01","2026-02","2026-03","2026-04","2026-05","2026-06",
    "2026-07","2026-08","2026-09","2026-10","2026-11","2026-12",
  ];
  const [vals, setVals] = useState({...manual});

  return (
    <div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.4)",display:"flex",alignItems:"center",justifyContent:"center",zIndex:1000,padding:16}}>
      <div className="glass" style={{width:"100%",maxWidth:480,maxHeight:"80vh",overflowY:"auto",padding:24,borderRadius:20}}>
        <div style={{fontSize:18,fontWeight:700,marginBottom:4}}>Manual Airbnb Income</div>
        <div style={{fontSize:12,color:"var(--text-3)",marginBottom:20}}>
          Enter your exact Airbnb payout totals per month from the Airbnb app. Manual entries override Plaid data for that month â€” no double counting.
        </div>
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8}}>
          {MONTHS.map(mo=>(
            <div key={mo}>
              <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",marginBottom:3}}>{moLabel(mo)}</div>
              <input
                type="number"
                placeholder="0"
                value={vals[mo]||""}
                onChange={e=>setVals(v=>({...v,[mo]:parseFloat(e.target.value)||0}))}
                style={{width:"100%",padding:"7px 10px",borderRadius:8,border:"1px solid rgba(0,0,0,0.12)",fontSize:13,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",background:"rgba(255,255,255,0.6)",boxSizing:"border-box"}}
              />
            </div>
          ))}
        </div>
        <div style={{display:"flex",gap:8,marginTop:20,justifyContent:"flex-end"}}>
          <button onClick={onClose} style={{padding:"8px 16px",borderRadius:10,border:"1px solid rgba(0,0,0,0.1)",background:"transparent",cursor:"pointer",fontSize:13}}>Cancel</button>
          <button onClick={()=>{onSave(vals);onClose();}} className="btn-primary">Save</button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ InvestModal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function InvestModal({ invest, onSave, onClose }) {
  const [vals, setVals] = useState({...invest});
  const props = PROPERTIES.filter(p=>["lockwood","everton","bstreet","pierce"].includes(p.id));
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="glass fade-in" style={{width:400,padding:28}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:17,fontWeight:700,marginBottom:6}}>Down Payments</div>
        <div style={{fontSize:12,color:"var(--text-3)",marginBottom:22}}>Enter the initial down payment for each property. Cash-on-cash return is calculated automatically from your Plaid expense data.</div>
        {props.map(p=>(
          <div key={p.id} style={{marginBottom:16}}>
            <div style={{fontSize:11,color:p.color,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:700,marginBottom:6,textTransform:"uppercase",letterSpacing:"0.08em"}}>{p.label}</div>
            <div style={{position:"relative"}}>
              <span style={{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",color:"var(--text-3)",fontSize:14}}>$</span>
              <input type="number" value={vals[p.id]||""} onChange={e=>setVals(v=>({...v,[p.id]:+e.target.value}))}
                placeholder="0"
                style={{width:"100%",background:"rgba(0,0,0,0.04)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:10,padding:"10px 12px 10px 26px",color:"var(--text)",fontSize:15,fontWeight:600,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",outline:"none"}}/>
            </div>
          </div>
        ))}
        <div style={{display:"flex",gap:10,marginTop:24,justifyContent:"flex-end"}}>
          <button onClick={onClose} className="btn-ghost">Cancel</button>
          <button onClick={()=>{onSave(vals);onClose();}} className="btn-primary">Save</button>
        </div>
      </div>
    </div>
  );
}

// â”€â”€ TxList â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// â”€â”€ TxList with bulk select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TxList({ txs, tagging, setTagging, doTag, doDelete, doBulkTag, doBulkDelete, filter, setFilter, getSuggestion }) {
  const [selected, setSelected] = useState(new Set());

  const filtered = filter==="in" ? txs.filter(t=>t.type==="in") : filter==="out" ? txs.filter(t=>t.type==="out") : txs;
  const sorted   = [...filtered].sort((a,b)=>b.date.localeCompare(a.date));
  const allSel   = sorted.length>0 && sorted.every(t=>selected.has(t.id));
  const selCount = selected.size;

  const toggle = (id,e) => { e && e.stopPropagation(); setSelected(p=>{const n=new Set(p); n.has(id)?n.delete(id):n.add(id); return n;}); setTagging(null); };
  const toggleAll = () => setSelected(allSel ? new Set() : new Set(sorted.map(t=>t.id)));
  const clearSel  = () => setSelected(new Set());

  const handleBulkTag = pid => { doBulkTag([...selected], pid); clearSel(); };
  const handleBulkDel = ()  => { doBulkDelete([...selected]); clearSel(); };

  const Checkbox = ({id, checked, onToggle}) => (
    <div onClick={e=>{e.stopPropagation(); onToggle ? onToggle() : toggle(id,e);}} style={{width:18,height:18,borderRadius:5,border:`1.5px solid ${checked?"#1a1a2e":"rgba(0,0,0,0.2)"}`,background:checked?"#1a1a2e":"transparent",cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,transition:"all 0.12s"}}>
      {checked&&<span style={{color:"white",fontSize:10,lineHeight:1,fontWeight:700}}>âœ“</span>}
    </div>
  );

  return (
    <div>
      {/* Toolbar */}
      <div style={{display:"flex",gap:8,marginBottom:12,alignItems:"center",flexWrap:"wrap"}}>
        <div className="seg-ctrl">
          {[["all","All"],["in","â†“ In"],["out","â†‘ Out"]].map(([k,l])=>(
            <button key={k} className={`seg-btn${filter===k?" active":""}`} onClick={()=>{setFilter(k);clearSel();}}>{l}</button>
          ))}
        </div>
        <span style={{fontSize:11,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{sorted.length} transactions</span>

        {selCount>0&&(
          <div style={{display:"flex",gap:5,alignItems:"center",marginLeft:"auto",flexWrap:"wrap"}}>
            <span style={{fontSize:11,fontWeight:700,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"var(--text-2)",marginRight:2}}>{selCount} selected â€”</span>
            {PROPERTIES.filter(p=>p.id!=="transfer").map(p=>(
              <button key={p.id} onClick={()=>handleBulkTag(p.id)}
                style={{background:"rgba(0,0,0,0.06)",color:"var(--text)",border:"1px solid rgba(0,0,0,0.12)",borderRadius:8,padding:"4px 10px",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:600,cursor:"pointer"}}>
                {p.label}
              </button>
            ))}
            <button onClick={handleBulkDel}
              style={{background:"rgba(255,69,58,0.1)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.3)",borderRadius:8,padding:"4px 10px",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:700,cursor:"pointer"}}>
              Delete {selCount}
            </button>
            <button onClick={clearSel} style={{background:"rgba(0,0,0,0.05)",color:"var(--text-3)",border:"1px solid rgba(0,0,0,0.1)",borderRadius:8,padding:"4px 8px",fontSize:10,cursor:"pointer"}}>âœ•</button>
          </div>
        )}
      </div>

      {sorted.length===0&&<div style={{textAlign:"center",padding:"32px 0",color:"var(--text-3)",fontSize:13}}>No transactions</div>}

      {sorted.length>0&&(
        <div className="glass" style={{overflow:"hidden"}}>
          <div style={{display:"grid",gridTemplateColumns:"36px 72px 22px 1fr 100px 120px",padding:"8px 14px",borderBottom:"1px solid rgba(0,0,0,0.06)",gap:8,alignItems:"center"}}>
            <Checkbox id="__all__" checked={allSel} onToggle={toggleAll}/>
            {["DATE","","PAYEE","AMOUNT","PROPERTY"].map(h=>(
              <span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.1em"}}>{h}</span>
            ))}
          </div>
          {sorted.map(tx=>{
            const isSel = selected.has(tx.id);
            return (
              <div key={tx.id}>
                <div style={{display:"grid",gridTemplateColumns:"36px 72px 22px 1fr 100px 120px",padding:"10px 14px",borderBottom:"1px solid rgba(0,0,0,0.04)",gap:8,alignItems:"center",cursor:"pointer",transition:"background 0.1s",background:isSel?"rgba(10,132,255,0.06)":"transparent"}}
                  onClick={()=>{ if(selCount>0){toggle(tx.id);return;} setTagging(t=>t===tx.id?null:tx.id); }}
                  onMouseEnter={e=>{if(!isSel)e.currentTarget.style.background="rgba(0,0,0,0.025)";}}
                  onMouseLeave={e=>{if(!isSel)e.currentTarget.style.background="transparent";}}>
                  <div onClick={e=>toggle(tx.id,e)}><Checkbox id={tx.id} checked={isSel}/></div>
                  <span style={{fontSize:11,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{fmtDate(tx.date)}</span>
                  <span className={tx.type==="in"?"dir-in":"dir-out"}>{tx.type==="in"?"â†“":"â†‘"}</span>
                  <div style={{overflow:"hidden"}}>
                    <div style={{fontSize:13,fontWeight:500,lineHeight:1.3,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{tx.payee}</div>
                    {tx.account&&<div style={{fontSize:10,color:"var(--text-3)",marginTop:1}}>{tx.account}</div>}
                  </div>
                  <span style={{fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:700,fontSize:13,color:tx.type==="in"?"#30d158":"#ff453a"}}>
                    {tx.type==="in"?"+":"-"}{fmtD(tx.amount)}
                  </span>
                  <div onClick={e=>e.stopPropagation()} style={{display:"flex",flexDirection:"column",alignItems:"flex-end",gap:2}}>
                    <span onClick={e=>{e.stopPropagation();setTagging(t=>t===tx.id?null:tx.id);}}>
                      <PropBadge id={tx.propId} small/>
                    </span>
                    {!tx.propId&&getSuggestion&&getSuggestion(tx)&&(
                      <span style={{fontSize:8,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",cursor:"pointer"}}
                        onClick={e=>{e.stopPropagation();doTag(tx.id,getSuggestion(tx));}}
                        title="Click to apply auto-tag suggestion">
                        ðŸ’¡ {getSuggestion(tx)}
                      </span>
                    )}
                  </div>
                </div>
                {tagging===tx.id&&(
                  <div style={{padding:"0 14px 12px",borderBottom:"1px solid rgba(0,0,0,0.04)"}}>
                    <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)} onDelete={doDelete}/>
                  </div>
                )}
              </div>
            );
          })}
        </div>
      )}
    </div>
  );
}


const BASE_TABS=["Portfolio","Airbnb","Pierce","Quarterly","Projections"];


// â”€â”€ Rule Prompt Modal â€” Copilot-style "apply to all?" â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function RulePromptModal({ payee, propId, onApplyAll, onApplyName, onSkip }) {
  const label = ({lockwood:"Lockwood",everton:"Everton",bstreet:"B Street",
    pierce:"Pierce Ave",llc:"General LLC",transfer:"Internal Transfer"})[propId]||propId;
  return (
    <div style={{position:"fixed",inset:0,zIndex:300,display:"flex",flexDirection:"column",
      justifyContent:"flex-end",background:"rgba(0,0,0,0.4)",backdropFilter:"blur(8px)"}}>
      <div style={{background:"#fff",borderRadius:"20px 20px 0 0",padding:"24px 20px 40px"}}>
        <div style={{width:36,height:4,background:"rgba(0,0,0,0.15)",borderRadius:2,
          margin:"0 auto 20px",cursor:"pointer"}} onClick={onSkip}/>
        <div style={{fontSize:11,fontWeight:700,letterSpacing:"0.08em",color:"#636366",
          textTransform:"uppercase",marginBottom:4}}>TAG CHANGED</div>
        <div style={{fontSize:15,color:"#1c1c1e",marginBottom:20,lineHeight:1.4}}>
          Do you want to tag everything from <b>"{payee}"</b> as <b>{label}</b>?
        </div>
        <button onClick={onApplyAll} style={{width:"100%",padding:"15px",textAlign:"left",
          background:"none",border:"none",borderTop:"1px solid rgba(0,0,0,0.08)",
          fontSize:15,color:"#1c1c1e",cursor:"pointer",display:"flex",justifyContent:"space-between"}}>
          <span>Tag all "{payee}" transactions</span>
          <span style={{color:"#636366"}}>â€º</span>
        </button>
        <button onClick={onApplyName} style={{width:"100%",padding:"15px",textAlign:"left",
          background:"none",border:"none",borderTop:"1px solid rgba(0,0,0,0.08)",
          fontSize:15,color:"#1c1c1e",cursor:"pointer",display:"flex",justifyContent:"space-between"}}>
          <span>Create rule for "{payee}" going forward</span>
          <span style={{color:"#636366"}}>â€º</span>
        </button>
        <button onClick={onSkip} style={{width:"100%",padding:"15px",textAlign:"center",
          background:"none",border:"none",borderTop:"1px solid rgba(0,0,0,0.08)",
          fontSize:15,color:"#636366",cursor:"pointer"}}>
          No thanks
        </button>
      </div>
    </div>
  );
}


// â”€â”€ Settings Page â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function SettingsPage({ onClose, autoTags, rules, onDeleteRule, settings, onSaveSettings,
  archived, doRestore, doTag, linked, onRemoveAccount, onClearAll, customProps=[], onDeleteProp }) {
  const [section, setSection] = React.useState("main");
  const PROP_LABEL = {lockwood:"Lockwood",everton:"Everton",bstreet:"B Street",
    pierce:"Pierce Ave",llc:"General LLC",transfer:"Internal Transfer",deleted:"Deleted"};
  const row = (label, right, onClick) => (
    <div onClick={onClick} style={{display:"flex",justifyContent:"space-between",alignItems:"center",
      padding:"14px 20px",borderBottom:"1px solid rgba(0,0,0,0.07)",cursor:onClick?"pointer":"default",
      background:"#fff"}}>
      <span style={{fontSize:15,color:onClick?"#1c1c1e":"#636366"}}>{label}</span>
      <span style={{fontSize:15,color:"#636366"}}>{right}</span>
    </div>
  );
  const toggle = (label, key) => (
    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",
      padding:"14px 20px",borderBottom:"1px solid rgba(0,0,0,0.07)",background:"#fff"}}>
      <span style={{fontSize:15,color:"#1c1c1e"}}>{label}</span>
      <div onClick={()=>onSaveSettings({...settings,[key]:!settings[key]})}
        style={{width:48,height:28,borderRadius:14,background:settings[key]?"#30d158":"#ccc",
          position:"relative",cursor:"pointer",transition:"background 0.2s"}}>
        <div style={{position:"absolute",top:2,left:settings[key]?20:2,width:24,height:24,
          borderRadius:12,background:"#fff",transition:"left 0.2s",
          boxShadow:"0 1px 4px rgba(0,0,0,0.3)"}}/>
      </div>
    </div>
  );

  return (
    <div style={{position:"fixed",inset:0,zIndex:400,background:settings.darkMode?"#1c1c1e":"#f2f2f7",
      overflowY:"auto",display:"flex",flexDirection:"column"}}>
      {/* Header */}
      <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",
        padding:"56px 20px 12px",background:settings.darkMode?"#1c1c1e":"#f2f2f7"}}>
        {section!=="main"
          ? <button onClick={()=>setSection("main")} style={{background:"none",border:"none",
              fontSize:16,color:"#007aff",cursor:"pointer",padding:0}}>â€¹ Back</button>
          : <div/>}
        <div style={{fontSize:17,fontWeight:600,color:settings.darkMode?"#fff":"#1c1c1e"}}>
          {section==="main"?"Settings":section==="tags"?"Tag Rules":
           section==="archive"?"Archive":section==="account"?"Account":"Settings"}
        </div>
        <button onClick={onClose} style={{background:"none",border:"none",fontSize:16,
          color:"#007aff",cursor:"pointer"}}>Done</button>
      </div>

      {section==="main"&&<>
        <div style={{fontSize:12,color:"#636366",textTransform:"uppercase",letterSpacing:"0.06em",
          padding:"16px 20px 6px"}}>Appearance</div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          {toggle("Dark Mode","darkMode")}
        </div>
        <div style={{fontSize:12,color:"#636366",textTransform:"uppercase",letterSpacing:"0.06em",
          padding:"8px 20px 6px"}}>Data</div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          {row("Tag Rules",`${Object.keys(rules).length} rules â€º`,()=>setSection("tags"))}
          {row("Archive / Deleted",`${archived.length} transactions â€º`,()=>setSection("archive"))}
        </div>
        <div style={{fontSize:12,color:"#636366",textTransform:"uppercase",letterSpacing:"0.06em",
          padding:"8px 20px 6px"}}>Notifications</div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          {toggle("New transactions","notifications")}
          {toggle("Daily sync at 7am","autoSync")}
        </div>
        {customProps.length>0&&<>
          <div style={{fontSize:12,color:"#636366",textTransform:"uppercase",letterSpacing:"0.06em",
            padding:"8px 20px 6px"}}>Properties</div>
          <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
            {customProps.map(p=>(
              <div key={p.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",
                padding:"12px 20px",borderBottom:"1px solid rgba(0,0,0,0.07)",background:"#fff"}}>
                <div>
                  <div style={{fontSize:15,color:"#1c1c1e",fontWeight:500}}>{p.label}</div>
                  <div style={{fontSize:12,color:"#636366"}}>{p.isAirbnb?"Airbnb property":"Non-Airbnb property"}</div>
                </div>
                <button onClick={()=>{if(window.confirm(`Delete "${p.label}"? Transactions will become untagged.`))onDeleteProp(p.id);}}
                  style={{background:"none",border:"none",color:"#ff3b30",fontSize:14,cursor:"pointer",padding:"4px 8px"}}>Delete</button>
              </div>
            ))}
          </div>
        </>}
        <div style={{fontSize:12,color:"#636366",textTransform:"uppercase",letterSpacing:"0.06em",
          padding:"8px 20px 6px"}}>Account</div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          {linked.map(a=>row(`${a.name} Â·Â·Â·${a.mask||""}`, "Remove",
            ()=>{if(window.confirm(`Remove ${a.name}?`))onRemoveAccount(a.access_token||a.id);}))}
          {row("Clear all data","â€º",()=>{if(window.confirm("Delete all transactions and tags?"))onClearAll();})}
        </div>
      </>}

      {section==="tags"&&<>
        <div style={{fontSize:12,color:"#636366",padding:"16px 20px 6px"}}>
          These rules auto-tag transactions from matching payees.
        </div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          {Object.keys(rules).length===0&&<div style={{padding:"20px",background:"#fff",
            textAlign:"center",color:"#636366",fontSize:14}}>No rules yet â€” tag a transaction to create one.</div>}
          {Object.entries(rules).map(([payee,propId])=>(
            <div key={payee} style={{display:"flex",justifyContent:"space-between",alignItems:"center",
              padding:"12px 20px",borderBottom:"1px solid rgba(0,0,0,0.07)",background:"#fff"}}>
              <div>
                <div style={{fontSize:14,color:"#1c1c1e",fontWeight:500,textTransform:"capitalize"}}>
                  {payee.charAt(0)+payee.slice(1).toLowerCase()}
                </div>
                <div style={{fontSize:12,color:"#636366"}}>{PROP_LABEL[propId]||propId}</div>
              </div>
              <button onClick={()=>onDeleteRule(payee)} style={{background:"none",border:"none",
                color:"#ff3b30",fontSize:14,cursor:"pointer",padding:"4px 8px"}}>Delete</button>
            </div>
          ))}
        </div>
      </>}

      {section==="archive"&&<>
        <div style={{fontSize:12,color:"#636366",padding:"16px 20px 6px"}}>
          Deleted & internal transfers. Tap Restore to bring back.
        </div>
        <div style={{borderRadius:12,overflow:"hidden",margin:"0 16px 16px"}}>
          {archived.length===0&&<div style={{padding:"20px",background:"#fff",
            textAlign:"center",color:"#636366",fontSize:14}}>Nothing archived.</div>}
          {archived.map(tx=>(
            <div key={tx.id} style={{display:"flex",justifyContent:"space-between",alignItems:"center",
              padding:"12px 20px",borderBottom:"1px solid rgba(0,0,0,0.07)",background:"#fff"}}>
              <div style={{flex:1,minWidth:0,marginRight:12}}>
                <div style={{fontSize:14,fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",
                  whiteSpace:"nowrap"}}>{tx.payee||tx.name}</div>
                <div style={{fontSize:12,color:"#636366"}}>{tx.date}</div>
              </div>
              <div style={{display:"flex",alignItems:"center",gap:8}}>
                <span style={{fontSize:13,fontWeight:600,color:tx.amount>0?"#30d158":"#ff453a",
                  fontFamily:"monospace"}}>{tx.amount>0?"+":""}{Math.abs(tx.amount).toFixed(0)}</span>
                <button onClick={()=>doRestore(tx.id)} style={{background:"rgba(0,122,255,0.1)",
                  border:"none",borderRadius:8,fontSize:12,fontWeight:600,color:"#007aff",
                  padding:"4px 10px",cursor:"pointer"}}>Restore</button>
              </div>
            </div>
          ))}
        </div>
      </>}
    </div>
  );
}

// â”€â”€ AddPropertyModal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function AddPropertyModal({ onSave, onClose }) {
  const [name, setName] = React.useState("");
  const [isAirbnb, setIsAirbnb] = React.useState(false);
  const nameRef = React.useRef(null);
  React.useEffect(()=>{ nameRef.current?.focus(); },[]);
  const handleSave = () => {
    if(!name.trim()) return;
    const id = name.trim().toLowerCase().replace(/[^a-z0-9]+/g,"-").replace(/^-|-$/g,"") + "-" + Date.now().toString(36);
    onSave({ id, label: name.trim(), isAirbnb });
  };
  return (
    <div style={{position:"fixed",inset:0,zIndex:600,display:"flex",flexDirection:"column",
      justifyContent:"flex-end",background:"rgba(0,0,0,0.45)",backdropFilter:"blur(8px)"}}>
      <div style={{background:"#fff",borderRadius:"20px 20px 0 0",padding:"24px 20px 40px"}}>
        <div style={{width:36,height:4,background:"rgba(0,0,0,0.15)",borderRadius:2,
          margin:"0 auto 20px",cursor:"pointer"}} onClick={onClose}/>
        <div style={{fontSize:11,fontWeight:700,letterSpacing:"0.08em",color:"#636366",
          textTransform:"uppercase",marginBottom:8}}>Add Property</div>
        <input
          ref={nameRef}
          value={name} onChange={e=>setName(e.target.value)}
          onKeyDown={e=>{ if(e.key==="Enter") handleSave(); }}
          placeholder="Property name"
          style={{width:"100%",boxSizing:"border-box",fontSize:17,padding:"12px 14px",
            border:"1px solid rgba(0,0,0,0.15)",borderRadius:12,outline:"none",marginBottom:16,
            fontFamily:"inherit",color:"#1c1c1e"}}
        />
        <div style={{display:"flex",gap:8,marginBottom:name.trim()&&isAirbnb?8:16}}>
          {[{v:false,l:"Non-Airbnb"},{v:true,l:"Airbnb"}].map(opt=>(
            <button key={String(opt.v)} onClick={()=>setIsAirbnb(opt.v)}
              style={{flex:1,padding:"10px",border:`1.5px solid ${isAirbnb===opt.v?"#007aff":"rgba(0,0,0,0.15)"}`,
                borderRadius:10,fontSize:14,fontWeight:isAirbnb===opt.v?600:400,
                color:isAirbnb===opt.v?"#007aff":"#636366",
                background:isAirbnb===opt.v?"rgba(0,122,255,0.07)":"transparent",cursor:"pointer"}}>
              {opt.l}
            </button>
          ))}
        </div>
        {isAirbnb&&<div style={{fontSize:12,color:"#636366",marginBottom:16,padding:"8px 12px",
          background:"rgba(0,0,0,0.04)",borderRadius:8}}>
          No separate tab â€” rolled into Airbnb aggregate
        </div>}
        <button onClick={handleSave} disabled={!name.trim()}
          style={{width:"100%",padding:"15px",borderRadius:12,fontSize:16,fontWeight:600,
            border:"none",cursor:name.trim()?"pointer":"default",
            background:name.trim()?"#1a1a2e":"rgba(0,0,0,0.08)",
            color:name.trim()?"#fff":"rgba(0,0,0,0.3)"}}>
          Add Property
        </button>
        <button onClick={onClose} style={{width:"100%",marginTop:8,padding:"12px",background:"none",
          border:"none",fontSize:15,color:"#636366",cursor:"pointer"}}>Cancel</button>
      </div>
    </div>
  );
}

// â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [tab, setTab]           = useState("Portfolio");
  const [tabIdx, setTabIdx]     = useState(0);
  const [customProps, setCustomProps] = useState(()=>LS.get(CUSTOM_PROPS_KEY)||[]);
  const [showAddProp, setShowAddProp] = useState(false);

  // Dynamic tabs: base 5 + any non-Airbnb custom props
  const tabs = useMemo(()=>[...BASE_TABS,...customProps.filter(p=>!p.isAirbnb).map(p=>p.label)],[customProps]);
  const feedIdx    = tabs.length;
  const archiveIdx = tabs.length + 1;

  // Sync module-level mutable arrays so PropBadge/TagMenu child components see current properties
  PROPERTIES = [...BASE_PROPERTIES,...customProps.map(p=>({id:p.id,label:p.label,color:"var(--text)",group:p.isAirbnb?"airbnb":p.id}))];
  AIRBNB_IDS = [...BASE_AIRBNB_IDS,...customProps.filter(p=>p.isAirbnb).map(p=>p.id)];
  // Center active pill in nav when tabIdx changes
  // Set initial track position + page-outer top after mount
  useEffect(()=>{
    if(trackRef.current) trackRef.current.style.transform = "translateX(0px)";
    const headerH = headerRef.current?.offsetHeight || 56;
    const navH = document.querySelector(".top-nav")?.offsetHeight || 44;
    const outer = document.querySelector(".page-outer");
    if(outer) outer.style.top = (headerH + navH) + "px";
    // Center the initial pill without animation
    centerNavPill(0, false);
  },[]);
  const trackRef                = useRef(null);
  const headerRef               = useRef(null);
  const navRef                  = useRef(null);
  const navTrackRef             = useRef(null);
  const drag                    = useRef({active:false,startX:0,startY:0,lastX:0,axis:null});
  const dragPillOffsets         = useRef(null); // pill center offsets cached at drag start

  const setTrackPos = (px, animated) => {
    const el = trackRef.current; if(!el) return;
    el.style.transition = animated ? "transform 0.32s cubic-bezier(0.25,0.46,0.45,0.94)" : "none";
    el.style.transform  = `translateX(${px}px)`;
  };

  // Center the active nav pill. Called explicitly so timing is deterministic.
  const centerNavPill = (idx, animated) => {
    const nav = navRef.current;
    const track = navTrackRef.current;
    if(!nav || !track) return;
    const pills = track.querySelectorAll(".top-nav-pill");
    const pill = pills[idx];
    if(!pill) return;
    const navW = nav.offsetWidth;
    const offset = navW/2 - pill.offsetLeft - pill.offsetWidth/2;
    track.style.transition = animated ? "transform 0.32s cubic-bezier(0.25,0.46,0.45,0.94)" : "none";
    track.style.transform = `translateX(${offset}px)`;
  };

  const navigateTab = (t) => {
    if(t === "Archive"){
      setTab("Archive"); setTabIdx(archiveIdx);
      setTrackPos(-archiveIdx * window.innerWidth, true);
      return;
    }
    if(t === "Feed"){
      setTab("Feed"); setTabIdx(feedIdx);
      setTrackPos(-feedIdx * window.innerWidth, true);
      return;
    }
    const idx = tabs.indexOf(t);
    if(idx < 0) return;
    setTab(t); setTabIdx(idx);
    setTrackPos(-idx * window.innerWidth, true);
    centerNavPill(idx, true);
  };


  const onTouchStart = (e) => {
    if(tabIdx >= feedIdx) return; // block swipe navigation from Feed or Archive panes
    const d = drag.current;
    d.active = true; d.axis = null;
    d.startX = d.lastX = e.touches[0].clientX;
    d.startY = e.touches[0].clientY;
    const el = trackRef.current; if(el) el.style.transition = "none";
    // Cache pill center offsets at drag start â€” avoids layout reads during move
    if(navTrackRef.current && navRef.current) {
      navTrackRef.current.style.transition = "none";
      const pills = navTrackRef.current.querySelectorAll(".top-nav-pill");
      const navW = navRef.current.offsetWidth;
      dragPillOffsets.current = Array.from(pills).map(p =>
        navW/2 - p.offsetLeft - p.offsetWidth/2
      );
    }
  };

  const onTouchMove = (e) => {
    const d = drag.current;
    if(!d.active) return;
    const dx = e.touches[0].clientX - d.startX;
    const dy = e.touches[0].clientY - d.startY;
    if(!d.axis){
      if(Math.abs(dx) < 6 && Math.abs(dy) < 6) return;
      d.axis = Math.abs(dx) > Math.abs(dy) ? "x" : "y";
    }
    if(d.axis !== "x") return;
    e.preventDefault();
    d.lastX = e.touches[0].clientX;
    const base = -tabIdx * window.innerWidth;
    const atStart = tabIdx===0 && dx>0;
    const atEnd   = tabIdx===tabs.length-1 && dx<0;
    const clampedDx = atStart ? Math.min(dx*0.06,16) : atEnd ? Math.max(dx*0.06,-16) : dx;
    setTrackPos(base + clampedDx, false);
    // Slide nav track so active pill stays centered proportionally during drag
    // Uses cached offsets from onTouchStart â€” no layout reads here
    if(navTrackRef.current && dragPillOffsets.current && !atStart && !atEnd){
      const frac = clampedDx / window.innerWidth;
      const offsets = dragPillOffsets.current;
      const toPillIdx = dx < 0 ? tabIdx+1 : tabIdx-1;
      const fromOff = offsets[tabIdx];
      const toOff   = offsets[toPillIdx];
      if(fromOff !== undefined && toOff !== undefined){
        const lerp = fromOff + (toOff - fromOff) * Math.min(1, Math.abs(frac));
        navTrackRef.current.style.transform = `translateX(${lerp}px)`;
      }
    }
  };

  const onTouchEnd = () => {
    const d = drag.current;
    if(!d.active) return;
    d.active = false;
    dragPillOffsets.current = null;
    if(d.axis !== "x"){ setTrackPos(-tabIdx*window.innerWidth, true); centerNavPill(tabIdx, true); return; }
    const dx = d.lastX - d.startX;
    const vw = window.innerWidth;
    let next = tabIdx;
    if(dx < -vw*0.25 && tabIdx < tabs.length-1) next = tabIdx+1;
    if(dx >  vw*0.25 && tabIdx > 0)             next = tabIdx-1;
    setTab(tabs[next] !== undefined ? tabs[next] : tab); setTabIdx(next);
    setTrackPos(-next*vw, true);
    // Animate nav pill to final position with same timing as swipe track
    centerNavPill(next, true);
  };
  const [txs, setTxs]           = useState(()=>LS.get(TX_KEY)||[]);
  const [tags, setTags]         = useState(()=>LS.get(TAGS_KEY)||{});
  const [autoTags, setAutoTags]   = useState(()=>LS.get(AUTO_KEY)||DEFAULT_AUTO);
  const [rules, setRules]         = useState({}); // payeeâ†’propId persistent rules
  const [settings, setSettings]   = useState({darkMode:false,notifications:true});
  const [showSettings, setShowSettings] = useState(false);
  const [showDrawer, setShowDrawer]     = useState(false);
  const [rulePrompt, setRulePrompt]     = useState(null); // {txId, payee, propId}
  const [tagging, setTagging]   = useState(null);
  const [linked, setLinked]     = useState([]);
  const [syncing, setSyncing]   = useState(false);
  const [status, setStatus]     = useState(null);
  const [linking, setLinking]   = useState(false);
  const [invest, setInvest]     = useState(()=>LS.get(INVEST_KEY)||DEFAULT_INVEST);
  // Manual income starts empty â€” user fills via âœŽ button in nav
  // Previously-saved entries persist in localStorage
  const [manualIncome, setManualIncome] = useState(()=>LS.get(MANUAL_KEY)||{});
  const [showManual, setShowManual] = useState(false);
  const [showInvest, setShowInvest] = useState(false);
  const [feedFilter, setFeedFilter] = useState("untagged");
  const [txFilter, setTxFilter] = useState("all");
  const [airbnbTxFilter, setAirbnbTxFilter] = useState("all");
  const [drillDown, setDrillDown] = useState(null); // {mo:"2025-11", type:"rev"|"exp"|"net", txs:[]}
  const [pierceTxFilter, setPierceTxFilter] = useState("all");

  useEffect(()=>{
    // Load bank connections
    fetch(`${BACKEND}/api/link-status`).then(r=>r.json()).then(d=>setLinked(d.accounts||[])).catch(()=>{});
    // Load server-side transactions (authoritative, deduplicated)
    fetch(`${BACKEND}/api/transactions/all`).then(r=>r.json()).then(data=>{
      if(data.transactions&&data.transactions.length>0){
        const arr=[...data.transactions].sort((a,b)=>b.date.localeCompare(a.date));
        setTxs(arr);
        LS.set(TX_KEY,arr);
      }
    }).catch(()=>{});
    // Load tags from server â€” server wins; migrate localStorage to server if server is empty
    fetch(`${BACKEND}/api/tags`).then(r=>r.json()).then(data=>{
      if(data.tags&&Object.keys(data.tags).length>0){
        setTags(data.tags); LS.set(TAGS_KEY,data.tags);
      } else {
        const local=LS.get(TAGS_KEY)||{};
        if(Object.keys(local).length>0)
          fetch(`${BACKEND}/api/tags`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tags:local})}).catch(()=>{});
      }
    }).catch(()=>{});
    // Load manual income from server â€” same pattern
    // Load rules
    fetch(`${BACKEND}/api/rules`).then(r=>r.json()).then(data=>{
      if(data.rules && Object.keys(data.rules).length>0){
        setRules(data.rules);
        const merged = {...(LS.get(AUTO_KEY)||DEFAULT_AUTO), ...data.rules};
        setAutoTags(merged);
        LS.set(AUTO_KEY, merged);
      }
    }).catch(()=>{});
    // Load settings
    fetch(`${BACKEND}/api/settings`).then(r=>r.json()).then(data=>{
      if(data.settings) setSettings(s=>({...s,...data.settings}));
    }).catch(()=>{});

    fetch(`${BACKEND}/api/manual-income`).then(r=>r.json()).then(data=>{
      if(data.manual&&Object.keys(data.manual).length>0){
        setManualIncome(data.manual); LS.set(MANUAL_KEY,data.manual);
      } else {
        const local=LS.get(MANUAL_KEY)||{};
        if(Object.keys(local).length>0)
          fetch(`${BACKEND}/api/manual-income`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({manual:local})}).catch(()=>{});
      }
    }).catch(()=>{});

    // Auto-sync daily at 7am â€” checks every minute if it's time
    const LAST_SYNC_KEY = "pg_last_auto_sync";
    const scheduleAutoSync = () => {
      const now = new Date();
      const lastSync = parseInt(localStorage.getItem(LAST_SYNC_KEY)||"0");
      const lastSyncDate = new Date(lastSync);
      // Check if we haven't synced today at 6am yet
      const todayAt7 = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 6, 0, 0);
      const shouldSync = now >= todayAt7 && lastSyncDate < todayAt7;
      if(shouldSync){
        console.log("Auto-sync: running daily 6am sync");
        localStorage.setItem(LAST_SYNC_KEY, Date.now().toString());
        fetch(`${BACKEND}/api/transactions/sync`).then(r=>r.json()).then(data=>{
          if(!data.error){
            fetch(`${BACKEND}/api/transactions/all`).then(r=>r.json()).then(d=>{
              if(d.transactions?.length>0){
                const arr=[...d.transactions].sort((a,b)=>b.date.localeCompare(a.date));
                setTxs(arr); LS.set(TX_KEY,arr);
              }
            }).catch(()=>{});
          }
        }).catch(()=>{});
      }
    };
    scheduleAutoSync(); // check immediately on load
    const ticker = setInterval(scheduleAutoSync, 60*1000); // check every minute
    return () => clearInterval(ticker);
  },[]);

  // Auto-tag: record suggestions only â€” user must confirm via Feed
  const applyAuto = useCallback((newTxs,at,cur)=>{
    // NO auto-application â€” just return existing tags unchanged
    // Auto-tag suggestions shown in Feed but not applied until user clicks
    return cur;
  },[]);

  // Get auto-tag suggestion for a tx (used in Feed to show hint)
  const getSuggestion = useCallback((tx)=>{
    if(tags[tx.id]) return null;
    const key=Object.keys(autoTags).find(k=>tx.payee?.toUpperCase().includes(k.toUpperCase()));
    return key ? autoTags[key] : null;
  },[tags,autoTags]);

  // Load all server-stored transactions (deduplicated server-side)
  const loadAll = useCallback(async(silent=false)=>{
    try {
      const res=await fetch(`${BACKEND}/api/transactions/all`);
      const data=await res.json();
      if(data.error) return;
      const arr=[...data.transactions].sort((a,b)=>b.date.localeCompare(a.date));
      setTxs(arr);
      LS.set(TX_KEY,arr);
      setTags(prev=>{ const u=applyAuto(arr,autoTags,prev); serverSaveTags(u); return u; });
      if(!silent) setStatus(`Loaded ${arr.length} transactions`);
    } catch(e){ if(!silent) setStatus("Load failed: "+e.message); }
  },[autoTags,applyAuto]);

  const sync = useCallback(async()=>{
    setSyncing(true); setStatus(null);
    try {
      const res=await fetch(`${BACKEND}/api/transactions/sync`);
      const data=await res.json();
      if(data.error) throw new Error(data.error);
      await loadAll(true);
      setStatus(`Synced Â· ${data.total_stored} transactions total`);
    } catch(e){setStatus("Sync failed: "+e.message);}
    finally{setSyncing(false);}
  },[loadAll]);

  const pullHistory = useCallback(async()=>{
    setSyncing(true); setStatus("Pulling 2 years of history â€” this may take 30s...");
    try {
      const res=await fetch(`${BACKEND}/api/transactions/historical`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({})});
      const data=await res.json();
      if(data.errors&&data.errors.length) setStatus(`Done with errors: ${data.errors[0]}`);
      await loadAll(true);
      setStatus(`âœ“ ${data.total_stored} transactions loaded (${data.pulled} pulled from history)`);
    } catch(e){setStatus("History pull failed: "+e.message);}
    finally{setSyncing(false);}
  },[loadAll]);

  const connectBank=useCallback(async()=>{
    setLinking(true); setStatus(null);
    try {
      const {link_token,error}=await fetch(`${BACKEND}/api/create-link-token`,{method:"POST"}).then(r=>r.json());
      if(error) throw new Error(error);
      window.Plaid.create({
        token:link_token,
        onSuccess:async(public_token,meta)=>{
          const name=meta?.institution?.name||"Bank Account";
          const ex=await fetch(`${BACKEND}/api/exchange-token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({public_token,account_name:name})}).then(r=>r.json());
          const ls=await fetch(`${BACKEND}/api/link-status`).then(r=>r.json());
          setLinked(ls.accounts||[]);
          // Pull 2 years of history immediately â€” this is what gets years of data like Copilot
          setStatus(`${name} connected â€” pulling 2 years of history...`);
          try {
            const hr=await fetch(`${BACKEND}/api/transactions/historical`,{
              method:"POST",headers:{"Content-Type":"application/json"},
              body:JSON.stringify({item_id:ex.item_id})
            }).then(r=>r.json());
            await loadAll(true);
            // Also run sync to catch anything from last 90 days not in historical
            await fetch(`${BACKEND}/api/transactions/sync`).then(r=>r.json());
            await loadAll(true);
            setStatus(`âœ“ ${name} â€” ${hr.total_stored||0} transactions loaded`);
          } catch(e) {
            setStatus(`${name} connected. Hit Sync to load transactions.`);
          }
        },
        onExit:err=>{if(err)setStatus("Exited: "+err.display_message);}
      }).open();
    } catch(e){setStatus("Could not open Plaid: "+e.message);}
    finally{setLinking(false);}
  },[sync]);

  const removeAccount=async(item_id)=>{
    await fetch(`${BACKEND}/api/remove-account`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item_id})});
    setLinked(prev=>prev.filter(a=>a.item_id!==item_id));
  };

  function doTag(txId, propId){
    const tx = txs.find(t=>t.id===txId);
    // Tag this transaction immediately
    const nextTags = {...tags, [txId]: propId};
    setTags(nextTags); serverSaveTags(nextTags); setTagging(null);
    // If payee is meaningful, show Copilot-style "apply to all?" prompt
    if(tx?.payee && propId!=="transfer" && propId!=="deleted"){
      const existingRule = rules[tx.payee.toUpperCase()];
      if(existingRule !== propId){
        // Slight delay so tag UI closes first
        setTimeout(()=>setRulePrompt({txId, payee:tx.payee, propId}), 150);
      }
    }
  }

  function applyRule(payee, propId, applyAll){
    const key = payee.toUpperCase();
    const nextAuto = {...autoTags, [key]: propId};
    const nextRules = {...rules, [key]: propId};
    setAutoTags(nextAuto); LS.set(AUTO_KEY, nextAuto);
    setRules(nextRules);
    fetch(`${BACKEND}/api/rules`,{method:"POST",headers:{"Content-Type":"application/json"},
      body:JSON.stringify({rules:nextRules})}).catch(()=>{});
    if(applyAll){
      // Tag all untagged transactions with same payee
      const nextTags = {...tags};
      txs.forEach(t=>{
        if(!nextTags[t.id] && t.payee?.toUpperCase()===key) nextTags[t.id]=propId;
      });
      setTags(nextTags); serverSaveTags(nextTags);
    }
    setRulePrompt(null);
  }

  function doDelete(txId){
    // Soft-delete: tag as "deleted" so it stays visible in the archive
    const nextTags={...tags,[txId]:"deleted"};
    setTags(nextTags); serverSaveTags(nextTags); setTagging(null);
  }

  function doRestore(txId){
    const nextTags={...tags}; delete nextTags[txId];
    setTags(nextTags); serverSaveTags(nextTags);
  }

  function doBulkTag(ids, propId){
    const nextTags={...tags};
    ids.forEach(id=>{ nextTags[id]=propId; });
    setTags(nextTags); serverSaveTags(nextTags);
  }

  function doBulkDelete(ids){
    const nextTags={...tags};
    ids.forEach(id=>{ nextTags[id]="deleted"; });
    setTags(nextTags); serverSaveTags(nextTags);
  }

  const saveInvest=vals=>{ setInvest(vals); LS.set(INVEST_KEY,vals); };

  const saveCustomProp = p => {
    const next=[...customProps,p]; setCustomProps(next); LS.set(CUSTOM_PROPS_KEY,next); setShowAddProp(false);
  };
  const deleteCustomProp = id => {
    const newTags={...tags};
    Object.keys(newTags).forEach(k=>{ if(newTags[k]===id) delete newTags[k]; });
    setTags(newTags); serverSaveTags(newTags);
    const next=customProps.filter(p=>p.id!==id); setCustomProps(next); LS.set(CUSTOM_PROPS_KEY,next);
  };

  // Server sync â€” write to localStorage AND server. localStorage = instant fallback if server fails.
  const serverSaveTags = useCallback((nextTags) => {
    LS.set(TAGS_KEY, nextTags);
    fetch(`${BACKEND}/api/tags`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({tags:nextTags})}).catch(()=>{});
  },[]);

  const saveManual = vals => {
    setManualIncome(vals);
    LS.set(MANUAL_KEY, vals);
    fetch(`${BACKEND}/api/manual-income`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({manual:vals})}).catch(()=>{});
  };

  // Deduplicate by id â€” Plaid can return the same transaction more than once
  const allEnriched=useMemo(()=>{
    const seen=new Set();
    return txs.filter(t=>!t.pending).filter(t=>{
      if(seen.has(t.id)) return false;
      seen.add(t.id);
      return true;
    }).map(tx=>({...tx,propId:tags[tx.id]||null}));
  },[txs,tags]);
  // Active = not deleted or transferred (for all normal financial calcs)
  const enriched = allEnriched.filter(t=>t.propId!=="deleted");
  const archived  = allEnriched.filter(t=>t.propId==="deleted"||t.propId==="transfer");
  const untagged  = enriched.filter(t=>!t.propId);
  const tagged    = enriched.filter(t=>t.propId&&t.propId!=="transfer");

  // â”€â”€ Metrics â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const M=useMemo(()=>{
    const forProp=id=>tagged.filter(t=>t.propId===id);
    const propM={};
    PROPERTIES.forEach(p=>{
      const ptxs=forProp(p.id);
      const rev=sumIn(ptxs), exp=sumOut(ptxs);
      propM[p.id]={rev,exp,cf:rev-exp,txs:ptxs};
    });

    // Manual income OVERRIDES Plaid for that month â€” no double counting
    // Build set of months that have manual entries
    const manualMonths = new Set(Object.keys(manualIncome).filter(k=>manualIncome[k]>0));
    // Plaid airbnb rev â€” exclude any month covered by manual entry
    const airbnbRevPlaid = AIRBNB_IDS.reduce((s,id)=>{
      const ptxs = propM[id].txs || [];
      return s + ptxs.filter(t=>t.type==="in"&&!manualMonths.has(t.date?.slice(0,7))).reduce((a,t)=>a+Math.abs(t.amount),0);
    }, 0);
    const manualAirbnbRev = Object.values(manualIncome).reduce((s,v)=>s+(v||0),0);
    const airbnbRev = airbnbRevPlaid + manualAirbnbRev;
    const airbnbExp=AIRBNB_IDS.reduce((s,id)=>s+propM[id].exp,0);
    const pierceRev=propM.pierce.rev, pierceExp=propM.pierce.exp;
    const llcExp   =propM.llc.exp;
    const totalRev =airbnbRev+pierceRev;
    const totalExp =airbnbExp+pierceExp+llcExp;
    const totalCF  =totalRev-totalExp;

    // Monthly data â€” use ALL non-transfer enriched txs + manual income entries
    const months = (() => {
      const seen = new Set();
      const mo={};
      enriched.filter(t=>t.propId!=="transfer").forEach(t=>{
        if(seen.has(t.id)) return;
        seen.add(t.id);
        const k=t.date?.slice(0,7)||"?";
        if(!mo[k])mo[k]={rev:0,exp:0,manual:false};
        if(t.type==="in")  mo[k].rev+=Math.abs(t.amount);
        if(t.type==="out") mo[k].exp+=Math.abs(t.amount);
      });
      // Manual income OVERRIDES Airbnb Plaid rev for that month only
      // Pierce revenue is already in mo[k].rev â€” we keep it, just swap out airbnb portion
      Object.entries(manualIncome).forEach(([k,v])=>{
        if(!v) return;
        if(!mo[k])mo[k]={rev:0,exp:0,airbnbRev:0,manual:true};
        // Subtract airbnb plaid rev for this month (already counted above), add manual
        const airbnbPlaidForMonth = AIRBNB_IDS.reduce((s,id)=>{
          return s + (propM[id]?.txs||[]).filter(t=>t.type==="in"&&t.date?.slice(0,7)===k).reduce((a,t)=>a+Math.abs(t.amount),0);
        },0);
        mo[k].rev = (mo[k].rev - airbnbPlaidForMonth) + v;
        mo[k].manual=true;
      });
      return Object.entries(mo).sort((a,b)=>a[0].localeCompare(b[0]));
    })();

    const moCount = Math.max(months.length, 1);
    const annualRev = (totalRev/moCount)*12;
    const annualExp = (totalExp/moCount)*12;

    // Real estate metrics
    const totalInvest = Object.values(invest).reduce((s,v)=>s+v,0);
    const netMargin   = totalRev>0?(totalCF/totalRev)*100:null;
    const cocReturn   = totalInvest>0?(totalCF/totalInvest)*100:null;
    const annualCoc   = totalInvest>0?((totalCF/moCount*12)/totalInvest)*100:null;

    // Per-property CoC
    const propCoc={};
    ["lockwood","everton","bstreet","pierce"].forEach(id=>{ // per-property CoC only
      const inv=invest[id]||0;
      propCoc[id]=inv>0?(propM[id].cf/inv)*100:null;
    });

    // â”€â”€ Quarterly aggregation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const quarters = (() => {
      const qmap = {};
      enriched.filter(t=>t.propId!=="transfer"&&t.date).forEach(t=>{
        const [yr,mo] = t.date.split("-");
        const q = Math.ceil(+mo/3);
        const key = `${yr}-Q${q}`;
        if(!qmap[key]) qmap[key]={label:`Q${q} '${yr.slice(2)}`,year:+yr,q,key,rev:0,exp:0,txCount:0};
        if(t.type==="in")  qmap[key].rev += Math.abs(t.amount);
        if(t.type==="out") qmap[key].exp += Math.abs(t.amount);
        qmap[key].txCount++;
      });
      return Object.values(qmap)
        .sort((a,b)=>a.year!==b.year?a.year-b.year:a.q-b.q)
        .map(q=>({...q, net:q.rev-q.exp, margin:q.rev>0?((q.rev-q.exp)/q.rev)*100:0, expRatio:q.rev>0?(q.exp/q.rev)*100:0}));
    })();

    // Monthly seasonal projections for rest of FY26
    // STR seasonality index by month (1.0 = average) â€” peaks summer/holidays, dips Jan-Feb
    const STR_SEASONAL = {
      "01":0.72,"02":0.75,"03":0.90,"04":1.00,"05":1.10,
      "06":1.18,"07":1.22,"08":1.20,"09":1.05,"10":1.02,
      "11":0.95,"12":1.08
    };
    const today = new Date();
    const currentMoKey = `${today.getFullYear()}-${String(today.getMonth()+1).padStart(2,'0')}`;
    // Compute monthly avg from actual data (airbnb only, last 6 months with data)
    const actualAirbnbMonths = months.filter(([k])=>k<=currentMoKey&&k>="2025-01");
    const avgAirbnbRev = actualAirbnbMonths.length>0
      ? actualAirbnbMonths.reduce((s,[,v])=>s+(v.rev||0),0)/actualAirbnbMonths.length
      : airbnbRev/Math.max(moCount,1);
    const avgAirbnbExp = actualAirbnbMonths.length>0
      ? actualAirbnbMonths.reduce((s,[,v])=>s+(v.exp||0),0)/actualAirbnbMonths.length
      : airbnbExp/Math.max(moCount,1);
    // Pierce is flat â€” use actual monthly avg
    const avgPierceRev = pierceRev/Math.max(moCount,1);
    const avgPierceExp = pierceExp/Math.max(moCount,1);
    // Build projected months for rest of 2026
    const projMonths = [];
    for(let m=1;m<=12;m++){
      const key=`2026-${String(m).padStart(2,'0')}`;
      if(key<=currentMoKey) continue; // skip months that already have actual data
      const si = STR_SEASONAL[String(m).padStart(2,'0')]||1.0;
      const projAirbnbRev = avgAirbnbRev * si;
      const projPierceRev = avgPierceRev;
      const projExp = (avgAirbnbExp * si) + avgPierceExp;
      projMonths.push([key,{rev:projAirbnbRev+projPierceRev, exp:projExp, projected:true}]);
    }
    // Combine actual + projected for full-year chart view
    const monthsWithProjections = [...months, ...projMonths];
    // 5-year annual projections (for table)
    const currentYear=new Date().getFullYear();
    const annualBase = (avgAirbnbRev+avgPierceRev)*12;
    const annualExpBase = (avgAirbnbExp+avgPierceExp)*12;
    const projections=Array.from({length:6},(_,i)=>{
      const yr=currentYear+i;
      const rev=annualBase*Math.pow(1.03,i);
      const exp=annualExpBase*Math.pow(1.02,i);
      return {year:yr,rev,exp,net:rev-exp,margin:rev>0?((rev-exp)/rev)*100:0};
    });

    // Quarterly projections â€” seasonal index by quarter
    const Q_SEASONAL = {"1":0.79,"2":1.09,"3":1.16,"4":1.02};
    const curQtr = Math.ceil((today.getMonth()+1)/3);
    const curQKey = `${today.getFullYear()}-Q${curQtr}`;
    const actualQtrs = quarters.filter(q=>q.key<=curQKey);
    const avgQRev = actualQtrs.length>0 ? actualQtrs.reduce((s,q)=>s+q.rev,0)/actualQtrs.length : 0;
    const avgQExp = actualQtrs.length>0 ? actualQtrs.reduce((s,q)=>s+q.exp,0)/actualQtrs.length : 0;
    const projQuarters = [];
    for(let yr=today.getFullYear();yr<=today.getFullYear()+1;yr++){
      for(let q=1;q<=4;q++){
        const key=`${yr}-Q${q}`;
        if(key<=curQKey||quarters.find(x=>x.key===key)) continue;
        const si=Q_SEASONAL[q.toString()]||1;
        const growth=Math.pow(1.03,yr-today.getFullYear());
        const rev=avgQRev*si*growth, exp=avgQExp*si*Math.pow(1.02,yr-today.getFullYear());
        projQuarters.push({key,label:`Q${q} '${yr.toString().slice(2)}`,year:yr,q,rev,exp,net:rev-exp,margin:rev>0?((rev-exp)/rev)*100:0,projected:true});
      }
    }
    const quartersWithProjections=[...quarters,...projQuarters];

    return {propM,airbnbRev,airbnbExp,airbnbCF:airbnbRev-airbnbExp,pierceRev,pierceExp,pierceCF:pierceRev-pierceExp,llcExp,totalRev,totalExp,totalCF,netMargin,cocReturn,annualCoc,propCoc,months,monthsWithProjections,moCount,projections,annualRev,annualExp,quarters,quartersWithProjections};
  },[tagged,enriched,invest,manualIncome]);

  const hasBank=linked.length>0||txs.length>0; // show content if we have txs even if linked state not yet resolved

  const clearAllData = () => {
    if(!window.confirm("Clear all cached transactions and tags? This cannot be undone.")) return;
    LS.set(TX_KEY, []); LS.set(TAGS_KEY, {}); LS.set(AUTO_KEY, {}); LS.set(MANUAL_KEY, {});
    setTxs([]); setTags({}); setAutoTags({}); setManualIncome({});
    // Also clear from server
    fetch(`${BACKEND}/api/transactions/delete`, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({ids:"__ALL__"})}).catch(()=>{});
    setStatus("All local data cleared");
  };
  // Tabs: Portfolio | Airbnb | Pierce | Feed | Archive
  const feedTxs = feedFilter==="untagged"?untagged:feedFilter==="tagged"?tagged:enriched;

  // Tab icons
  const TAB_ICONS = {
    "Portfolio": <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="3" width="7" height="7" rx="1.5"/><rect x="14" y="3" width="7" height="7" rx="1.5"/><rect x="3" y="14" width="7" height="7" rx="1.5"/><rect x="14" y="14" width="7" height="7" rx="1.5"/></svg>,
    "Airbnb":    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
    "Pierce":    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><circle cx="12" cy="13" r="2"/></svg>,
    "Feed":      <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>,
    "Quarterly":  <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
    "Projections":<svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><polyline points="22 7 13.5 15.5 8.5 10.5 2 17"/><polyline points="16 7 22 7 22 13"/></svg>,
    "Archive":   <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><polyline points="21 8 21 21 3 21 3 8"/><rect x="1" y="3" width="22" height="5" rx="1"/><line x1="10" y1="12" x2="14" y2="12"/></svg>,
  };

  return (
    <div style={{minHeight:"100vh",background:"#f5f5f7"}}>

      {/* TOP HEADER â€” minimal 3-slot */}
      <div className="top-header" ref={headerRef} style={{position:"relative",justifyContent:"space-between"}}>
        {/* Left: hamburger */}
        <button onClick={()=>setShowDrawer(true)} style={{background:"transparent",border:"none",color:"var(--text-2)",padding:"6px 8px",borderRadius:8,cursor:"pointer",display:"flex",alignItems:"center",fontSize:22,lineHeight:1,zIndex:1,flexShrink:0}}>â˜°</button>
        {/* Center: logo + name (absolutely centered) */}
        <div style={{position:"absolute",left:"50%",transform:"translateX(-50%)",display:"flex",alignItems:"center",gap:7,pointerEvents:"none"}}>
          <svg width="22" height="22" viewBox="0 0 32 32" fill="none"><ellipse cx="16" cy="13" rx="8" ry="7" fill="#1a1a2e"/><ellipse cx="16" cy="13" rx="5" ry="4.5" fill="#f5f5f7"/><circle cx="16" cy="13" r="2" fill="#1a1a2e"/><path d="M12 19c0 0-4 3-4 7h16c0-4-4-7-4-7" fill="#1a1a2e"/></svg>
          <span style={{fontWeight:700,fontSize:15,letterSpacing:"-0.01em"}}>Property Pigeon</span>
        </div>
        {/* Right: subtle sync dot when syncing, otherwise spacer */}
        <div style={{width:40,display:"flex",alignItems:"center",justifyContent:"flex-end",flexShrink:0}}>
          {syncing&&<div style={{width:7,height:7,borderRadius:"50%",background:"var(--green)",opacity:0.7}}/>}
        </div>
      </div>
      {/* TOP NAV */}
      <div className="top-nav" ref={navRef}>
        <div className="top-nav-track" ref={navTrackRef}>
          {tabs.map(t=>(
            <button key={t} className={`top-nav-pill${tabs[tabIdx]===t?" active":""}`} onClick={()=>navigateTab(t)}>
              {t}
            </button>
          ))}
        </div>
      </div>

      {/* CONTENT */}
      <div className="page-outer" onTouchStart={onTouchStart} onTouchMove={onTouchMove} onTouchEnd={onTouchEnd}>
        <div ref={trackRef} className="swipe-track" style={{transform:"translateX(0px)"}}>

        <div className="swipe-pane">
          <div style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Total Portfolio</div>
              <div style={{display:"flex",alignItems:"baseline",gap:10}}>
                <div className="big-num">{fmt$(M.totalRev)}</div>
                <div style={{fontSize:13,color:"var(--text-3)"}}>gross revenue</div>
              </div>
              <div style={{display:"flex",gap:16,marginTop:6}}>
                <span style={{fontSize:13,color:"#ff453a"}}>{fmt$(M.totalExp)} expenses</span>
                <span style={{fontSize:13,color:M.totalCF>=0?"#30d158":"#ff453a",fontWeight:600}}>{fmt$(M.totalCF)} net</span>
                {M.netMargin!==null&&<span style={{fontSize:13,color:"var(--text-3)"}}>{fmtPct(M.netMargin)} margin</span>}
              </div>
            </div>

            {/* Nudge to enter manual income if empty */}
            {Object.keys(manualIncome).length===0&&(
              <div style={{background:"rgba(0,0,0,0.04)",border:"1px solid rgba(0,0,0,0.08)",borderRadius:10,padding:"10px 14px",marginBottom:10,display:"flex",alignItems:"center",justifyContent:"space-between",gap:10}}>
                <span style={{fontSize:12,color:"var(--text-2)"}}>No Airbnb revenue entered yet â€” add monthly payouts to see accurate numbers</span>
                <button onClick={()=>setShowManual(true)} style={{fontSize:11,fontWeight:600,background:"#1a1a2e",color:"#fff",border:"none",borderRadius:8,padding:"5px 12px",cursor:"pointer",whiteSpace:"nowrap"}}>âœŽ Add Income</button>
              </div>
            )}

            {/* Summary cards */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
              {[
                {l:"Airbnb Revenue",  v:fmt$(M.airbnbRev), sub:"8 units"},
                {l:"Pierce Revenue",  v:fmt$(M.pierceRev), sub:"7 units"},
                {l:"Total Expenses",  v:fmt$(M.totalExp),  sub:"all properties", red:true},
                {l:"Net Income",      v:fmt$(M.totalCF),   sub:fmtPct(M.netMargin)+" margin", green:M.totalCF>=0},
              ].map(c=>(
                <div key={c.l} className="card card-padded">
                  <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>{c.l}</div>
                  <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                  <div style={{fontSize:11,color:"var(--text-3)",marginTop:2}}>{c.sub}</div>
                </div>
              ))}
            </div>

            {/* To Review â€” always visible, Copilot-style */}
            {(()=>{
              const toReview = untagged.slice(0, 8);
              const PROP_LABEL = {lockwood:"Lockwood",everton:"Everton",bstreet:"B Street",pierce:"Pierce Ave",llc:"General LLC",transfer:"Transfer"};
              const PROP_COLOR = {lockwood:"#30d158",everton:"#007aff",bstreet:"#ff9f0a",pierce:"#bf5af2",llc:"#636366",transfer:"#636366"};
              return (
                <div style={{marginBottom:16}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:8,paddingLeft:2}}>
                    <div style={{fontSize:11,fontWeight:700,letterSpacing:"0.08em",color:"var(--text-3)",textTransform:"uppercase"}}>
                      To Review
                      {toReview.length>0&&<span style={{marginLeft:6,background:"#007aff",color:"#fff",borderRadius:10,padding:"1px 7px",fontSize:9,fontWeight:700,verticalAlign:"middle"}}>{untagged.length}</span>}
                    </div>
                    <button onClick={()=>navigateTab("Feed")} style={{background:"none",border:"none",fontSize:12,color:"#007aff",cursor:"pointer",padding:0,fontWeight:500}}>View all â€º</button>
                  </div>
                  <div className="card" style={{overflow:"hidden",borderRadius:16}}>
                    {toReview.length===0?(
                      <div style={{padding:"20px 16px",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                        <span style={{fontSize:13,color:"var(--text-3)"}}>Nothing to review â€” all caught up</span>
                        <button onClick={()=>navigateTab("Feed")} style={{background:"none",border:"1px solid rgba(0,0,0,0.12)",borderRadius:8,fontSize:11,fontWeight:600,color:"var(--text-3)",padding:"4px 10px",cursor:"pointer",whiteSpace:"nowrap"}}>View all transactions</button>
                      </div>
                    ):(
                      <>
                        {toReview.map((tx,i)=>{
                          const sug = getSuggestion(tx);
                          return (
                            <div key={tx.id} style={{borderBottom:i<toReview.length-1?"1px solid rgba(0,0,0,0.06)":"none"}}>
                              <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"13px 16px"}}>
                                <div style={{flex:1,minWidth:0,marginRight:12}}>
                                  <div style={{fontSize:14,fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:"var(--text)"}}>{tx.payee||tx.name}</div>
                                  <div style={{display:"flex",alignItems:"center",gap:8,marginTop:4}}>
                                    <span style={{fontSize:11,color:"var(--text-3)"}}>{tx.date}</span>
                                    {sug&&(
                                      <button onClick={e=>{e.stopPropagation();doTag(tx.id,sug);}}
                                        style={{background:`${PROP_COLOR[sug]||"#636366"}20`,border:"none",borderRadius:20,
                                          fontSize:11,fontWeight:700,color:PROP_COLOR[sug]||"#636366",
                                          padding:"2px 10px",cursor:"pointer",letterSpacing:"0.04em",textTransform:"uppercase"}}>
                                        {PROP_LABEL[sug]||sug}
                                      </button>
                                    )}
                                  </div>
                                </div>
                                <div style={{display:"flex",alignItems:"center",gap:10,flexShrink:0}}>
                                  <span style={{fontSize:14,fontWeight:700,color:tx.amount>0?"#30d158":"#ff453a",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>
                                    {tx.amount>0?"+":""}{fmt$(Math.abs(tx.amount))}
                                  </span>
                                  <div style={{width:8,height:8,borderRadius:"50%",background:"#007aff",flexShrink:0}}/>
                                </div>
                              </div>
                            </div>
                          );
                        })}
                        <button onClick={async()=>{
                          for(const tx of toReview){
                            const sug=getSuggestion(tx);
                            if(sug) await doTag(tx.id,sug);
                            else await doTag(tx.id,"llc");
                          }
                        }} style={{width:"100%",padding:"14px",background:"none",border:"none",
                          borderTop:"1px solid rgba(0,0,0,0.06)",fontSize:13,fontWeight:600,
                          color:"var(--text-2)",cursor:"pointer",textAlign:"center",letterSpacing:"0.02em"}}>
                          MARK AS REVIEWED
                        </button>
                      </>
                    )}
                  </div>
                </div>
              );
            })()}

            {/* Month-by-month charts */}
            {M.months.length>0&&(<>
              <div className="section-title">Revenue Â· Month by Month <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>hatched = projected</span></div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="rev" color="#30d158" onBarClick={(mo)=>setDrillDown({mo,type:"rev",txs:enriched})}/>
              </div>

              <div className="section-title">Expenses Â· Month by Month</div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="exp" color="#ff453a" onBarClick={(mo)=>setDrillDown({mo,type:"exp",txs:enriched})}/>
              </div>

              <div className="section-title">Net Income Â· Month by Month</div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="net" color={null} onBarClick={(mo)=>setDrillDown({mo,type:"net",txs:enriched})}/>
              </div>

              <div className="section-title">Net Margin % Â· Month by Month <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>â‰¥30% healthy Â· grey=marginal Â· red=negative</span></div>
              <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
                <MiniBar months={M.monthsWithProjections} valueKey="margin" color={null} marginMode fmt={v=>`${v.toFixed(1)}%`}/>
              </div>
            </>)}



            {/* CoC return */}
            {M.annualCoc&&(
              <>
                <div className="section-title">Return on Investment</div>
                <div className="card card-padded" style={{marginBottom:8}}>
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
                    {[
                      {l:"Cash-on-Cash",v:fmtPct(M.annualCoc),sub:"annualized"},
                      {l:"Net Margin",  v:fmtPct(M.netMargin), sub:"total revenue"},
                    ].map(c=>(
                      <div key={c.l}>
                        <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:3}}>{c.l}</div>
                        <div style={{fontSize:20,fontWeight:700,letterSpacing:"-0.02em"}}>{c.v}</div>
                        <div style={{fontSize:10,color:"var(--text-3)"}}>{c.sub}</div>
                      </div>
                    ))}
                  </div>
                  <button onClick={()=>setShowInvest(true)} style={{marginTop:12,fontSize:11,color:"var(--text-3)",background:"none",border:"none",cursor:"pointer",textDecoration:"underline",padding:0}}>
                    Edit down payments â†’
                  </button>
                </div>
              </>
            )}
            {!M.annualCoc&&(
              <button onClick={()=>setShowInvest(true)} style={{fontSize:12,color:"var(--text-3)",background:"rgba(0,0,0,0.04)",border:"1px solid rgba(0,0,0,0.08)",borderRadius:10,padding:"8px 14px",cursor:"pointer",marginBottom:8,display:"block"}}>
                + Add down payments to see CoC return
              </button>
            )}
          </div>
        </div>

        {/* â”€â”€ AIRBNB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        <div className="swipe-pane">
          <div style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Airbnb Portfolio Â· 8 units</div>
              <div className="big-num">{fmt$(M.airbnbRev)}</div>
              <div style={{display:"flex",gap:16,marginTop:6,flexWrap:"wrap"}}>
                <span style={{fontSize:13,color:"#ff453a"}}>{fmt$(M.airbnbExp)} expenses</span>
                <span style={{fontSize:13,color:M.airbnbCF>=0?"#30d158":"#ff453a",fontWeight:600}}>{fmt$(M.airbnbCF)} net</span>
                {M.airbnbRev>0&&<span style={{fontSize:13,color:"var(--text-3)"}}>{fmtPct((M.airbnbCF/M.airbnbRev)*100)} margin</span>}
              </div>
            </div>

            {/* KPI cards */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
              {[
                {l:"Gross Revenue",  v:fmt$(M.airbnbRev),  green:true},
                {l:"Total Expenses", v:fmt$(M.airbnbExp),  red:true},
                {l:"Net Income",     v:fmt$(M.airbnbCF),   green:M.airbnbCF>=0, red:M.airbnbCF<0},
                {l:"Net Margin",     v:M.airbnbRev>0?fmtPct((M.airbnbCF/M.airbnbRev)*100):"â€”", green:M.airbnbCF>=0},
              ].map(c=>(
                <div key={c.l} className="card card-padded">
                  <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>{c.l}</div>
                  <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                </div>
              ))}
            </div>

            {/* Month-by-month charts */}
            {M.months.length>0&&(()=>{
              // Build airbnb-only months â€” manual OVERRIDES Plaid rev for that month
              const aMo={};
              const manualMos = new Set(Object.keys(manualIncome).filter(k=>manualIncome[k]>0));
              tagged.filter(t=>AIRBNB_IDS.includes(t.propId)).forEach(t=>{
                const k=t.date?.slice(0,7)||"?";
                if(!aMo[k])aMo[k]={rev:0,exp:0};
                // Only count Plaid rev for months NOT covered by manual entry
                if(t.type==="in"&&!manualMos.has(k)) aMo[k].rev+=Math.abs(t.amount);
                if(t.type==="out") aMo[k].exp+=Math.abs(t.amount);
              });
              Object.entries(manualIncome).forEach(([k,v])=>{
                if(!v)return;
                if(!aMo[k])aMo[k]={rev:0,exp:0};
                aMo[k].rev=v; // override, not additive
              });
              // Add seasonal projections for rest of 2026
              const today2=new Date();
              const curMo2=`${today2.getFullYear()}-${String(today2.getMonth()+1).padStart(2,'0')}`;
              const STR_SI={"01":0.72,"02":0.75,"03":0.90,"04":1.00,"05":1.10,"06":1.18,"07":1.22,"08":1.20,"09":1.05,"10":1.02,"11":0.95,"12":1.08};
              const aActual=Object.entries(aMo).filter(([k])=>k<=curMo2);
              const aAvgRev=aActual.length>0?aActual.reduce((s,[,v])=>s+v.rev,0)/aActual.length:0;
              const aAvgExp=aActual.length>0?aActual.reduce((s,[,v])=>s+v.exp,0)/aActual.length:0;
              for(let m=1;m<=12;m++){
                const k=`2026-${String(m).padStart(2,'0')}`;
                if(k<=curMo2||aMo[k]) continue;
                const si=STR_SI[String(m).padStart(2,'0')]||1;
                aMo[k]={rev:aAvgRev*si,exp:aAvgExp*si,projected:true};
              }
              const aMths=Object.entries(aMo).sort((a,b)=>a[0].localeCompare(b[0]));
              if(aMths.length===0) return null;
              return (
                <>
                  <div className="section-title">Revenue Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="rev" color="#30d158" onBarClick={(mo)=>setDrillDown({mo,type:"rev",txs:enriched.filter(t=>AIRBNB_IDS.includes(t.propId)||(!t.propId&&t.type==="in"))})}/></div>
                  <div className="section-title">Expenses Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="exp" color="#ff453a" onBarClick={(mo)=>setDrillDown({mo,type:"exp",txs:enriched.filter(t=>AIRBNB_IDS.includes(t.propId))})}/></div>
                  <div className="section-title">Net Income Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="net" color={null} onBarClick={(mo)=>setDrillDown({mo,type:"net",txs:enriched.filter(t=>AIRBNB_IDS.includes(t.propId)||(!t.propId&&t.type==="in"))})}/></div>
                  <div className="section-title">Net Margin % Â· Month by Month <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>â‰¥30% healthy Â· grey=ok Â· red=negative</span></div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={aMths} valueKey="margin" color={null} marginMode fmt={v=>`${v.toFixed(1)}%`}/></div>
                </>
              );
            })()}

            {/* Per-property EXPENSES only (revenue comes in as lump sum, can't split) */}
            <div className="section-title">Expenses by Property</div>
            <div className="card" style={{marginBottom:8,overflow:"hidden"}}>
              <div style={{display:"grid",gridTemplateColumns:"1fr auto",padding:"8px 16px",borderBottom:"1px solid rgba(0,0,0,0.06)",gap:8}}>
                <span style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em"}}>Property</span>
                <span style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",textAlign:"right"}}>Expenses</span>
              </div>
              {["lockwood","everton","bstreet"].map((id,i)=>{
                const pm=M.propM[id]; const p=PROPERTIES.find(x=>x.id===id);
                const pct=M.airbnbExp>0?(pm.exp/M.airbnbExp)*100:0;
                return (
                  <div key={id} style={{padding:"12px 16px",borderBottom:i<2?"1px solid rgba(0,0,0,0.05)":"none"}}>
                    <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:5}}>
                      <span style={{fontSize:13,fontWeight:600}}>{p.label}</span>
                      <span style={{fontSize:13,color:"#ff453a",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:600}}>{fmt$(pm.exp)}</span>
                    </div>
                    <div style={{height:3,background:"rgba(0,0,0,0.06)",borderRadius:2,overflow:"hidden"}}>
                      <div style={{height:"100%",width:`${pct}%`,background:"#ff453a",borderRadius:2}}/>
                    </div>
                    <div style={{fontSize:10,color:"var(--text-3)",marginTop:3}}>{pct.toFixed(0)}% of total Airbnb expenses</div>
                  </div>
                );
              })}
            </div>

            {/* Transactions â€” unified All/In/Out */}
            <div className="section-title">Transactions</div>
            <TxList
              txs={enriched.filter(t=>AIRBNB_IDS.includes(t.propId)||(t.type==="in"&&!t.propId)||(t.type==="out"&&!t.propId))}
              tagging={tagging} setTagging={setTagging}
              doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
              filter={airbnbTxFilter} setFilter={setAirbnbTxFilter} getSuggestion={getSuggestion}
            />
          </div>
        </div>

        {/* â”€â”€ PIERCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        <div className="swipe-pane">
          <div style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Pierce Ave Â· 7 units Â· Section 8</div>
              <div className="big-num">{fmt$(M.pierceRev)}</div>
              <div style={{display:"flex",gap:16,marginTop:6,flexWrap:"wrap"}}>
                <span style={{fontSize:13,color:"#ff453a"}}>{fmt$(M.pierceExp)} expenses</span>
                <span style={{fontSize:13,color:M.pierceCF>=0?"#30d158":"#ff453a",fontWeight:600}}>{fmt$(M.pierceCF)} net</span>
                {M.pierceRev>0&&<span style={{fontSize:13,color:"var(--text-3)"}}>{fmtPct((M.pierceCF/M.pierceRev)*100)} margin</span>}
              </div>
            </div>

            {/* KPI cards */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
              {[
                {l:"Gross Rent",    v:fmt$(M.pierceRev),  green:true},
                {l:"Expenses",     v:fmt$(M.pierceExp),   red:true},
                {l:"Net Income",   v:fmt$(M.pierceCF),    green:M.pierceCF>=0, red:M.pierceCF<0},
                {l:"Net Margin",   v:M.pierceRev>0?fmtPct((M.pierceCF/M.pierceRev)*100):"â€”", green:M.pierceCF>=0},
              ].map(c=>(
                <div key={c.l} className="card card-padded">
                  <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>{c.l}</div>
                  <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                </div>
              ))}
            </div>

            {/* Month-by-month charts */}
            {(()=>{
              const pMo={};
              M.propM.pierce.txs.forEach(t=>{
                const k=t.date?.slice(0,7)||"?";
                if(!pMo[k])pMo[k]={rev:0,exp:0};
                if(t.type==="in") pMo[k].rev+=Math.abs(t.amount);
                if(t.type==="out") pMo[k].exp+=Math.abs(t.amount);
              });
              // Pierce is flat â€” project remaining 2026 months at same run rate
              const _now=new Date(); const curMo2=`${_now.getFullYear()}-${String(_now.getMonth()+1).padStart(2,'0')}`;
              const pActual=Object.entries(pMo).filter(([k])=>k<=curMo2);
              const pAvgRev=pActual.length>0?pActual.reduce((s,[,v])=>s+v.rev,0)/pActual.length:0;
              const pAvgExp=pActual.length>0?pActual.reduce((s,[,v])=>s+v.exp,0)/pActual.length:0;
              for(let m=1;m<=12;m++){
                const k=`2026-${String(m).padStart(2,'0')}`;
                if(k<=curMo2||pMo[k]) continue;
                pMo[k]={rev:pAvgRev,exp:pAvgExp,projected:true};
              }
              const pMths=Object.entries(pMo).sort((a,b)=>a[0].localeCompare(b[0]));
              if(pMths.length===0) return null;
              return (
                <>
                  <div className="section-title">Rent Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="rev" color="#30d158" onBarClick={(mo)=>setDrillDown({mo,type:"rev",txs:M.propM.pierce.txs})}/></div>
                  <div className="section-title">Expenses Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="exp" color="#ff453a" onBarClick={(mo)=>setDrillDown({mo,type:"exp",txs:M.propM.pierce.txs})}/></div>
                  <div className="section-title">Net Income Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="net" color={null} onBarClick={(mo)=>setDrillDown({mo,type:"net",txs:M.propM.pierce.txs})}/></div>
                  <div className="section-title">Net Margin % Â· Month by Month</div>
                  <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={pMths} valueKey="margin" color={null} marginMode fmt={v=>`${v.toFixed(1)}%`}/></div>
                </>
              );
            })()}

            {/* Transactions */}
            <div className="section-title">Transactions</div>
            <TxList
              txs={M.propM.pierce.txs}
              tagging={tagging} setTagging={setTagging}
              doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
              filter={pierceTxFilter} setFilter={setPierceTxFilter} getSuggestion={getSuggestion}
            />
          </div>
        </div>

        {/* â”€â”€ ARCHIVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        <div className="swipe-pane">
        {(()=>{
          const qData = M.quartersWithProjections;
          const qs = M.quarters;
          if(qData.length===0) return <div style={{minHeight:"100%"}}><div className="page-header"><div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>Quarterly</div></div><div className="card card-padded" style={{textAlign:"center",color:"var(--text-3)",fontSize:13}}>No data yet â€” sync your bank to get started.</div></div>;

          // Convert quarter objects to [key, data] pairs for MiniBar
          const qMths = qData.map(q=>[q.key,{rev:q.rev,exp:q.exp,net:q.net,margin:q.margin,projected:q.projected}]);
          // X-axis label: just the quarter number (Q1, Q2â€¦)
          const qAxisLabel = k => { const q=qData.find(x=>x.key===k); return q?`Q${q.q}'${q.year.toString().slice(2)}`:k; };

          // Delta badge for summary table
          const Delta = ({cur, prev}) => {
            if(prev==null||prev===0) return null;
            const pct = ((cur-prev)/Math.abs(prev))*100;
            const up = pct >= 0;
            return (
              <span style={{fontSize:10,fontWeight:700,color:up?"#30d158":"#ff453a",background:up?"rgba(48,209,88,0.1)":"rgba(255,69,58,0.1)",borderRadius:6,padding:"2px 6px",marginLeft:6,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>
                {up?"+":""}{pct.toFixed(1)}%
              </span>
            );
          };

          return (
          <div style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>All Properties Â· Combined</div>
              <div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>Quarterly</div>
            </div>

            <div className="section-title">Revenue Â· Quarter by Quarter <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>hatched = projected</span></div>
            <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
              <MiniBar months={qMths} valueKey="rev" color="#30d158" onBarClick={()=>navigateTab("Feed")} labelFn={qAxisLabel}/>
            </div>

            <div className="section-title">Expenses Â· Quarter by Quarter</div>
            <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
              <MiniBar months={qMths} valueKey="exp" color="#ff453a" onBarClick={()=>navigateTab("Feed")} labelFn={qAxisLabel}/>
            </div>

            <div className="section-title">Net Income Â· Quarter by Quarter</div>
            <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
              <MiniBar months={qMths} valueKey="net" color={null} onBarClick={()=>navigateTab("Feed")} labelFn={qAxisLabel}/>
            </div>

            <div className="section-title">Net Margin % Â· Quarter by Quarter <span style={{fontWeight:400,fontSize:9,color:"var(--text-3)"}}>â‰¥30% healthy Â· grey=ok Â· red=negative</span></div>
            <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}>
              <MiniBar months={qMths} valueKey="margin" color={null} marginMode labelFn={qAxisLabel} fmt={v=>`${v.toFixed(1)}%`}/>
            </div>

            {/* Actual quarter history table */}
            {qs.length>0&&(
              <>
                <div className="section-title">All Quarters</div>
                <div className="card" style={{overflow:"hidden",marginBottom:8}}>
                  <div style={{display:"grid",gridTemplateColumns:"72px 1fr 1fr 1fr 60px",padding:"8px 14px",borderBottom:"1px solid rgba(0,0,0,0.06)",gap:8}}>
                    {["Quarter","Revenue","Expenses","Net","Margin"].map(h=>(
                      <span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.07em",textAlign:h==="Quarter"?"left":"right"}}>{h}</span>
                    ))}
                  </div>
                  {[...qs].reverse().map((q,i,arr)=>{
                    const prev = arr[i+1];
                    return (
                      <div key={q.key} style={{display:"grid",gridTemplateColumns:"58px 1fr 1fr 1fr 52px",padding:"10px 14px",borderBottom:"1px solid rgba(0,0,0,0.04)",gap:6,alignItems:"start",background:i===0?"rgba(48,209,88,0.03)":"transparent"}}>
                        <span style={{fontSize:12,fontWeight:700,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:i===0?"#30d158":"var(--text)",paddingTop:3}}>{q.label}</span>
                        <div style={{textAlign:"right"}}>
                          <div style={{fontSize:11,fontWeight:600,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"#30d158"}}>{fmt$(q.rev)}</div>
                          {prev&&<div style={{marginTop:3}}><Delta cur={q.rev} prev={prev.rev}/></div>}
                        </div>
                        <div style={{textAlign:"right"}}>
                          <div style={{fontSize:11,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"#ff453a"}}>{fmt$(q.exp)}</div>
                          {prev&&<div style={{marginTop:3}}><Delta cur={q.exp} prev={prev.exp}/></div>}
                        </div>
                        <div style={{textAlign:"right"}}>
                          <div style={{fontSize:11,fontWeight:700,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:q.net>=0?"#30d158":"#ff453a"}}>{fmt$(q.net)}</div>
                          {prev&&<div style={{marginTop:3}}><Delta cur={q.net} prev={prev.net}/></div>}
                        </div>
                        <div style={{textAlign:"right",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:q.margin>=30?"#30d158":q.margin>=0?"var(--text-3)":"#ff453a",paddingTop:3}}>{q.margin.toFixed(1)}%</div>
                      </div>
                    );
                  })}
                </div>
              </>
            )}
          </div>
          );
        })()}
        </div>

        <div className="swipe-pane">
        {(()=>{
          const now = new Date();
          const thisYear = now.getFullYear();
          const thisMo = now.getMonth(); // 0-indexed
          // Current year progress
          const moRemaining = 12 - thisMo;
          const moElapsed = thisMo;

          return (
          <div style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>5-Year Outlook Â· as of {now.toLocaleDateString("en-US",{month:"long",year:"numeric"})}</div>
              <div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>Projections</div>
              <div style={{fontSize:12,color:"var(--text-3)",marginTop:4}}>Based on actual run rate Â· STR seasonality applied Â· Pierce flat</div>
            </div>

            {/* This year callout */}
            <div className="section-title">{thisYear} Â· Current Year</div>
            <div className="card card-padded" style={{marginBottom:8}}>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:12}}>
                {[
                  {l:"YTD Revenue",   v:fmt$(M.totalRev),              sub:`${moElapsed} months actual`},
                  {l:"YTD Expenses",  v:fmt$(M.totalExp),              sub:"all properties", red:true},
                  {l:"YTD Net",       v:fmt$(M.totalCF),               sub:"cash flow", green:M.totalCF>=0},
                  {l:"YTD Margin",    v:M.netMargin!=null?fmtPct(M.netMargin):"â€”", sub:"net margin", green:M.netMargin>=30},
                ].map(c=>(
                  <div key={c.l}>
                    <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:3}}>{c.l}</div>
                    <div style={{fontSize:20,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                    <div style={{fontSize:10,color:"var(--text-3)"}}>{c.sub}</div>
                  </div>
                ))}
              </div>
              {/* Full-year {thisYear} projection */}
              {(()=>{
                const proj = M.projections[0];
                const ytdRev = M.totalRev;
                const ytdExp = M.totalExp;
                const remainRev = proj.rev - (ytdRev/Math.max(moElapsed,1))*12 + (ytdRev/Math.max(moElapsed,1))*12 - ytdRev;
                const fullYearRev = ytdRev + (M.annualRev - ytdRev) * (moRemaining/12);
                const fullYearExp = ytdExp + (M.annualExp - ytdExp) * (moRemaining/12);
                const fullYearNet = fullYearRev - fullYearExp;
                return (
                  <div style={{borderTop:"1px solid rgba(0,0,0,0.07)",paddingTop:12,marginTop:4}}>
                    <div style={{fontSize:10,color:"var(--text-3)",marginBottom:8,fontWeight:600,textTransform:"uppercase",letterSpacing:"0.06em"}}>Full Year {thisYear} Forecast</div>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8}}>
                      {[
                        {l:"Revenue",  v:fmt$(M.projections[0].rev), green:true},
                        {l:"Expenses", v:fmt$(M.projections[0].exp), red:true},
                        {l:"Net",      v:fmt$(M.projections[0].net), green:M.projections[0].net>=0},
                      ].map(c=>(
                        <div key={c.l} style={{background:"rgba(0,0,0,0.03)",borderRadius:10,padding:"8px 10px"}}>
                          <div style={{fontSize:9,color:"var(--text-3)",marginBottom:3,textTransform:"uppercase",letterSpacing:"0.06em"}}>{c.l}</div>
                          <div style={{fontSize:15,fontWeight:700,color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                        </div>
                      ))}
                    </div>
                  </div>
                );
              })()}
            </div>

            {/* 5-year table */}
            <div className="section-title">5-Year Forecast Â· {thisYear}â€“{thisYear+4}</div>
            <div className="card" style={{overflow:"hidden",marginBottom:8}}>
              <div style={{display:"grid",gridTemplateColumns:"56px 1fr 1fr 1fr 72px",borderBottom:"1px solid rgba(0,0,0,0.06)",padding:"8px 14px",gap:8}}>
                {["Year","Revenue","Expenses","Net","Margin"].map(h=>(
                  <span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",textAlign:h==="Year"?"left":"right"}}>{h}</span>
                ))}
              </div>
              {M.projections.map((d,i)=>(
                <div key={d.year} style={{display:"grid",gridTemplateColumns:"56px 1fr 1fr 1fr 72px",padding:"13px 14px",borderBottom:"1px solid rgba(0,0,0,0.04)",gap:8,alignItems:"center",background:i===0?"rgba(48,209,88,0.04)":"transparent"}}>
                  <span style={{fontSize:13,fontWeight:700,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:i===0?"#30d158":"var(--text)"}}>{d.year}{i===0?" â†":""}</span>
                  <span style={{fontSize:12,color:"#30d158",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textAlign:"right",fontWeight:600}}>{fmt$(d.rev)}</span>
                  <span style={{fontSize:12,color:"#ff453a",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textAlign:"right"}}>{fmt$(d.exp)}</span>
                  <span style={{fontSize:12,fontWeight:700,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textAlign:"right",color:d.net>=0?"#30d158":"#ff453a"}}>{fmt$(d.net)}</span>
                  <span style={{fontSize:11,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textAlign:"right",color:d.margin>=30?"#30d158":d.margin>=0?"var(--text-3)":"#ff453a"}}>{fmtPct(d.margin)}</span>
                </div>
              ))}
            </div>

            {/* Assumptions */}
            <div className="section-title">Assumptions</div>
            <div className="card card-padded" style={{marginBottom:8}}>
              {[
                {l:"Revenue growth", v:"3% / year", sub:"conservative STR market appreciation"},
                {l:"Expense growth",  v:"2% / year", sub:"maintenance + cost inflation"},
                {l:"Airbnb seasonality", v:"Applied", sub:"Julâ€“Aug peak 1.22x Â· Janâ€“Feb trough 0.72x"},
                {l:"Pierce Ave",    v:"Flat",    sub:"Section 8 â€” fixed rent, predictable"},
                {l:"Base data",     v:`${M.moCount} months`, sub:"actual transactions to date"},
              ].map(a=>(
                <div key={a.l} style={{display:"flex",justifyContent:"space-between",alignItems:"center",paddingBottom:10,marginBottom:10,borderBottom:"1px solid rgba(0,0,0,0.05)"}}>
                  <div>
                    <div style={{fontSize:13,fontWeight:500}}>{a.l}</div>
                    <div style={{fontSize:11,color:"var(--text-3)",marginTop:1}}>{a.sub}</div>
                  </div>
                  <span style={{fontSize:13,fontWeight:600,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"var(--text-2)"}}>{a.v}</span>
                </div>
              ))}
              {M.annualCoc&&(
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                  <div>
                    <div style={{fontSize:13,fontWeight:500}}>Cash-on-Cash Return</div>
                    <div style={{fontSize:11,color:"var(--text-3)",marginTop:1}}>annualized Â· based on down payments</div>
                  </div>
                  <span style={{fontSize:13,fontWeight:600,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"#30d158"}}>{fmtPct(M.annualCoc)}</span>
                </div>
              )}
              {!M.annualCoc&&(
                <button onClick={()=>setShowInvest(true)} style={{fontSize:12,color:"var(--text-3)",background:"rgba(0,0,0,0.04)",border:"1px solid rgba(0,0,0,0.08)",borderRadius:10,padding:"8px 14px",cursor:"pointer",display:"block",width:"100%",textAlign:"left"}}>
                  + Add down payments to unlock CoC return
                </button>
              )}
            </div>
          </div>
          );
        })()}
        </div>

        {/* â”€â”€ CUSTOM PROPERTY PANES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        {customProps.filter(p=>!p.isAirbnb).map(p=>{
          const cMo = {};
          enriched.filter(t=>t.propId===p.id).forEach(t=>{
            const mo=t.date?.slice(0,7); if(!mo) return;
            if(!cMo[mo]) cMo[mo]={rev:0,exp:0};
            if(t.type==="in") cMo[mo].rev+=Math.abs(t.amount); else cMo[mo].exp+=Math.abs(t.amount);
          });
          const cMths=Object.entries(cMo).sort(([a],[b])=>a<b?-1:1).map(([mo,v])=>[mo,{...v,net:v.rev-v.exp,margin:v.rev>0?((v.rev-v.exp)/v.rev)*100:0}]);
          const totRev=cMths.reduce((s,[,v])=>s+v.rev,0), totExp=cMths.reduce((s,[,v])=>s+v.exp,0), totCF=totRev-totExp;
          return (
            <div className="swipe-pane" key={p.id}>
              <div className="page-header">
                <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>{p.label}</div>
                <div className="big-num">{fmt$(totRev)}</div>
                <div style={{display:"flex",gap:16,marginTop:6}}>
                  <span style={{fontSize:13,color:"#ff453a"}}>{fmt$(totExp)} expenses</span>
                  <span style={{fontSize:13,color:totCF>=0?"#30d158":"#ff453a",fontWeight:600}}>{fmt$(totCF)} net</span>
                </div>
              </div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
                {[{l:"Gross Revenue",v:fmt$(totRev),green:true},{l:"Expenses",v:fmt$(totExp),red:true},
                  {l:"Net Income",v:fmt$(totCF),green:totCF>=0,red:totCF<0},
                  {l:"Net Margin",v:totRev>0?fmtPct((totCF/totRev)*100):"â€”",green:totCF>=0}].map(c=>(
                  <div key={c.l} className="card card-padded">
                    <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",letterSpacing:"0.08em",marginBottom:4}}>{c.l}</div>
                    <div style={{fontSize:22,fontWeight:700,letterSpacing:"-0.02em",color:c.red?"#ff453a":c.green?"#30d158":"var(--text)"}}>{c.v}</div>
                  </div>
                ))}
              </div>
              {cMths.length>0&&<>
                <div className="section-title">Revenue Â· Month by Month</div>
                <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={cMths} valueKey="rev" color="#30d158"/></div>
                <div className="section-title">Expenses Â· Month by Month</div>
                <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={cMths} valueKey="exp" color="#ff453a"/></div>
                <div className="section-title">Net Income Â· Month by Month</div>
                <div className="card card-padded" style={{marginBottom:8,overflow:"visible"}}><MiniBar months={cMths} valueKey="net" color={null}/></div>
              </>}
            </div>
          );
        })}

        {/* â”€â”€ FEED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
        <div className="swipe-pane">
          <div style={{minHeight:"100%"}}>
            <div className="page-header" style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between"}}>
              <div>
                <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Transaction Feed</div>
                <div style={{display:"flex",gap:8,alignItems:"center"}}>
                  <div className="big-num" style={{fontSize:26}}>{untagged.length}</div>
                  <div style={{fontSize:13,color:"var(--text-3)"}}>untagged</div>
                </div>
              </div>
              <div className="seg-ctrl" style={{marginTop:4}}>
                {[["untagged",`Untagged (${untagged.length})`],["tagged","Tagged"],["all","All"]].map(([k,l])=>(
                  <button key={k} className={`seg-btn${feedFilter===k?" active":""}`} onClick={()=>setFeedFilter(k)}>{l}</button>
                ))}
              </div>
            </div>

            {txs.length===0&&linked.length===0&&(
              <div className="card card-padded" style={{textAlign:"center",padding:"48px 24px"}}>
                <div style={{fontSize:32,marginBottom:12}}>ðŸ¦</div>
                <div style={{fontSize:15,fontWeight:600,marginBottom:12}}>No bank connected</div>
                <button onClick={connectBank} className="btn-primary">Connect Bank</button>
              </div>
            )}

            {(txs.length>0||linked.length>0)&&<TxList
              txs={feedTxs}
              tagging={tagging} setTagging={setTagging}
              doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
              filter={txFilter} setFilter={setTxFilter} getSuggestion={getSuggestion}
            />}
          </div>
        </div>

        <div className="swipe-pane">
          <div style={{minHeight:"100%"}}>
            <div className="page-header">
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:4}}>Archive Â· Settings</div>
              <div style={{fontSize:15,fontWeight:600}}>Deleted & Internal Transfers</div>
              <div style={{fontSize:12,color:"var(--text-3)",marginTop:4}}>Review and re-tag any transaction below.</div>
            </div>

            {archived.length===0&&(
              <div className="card card-padded" style={{textAlign:"center",color:"var(--text-3)",padding:"48px 24px",fontSize:13}}>
                Nothing here yet â€” deleted and transferred transactions appear here.
              </div>
            )}

            {archived.length>0&&(
              <div className="card" style={{overflow:"hidden"}}>
                {[...archived].sort((a,b)=>b.date.localeCompare(a.date)).map((tx,i)=>(
                  <div key={tx.id} style={{borderBottom:i<archived.length-1?"1px solid rgba(0,0,0,0.05)":"none"}}>
                    <div style={{display:"grid",gridTemplateColumns:"64px 1fr auto auto",padding:"11px 14px",gap:8,alignItems:"center"}}>
                      <span style={{fontSize:10,color:"var(--text-3)",fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace"}}>{fmtDate(tx.date)}</span>
                      <div>
                        <div style={{fontSize:12,fontWeight:500,lineHeight:1.3}}>{tx.payee}</div>
                        <div style={{fontSize:10,color:"var(--text-3)",marginTop:1}}>
                          {tx.propId==="deleted"?"ðŸ—‘ Deleted":"â†” Transfer"} Â· {tx.account||""}
                        </div>
                      </div>
                      <span style={{fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",fontWeight:600,fontSize:12,color:tx.type==="in"?"#30d158":"#ff453a"}}>
                        {tx.type==="in"?"+":"-"}{fmtD(tx.amount)}
                      </span>
                      <div style={{display:"flex",flexDirection:"column",gap:4}}>
                        <button onClick={()=>doRestore(tx.id)} style={{background:"rgba(0,0,0,0.05)",border:"1px solid rgba(0,0,0,0.1)",borderRadius:7,padding:"4px 8px",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",cursor:"pointer",color:"var(--text-2)",fontWeight:600,whiteSpace:"nowrap"}}>
                          Restore
                        </button>
                        {tx.type==="in"?(
                          <button onClick={()=>{const p=PROPERTIES.find(x=>x.id!=="transfer"&&x.id!=="deleted"&&x.id!=="llc"&&x.group!=="airbnb"||x.id==="airbnb");doTag(tx.id,"airbnb");}} style={{background:"rgba(48,209,88,0.1)",border:"1px solid rgba(48,209,88,0.2)",borderRadius:7,padding:"4px 8px",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",cursor:"pointer",color:"#30d158",fontWeight:600}}>
                            â†’ Airbnb
                          </button>
                        ):(
                          <button onClick={()=>setTagging(tagging===tx.id?null:tx.id)} style={{background:"rgba(0,0,0,0.04)",border:"1px solid rgba(0,0,0,0.08)",borderRadius:7,padding:"4px 8px",fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",cursor:"pointer",color:"var(--text-2)",fontWeight:600}}>
                            Re-tag
                          </button>
                        )}
                      </div>
                    </div>
                    {tagging===tx.id&&(
                      <div style={{padding:"0 14px 12px",borderTop:"1px solid rgba(0,0,0,0.04)"}}>
                        <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)} onDelete={doDelete}/>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}

            {/* Connected banks */}
            {linked.length>0&&(
              <>
                <div className="section-title">Connected Banks</div>
                <div className="card" style={{overflow:"hidden"}}>
                  {linked.map((a,i)=>(
                    <div key={a.item_id} style={{display:"flex",alignItems:"center",justifyContent:"space-between",padding:"12px 14px",borderBottom:i<linked.length-1?"1px solid rgba(0,0,0,0.05)":"none"}}>
                      <span style={{fontSize:13,fontWeight:500}}>{a.name}</span>
                      <div style={{display:"flex",gap:8}}>
                        <button onClick={()=>pullHistory()} style={{fontSize:11,color:"var(--text-3)",background:"none",border:"none",cursor:"pointer"}}>â†“ Pull History</button>
                        <button onClick={()=>removeAccount(a.item_id)} style={{fontSize:11,color:"#ff453a",background:"none",border:"none",cursor:"pointer"}}>Remove</button>
                      </div>
                    </div>
                  ))}
                </div>
              </>
            )}

            {/* Data management */}
            <div className="section-title">Data</div>
            <div className="card card-padded" style={{marginBottom:8}}>
              <div style={{fontSize:13,fontWeight:600,marginBottom:4}}>Local Cache</div>
              <div style={{fontSize:12,color:"var(--text-3)",marginBottom:12}}>{txs.length} transactions stored locally. If you see expenses with no bank connected, this is leftover data from a previous session â€” clear it here.</div>
              <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
                <button onClick={clearAllData} style={{background:"rgba(255,69,58,0.08)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.2)",borderRadius:10,padding:"8px 16px",fontSize:12,fontWeight:600,cursor:"pointer"}}>
                  Clear All Cached Data
                </button>
                <button onClick={()=>setShowManual(true)} style={{background:"rgba(0,0,0,0.04)",color:"var(--text)",border:"1px solid rgba(0,0,0,0.1)",borderRadius:10,padding:"8px 16px",fontSize:12,fontWeight:600,cursor:"pointer"}}>
                  âœŽ Manual Income
                </button>
              </div>
            </div>

            {/* Auto-tag rules */}
            {Object.keys(autoTags).length>0&&(
              <>
                <div className="section-title">Auto-Tag Rules <span style={{fontWeight:400,textTransform:"none",fontSize:9}}>(suggestions only â€” not applied automatically)</span></div>
                <div className="card card-padded">
                  <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                    {Object.entries(autoTags).map(([payee,pid])=>(
                      <div key={payee} style={{display:"flex",alignItems:"center",gap:5,background:"rgba(0,0,0,0.04)",border:"1px solid rgba(0,0,0,0.07)",borderRadius:8,padding:"4px 10px"}}>
                        <span style={{fontSize:10,fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",color:"var(--text-3)"}}>{payee}</span>
                        <span style={{color:"var(--text-3)",fontSize:10}}>â†’</span>
                        <PropBadge id={pid} small/>
                        <button onClick={()=>{const n={...autoTags};delete n[payee];setAutoTags(n);LS.set(AUTO_KEY,n);}} style={{background:"none",border:"none",color:"var(--text-3)",cursor:"pointer",fontSize:12,lineHeight:1,padding:"0 2px"}}>Ã—</button>
                      </div>
                    ))}
                  </div>
                </div>
              </>
            )}
          </div>
        </div>

        </div>{/* end .swipe-track */}
      </div>{/* end .page-outer */}



      {/* SIDE DRAWER */}
      {showDrawer&&<div style={{position:"fixed",inset:0,background:"rgba(0,0,0,0.45)",zIndex:500}} onClick={()=>setShowDrawer(false)}/>}
      <div style={{position:"fixed",top:0,left:0,bottom:0,width:280,background:"var(--header-bg)",backdropFilter:"blur(28px)",WebkitBackdropFilter:"blur(28px)",zIndex:501,transform:showDrawer?"translateX(0)":"translateX(-100%)",transition:"transform 0.28s cubic-bezier(0.25,0.46,0.45,0.94)",boxShadow:showDrawer?"4px 0 32px rgba(0,0,0,0.18)":"none",display:"flex",flexDirection:"column",overflowY:"auto"}}>
        {/* Drawer header */}
        <div style={{padding:"20px 20px 16px",borderBottom:"1px solid rgba(128,128,128,0.12)",display:"flex",alignItems:"center",justifyContent:"space-between",flexShrink:0}}>
          <div style={{display:"flex",alignItems:"center",gap:8}}>
            <svg width="20" height="20" viewBox="0 0 32 32" fill="none"><ellipse cx="16" cy="13" rx="8" ry="7" fill="#1a1a2e"/><ellipse cx="16" cy="13" rx="5" ry="4.5" fill="#f5f5f7"/><circle cx="16" cy="13" r="2" fill="#1a1a2e"/><path d="M12 19c0 0-4 3-4 7h16c0-4-4-7-4-7" fill="#1a1a2e"/></svg>
            <span style={{fontWeight:700,fontSize:14,letterSpacing:"-0.01em"}}>Property Pigeon</span>
          </div>
          <button onClick={()=>setShowDrawer(false)} style={{background:"rgba(0,0,0,0.06)",border:"none",borderRadius:20,width:30,height:30,fontSize:15,cursor:"pointer",display:"flex",alignItems:"center",justifyContent:"center",color:"var(--text-2)"}}>
            <svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round"><line x1="1" y1="1" x2="11" y2="11"/><line x1="11" y1="1" x2="1" y2="11"/></svg>
          </button>
        </div>

        {/* NAVIGATE section */}
        {(()=>{
          const DRAWER_ICONS = {
            "Portfolio":    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="8" width="3" height="6" rx="0.5"/><rect x="6.5" y="5" width="3" height="9" rx="0.5"/><rect x="12" y="2" width="3" height="12" rx="0.5"/></svg>,
            "Airbnb":       <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M1 6l7-5 7 5v8a1 1 0 01-1 1H2a1 1 0 01-1-1z"/><polyline points="6 15 6 8 10 8 10 15"/></svg>,
            "Pierce":       <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="2" y="6" width="12" height="9" rx="1"/><path d="M5 6V4a3 3 0 016 0v2"/><line x1="8" y1="9" x2="8" y2="12"/></svg>,
            "Quarterly":    <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="2" width="14" height="12" rx="1.5"/><line x1="1" y1="6" x2="15" y2="6"/><line x1="8" y1="2" x2="8" y2="14"/></svg>,
            "Projections":  <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><polyline points="1 12 5 7 9 9 15 3"/><polyline points="11 3 15 3 15 7"/></svg>,
            "Feed":         <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><line x1="4" y1="4" x2="14" y2="4"/><line x1="4" y1="8" x2="14" y2="8"/><line x1="4" y1="12" x2="14" y2="12"/><circle cx="1.5" cy="4" r="0.8" fill="currentColor" stroke="none"/><circle cx="1.5" cy="8" r="0.8" fill="currentColor" stroke="none"/><circle cx="1.5" cy="12" r="0.8" fill="currentColor" stroke="none"/></svg>,
            "Archive":      <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><rect x="1" y="1" width="14" height="4" rx="1"/><path d="M2 5v8a1 1 0 001 1h10a1 1 0 001-1V5"/><line x1="6" y1="8" x2="10" y2="8"/></svg>,
          };
          const customIcon = <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round" strokeLinejoin="round"><path d="M2 3h12a1 1 0 011 1v8a1 1 0 01-1 1H2a1 1 0 01-1-1V4a1 1 0 011-1z"/><line x1="5" y1="7" x2="11" y2="7"/></svg>;
          const navRows = [
            ...tabs.map(t => ({ label: t, icon: DRAWER_ICONS[t] || customIcon, isTab: true })),
            { label: "Transactions", icon: DRAWER_ICONS["Feed"], isTab: false, action: ()=>{navigateTab("Feed");setShowDrawer(false);} },
            { label: "Archive",      icon: DRAWER_ICONS["Archive"], isTab: false, action: ()=>{navigateTab("Archive");setShowDrawer(false);} },
          ];
          return (
            <>
              <div style={{fontSize:10,fontWeight:600,letterSpacing:"0.1em",color:"var(--text-3)",
                fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",
                padding:"14px 20px 6px",flexShrink:0}}>Navigate</div>
              {navRows.map((item,i)=>{
                const isActive = item.isTab && tabs[tabIdx]===item.label;
                return (
                  <button key={item.label+i} onClick={item.isTab ? ()=>{navigateTab(item.label);setShowDrawer(false);} : item.action}
                    style={{background:isActive?"rgba(128,128,128,0.08)":"transparent",border:"none",
                      padding:"0 20px",height:52,display:"flex",alignItems:"center",justifyContent:"space-between",
                      gap:12,cursor:"pointer",textAlign:"left",width:"100%",
                      color:isActive?"var(--text)":"var(--text-2)",flexShrink:0}}>
                    <div style={{display:"flex",alignItems:"center",gap:12}}>
                      <span style={{flexShrink:0,opacity:isActive?1:0.7}}>{item.icon}</span>
                      <span style={{fontSize:15,fontWeight:isActive?600:500}}>{item.label}</span>
                    </div>
                    <span style={{color:"var(--text-3)",fontSize:16}}>â€º</span>
                  </button>
                );
              })}
            </>
          );
        })()}

        {/* ACTIONS section */}
        <div style={{fontSize:10,fontWeight:600,letterSpacing:"0.1em",color:"var(--text-3)",
          fontFamily:"ui-monospace,'SF Mono',SFMono-Regular,monospace",textTransform:"uppercase",
          padding:"14px 20px 6px",borderTop:"1px solid rgba(128,128,128,0.1)",flexShrink:0,marginTop:4}}>Actions</div>
        {[
          { label:"Airbnb Revenue",
            icon:<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round"><circle cx="8" cy="8" r="7"/><line x1="8" y1="4" x2="8" y2="12"/><line x1="4" y1="8" x2="12" y2="8"/></svg>,
            action:()=>{setShowManual(true);setShowDrawer(false);}},
          { label:"Add Property",
            icon:<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round"><rect x="1" y="1" width="14" height="14" rx="2"/><line x1="8" y1="5" x2="8" y2="11"/><line x1="5" y1="8" x2="11" y2="8"/></svg>,
            action:()=>{setShowAddProp(true);setShowDrawer(false);}},
          { label:"Add Bank",
            icon:<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round"><rect x="1" y="4" width="14" height="10" rx="1.5"/><line x1="1" y1="8" x2="15" y2="8"/><line x1="4" y1="11.5" x2="6" y2="11.5"/></svg>,
            action:()=>{connectBank();setShowDrawer(false);}},
          { label:"Settings",
            icon:<svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" strokeWidth="1.8" strokeLinecap="round"><circle cx="8" cy="8" r="2.5"/><path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.05 3.05l1.41 1.41M11.54 11.54l1.41 1.41M3.05 12.95l1.41-1.41M11.54 4.46l1.41-1.41"/></svg>,
            action:()=>{setShowSettings(true);setShowDrawer(false);}},
        ].map((item,i,arr)=>(
          <button key={item.label} onClick={item.action}
            style={{background:"transparent",border:"none",
              borderBottom:i<arr.length-1?"1px solid rgba(128,128,128,0.07)":"none",
              padding:"0 20px",height:52,display:"flex",alignItems:"center",justifyContent:"space-between",
              gap:12,cursor:"pointer",textAlign:"left",width:"100%",
              color:"var(--text-2)",flexShrink:0}}>
            <div style={{display:"flex",alignItems:"center",gap:12}}>
              <span style={{flexShrink:0,opacity:0.7}}>{item.icon}</span>
              <span style={{fontSize:15,fontWeight:500}}>{item.label}</span>
            </div>
            <span style={{color:"var(--text-3)",fontSize:16}}>â€º</span>
          </button>
        ))}
      </div>

      {showAddProp&&<AddPropertyModal onSave={saveCustomProp} onClose={()=>setShowAddProp(false)}/>}
      {showInvest&&<InvestModal invest={invest} onSave={saveInvest} onClose={()=>setShowInvest(false)}/>}
      {drillDown&&<MonthDrillDown mo={drillDown.mo} type={drillDown.type} txs={drillDown.txs}
        onClose={()=>setDrillDown(null)}
        doTag={doTag} doDelete={doDelete} doBulkTag={doBulkTag} doBulkDelete={doBulkDelete}
        getSuggestion={getSuggestion}
      />}
      {showManual&&<ManualIncomeModal manual={manualIncome} onSave={saveManual} onClose={()=>setShowManual(false)}/>}
      {rulePrompt&&<RulePromptModal
        payee={rulePrompt.payee} propId={rulePrompt.propId}
        onApplyAll={()=>applyRule(rulePrompt.payee,rulePrompt.propId,true)}
        onApplyName={()=>applyRule(rulePrompt.payee,rulePrompt.propId,false)}
        onSkip={()=>setRulePrompt(null)}
      />}
      {showSettings&&<SettingsPage
        onClose={()=>setShowSettings(false)}
        customProps={customProps} onDeleteProp={deleteCustomProp}
        autoTags={autoTags} rules={rules}
        onDeleteRule={payee=>{
          const nr={...rules}; delete nr[payee];
          const na={...autoTags}; delete na[payee];
          setRules(nr); setAutoTags(na);
          LS.set(AUTO_KEY,na);
          fetch(`${BACKEND}/api/rules`,{method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({rules:nr})}).catch(()=>{});
        }}
        settings={settings}
        onSaveSettings={s=>{
          setSettings(s);
          fetch(`${BACKEND}/api/settings`,{method:"POST",headers:{"Content-Type":"application/json"},
            body:JSON.stringify({settings:s})}).catch(()=>{});
          if(s.darkMode) document.documentElement.setAttribute("data-theme","dark");
          else document.documentElement.removeAttribute("data-theme");
        }}
        archived={enriched.filter(t=>tags[t.id]==="deleted")}
        doRestore={doRestore}
        doTag={doTag}
        linked={linked}
        onRemoveAccount={async(id)=>{
          await fetch(`${BACKEND}/api/remove-account`,{method:"POST",
            headers:{"Content-Type":"application/json"},body:JSON.stringify({account_id:id})});
          loadAll();
        }}
        onClearAll={()=>{
          LS.set(TX_KEY,[]); LS.set(TAGS_KEY,{}); LS.set(AUTO_KEY,{}); LS.set(MANUAL_KEY,{});
          setTxs([]); setTags({}); setAutoTags({}); setManualIncome({});
        }}
      />}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
