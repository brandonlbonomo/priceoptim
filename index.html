<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Property Pigeon</title>
  <link href="https://fonts.googleapis.com/css2?family=SF+Pro+Display:wght@300;400;500;600;700&family=Figtree:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet"/>
  <link rel="manifest" href="/manifest.json"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-status-bar-style" content="default"/>
  <meta name="apple-mobile-web-app-title" content="Pigeon"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="theme-color" content="#eef2f7"/>
  <link rel="apple-touch-icon" href="/icon-192.png"/>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <style>
    :root {
      --bg: #0a0a0f;
      --glass: rgba(255,255,255,0.55);
      --glass-border: rgba(255,255,255,0.75);
      --glass-hover: rgba(255,255,255,0.70);
      --green: #30d158;
      --green-dim: rgba(48,209,88,0.15);
      --red: #ff453a;
      --red-dim: rgba(255,69,58,0.15);
      --blue: #0a84ff;
      --blue-dim: rgba(10,132,255,0.15);
      --purple: #bf5af2;
      --yellow: #ffd60a;
      --text: #1a1a2e;
      --text-2: rgba(26,26,46,0.60);
      --text-3: rgba(26,26,46,0.38);
      --radius: 16px;
      --radius-sm: 10px;
    }
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      background: #eef2f7;
      color: var(--text);
      font-family: 'Figtree', -apple-system, sans-serif;
      min-height: 100vh;
      position: relative;
      overflow-x: hidden;
    }

    body::before {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(ellipse 60% 50% at 10% 15%,  rgba(255,255,255,0.06) 0%, transparent 60%),
        radial-gradient(ellipse 50% 45% at 90% 10%,  rgba(200,240,255,0.07) 0%, transparent 55%),
        radial-gradient(ellipse 55% 50% at 80% 85%,  rgba(180,255,200,0.05) 0%, transparent 55%),
        radial-gradient(ellipse 45% 40% at 15% 85%,  rgba(220,200,255,0.05) 0%, transparent 50%),
        linear-gradient(145deg, #f0f4f8 0%, #e8edf5 35%, #eef2f7 65%, #f2f0f8 100%);
      pointer-events: none;
    }

    body::after {
      content: '';
      position: fixed;
      inset: 0;
      z-index: 0;
      background:
        radial-gradient(circle 400px at 25% 55%, rgba(120,180,255,0.12) 0%, transparent 65%),
        radial-gradient(circle 350px at 75% 35%, rgba(160,220,180,0.10) 0%, transparent 65%),
        radial-gradient(circle 300px at 60% 80%, rgba(200,160,255,0.08) 0%, transparent 60%);
      animation: driftOrbs 20s ease-in-out infinite alternate;
      pointer-events: none;
    }

    @keyframes driftOrbs {
      0%   { transform: translate(0, 0) scale(1); }
      33%  { transform: translate(25px, -15px) scale(1.04); }
      66%  { transform: translate(-15px, 25px) scale(0.97); }
      100% { transform: translate(12px, -8px) scale(1.02); }
    }

    #root { position: relative; z-index: 1; }

    button { cursor: pointer; font-family: inherit; }
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.15); border-radius: 4px; }

    /* Glass card */
    .glass {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
    }
    .glass-sm {
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm);
      backdrop-filter: blur(16px);
    }

    /* Nav */
    .nav {
      position: sticky; top: 0; z-index: 100;
      padding: 14px 28px;
      background: rgba(248,250,252,0.55);
      backdrop-filter: blur(32px) saturate(1.8);
      -webkit-backdrop-filter: blur(32px) saturate(1.8);
      border-bottom: 1px solid rgba(255,255,255,0.07);
      display: flex; align-items: center; justify-content: space-between;
    }
    .nav-tab {
      background: transparent;
      color: var(--text-3);
      border: none;
      padding: 7px 16px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 500;
      transition: all 0.2s;
      position: relative;
    }
    .nav-tab.active {
      background: rgba(0,0,0,0.07);
      color: var(--text);
      font-weight: 600;
    }
    .nav-tab:hover:not(.active) { color: var(--text-2); }

    /* Pills */
    .pill {
      display: inline-flex; align-items: center; gap: 6px;
      background: rgba(255,255,255,0.65);
      border: 1px solid rgba(0,0,0,0.1);
      border-radius: 20px;
      padding: 4px 12px;
      font-size: 11px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 500;
    }
    .pill-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--green); }

    /* Big stat */
    .stat-num {
      font-family: 'Figtree', sans-serif;
      font-size: 36px;
      font-weight: 700;
      letter-spacing: -0.03em;
      line-height: 1;
    }
    .stat-label {
      font-size: 11px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--text-3);
      font-family: 'JetBrains Mono', monospace;
    }

    /* Chart tooltip */
    .chart-tooltip {
      position: absolute;
      background: rgba(20,20,28,0.95);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 10px;
      padding: 10px 14px;
      font-size: 12px;
      pointer-events: none;
      backdrop-filter: blur(20px);
      white-space: nowrap;
      z-index: 50;
      transform: translateX(-50%);
      box-shadow: 0 8px 32px rgba(0,0,0,0.4);
    }

    /* Direction badge */
    .dir-in  { color: var(--green); font-size: 15px; }
    .dir-out { color: var(--red);   font-size: 15px; }

    /* Property badge */
    .prop-badge {
      display: inline-block;
      border-radius: 6px;
      padding: 2px 8px;
      font-size: 10px;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 700;
      letter-spacing: 0.05em;
    }

    /* Segment control */
    .seg-ctrl {
      display: inline-flex;
      background: rgba(0,0,0,0.05);
      border: 1px solid rgba(0,0,0,0.08);
      border-radius: 10px;
      padding: 3px;
      gap: 2px;
    }
    .seg-btn {
      background: transparent;
      border: none;
      color: var(--text-3);
      border-radius: 7px;
      padding: 5px 14px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.18s;
    }
    .seg-btn.active {
      background: rgba(0,0,0,0.08);
      color: var(--text);
      font-weight: 600;
    }

    /* Action button */
    .btn-ghost {
      background: rgba(255,255,255,0.6);
      border: 1px solid rgba(0,0,0,0.12);
      color: var(--text-2);
      border-radius: 10px;
      padding: 7px 14px;
      font-size: 12px;
      font-weight: 500;
      transition: all 0.18s;
    }
    .btn-ghost:hover { background: rgba(255,255,255,0.85); color: var(--text); }
    .btn-primary {
      background: var(--green);
      border: none;
      color: #000;
      border-radius: 10px;
      padding: 8px 16px;
      font-size: 12px;
      font-weight: 700;
      transition: all 0.18s;
    }
    .btn-primary:hover { filter: brightness(1.1); }

    /* Modal overlay */
    .modal-overlay {
      position: fixed; inset: 0; z-index: 200;
      background: rgba(0,0,0,0.6);
      backdrop-filter: blur(8px);
      display: flex; align-items: center; justify-content: center;
    }

    /* Tx row */
    .tx-row {
      display: grid;
      grid-template-columns: 76px 28px 1fr 100px 96px 120px;
      padding: 11px 16px;
      border-bottom: 1px solid rgba(0,0,0,0.05);
      align-items: center;
      gap: 8px;
      cursor: pointer;
      transition: background 0.15s;
    }
    .tx-row:hover { background: rgba(0,0,0,0.03); }
    .tx-row:last-child { border-bottom: none; }

    /* Metric card */
    .metric-card {
      background: rgba(255,255,255,0.55);
      border: 1px solid rgba(255,255,255,0.75);
      border-radius: var(--radius-sm);
      padding: 16px 18px;
      backdrop-filter: blur(16px);
    }

    @keyframes fadeIn { from { opacity:0; transform:translateY(8px); } to { opacity:1; transform:translateY(0); } }
    .fade-in { animation: fadeIn 0.3s ease forwards; }
  </style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useMemo, useEffect, useCallback, useRef } = React;
const BACKEND = "";

// ‚îÄ‚îÄ Formatters ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const fmt$ = n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(n||0);
const fmtD = n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",minimumFractionDigits:0,maximumFractionDigits:0}).format(Math.abs(n||0));
const fmtPct = n => (n==null||isNaN(n)||!isFinite(n))?"‚Äî":`${n.toFixed(1)}%`;
const fmtDate = d => { try { return new Date(d+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"}); } catch { return d||""; } };
const moLabel = s => { try { const [y,m]=s.split("-"); return ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"][+m-1]+" '"+y.slice(2); } catch { return s; } };

// ‚îÄ‚îÄ Properties ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const PROPERTIES = [
  { id:"lockwood", label:"Lockwood",          color:"#30d158", group:"airbnb" },
  { id:"everton",  label:"Everton",            color:"#0a84ff", group:"airbnb" },
  { id:"bstreet",  label:"B Street",           color:"#5e5ce6", group:"airbnb" },
  { id:"pierce",   label:"Pierce Ave",         color:"#64d2ff", group:"pierce" },
  { id:"llc",      label:"General LLC",        color:"#bf5af2", group:"llc"    },
  { id:"transfer", label:"Internal Transfer",  color:"#636366", group:"transfer"},
];
const AIRBNB_IDS = ["lockwood","everton","bstreet"];

// ‚îÄ‚îÄ Storage ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const LS = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => { try { localStorage.setItem(k,JSON.stringify(v)); } catch {} },
};
const TAGS_KEY    = "pg_tags_v2";
const AUTO_KEY    = "pg_auto_v2";
const TX_KEY      = "pg_txs_v2";
const INVEST_KEY  = "pg_invest";
const DEFAULT_AUTO = { "AIRBNB PAYMENTS":"lockwood","AIRBNB":"lockwood","HOUSING AUTHORITY":"pierce" };
const DEFAULT_INVEST = { lockwood:0, everton:0, bstreet:0, pierce:0 };

// ‚îÄ‚îÄ Helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function sumIn(txs)  { return txs.filter(t=>t.type==="in" ).reduce((s,t)=>s+Math.abs(t.amount),0); }
function sumOut(txs) { return txs.filter(t=>t.type==="out").reduce((s,t)=>s+Math.abs(t.amount),0); }

// ‚îÄ‚îÄ PropBadge ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function PropBadge({ id, small }) {
  const p = PROPERTIES.find(x=>x.id===id);
  const fs = small ? 9 : 10;
  const pad = small ? "2px 7px" : "3px 9px";
  if (!p) return <span className="prop-badge" style={{fontSize:fs,padding:pad,background:"rgba(255,214,10,0.15)",color:"#ffd60a",border:"1px solid rgba(255,214,10,0.25)"}}>UNTAGGED</span>;
  return <span className="prop-badge" style={{fontSize:fs,padding:pad,background:`${p.color}18`,color:p.color,border:`1px solid ${p.color}30`}}>{p.label.toUpperCase()}</span>;
}

// ‚îÄ‚îÄ TagMenu ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function TagMenu({ tx, onTag, onClose, onDelete }) {
  const [confirmDelete, setConfirmDelete] = useState(false);
  return (
    <div style={{display:"flex",gap:5,flexWrap:"wrap",padding:"8px 0 2px",alignItems:"center"}}>
      {PROPERTIES.map(p=>(
        <button key={p.id} onClick={()=>onTag(tx.id,p.id)} style={{background:`${p.color}15`,color:p.color,border:`1px solid ${p.color}35`,borderRadius:8,padding:"5px 12px",fontSize:11,fontFamily:"'JetBrains Mono',monospace",fontWeight:700,cursor:"pointer"}}>
          {p.label}
        </button>
      ))}
      <div style={{width:1,height:20,background:"rgba(0,0,0,0.1)",margin:"0 2px",flexShrink:0}}/>
      {confirmDelete
        ? <>
            <span style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>Sure?</span>
            <button onClick={()=>{onDelete(tx.id);onClose();}} style={{background:"rgba(255,69,58,0.15)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.4)",borderRadius:8,padding:"5px 12px",fontSize:11,fontFamily:"'JetBrains Mono',monospace",fontWeight:700,cursor:"pointer"}}>Yes, delete</button>
            <button onClick={()=>setConfirmDelete(false)} style={{background:"rgba(0,0,0,0.04)",color:"var(--text-3)",border:"1px solid rgba(0,0,0,0.1)",borderRadius:8,padding:"5px 10px",fontSize:11,cursor:"pointer"}}>Cancel</button>
          </>
        : <button onClick={()=>setConfirmDelete(true)} style={{background:"rgba(255,69,58,0.07)",color:"#ff453a",border:"1px solid rgba(255,69,58,0.25)",borderRadius:8,padding:"5px 11px",fontSize:11,cursor:"pointer",fontFamily:"'JetBrains Mono',monospace",fontWeight:600}}>üóë Delete</button>
      }
      <button onClick={onClose} style={{background:"rgba(0,0,0,0.04)",color:"var(--text-3)",border:"1px solid rgba(0,0,0,0.1)",borderRadius:8,padding:"5px 10px",fontSize:11,cursor:"pointer"}}>‚úï</button>
    </div>
  );
}

// ‚îÄ‚îÄ BarChart with hover tooltip ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function BarChart({ months, colorKey="green", label="Revenue" }) {
  const [hov, setHov] = useState(null);
  const vals = months.map(([,v])=> colorKey==="green" ? v.rev : colorKey==="red" ? v.exp : v.rev-v.exp);
  const max  = Math.max(...vals, 1);

  return (
    <div style={{position:"relative"}}>
      <div style={{display:"flex",gap:3,alignItems:"flex-end",height:90,padding:"0 4px"}}>
        {months.map(([mo,v],i)=>{
          const val = colorKey==="green"?v.rev:colorKey==="red"?v.exp:v.rev-v.exp;
          const pct = Math.max(4,(val/max)*100);
          const color = colorKey==="green"?"#30d158":colorKey==="red"?"#ff453a":val>=0?"#30d158":"#ff453a";
          return (
            <div key={mo} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",position:"relative"}}
              onMouseEnter={()=>setHov(i)} onMouseLeave={()=>setHov(null)}>
              <div style={{
                width:"100%",borderRadius:"4px 4px 0 0",
                background: hov===i ? color : `${color}bb`,
                height:`${pct}%`,
                transition:"all 0.15s",
                cursor:"pointer",
                boxShadow: hov===i ? `0 0 12px ${color}60` : "none",
              }}/>
              {hov===i&&(
                <div className="chart-tooltip" style={{bottom:"calc(100% + 8px)",left:"50%"}}>
                  <div style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",marginBottom:3}}>{moLabel(mo)}</div>
                  <div style={{fontSize:14,fontWeight:700,color:color}}>{fmt$(val)}</div>
                  <div style={{fontSize:10,color:"var(--text-3)",marginTop:2}}>{label}</div>
                </div>
              )}
            </div>
          );
        })}
      </div>
      <div style={{display:"flex",marginTop:6,padding:"0 4px"}}>
        {months.map(([mo])=>(
          <div key={mo} style={{flex:1,textAlign:"center",fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{moLabel(mo).slice(0,3)}</div>
        ))}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ Smooth Projection Chart with draggable scrubber ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function ProjectionChart({ data }) {
  const svgRef = useRef(null);
  const [scrubX, setScrubX] = useState(null);  // pixel x within SVG
  const [isDragging, setIsDragging] = useState(false);
  const W=600, H=220, PL=50, PR=20, PT=20, PB=30;
  const CW=W-PL-PR, CH=H-PT-PB;

  const lines=[
    {key:"rev",color:"#30d158",label:"Revenue"},
    {key:"exp",color:"#ff453a",label:"Expenses"},
    {key:"net",color:"#0a84ff",label:"Net Income"},
  ];

  const allVals=data.flatMap(d=>[d.rev,d.exp,d.net]);
  const minV=Math.min(0,...allVals), maxV=Math.max(...allVals,1);
  const scaleY=v=>PT+CH*(1-(v-minV)/(maxV-minV));
  const scaleX=i=>PL+CW*(i/(data.length-1));

  // Smooth cubic bezier path
  const smoothPath=key=>{
    const pts=data.map((d,i)=>([scaleX(i),scaleY(d[key])]));
    if(pts.length<2) return "";
    let d=`M${pts[0][0]},${pts[0][1]}`;
    for(let i=0;i<pts.length-1;i++){
      const cp1x=pts[i][0]+(pts[i+1][0]-pts[i][0])*0.4;
      const cp1y=pts[i][1];
      const cp2x=pts[i][0]+(pts[i+1][0]-pts[i][0])*0.6;
      const cp2y=pts[i+1][1];
      d+=` C${cp1x},${cp1y} ${cp2x},${cp2y} ${pts[i+1][0]},${pts[i+1][1]}`;
    }
    return d;
  };

  // Find which data point scrubX is closest to
  const activeIdx = scrubX===null ? null : Math.min(data.length-1, Math.max(0,
    Math.round((scrubX - PL) / CW * (data.length-1))
  ));

  const getSVGX = e => {
    if(!svgRef.current) return null;
    const rect=svgRef.current.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const ratio = (clientX-rect.left)/rect.width;
    return ratio*W;
  };

  const onMove = e => {
    if(e.type==="mousemove"&&!isDragging&&e.buttons===0) {
      setScrubX(getSVGX(e));
    } else if(isDragging || e.type==="mousemove") {
      setScrubX(getSVGX(e));
    } else if(e.touches) {
      setScrubX(getSVGX(e));
    }
  };

  const activeData = activeIdx!==null ? data[activeIdx] : null;
  const scrubLineX = activeIdx!==null ? scaleX(activeIdx) : null;

  return (
    <div>
      <svg ref={svgRef} viewBox={`0 0 ${W} ${H}`} style={{width:"100%",height:"auto",overflow:"visible",cursor:"crosshair",userSelect:"none"}}
        onMouseMove={onMove} onMouseLeave={()=>{setScrubX(null);setIsDragging(false);}}
        onMouseDown={()=>setIsDragging(true)} onMouseUp={()=>setIsDragging(false)}
        onTouchMove={onMove} onTouchStart={onMove} onTouchEnd={()=>setScrubX(null)}>
        <defs>
          {lines.map(l=>(
            <linearGradient key={l.key} id={`pg_${l.key}`} x1="0" y1="0" x2="0" y2="1">
              <stop offset="0%" stopColor={l.color} stopOpacity="0.18"/>
              <stop offset="100%" stopColor={l.color} stopOpacity="0.02"/>
            </linearGradient>
          ))}
        </defs>

        {/* Grid */}
        {[0,0.25,0.5,0.75,1].map(f=>{
          const y=PT+CH*f;
          const val=maxV-(maxV-minV)*f;
          return (
            <g key={f}>
              <line x1={PL} y1={y} x2={W-PR} y2={y} stroke="rgba(0,0,0,0.07)" strokeWidth="1" strokeDasharray="3,4"/>
              <text x={PL-6} y={y+4} textAnchor="end" style={{fontSize:8,fill:"rgba(26,26,46,0.35)",fontFamily:"'JetBrains Mono',monospace"}}>{fmt$(val).replace("$","")}</text>
            </g>
          );
        })}

        {/* Area fills */}
        {lines.map(l=>{
          const path=smoothPath(l.key);
          const lastX=scaleX(data.length-1);
          return <path key={l.key} d={path+` L${lastX},${H-PB} L${PL},${H-PB} Z`} fill={`url(#pg_${l.key})`}/>;
        })}

        {/* Lines */}
        {lines.map(l=>(
          <path key={l.key} d={smoothPath(l.key)} fill="none" stroke={l.color} strokeWidth="2.5"
            strokeLinecap="round" strokeLinejoin="round"/>
        ))}

        {/* Scrub line */}
        {scrubLineX!==null&&(
          <line x1={scrubLineX} y1={PT} x2={scrubLineX} y2={H-PB}
            stroke="rgba(26,26,46,0.25)" strokeWidth="1.5" strokeDasharray="3,3"/>
        )}

        {/* Dots at scrub position */}
        {activeIdx!==null&&lines.map(l=>(
          <circle key={l.key} cx={scaleX(activeIdx)} cy={scaleY(activeData[l.key])} r="5"
            fill={l.color} stroke="white" strokeWidth="2"/>
        ))}

        {/* X axis labels */}
        {data.map((d,i)=>(
          <text key={i} x={scaleX(i)} y={H-4} textAnchor="middle"
            style={{fontSize:9,fill:activeIdx===i?"rgba(26,26,46,0.8)":"rgba(26,26,46,0.35)",fontFamily:"'JetBrains Mono',monospace",fontWeight:activeIdx===i?"700":"400"}}>
            {d.year}
          </text>
        ))}
      </svg>

      {/* Live ticker ‚Äî shows active data or last year by default */}
      {(()=>{
        const d=activeData||data[data.length-1];
        const yr=activeData?d.year:`${d.year} (proj.)`;
        return (
          <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr 1fr",gap:8,marginTop:12}}>
            {[
              {l:"Year",     v:yr,           c:"var(--text)"},
              {l:"Revenue",  v:fmt$(d.rev),  c:"#30d158"},
              {l:"Expenses", v:fmt$(d.exp),  c:"#ff453a"},
              {l:"Net Income",v:fmt$(d.net), c:"#0a84ff"},
            ].map(item=>(
              <div key={item.l} style={{background:"rgba(255,255,255,0.5)",border:"1px solid rgba(255,255,255,0.7)",borderRadius:10,padding:"12px 14px",textAlign:"center",transition:"all 0.1s"}}>
                <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:5}}>{item.l}</div>
                <div style={{fontSize:16,fontWeight:800,color:item.c,fontFamily:"'JetBrains Mono',monospace",letterSpacing:"-0.02em",transition:"all 0.08s"}}>{item.v}</div>
              </div>
            ))}
          </div>
        );
      })()}

      <div style={{display:"flex",gap:16,marginTop:12,justifyContent:"center"}}>
        {lines.map(l=>(
          <div key={l.key} style={{display:"flex",alignItems:"center",gap:5}}>
            <div style={{width:20,height:2.5,background:l.color,borderRadius:2}}/>
            <span style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{l.label}</span>
          </div>
        ))}
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ InvestModal ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function InvestModal({ invest, onSave, onClose }) {
  const [vals, setVals] = useState({...invest});
  const props = PROPERTIES.filter(p=>["lockwood","everton","bstreet","pierce"].includes(p.id));
  return (
    <div className="modal-overlay" onClick={onClose}>
      <div className="glass fade-in" style={{width:400,padding:28}} onClick={e=>e.stopPropagation()}>
        <div style={{fontSize:17,fontWeight:700,marginBottom:6}}>Down Payments</div>
        <div style={{fontSize:12,color:"var(--text-3)",marginBottom:22}}>Enter the initial down payment for each property. Cash-on-cash return is calculated automatically from your Plaid expense data.</div>
        {props.map(p=>(
          <div key={p.id} style={{marginBottom:16}}>
            <div style={{fontSize:11,color:p.color,fontFamily:"'JetBrains Mono',monospace",fontWeight:700,marginBottom:6,textTransform:"uppercase",letterSpacing:"0.08em"}}>{p.label}</div>
            <div style={{position:"relative"}}>
              <span style={{position:"absolute",left:12,top:"50%",transform:"translateY(-50%)",color:"var(--text-3)",fontSize:14}}>$</span>
              <input type="number" value={vals[p.id]||""} onChange={e=>setVals(v=>({...v,[p.id]:+e.target.value}))}
                placeholder="0"
                style={{width:"100%",background:"rgba(0,0,0,0.04)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:10,padding:"10px 12px 10px 26px",color:"var(--text)",fontSize:15,fontWeight:600,fontFamily:"'JetBrains Mono',monospace",outline:"none"}}/>
            </div>
          </div>
        ))}
        <div style={{display:"flex",gap:10,marginTop:24,justifyContent:"flex-end"}}>
          <button onClick={onClose} className="btn-ghost">Cancel</button>
          <button onClick={()=>{onSave(vals);onClose();}} className="btn-primary">Save</button>
        </div>
      </div>
    </div>
  );
}

// ‚îÄ‚îÄ TxList ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function TxList({ txs, tagging, setTagging, doTag, doDelete, filter, setFilter }) {
  const filtered = filter==="in" ? txs.filter(t=>t.type==="in") : filter==="out" ? txs.filter(t=>t.type==="out") : txs;
  const sorted   = [...filtered].sort((a,b)=>b.date.localeCompare(a.date));

  return (
    <div>
      <div style={{display:"flex",gap:8,marginBottom:14,alignItems:"center"}}>
        <div className="seg-ctrl">
          {[["all","All"],["in","Money In"],["out","Money Out"]].map(([k,l])=>(
            <button key={k} className={`seg-btn${filter===k?" active":""}`} onClick={()=>setFilter(k)}>{l}</button>
          ))}
        </div>
        <span style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{sorted.length} transactions</span>
      </div>

      {sorted.length===0&&<div style={{textAlign:"center",padding:"32px 0",color:"var(--text-3)",fontSize:13}}>No transactions</div>}

      {sorted.length>0&&(
        <div className="glass" style={{overflow:"hidden"}}>
          <div style={{display:"grid",gridTemplateColumns:"76px 28px 1fr 100px 96px 120px",padding:"8px 16px",borderBottom:"1px solid rgba(0,0,0,0.06)",gap:8}}>
            {["DATE","","PAYEE","AMOUNT","ACCOUNT","PROPERTY"].map(h=>(
              <span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em"}}>{h}</span>
            ))}
          </div>
          {sorted.map(tx=>(
            <div key={tx.id}>
              <div className="tx-row" onClick={()=>setTagging(t=>t===tx.id?null:tx.id)}>
                <span style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{fmtDate(tx.date)}</span>
                <span className={tx.type==="in"?"dir-in":"dir-out"}>{tx.type==="in"?"‚Üì":"‚Üë"}</span>
                <div>
                  <div style={{fontSize:13,fontWeight:500,lineHeight:1.3}}>{tx.payee}</div>
                  {tx.account&&<div style={{fontSize:10,color:"var(--text-3)",marginTop:1}}>{tx.account}</div>}
                </div>
                <span style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:13,color:tx.type==="in"?"#30d158":"#ff453a"}}>
                  {tx.type==="in"?"+":"-"}{fmtD(tx.amount)}
                </span>
                <span style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{tx.account||""}</span>
                <div onClick={e=>e.stopPropagation()}>
                  <span onClick={e=>{e.stopPropagation();setTagging(t=>t===tx.id?null:tx.id);}}>
                    <PropBadge id={tx.propId} small/>
                  </span>
                </div>
              </div>
              {tagging===tx.id&&(
                <div style={{padding:"0 16px 12px",borderBottom:"1px solid rgba(0,0,0,0.05)"}}>
                  <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)} onDelete={doDelete}/>
                </div>
              )}
            </div>
          ))}
        </div>
      )}
    </div>
  );
}

// ‚îÄ‚îÄ Main App ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function App() {
  const [tab, setTab]           = useState("Portfolio");
  const [txs, setTxs]           = useState(()=>LS.get(TX_KEY)||[]);
  const [tags, setTags]         = useState(()=>LS.get(TAGS_KEY)||{});
  const [autoTags, setAutoTags] = useState(()=>LS.get(AUTO_KEY)||DEFAULT_AUTO);
  const [tagging, setTagging]   = useState(null);
  const [linked, setLinked]     = useState([]);
  const [syncing, setSyncing]   = useState(false);
  const [status, setStatus]     = useState(null);
  const [linking, setLinking]   = useState(false);
  const [invest, setInvest]     = useState(()=>LS.get(INVEST_KEY)||DEFAULT_INVEST);
  const [showInvest, setShowInvest] = useState(false);
  const [feedFilter, setFeedFilter] = useState("untagged");
  const [txFilter, setTxFilter] = useState("all");
  const [airbnbTxFilter, setAirbnbTxFilter] = useState("all");
  const [pierceTxFilter, setPierceTxFilter] = useState("all");

  useEffect(()=>{
    // Load bank connections
    fetch(`${BACKEND}/api/link-status`).then(r=>r.json()).then(d=>setLinked(d.accounts||[])).catch(()=>{});
    // Load server-side transactions (authoritative, deduplicated)
    fetch(`${BACKEND}/api/transactions/all`).then(r=>r.json()).then(data=>{
      if(data.transactions&&data.transactions.length>0){
        const arr=[...data.transactions].sort((a,b)=>b.date.localeCompare(a.date));
        setTxs(arr);
        LS.set(TX_KEY,arr);
      }
    }).catch(()=>{});
  },[]);

  const applyAuto = useCallback((newTxs,at,cur)=>{
    const next={...cur};
    newTxs.forEach(tx=>{
      if(next[tx.id]) return;
      const key=Object.keys(at).find(k=>tx.payee?.toUpperCase().includes(k.toUpperCase()));
      if(key) next[tx.id]=at[key];
    });
    return next;
  },[]);

  // Load all server-stored transactions (deduplicated server-side)
  const loadAll = useCallback(async(silent=false)=>{
    try {
      const res=await fetch(`${BACKEND}/api/transactions/all`);
      const data=await res.json();
      if(data.error) return;
      const arr=[...data.transactions].sort((a,b)=>b.date.localeCompare(a.date));
      setTxs(arr);
      LS.set(TX_KEY,arr);
      setTags(prev=>{ const u=applyAuto(arr,autoTags,prev); LS.set(TAGS_KEY,u); return u; });
      if(!silent) setStatus(`Loaded ${arr.length} transactions`);
    } catch(e){ if(!silent) setStatus("Load failed: "+e.message); }
  },[autoTags,applyAuto]);

  const sync = useCallback(async()=>{
    setSyncing(true); setStatus(null);
    try {
      const res=await fetch(`${BACKEND}/api/transactions/sync`);
      const data=await res.json();
      if(data.error) throw new Error(data.error);
      // After sync, reload everything from server ‚Äî guaranteed deduplicated
      await loadAll(true);
      setStatus(`Synced ¬∑ ${data.total_stored} transactions total`);
    } catch(e){setStatus("Sync failed: "+e.message);}
    finally{setSyncing(false);}
  },[loadAll]);

  const connectBank=useCallback(async()=>{
    setLinking(true); setStatus(null);
    try {
      const {link_token,error}=await fetch(`${BACKEND}/api/create-link-token`,{method:"POST"}).then(r=>r.json());
      if(error) throw new Error(error);
      window.Plaid.create({
        token:link_token,
        onSuccess:async(public_token,meta)=>{
          const name=meta?.institution?.name||"Bank Account";
          await fetch(`${BACKEND}/api/exchange-token`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({public_token,account_name:name})});
          const ls=await fetch(`${BACKEND}/api/link-status`).then(r=>r.json());
          setLinked(ls.accounts||[]); setStatus(`${name} connected`);
          setTimeout(sync,600);
        },
        onExit:err=>{if(err)setStatus("Exited: "+err.display_message);}
      }).open();
    } catch(e){setStatus("Could not open Plaid: "+e.message);}
    finally{setLinking(false);}
  },[sync]);

  const removeAccount=async(item_id)=>{
    await fetch(`${BACKEND}/api/remove-account`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item_id})});
    setLinked(prev=>prev.filter(a=>a.item_id!==item_id));
  };

  function doTag(txId,propId){
    const tx=txs.find(t=>t.id===txId);
    const nextTags={...tags,[txId]:propId};
    if(tx?.payee&&propId!=="transfer"&&propId!=="llc"){
      const key=tx.payee.toUpperCase();
      const nextAuto={...autoTags,[key]:propId};
      txs.forEach(t=>{if(!nextTags[t.id]&&t.payee?.toUpperCase()===key)nextTags[t.id]=propId;});
      setAutoTags(nextAuto); LS.set(AUTO_KEY,nextAuto);
    }
    setTags(nextTags); LS.set(TAGS_KEY,nextTags); setTagging(null);
  }

  function doDelete(txId){
    setTxs(prev=>{
      const arr=prev.filter(t=>t.id!==txId);
      LS.set(TX_KEY,arr);
      return arr;
    });
    setTags(prev=>{
      const next={...prev};
      delete next[txId];
      LS.set(TAGS_KEY,next);
      return next;
    });
    setTagging(null);
  }

  const saveInvest=vals=>{ setInvest(vals); LS.set(INVEST_KEY,vals); };

  // Deduplicate by id ‚Äî Plaid can return the same transaction more than once
  const enriched=useMemo(()=>{
    const seen=new Set();
    return txs.filter(t=>!t.pending).filter(t=>{
      if(seen.has(t.id)) return false;
      seen.add(t.id);
      return true;
    }).map(tx=>({...tx,propId:tags[tx.id]||null}));
  },[txs,tags]);
  const untagged=enriched.filter(t=>!t.propId);
  const tagged  =enriched.filter(t=>t.propId);

  // ‚îÄ‚îÄ Metrics ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const M=useMemo(()=>{
    const forProp=id=>tagged.filter(t=>t.propId===id);
    const propM={};
    PROPERTIES.forEach(p=>{
      const ptxs=forProp(p.id);
      const rev=sumIn(ptxs), exp=sumOut(ptxs);
      propM[p.id]={rev,exp,cf:rev-exp,txs:ptxs};
    });

    const airbnbRev=AIRBNB_IDS.reduce((s,id)=>s+propM[id].rev,0);
    const airbnbExp=AIRBNB_IDS.reduce((s,id)=>s+propM[id].exp,0);
    const pierceRev=propM.pierce.rev, pierceExp=propM.pierce.exp;
    const llcExp   =propM.llc.exp;
    const totalRev =airbnbRev+pierceRev;
    const totalExp =airbnbExp+pierceExp+llcExp;
    const totalCF  =totalRev-totalExp;

    // Monthly data ‚Äî use ALL non-transfer enriched txs (tagged or not)
    // De-duplicate by id first to prevent Plaid double-posting
    const months = (() => {
      const seen = new Set();
      const mo={};
      enriched.filter(t=>t.propId!=="transfer").forEach(t=>{
        if(seen.has(t.id)) return;
        seen.add(t.id);
        const k=t.date?.slice(0,7)||"?";
        if(!mo[k])mo[k]={rev:0,exp:0};
        if(t.type==="in")  mo[k].rev+=Math.abs(t.amount);
        if(t.type==="out") mo[k].exp+=Math.abs(t.amount);
      });
      return Object.entries(mo).sort((a,b)=>a[0].localeCompare(b[0]));
    })();

    const moCount = Math.max(months.length, 1);
    const annualRev = (totalRev/moCount)*12;
    const annualExp = (totalExp/moCount)*12;

    // Real estate metrics
    const totalInvest = Object.values(invest).reduce((s,v)=>s+v,0);
    const netMargin   = totalRev>0?(totalCF/totalRev)*100:null;
    const cocReturn   = totalInvest>0?(totalCF/totalInvest)*100:null;
    const annualCoc   = totalInvest>0?((totalCF/moCount*12)/totalInvest)*100:null;

    // Per-property CoC
    const propCoc={};
    ["lockwood","everton","bstreet","pierce"].forEach(id=>{
      const inv=invest[id]||0;
      propCoc[id]=inv>0?(propM[id].cf/inv)*100:null;
    });

    // 5-year projections (3% annual revenue growth, 2% expense growth)
    const currentYear=new Date().getFullYear();
    const projections=Array.from({length:6},(_,i)=>{
      const yr=currentYear+i;
      const rev=annualRev*Math.pow(1.03,i);
      const exp=annualExp*Math.pow(1.02,i);
      return {year:yr,rev,exp,net:rev-exp};
    });

    return {propM,airbnbRev,airbnbExp,airbnbCF:airbnbRev-airbnbExp,pierceRev,pierceExp,pierceCF:pierceRev-pierceExp,llcExp,totalRev,totalExp,totalCF,netMargin,cocReturn,annualCoc,propCoc,months,moCount,projections,annualRev,annualExp};
  },[tagged,invest]);

  const hasBank=linked.length>0;
  const TABS=["Portfolio","Airbnb","Pierce Ave","Projections","Feed"];

  // Feed display
  const feedTxs = feedFilter==="untagged"?untagged:feedFilter==="tagged"?tagged:enriched;
  const feedDisplayed = txFilter==="in"?feedTxs.filter(t=>t.type==="in"):txFilter==="out"?feedTxs.filter(t=>t.type==="out"):feedTxs;

  return (
    <div style={{minHeight:"100vh"}}>

      {/* NAV */}
      <nav className="nav">
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <div style={{width:36,height:36,display:"flex",alignItems:"center",justifyContent:"center"}}>
              <svg width="36" height="36" viewBox="0 0 36 36" fill="none" xmlns="http://www.w3.org/2000/svg">
                <defs>
                  <linearGradient id="xrayGrad" x1="0" y1="0" x2="36" y2="36" gradientUnits="userSpaceOnUse">
                    <stop offset="0%" stopColor="rgba(180,220,255,0.95)"/>
                    <stop offset="100%" stopColor="rgba(120,180,255,0.70)"/>
                  </linearGradient>
                  <filter id="glow">
                    <feGaussianBlur stdDeviation="1.2" result="blur"/>
                    <feMerge><feMergeNode in="blur"/><feMergeNode in="SourceGraphic"/></feMerge>
                  </filter>
                </defs>
                {/* Body */}
                <ellipse cx="17" cy="21" rx="8" ry="6.5" stroke="url(#xrayGrad)" strokeWidth="1.1" fill="none" filter="url(#glow)"/>
                {/* Head */}
                <circle cx="23" cy="13" r="4.5" stroke="url(#xrayGrad)" strokeWidth="1.1" fill="none" filter="url(#glow)"/>
                {/* Neck connecting head to body */}
                <path d="M20 16.5 C19 17.5 18 18.5 17.5 19.2" stroke="url(#xrayGrad)" strokeWidth="1.1" fill="none" strokeLinecap="round"/>
                {/* Beak */}
                <path d="M26.5 12.5 L30 11.5 L27 13.5" stroke="url(#xrayGrad)" strokeWidth="1" fill="none" strokeLinecap="round" strokeLinejoin="round"/>
                {/* Eye */}
                <circle cx="24.5" cy="12" r="1" stroke="url(#xrayGrad)" strokeWidth="0.9" fill="none"/>
                <circle cx="24.5" cy="12" r="0.3" fill="url(#xrayGrad)" opacity="0.8"/>
                {/* Wing */}
                <path d="M13 20 C10 17 8 15 9 13 C11 11 14 14 17 16" stroke="url(#xrayGrad)" strokeWidth="1.1" fill="none" strokeLinecap="round"/>
                <path d="M10 18 C9 16 9.5 14.5 11 14" stroke="url(#xrayGrad)" strokeWidth="0.7" fill="none" strokeLinecap="round" opacity="0.6"/>
                {/* Tail */}
                <path d="M10 23 C8 24 6 25 5 24" stroke="url(#xrayGrad)" strokeWidth="1" fill="none" strokeLinecap="round"/>
                <path d="M10.5 24.5 C8.5 26 7 27 5.5 26.5" stroke="url(#xrayGrad)" strokeWidth="0.8" fill="none" strokeLinecap="round" opacity="0.7"/>
                {/* Legs */}
                <path d="M16 27 L15 30 M15 30 L13.5 31.5 M15 30 L16 31.5" stroke="url(#xrayGrad)" strokeWidth="0.9" fill="none" strokeLinecap="round"/>
                <path d="M19 27.5 L18.5 30.5 M18.5 30.5 L17 32 M18.5 30.5 L19.5 32" stroke="url(#xrayGrad)" strokeWidth="0.9" fill="none" strokeLinecap="round"/>
                {/* Internal structure lines - x-ray feel */}
                <path d="M17 19 L19 22 M18 19.5 L17 23" stroke="url(#xrayGrad)" strokeWidth="0.5" fill="none" opacity="0.35" strokeLinecap="round"/>
                <path d="M22 12 L24 15 M23 11 L25 14" stroke="url(#xrayGrad)" strokeWidth="0.45" fill="none" opacity="0.3" strokeLinecap="round"/>
              </svg>
            </div>
          <div>
            <div style={{fontSize:14,fontWeight:700,letterSpacing:"-0.01em"}}>Property Pigeon</div>
            <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",letterSpacing:"0.08em"}}>LOCKWOOD ¬∑ EVERTON ¬∑ B ST ¬∑ PIERCE ¬∑ 8 STR ¬∑ 7 SEC8</div>
          </div>
        </div>
        <div style={{display:"flex",gap:2,alignItems:"center"}}>
          {TABS.map(t=>(
            <button key={t} className={`nav-tab${tab===t?" active":""}`} onClick={()=>setTab(t)}>
              {t}
              {t==="Feed"&&untagged.length>0&&<span style={{position:"absolute",top:-4,right:-2,background:"#ffd60a",color:"#000",borderRadius:"50%",width:14,height:14,fontSize:8,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center"}}>{untagged.length}</span>}
            </button>
          ))}
          <div style={{width:1,height:18,background:"rgba(255,255,255,0.1)",margin:"0 6px"}}/>
          <button onClick={connectBank} disabled={linking} className="btn-ghost" style={{fontSize:12}}>
            {linking?"Linking...":"+ Add Bank"}
          </button>
          <button onClick={sync} disabled={syncing||!hasBank} className="btn-ghost" style={{fontSize:12,color:syncing||!hasBank?"var(--text-3)":"var(--green)"}}>
            {syncing?"Syncing‚Ä¶":"‚Üª Sync"}
          </button>
        </div>
      </nav>

      {/* STATUS */}
      {(hasBank||status)&&(
        <div style={{padding:"8px 28px",background:"rgba(255,255,255,0.45)",borderBottom:"1px solid rgba(0,0,0,0.05)",display:"flex",alignItems:"center",justifyContent:"space-between",gap:12}}>
          <div style={{display:"flex",gap:6,flexWrap:"wrap"}}>
            {linked.map(a=>(
              <div key={a.item_id} className="pill">
                <div className="pill-dot"/>
                <span style={{color:"var(--text-2)"}}>{a.name}</span>
                <button onClick={()=>removeAccount(a.item_id)} style={{background:"none",border:"none",color:"var(--text-3)",fontSize:13,cursor:"pointer",lineHeight:1,marginLeft:2}}>√ó</button>
              </div>
            ))}
          </div>
          {status&&<div style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{status}</div>}
        </div>
      )}

      <div style={{maxWidth:1080,margin:"0 auto",padding:"28px 28px 100px"}}>

        {/* ‚îÄ‚îÄ PORTFOLIO ‚îÄ‚îÄ */}
        {tab==="Portfolio"&&(
          <div className="fade-in">
            <div style={{display:"flex",alignItems:"center",justifyContent:"space-between",marginBottom:24}}>
              <div>
                <div style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:4}}>All Properties ¬∑ Live from Plaid</div>
                <div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>Portfolio Overview</div>
              </div>
              <button onClick={()=>setShowInvest(true)} className="btn-ghost" style={{fontSize:12}}>‚öô Down Payments</button>
            </div>

            {!hasBank&&(
              <div className="glass" style={{textAlign:"center",padding:"60px 0"}}>
                <div style={{fontSize:40,marginBottom:12}}>üè¶</div>
                <div style={{fontSize:16,fontWeight:600,marginBottom:6}}>No bank connected</div>
                <div style={{fontSize:13,color:"var(--text-3)",marginBottom:20}}>Click "+ Add Bank" to connect via Plaid</div>
              </div>
            )}

            {hasBank&&<>
              {/* Top 3 stats */}
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:10,marginBottom:10}}>
                {[
                  {l:"Gross Revenue",v:fmt$(M.totalRev),a:"var(--green)"},
                  {l:"Total Expenses",v:fmt$(M.totalExp),a:"var(--red)"},
                  {l:"Net Cash Flow", v:fmt$(M.totalCF), a:M.totalCF>=0?"var(--green)":"var(--red)"},
                ].map(c=>(
                  <div key={c.l} className="glass" style={{padding:"22px 24px"}}>
                    <div className="stat-label" style={{marginBottom:10}}>{c.l}</div>
                    <div className="stat-num" style={{color:c.a}}>{c.v}</div>
                  </div>
                ))}
              </div>

              {/* Real estate metrics */}
              <div style={{display:"grid",gridTemplateColumns:"repeat(4,1fr)",gap:8,marginBottom:10}}>
                {[
                  {l:"Net Margin",     v:fmtPct(M.netMargin),   sub:"Revenue ‚Üí profit"},
                  {l:"Cash-on-Cash",   v:fmtPct(M.cocReturn),   sub:"Total return on invested"},
                  {l:"Annualized CoC", v:fmtPct(M.annualCoc),   sub:"Projected annual"},
                  {l:"Expense Ratio",  v:fmtPct(M.totalRev>0?(M.totalExp/M.totalRev)*100:null), sub:"Expenses √∑ revenue"},
                ].map(m=>(
                  <div key={m.l} className="metric-card">
                    <div className="stat-label" style={{marginBottom:8}}>{m.l}</div>
                    <div style={{fontSize:20,fontWeight:800,fontFamily:"'JetBrains Mono',monospace",color:m.v==="‚Äî"?"var(--text-3)":"var(--text)",letterSpacing:"-0.02em"}}>{m.v}</div>
                    <div style={{fontSize:10,color:"var(--text-3)",marginTop:4}}>{m.sub}{m.l.includes("Cash")&&!invest.lockwood&&!invest.pierce?' ¬∑ add down payment ‚Üë':''}</div>
                  </div>
                ))}
              </div>

              {/* Property split */}
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:10}}>
                {[
                  {l:"Airbnb Portfolio (8 units)",rev:M.airbnbRev,exp:M.airbnbExp,cf:M.airbnbCF,color:"#30d158"},
                  {l:"Pierce Ave ¬∑ Section 8 ¬∑ 7 Units",    rev:M.pierceRev,exp:M.pierceExp,cf:M.pierceCF,color:"#64d2ff"},
                ].map(r=>(
                  <div key={r.l} className="glass" style={{padding:"18px 20px",borderLeft:`3px solid ${r.color}`}}>
                    <div style={{fontSize:10,color:r.color,fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:14,fontWeight:700}}>{r.l}</div>
                    <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:12}}>
                      {[{l:"Revenue",v:r.rev,c:"var(--green)"},{l:"Expenses",v:r.exp,c:"var(--red)"},{l:"Cash Flow",v:r.cf,c:r.cf>=0?"var(--green)":"var(--red)"}].map(s=>(
                        <div key={s.l}><div style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",marginBottom:4}}>{s.l}</div><div style={{fontSize:18,fontWeight:700,color:s.c,fontFamily:"'JetBrains Mono',monospace"}}>{fmt$(s.v)}</div></div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>

              {M.llcExp>0&&(
                <div className="glass" style={{padding:"14px 20px",marginBottom:10,borderLeft:"3px solid #bf5af2",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
                  <div style={{fontSize:10,color:"#bf5af2",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",fontWeight:700}}>General LLC Expenses</div>
                  <div style={{fontSize:20,fontWeight:700,color:"#bf5af2",fontFamily:"'JetBrains Mono',monospace"}}>{fmt$(M.llcExp)}</div>
                </div>
              )}

              {/* Charts */}
              {M.months.length>0&&(
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:10}}>
                  <div className="glass" style={{padding:"20px"}}>
                    <div className="stat-label" style={{marginBottom:14}}>Monthly Revenue</div>
                    <BarChart months={M.months} colorKey="green" label="Revenue"/>
                  </div>
                  <div className="glass" style={{padding:"20px"}}>
                    <div className="stat-label" style={{marginBottom:14}}>Monthly Expenses</div>
                    <BarChart months={M.months} colorKey="red" label="Expenses"/>
                  </div>
                </div>
              )}

              {/* 5-year projections */}
              

              <div style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>
                {tagged.length} tagged ¬∑ {untagged.length} untagged
                {untagged.length>0&&<button onClick={()=>setTab("Feed")} style={{fontSize:11,color:"var(--yellow)",fontFamily:"'JetBrains Mono',monospace",background:"none",border:"none",textDecoration:"underline",marginLeft:8,cursor:"pointer"}}>tag now ‚Üí</button>}
              </div>
            </>}
          </div>
        )}

        {/* ‚îÄ‚îÄ AIRBNB ‚îÄ‚îÄ */}
        {tab==="Airbnb"&&(
          <div className="fade-in">
            <div style={{marginBottom:22}}>
              <div style={{fontSize:10,color:"var(--green)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:4}}>‚óè Airbnb Portfolio</div>
              <div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>Short-Term Rentals ¬∑ 8 Units</div>
            </div>

            {/* Top stats ‚Äî portfolio-level only, no per-property income */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:8}}>
              {[
                {l:"Total Airbnb Revenue",v:fmt$(M.airbnbRev),a:"var(--green)",sub:"Deposited as portfolio lump sum"},
                {l:"Total Airbnb Expenses",v:fmt$(M.airbnbExp),a:"var(--red)",sub:"Tracked per property below"},
              ].map(c=>(
                <div key={c.l} className="glass" style={{padding:"20px 22px"}}>
                  <div className="stat-label" style={{marginBottom:8}}>{c.l}</div>
                  <div className="stat-num" style={{color:c.a,fontSize:28}}>{c.v}</div>
                  <div style={{fontSize:11,color:"var(--text-3)",marginTop:6}}>{c.sub}</div>
                </div>
              ))}
            </div>

            {/* Portfolio-level metrics */}
            <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:8,marginBottom:16}}>
              {[
                {l:"Net Cash Flow",    v:fmt$(M.airbnbCF),  accent:M.airbnbCF>=0?"var(--green)":"var(--red)"},
                {l:"Expense Ratio",   v:fmtPct(M.airbnbRev>0?(M.airbnbExp/M.airbnbRev)*100:null), accent:"var(--text)"},
                {l:"Avg Monthly CF",  v:fmt$(M.airbnbCF/M.moCount), accent:M.airbnbCF>=0?"var(--green)":"var(--red)"},
              ].map(m=>(
                <div key={m.l} className="metric-card">
                  <div className="stat-label" style={{marginBottom:6}}>{m.l}</div>
                  <div style={{fontSize:20,fontWeight:700,fontFamily:"'JetBrains Mono',monospace",color:m.accent||"var(--text)"}}>{m.v}</div>
                </div>
              ))}
            </div>

            {/* Per-property EXPENSES only */}
            <div style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:10,paddingBottom:8,borderBottom:"1px solid rgba(0,0,0,0.06)"}}>
              Expenses by Property
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:20}}>
              {AIRBNB_IDS.map(id=>{
                const p=PROPERTIES.find(x=>x.id===id);
                const pm=M.propM[id];
                const expTxs=pm.txs.filter(t=>t.type==="out");
                const pct=M.airbnbExp>0?(pm.exp/M.airbnbExp)*100:0;
                return (
                  <div key={id} className="glass" style={{padding:"16px 18px",borderTop:`2px solid ${p.color}`}}>
                    <div style={{fontSize:11,color:p.color,fontFamily:"'JetBrains Mono',monospace",fontWeight:700,textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:12}}>{p.label}</div>
                    <div style={{marginBottom:10}}>
                      <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",marginBottom:4}}>Total Expenses</div>
                      <div style={{fontSize:22,fontWeight:700,color:"var(--red)",fontFamily:"'JetBrains Mono',monospace"}}>{fmt$(pm.exp)}</div>
                    </div>
                    {/* Expense share bar */}
                    <div style={{background:"rgba(0,0,0,0.04)",borderRadius:4,height:4,marginBottom:6,overflow:"hidden"}}>
                      <div style={{width:`${pct}%`,height:"100%",background:p.color,borderRadius:4,transition:"width 0.5s ease"}}/>
                    </div>
                    <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{pct.toFixed(0)}% of total expenses ¬∑ {expTxs.length} transactions</div>
                  </div>
                );
              })}
            </div>

            {/* Side-by-side: Money In (lump sum) | Money Out (per property) */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,alignItems:"start"}}>

              {/* LEFT ‚Äî Money In: all income tagged to any airbnb property */}
              {(()=>{
                const airbnbInTxs = [...enriched.filter(t=>t.type==="in"&&AIRBNB_IDS.includes(t.propId))].sort((a,b)=>b.date.localeCompare(a.date));
                return (
                  <div>
                    <div style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:10,paddingBottom:8,borderBottom:"1px solid rgba(0,0,0,0.07)"}}>
                      ‚Üì Money In <span style={{fontWeight:400,textTransform:"none",fontSize:10,letterSpacing:0,marginLeft:6}}>¬∑ click any row to delete</span>
                    </div>
                    {airbnbInTxs.length===0
                      ? <div style={{textAlign:"center",padding:"32px 0",color:"var(--text-3)",fontSize:12}}>No deposits tagged yet ‚Äî tag income in Feed first</div>
                      : <div className="glass" style={{overflow:"hidden"}}>
                          <div style={{display:"grid",gridTemplateColumns:"72px 1fr 90px",padding:"7px 14px",borderBottom:"1px solid rgba(0,0,0,0.05)",gap:8}}>
                            {["DATE","PAYEE","AMOUNT"].map(h=><span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em"}}>{h}</span>)}
                          </div>
                          {airbnbInTxs.map(tx=>(
                            <div key={tx.id}>
                              <div style={{display:"grid",gridTemplateColumns:"72px 1fr 90px",padding:"10px 14px",borderBottom:"1px solid rgba(0,0,0,0.04)",gap:8,alignItems:"center",cursor:"pointer",transition:"background 0.12s",background:tagging===tx.id?"rgba(0,0,0,0.04)":"transparent"}}
                                onClick={()=>setTagging(t=>t===tx.id?null:tx.id)}
                                onMouseEnter={e=>{if(tagging!==tx.id)e.currentTarget.style.background="rgba(0,0,0,0.02)"}}
                                onMouseLeave={e=>{if(tagging!==tx.id)e.currentTarget.style.background="transparent"}}>
                                <span style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{fmtDate(tx.date)}</span>
                                <div style={{fontSize:12,fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{tx.payee}</div>
                                <span style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:12,color:"#30d158"}}>+{fmtD(tx.amount)}</span>
                              </div>
                              {tagging===tx.id&&(
                                <div style={{padding:"6px 14px 12px",borderBottom:"1px solid rgba(0,0,0,0.04)",background:"rgba(255,255,255,0.4)"}}>
                                  <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)} onDelete={doDelete}/>
                                </div>
                              )}
                            </div>
                          ))}
                        </div>
                    }
                  </div>
                );
              })()}

              {/* RIGHT ‚Äî Money Out (taggable per property) */}
              <div>
                <div style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:10,paddingBottom:8,borderBottom:"1px solid rgba(0,0,0,0.07)"}}>
                  ‚Üë Money Out <span style={{fontWeight:400,textTransform:"none",fontSize:10,letterSpacing:0,marginLeft:6}}>¬∑ tag to property</span>
                </div>
                {AIRBNB_IDS.flatMap(id=>M.propM[id].txs).filter(t=>t.type==="out").length===0
                  ? <div style={{textAlign:"center",padding:"32px 0",color:"var(--text-3)",fontSize:12}}>No expenses yet</div>
                  : <div className="glass" style={{overflow:"hidden"}}>
                      <div style={{display:"grid",gridTemplateColumns:"72px 1fr 90px 110px",padding:"7px 14px",borderBottom:"1px solid rgba(0,0,0,0.05)",gap:8}}>
                        {["DATE","PAYEE","AMOUNT","PROPERTY"].map(h=><span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em"}}>{h}</span>)}
                      </div>
                      {[...AIRBNB_IDS.flatMap(id=>M.propM[id].txs).filter(t=>t.type==="out")].sort((a,b)=>b.date.localeCompare(a.date)).map(tx=>(
                        <div key={tx.id}>
                          <div style={{display:"grid",gridTemplateColumns:"72px 1fr 90px 110px",padding:"10px 14px",borderBottom:"1px solid rgba(0,0,0,0.04)",gap:8,alignItems:"center",cursor:"pointer",transition:"background 0.12s"}}
                            onClick={()=>setTagging(t=>t===tx.id?null:tx.id)}
                            onMouseEnter={e=>e.currentTarget.style.background="rgba(0,0,0,0.02)"}
                            onMouseLeave={e=>e.currentTarget.style.background="transparent"}>
                            <span style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{fmtDate(tx.date)}</span>
                            <div style={{fontSize:12,fontWeight:500,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{tx.payee}</div>
                            <span style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:12,color:"#ff453a"}}>-{fmtD(tx.amount)}</span>
                            <div onClick={e=>e.stopPropagation()}>
                              <span onClick={e=>{e.stopPropagation();setTagging(t=>t===tx.id?null:tx.id);}}>
                                <PropBadge id={tx.propId} small/>
                              </span>
                            </div>
                          </div>
                          {tagging===tx.id&&(
                            <div style={{padding:"0 14px 10px",borderBottom:"1px solid rgba(0,0,0,0.04)"}}>
                              <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)} onDelete={doDelete}/>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                }
              </div>
            </div>




          </div>
        )}

        {/* ‚îÄ‚îÄ PIERCE AVE ‚îÄ‚îÄ */}
        {tab==="Pierce Ave"&&(
          <div className="fade-in">
            <div style={{marginBottom:20}}>
              <div style={{fontSize:10,color:"#64d2ff",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:4}}>‚óè Section 8</div>
              <div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>1703 Pierce Ave ¬∑ 7 Units ¬∑ Niagara Falls</div>
            </div>

            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:8,marginBottom:8}}>
              {[{l:"Gross Rent",v:fmt$(M.pierceRev),a:"#64d2ff"},{l:"Total Expenses",v:fmt$(M.pierceExp),a:"var(--red)"},{l:"Net Cash Flow",v:fmt$(M.pierceCF),a:M.pierceCF>=0?"var(--green)":"var(--red)"}].map(c=>(
                <div key={c.l} className="glass" style={{padding:"20px 22px"}}>
                  <div className="stat-label" style={{marginBottom:8}}>{c.l}</div>
                  <div className="stat-num" style={{color:c.a,fontSize:28}}>{c.v}</div>
                </div>
              ))}
            </div>

            <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:8,marginBottom:16}}>
              {[
                {l:"Net Margin",     v:fmtPct(M.pierceRev>0?(M.pierceCF/M.pierceRev)*100:null)},
                {l:"CoC Return",     v:fmtPct(M.propCoc.pierce)},
                {l:"Avg Monthly CF", v:fmt$(M.pierceCF/M.moCount)},
              ].map(m=>(
                <div key={m.l} className="metric-card">
                  <div className="stat-label" style={{marginBottom:6}}>{m.l}</div>
                  <div style={{fontSize:18,fontWeight:700,fontFamily:"'JetBrains Mono',monospace"}}>{m.v}</div>
                </div>
              ))}
            </div>

            <div style={{marginBottom:6,fontSize:13,fontWeight:600}}>Pierce Ave Transactions</div>
            <TxList
              txs={M.propM.pierce.txs}
              tagging={tagging} setTagging={setTagging} doTag={doTag} doDelete={doDelete}
              filter={pierceTxFilter} setFilter={setPierceTxFilter}
            />
          </div>
        )}

        {/* ‚îÄ‚îÄ PROJECTIONS ‚îÄ‚îÄ */}
        {tab==="Projections"&&(
          <div className="fade-in">
            <div style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between",marginBottom:24}}>
              <div>
                <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:4}}>Based on current run rate</div>
                <div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>5-Year Projections</div>
              </div>
              <div style={{display:"flex",gap:6,alignItems:"center"}}>
                <div style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>Drag or hover to explore years</div>
              </div>
            </div>

            <div className="glass" style={{padding:"24px",marginBottom:10}}>
              <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:16}}>
                Revenue ¬∑ Expenses ¬∑ Net Income
                <span style={{fontWeight:400,marginLeft:8,textTransform:"none",letterSpacing:0}}>3% revenue growth ¬∑ 2% expense growth annually</span>
              </div>
              <ProjectionChart data={M.projections}/>
            </div>

            {/* Assumption controls */}
            <div className="glass" style={{padding:"20px",marginBottom:10}}>
              <div style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:14}}>Assumptions</div>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:16}}>
                {[
                  {l:"Annual Revenue Growth",v:"3.0%",note:"Conservative STR/Section 8 estimate"},
                  {l:"Annual Expense Growth",v:"2.0%",note:"Inflation-adjusted maintenance"},
                  {l:"Base Period",v:`${M.moCount} months`,note:"Months of data used for run rate"},
                ].map(a=>(
                  <div key={a.l} style={{background:"rgba(255,255,255,0.4)",borderRadius:10,padding:"14px"}}>
                    <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em",marginBottom:6}}>{a.l}</div>
                    <div style={{fontSize:18,fontWeight:700,fontFamily:"'JetBrains Mono',monospace",marginBottom:4}}>{a.v}</div>
                    <div style={{fontSize:10,color:"var(--text-3)"}}>{a.note}</div>
                  </div>
                ))}
              </div>
            </div>

            {/* Year-by-year table */}
            <div className="glass" style={{overflow:"hidden"}}>
              <div style={{display:"grid",gridTemplateColumns:"80px 1fr 1fr 1fr 80px",padding:"9px 18px",borderBottom:"1px solid rgba(0,0,0,0.06)",gap:8}}>
                {["YEAR","REVENUE","EXPENSES","NET INCOME","MARGIN"].map(h=>(
                  <span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em"}}>{h}</span>
                ))}
              </div>
              {M.projections.map((d,i)=>(
                <div key={d.year} style={{display:"grid",gridTemplateColumns:"80px 1fr 1fr 1fr 80px",padding:"13px 18px",borderBottom:"1px solid rgba(0,0,0,0.04)",gap:8,alignItems:"center",background:i===0?"rgba(48,209,88,0.04)":"transparent"}}>
                  <span style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:13}}>{d.year}{i===0?" (now)":""}</span>
                  <span style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:600,fontSize:13,color:"#30d158"}}>{fmt$(d.rev)}</span>
                  <span style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:600,fontSize:13,color:"#ff453a"}}>{fmt$(d.exp)}</span>
                  <span style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:13,color:d.net>=0?"#0a84ff":"#ff453a"}}>{fmt$(d.net)}</span>
                  <span style={{fontFamily:"'JetBrains Mono',monospace",fontSize:12,color:"var(--text-2)"}}>{fmtPct(d.rev>0?(d.net/d.rev)*100:0)}</span>
                </div>
              ))}
            </div>
          </div>
        )}

        {/* ‚îÄ‚îÄ FEED ‚îÄ‚îÄ */}
        {tab==="Feed"&&(
          <div className="fade-in">
            <div style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between",marginBottom:18}}>
              <div>
                <div style={{fontSize:26,fontWeight:700,letterSpacing:"-0.02em"}}>Transaction Feed</div>
                <div style={{fontSize:12,color:"var(--text-3)",marginTop:3}}>Tag each transaction ¬∑ drives all numbers everywhere</div>
              </div>
              <div className="seg-ctrl">
                {[["untagged",`Untagged (${untagged.length})`],["tagged","Tagged"],["all","All"]].map(([k,l])=>(
                  <button key={k} className={`seg-btn${feedFilter===k?" active":""}`} onClick={()=>setFeedFilter(k)}>{l}</button>
                ))}
              </div>
            </div>

            {!hasBank&&(
              <div className="glass" style={{textAlign:"center",padding:"60px 0"}}>
                <div style={{fontSize:40,marginBottom:12}}>üè¶</div>
                <div style={{fontSize:16,fontWeight:600,marginBottom:14}}>No bank connected</div>
                <button onClick={connectBank} className="btn-primary">Connect Bank ‚Üí</button>
              </div>
            )}

            {hasBank&&(
              <>
                {/* Money In / Money Out filter on feed */}
                <div style={{display:"flex",gap:8,marginBottom:14,alignItems:"center"}}>
                  <div className="seg-ctrl">
                    {[["all","All"],["in","Money In"],["out","Money Out"]].map(([k,l])=>(
                      <button key={k} className={`seg-btn${txFilter===k?" active":""}`} onClick={()=>setTxFilter(k)}>{l}</button>
                    ))}
                  </div>
                  <span style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{feedDisplayed.length} transactions</span>
                </div>

                {feedDisplayed.length===0&&(
                  <div style={{textAlign:"center",padding:"40px 0",color:"var(--text-3)",fontSize:13}}>
                    {feedFilter==="untagged"?"All transactions tagged ‚úì":"No transactions yet ‚Äî hit Sync"}
                  </div>
                )}

                {feedDisplayed.length>0&&(
                  <div className="glass" style={{overflow:"hidden"}}>
                    <div style={{display:"grid",gridTemplateColumns:"76px 28px 1fr 100px 96px 120px",padding:"8px 16px",borderBottom:"1px solid rgba(0,0,0,0.06)",gap:8}}>
                      {["DATE","","PAYEE","AMOUNT","ACCOUNT","PROPERTY"].map(h=>(
                        <span key={h} style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.1em"}}>{h}</span>
                      ))}
                    </div>
                    {[...feedDisplayed].sort((a,b)=>b.date.localeCompare(a.date)).map(tx=>(
                      <div key={tx.id}>
                        <div className="tx-row" onClick={()=>setTagging(t=>t===tx.id?null:tx.id)}>
                          <span style={{fontSize:11,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace"}}>{fmtDate(tx.date)}</span>
                          <span className={tx.type==="in"?"dir-in":"dir-out"}>{tx.type==="in"?"‚Üì":"‚Üë"}</span>
                          <div>
                            <div style={{fontSize:13,fontWeight:500}}>{tx.payee}</div>
                            {tx.account&&<div style={{fontSize:10,color:"var(--text-3)",marginTop:1}}>{tx.account}</div>}
                          </div>
                          <span style={{fontFamily:"'JetBrains Mono',monospace",fontWeight:700,fontSize:13,color:tx.type==="in"?"#30d158":"#ff453a"}}>
                            {tx.type==="in"?"+":"-"}{fmtD(tx.amount)}
                          </span>
                          <span style={{fontSize:10,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{tx.account||""}</span>
                          <div onClick={e=>e.stopPropagation()}>
                            <span onClick={e=>{e.stopPropagation();setTagging(t=>t===tx.id?null:tx.id);}}>
                              <PropBadge id={tx.propId} small/>
                            </span>
                          </div>
                        </div>
                        {tagging===tx.id&&(
                          <div style={{padding:"0 16px 12px",borderBottom:"1px solid rgba(0,0,0,0.05)"}}>
                            <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)} onDelete={doDelete}/>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                )}

                {/* Auto-tag rules */}
                {Object.keys(autoTags).length>0&&(
                  <div style={{marginTop:20,padding:"16px 18px",background:"rgba(255,255,255,0.45)",border:"1px solid rgba(255,255,255,0.6)",borderRadius:12}}>
                    <div style={{fontSize:9,color:"var(--text-3)",fontFamily:"'JetBrains Mono',monospace",textTransform:"uppercase",letterSpacing:"0.12em",marginBottom:10}}>Auto-Tag Rules</div>
                    <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                      {Object.entries(autoTags).map(([payee,pid])=>(
                        <div key={payee} style={{display:"flex",alignItems:"center",gap:5,background:"rgba(0,0,0,0.03)",border:"1px solid rgba(0,0,0,0.07)",borderRadius:6,padding:"3px 10px"}}>
                          <span style={{fontSize:10,fontFamily:"'JetBrains Mono',monospace",color:"var(--text-3)"}}>{payee}</span>
                          <span style={{color:"var(--text-3)",fontSize:10}}>‚Üí</span>
                          <PropBadge id={pid} small/>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </>
            )}
          </div>
        )}
      </div>

      {showInvest&&<InvestModal invest={invest} onSave={saveInvest} onClose={()=>setShowInvest(false)}/>}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
