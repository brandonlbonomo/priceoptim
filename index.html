<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Property Pigeon</title>
  <script src="https://cdn.plaid.com/link/v2/stable/link-initialize.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #080808; color: #e0e0e0; font-family: -apple-system, 'DM Sans', sans-serif; min-height: 100vh; }
    button { cursor: pointer; font-family: inherit; }
    ::-webkit-scrollbar { width: 4px; } ::-webkit-scrollbar-track { background: #111; } ::-webkit-scrollbar-thumb { background: #333; }
  </style>
</head>
<body>
<div id="root"></div>
<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
<script type="text/babel">
const { useState, useMemo, useEffect, useCallback, useRef } = React;

const BACKEND = "";  // same origin â€” Render serves both

const fmt$ = n => new Intl.NumberFormat("en-US",{style:"currency",currency:"USD",maximumFractionDigits:0}).format(n||0);
const fmtPct = n => (n==null||isNaN(n)) ? "â€”" : `${n.toFixed(1)}%`;
const fmtDate = d => { try { return new Date(d+"T00:00:00").toLocaleDateString("en-US",{month:"short",day:"numeric"}); } catch { return d; } };

// â”€â”€ Tag buckets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const BUCKETS = [
  { id:"airbnb",   label:"Airbnb Portfolio", short:"Airbnb",    color:"#c8ff00" },
  { id:"pierce",   label:"1703 Pierce Ave",  short:"Pierce Ave", color:"#60cfff" },
  { id:"llc",      label:"General LLC",      short:"LLC",        color:"#c084fc" },
  { id:"transfer", label:"Internal Transfer",short:"Transfer",   color:"#888888" },
];

// â”€â”€ Local storage â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const LS = {
  get: k => { try { return JSON.parse(localStorage.getItem(k)); } catch { return null; } },
  set: (k,v) => { try { localStorage.setItem(k,JSON.stringify(v)); } catch {} },
};

const TAGS_KEY     = "pg_tags";
const AUTOTAG_KEY  = "pg_auto";
const TX_KEY       = "pg_txs";

const DEFAULT_AUTO = {
  "AIRBNB": "airbnb", "AIRBNB PAYMENTS": "airbnb",
  "HOUSING AUTHORITY": "pierce", "HOUSING AUTHORITY PMT": "pierce",
};

// â”€â”€ Components â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function Badge({ id, small }) {
  const b = BUCKETS.find(x=>x.id===id);
  const pad = small ? "2px 7px" : "3px 10px";
  const fs  = small ? 10 : 11;
  if (!b) return <span style={{padding:pad,fontSize:fs,fontFamily:"monospace",fontWeight:600,borderRadius:4,background:"rgba(255,200,0,0.12)",color:"#ffb800",border:"1px solid rgba(255,184,0,0.3)"}}>UNTAGGED</span>;
  return <span style={{padding:pad,fontSize:fs,fontFamily:"monospace",fontWeight:600,borderRadius:4,background:`${b.color}15`,color:b.color,border:`1px solid ${b.color}35`}}>{b.short.toUpperCase()}</span>;
}

function Tile({ label, value, sub, accent="#e0e0e0", span=1 }) {
  return (
    <div style={{background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.07)",padding:"18px 20px",gridColumn:`span ${span}`}}>
      <div style={{fontSize:10,color:"#555",textTransform:"uppercase",letterSpacing:"0.12em",fontFamily:"monospace",marginBottom:7}}>{label}</div>
      <div style={{fontSize:20,fontWeight:800,color:accent,fontFamily:"monospace",letterSpacing:"-0.02em"}}>{value}</div>
      {sub&&<div style={{fontSize:11,color:"#444",marginTop:4}}>{sub}</div>}
    </div>
  );
}

function SectionHead({ label }) {
  return <div style={{fontSize:10,color:"#555",fontFamily:"monospace",textTransform:"uppercase",letterSpacing:"0.14em",margin:"28px 0 10px",borderBottom:"1px solid rgba(255,255,255,0.05)",paddingBottom:8}}>{label}</div>;
}

function TagMenu({ tx, onTag, onClose }) {
  return (
    <div style={{display:"flex",gap:6,flexWrap:"wrap",marginTop:8}}>
      {BUCKETS.map(b=>(
        <button key={b.id} onClick={()=>onTag(tx.id, b.id)} style={{background:`${b.color}15`,color:b.color,border:`1px solid ${b.color}40`,borderRadius:6,padding:"5px 12px",fontSize:11,fontFamily:"monospace",fontWeight:700}}>
          {b.short}
        </button>
      ))}
      <button onClick={onClose} style={{background:"transparent",color:"#555",border:"1px solid rgba(255,255,255,0.1)",borderRadius:6,padding:"5px 9px",fontSize:11,fontFamily:"monospace"}}>âœ•</button>
    </div>
  );
}

// â”€â”€ Main App â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function App() {
  const [tab, setTab]           = useState("Feed");
  const [txs, setTxs]           = useState(() => LS.get(TX_KEY) || []);
  const [tags, setTags]         = useState(() => LS.get(TAGS_KEY) || {});
  const [autoTags, setAutoTags] = useState(() => LS.get(AUTOTAG_KEY) || DEFAULT_AUTO);
  const [tagging, setTagging]   = useState(null);
  const [linkedAccounts, setLinkedAccounts] = useState([]);
  const [syncing, setSyncing]   = useState(false);
  const [status, setStatus]     = useState(null);
  const [linking, setLinking]   = useState(false);
  const [feedFilter, setFeedFilter] = useState("untagged");

  // Check linked accounts on mount
  useEffect(() => {
    fetch(`${BACKEND}/api/link-status`)
      .then(r=>r.json())
      .then(d=>setLinkedAccounts(d.accounts||[]))
      .catch(()=>{});
  }, []);

  // Apply auto-tags
  const applyAuto = useCallback((newTxs, at, cur) => {
    const next = {...cur};
    newTxs.forEach(tx => {
      if (next[tx.id]) return;
      const key = Object.keys(at).find(k => tx.payee?.toUpperCase().includes(k.toUpperCase()));
      if (key) next[tx.id] = at[key];
    });
    return next;
  }, []);

  // Sync from Plaid
  const sync = useCallback(async () => {
    setSyncing(true); setStatus(null);
    try {
      const res  = await fetch(`${BACKEND}/api/transactions/sync`);
      const data = await res.json();
      if (data.error) throw new Error(data.error);

      setTxs(prev => {
        const map = Object.fromEntries(prev.map(t=>[t.id,t]));
        data.removed.forEach(id => delete map[id]);
        data.modified.forEach(tx => { map[tx.id] = tx; });
        data.added.forEach(tx => { if (!map[tx.id]) map[tx.id] = tx; });
        const arr = Object.values(map).sort((a,b)=>b.date.localeCompare(a.date));
        LS.set(TX_KEY, arr);
        return arr;
      });

      setTags(prev => {
        const updated = applyAuto(data.added, autoTags, prev);
        LS.set(TAGS_KEY, updated);
        return updated;
      });

      const newCount = data.added.filter(t=>!t.pending).length;
      setStatus(newCount > 0 ? `${newCount} new transactions pulled` : "Up to date");
    } catch(e) { setStatus("Sync failed: " + e.message); }
    finally { setSyncing(false); }
  }, [autoTags, applyAuto]);

  // Connect bank
  const connectBank = useCallback(async () => {
    setLinking(true); setStatus(null);
    try {
      const res = await fetch(`${BACKEND}/api/create-link-token`, {method:"POST"});
      const { link_token, error } = await res.json();
      if (error) throw new Error(error);

      const handler = window.Plaid.create({
        token: link_token,
        onSuccess: async (public_token, metadata) => {
          const name = metadata?.institution?.name || "Bank Account";
          await fetch(`${BACKEND}/api/exchange-token`, {
            method:"POST", headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ public_token, account_name: name }),
          });
          setStatus(`${name} connected! Syncing...`);
          const ls = await fetch(`${BACKEND}/api/link-status`).then(r=>r.json());
          setLinkedAccounts(ls.accounts||[]);
          setTimeout(sync, 800);
        },
        onExit: err => { if(err) setStatus("Exited: "+err.display_message); },
      });
      handler.open();
    } catch(e) { setStatus("Could not open Plaid: "+e.message); }
    finally { setLinking(false); }
  }, [sync]);

  // Remove account
  const removeAccount = async (item_id) => {
    await fetch(`${BACKEND}/api/remove-account`, {method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({item_id})});
    setLinkedAccounts(prev=>prev.filter(a=>a.item_id!==item_id));
  };

  // Tag a transaction
  function doTag(txId, bucketId) {
    const tx = txs.find(t=>t.id===txId);
    const nextTags = {...tags, [txId]: bucketId};

    // learn auto-tag if not transfer/llc
    if (tx?.payee && bucketId !== "transfer" && bucketId !== "llc") {
      const key = tx.payee.toUpperCase();
      const nextAuto = {...autoTags, [key]: bucketId};
      // apply to all matching untagged
      txs.forEach(t => {
        if (!nextTags[t.id] && t.payee?.toUpperCase() === key) nextTags[t.id] = bucketId;
      });
      setAutoTags(nextAuto);
      LS.set(AUTOTAG_KEY, nextAuto);
    }

    setTags(nextTags);
    LS.set(TAGS_KEY, nextTags);
    setTagging(null);
  }

  // Enrich transactions with tags
  const enriched = useMemo(() =>
    txs.filter(t=>!t.pending).map(tx => ({
      ...tx,
      bucket: tags[tx.id] || null,
    }))
  , [txs, tags]);

  const untagged = enriched.filter(t=>!t.bucket);
  const tagged   = enriched.filter(t=>t.bucket);

  // â”€â”€ Derived metrics from tagged transactions only â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const metrics = useMemo(() => {
    const byBucket = (id, type) => tagged.filter(t=>t.bucket===id&&(type?t.type===type:true));
    const sumAmt   = txs => txs.reduce((s,t)=>s+Math.abs(t.amount),0);

    const airbnbRev  = sumAmt(byBucket("airbnb","in"));
    const airbnbExp  = sumAmt(byBucket("airbnb","out"));
    const airbnbCF   = airbnbRev - airbnbExp;

    const pierceRev  = sumAmt(byBucket("pierce","in"));
    const pierceExp  = sumAmt(byBucket("pierce","out"));
    const pierceCF   = pierceRev - pierceExp;

    const llcExp     = sumAmt(byBucket("llc","out"));

    const totalRev   = airbnbRev + pierceRev;
    const totalExp   = airbnbExp + pierceExp + llcExp;
    const totalCF    = totalRev - totalExp;

    // Month grouping for charts
    const byMonth = {};
    tagged.filter(t=>t.bucket!=="transfer").forEach(t => {
      const mo = t.date?.slice(0,7) || "unknown";
      if (!byMonth[mo]) byMonth[mo] = {rev:0,exp:0};
      if (t.type==="in")  byMonth[mo].rev += Math.abs(t.amount);
      if (t.type==="out") byMonth[mo].exp += Math.abs(t.amount);
    });
    const months = Object.entries(byMonth).sort((a,b)=>a[0].localeCompare(b[0])).slice(-12);

    return { airbnbRev,airbnbExp,airbnbCF,pierceRev,pierceExp,pierceCF,llcExp,totalRev,totalExp,totalCF,months };
  }, [tagged]);

  const TABS = ["Portfolio","Airbnb","Pierce Ave","Feed"];
  const hasBank = linkedAccounts.length > 0;

  const hdr = (active) => ({
    background: active?"#c8ff00":"transparent",
    color: active?"#000":"#666",
    border:"1px solid",
    borderColor: active?"#c8ff00":"rgba(255,255,255,0.09)",
    borderRadius:8, padding:"7px 18px",
    fontSize:12, fontWeight:active?700:500,
    fontFamily:"monospace", transition:"all 0.15s",
    position:"relative",
  });

  const g3 = { display:"grid", gridTemplateColumns:"1fr 1fr 1fr", gap:2, marginBottom:2 };
  const g4 = { display:"grid", gridTemplateColumns:"repeat(4,1fr)", gap:2, marginBottom:2 };

  // Feed filter options
  const feedOptions = [
    {k:"untagged", l:`Untagged (${untagged.length})`},
    {k:"tagged",   l:"Tagged"},
    {k:"all",      l:"All"},
  ];
  const displayTxs = feedFilter==="untagged" ? untagged : feedFilter==="tagged" ? tagged : enriched;

  const maxMonth = Math.max(...metrics.months.map(([,v])=>v.rev+v.exp), 1);

  return (
    <div style={{minHeight:"100vh",background:"#080808",color:"#e0e0e0"}}>

      {/* HEADER */}
      <div style={{padding:"16px 28px",borderBottom:"1px solid rgba(255,255,255,0.07)",display:"flex",alignItems:"center",justifyContent:"space-between",position:"sticky",top:0,background:"rgba(8,8,8,0.97)",backdropFilter:"blur(12px)",zIndex:100}}>
        <div style={{display:"flex",alignItems:"center",gap:10}}>
          <div style={{width:28,height:28,borderRadius:6,background:"#c8ff00",display:"flex",alignItems:"center",justifyContent:"center",fontSize:15}}>ğŸ¦</div>
          <div>
            <div style={{fontSize:14,fontWeight:700}}>Property Pigeon</div>
            <div style={{fontSize:9,color:"#555",fontFamily:"monospace",letterSpacing:"0.1em"}}>AIRBNB Â· SECTION 8 Â· LLC</div>
          </div>
        </div>
        <div style={{display:"flex",gap:5,alignItems:"center"}}>
          {TABS.map(t=>(
            <button key={t} onClick={()=>setTab(t)} style={hdr(tab===t)}>
              {t}
              {t==="Feed"&&untagged.length>0&&<span style={{position:"absolute",top:-5,right:-5,background:"#ffb800",color:"#000",borderRadius:"50%",width:15,height:15,fontSize:8,fontWeight:800,display:"flex",alignItems:"center",justifyContent:"center"}}>{untagged.length}</span>}
            </button>
          ))}
          <div style={{width:1,height:20,background:"rgba(255,255,255,0.1)",margin:"0 4px"}}/>
          <button onClick={connectBank} disabled={linking} style={{background:"rgba(200,255,0,0.1)",color:"#c8ff00",border:"1px solid rgba(200,255,0,0.3)",borderRadius:8,padding:"7px 14px",fontSize:11,fontFamily:"monospace",fontWeight:700}}>
            {linking?"Linking...":"+ Add Bank"}
          </button>
          <button onClick={sync} disabled={syncing||!hasBank} style={{background:"transparent",color:syncing||!hasBank?"#444":"#c8ff00",border:"1px solid",borderColor:syncing||!hasBank?"#333":"rgba(200,255,0,0.3)",borderRadius:8,padding:"7px 14px",fontSize:11,fontFamily:"monospace"}}>
            {syncing?"Syncing...":"â†» Sync"}
          </button>
        </div>
      </div>

      {/* Status bar */}
      {(status||linkedAccounts.length>0) && (
        <div style={{background:"rgba(255,255,255,0.02)",borderBottom:"1px solid rgba(255,255,255,0.05)",padding:"8px 28px",display:"flex",alignItems:"center",justifyContent:"space-between",gap:12}}>
          <div style={{display:"flex",gap:8,flexWrap:"wrap"}}>
            {linkedAccounts.map(a=>(
              <div key={a.item_id} style={{display:"flex",alignItems:"center",gap:6,background:"rgba(200,255,0,0.06)",border:"1px solid rgba(200,255,0,0.15)",borderRadius:6,padding:"3px 10px"}}>
                <div style={{width:5,height:5,borderRadius:"50%",background:"#c8ff00"}}/>
                <span style={{fontSize:11,fontFamily:"monospace",color:"#c8ff00"}}>{a.name}</span>
                <button onClick={()=>removeAccount(a.item_id)} style={{background:"none",border:"none",color:"#444",fontSize:12,lineHeight:1,cursor:"pointer",padding:"0 0 0 2px"}}>Ã—</button>
              </div>
            ))}
          </div>
          {status&&<div style={{fontSize:11,color:"#555",fontFamily:"monospace",flexShrink:0}}>{status}</div>}
        </div>
      )}

      <div style={{maxWidth:1060,margin:"0 auto",padding:"28px 28px 80px"}}>

        {/* â”€â”€ PORTFOLIO â”€â”€ */}
        {tab==="Portfolio"&&(
          <div>
            <div style={{marginBottom:24}}>
              <div style={{fontSize:10,color:"#555",fontFamily:"monospace",textTransform:"uppercase",letterSpacing:"0.12em"}}>All Properties Â· Live from Plaid</div>
              <div style={{fontSize:22,fontWeight:700,marginTop:3}}>Portfolio Overview</div>
            </div>

            {!hasBank&&<div style={{textAlign:"center",padding:"60px 0",color:"#444"}}><div style={{fontSize:36,marginBottom:12}}>ğŸ¦</div><div style={{fontSize:15,fontWeight:600,color:"#666",marginBottom:6}}>No bank connected</div><div style={{fontSize:13}}>Click "+ Add Bank" in the header to connect via Plaid.</div></div>}

            {hasBank&&(
              <>
                <div style={g3}>
                  {[{l:"Gross Revenue",v:fmt$(metrics.totalRev),a:"#c8ff00"},{l:"Total Expenses",v:fmt$(metrics.totalExp),a:"#ff5c5c"},{l:"Net Cash Flow",v:fmt$(metrics.totalCF),a:metrics.totalCF>=0?"#c8ff00":"#ff5c5c"}].map(c=>(
                    <div key={c.l} style={{background:"rgba(255,255,255,0.03)",padding:"26px 22px",borderRight:"1px solid rgba(255,255,255,0.05)"}}>
                      <div style={{fontSize:10,color:"#555",textTransform:"uppercase",letterSpacing:"0.12em",fontFamily:"monospace",marginBottom:8}}>{c.l}</div>
                      <div style={{fontSize:32,fontWeight:800,color:c.a,fontFamily:"monospace",letterSpacing:"-0.02em"}}>{c.v}</div>
                    </div>
                  ))}
                </div>
                <div style={{...g4, marginTop:2}}>
                  <Tile label="Airbnb Revenue"  value={fmt$(metrics.airbnbRev)}  accent="#c8ff00"/>
                  <Tile label="Airbnb Expenses" value={fmt$(metrics.airbnbExp)}  accent="#ff5c5c"/>
                  <Tile label="Pierce Revenue"  value={fmt$(metrics.pierceRev)}  accent="#60cfff"/>
                  <Tile label="Pierce Expenses" value={fmt$(metrics.pierceExp)}  accent="#ff5c5c"/>
                </div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:2,marginBottom:2}}>
                  <Tile label="Airbnb Cash Flow"  value={fmt$(metrics.airbnbCF)} accent={metrics.airbnbCF>=0?"#c8ff00":"#ff5c5c"}/>
                  <Tile label="Pierce Cash Flow"  value={fmt$(metrics.pierceCF)} accent={metrics.pierceCF>=0?"#c8ff00":"#ff5c5c"}/>
                  <Tile label="General LLC Exp"   value={fmt$(metrics.llcExp)}   accent="#c084fc"/>
                </div>

                {/* Bar chart */}
                {metrics.months.length>0&&(
                  <div style={{background:"rgba(255,255,255,0.02)",padding:"22px 22px 14px",border:"1px solid rgba(255,255,255,0.06)",marginTop:20}}>
                    <div style={{fontSize:10,color:"#555",fontFamily:"monospace",textTransform:"uppercase",letterSpacing:"0.12em",marginBottom:18}}>Monthly Revenue vs Expenses (last 12 mo)</div>
                    <div style={{display:"flex",gap:3,alignItems:"flex-end",height:80}}>
                      {metrics.months.map(([mo,v])=>(
                        <div key={mo} style={{flex:1,display:"flex",gap:1,alignItems:"flex-end",height:"100%"}}>
                          <div style={{flex:1,background:"#c8ff00",opacity:0.8,height:`${Math.max(3,(v.rev/maxMonth)*100)}%`,borderRadius:"2px 2px 0 0"}}/>
                          <div style={{flex:1,background:"#ff5c5c",opacity:0.7,height:`${Math.max(3,(v.exp/maxMonth)*100)}%`,borderRadius:"2px 2px 0 0"}}/>
                        </div>
                      ))}
                    </div>
                    <div style={{display:"flex",marginTop:6}}>
                      {metrics.months.map(([mo])=>(
                        <div key={mo} style={{flex:1,textAlign:"center",fontSize:8,color:"#444",fontFamily:"monospace"}}>{mo.slice(5)}</div>
                      ))}
                    </div>
                    <div style={{display:"flex",gap:16,marginTop:10}}>
                      {[["#c8ff00","Revenue"],["#ff5c5c","Expenses"]].map(([c,l])=>(
                        <div key={l} style={{display:"flex",gap:5,alignItems:"center"}}><div style={{width:8,height:8,background:c,borderRadius:2}}/><span style={{fontSize:10,color:"#555",fontFamily:"monospace"}}>{l}</span></div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Tagged tx count */}
                <div style={{marginTop:16,display:"flex",gap:12}}>
                  <div style={{fontSize:11,color:"#555",fontFamily:"monospace"}}>{tagged.length} tagged transactions Â· {untagged.length} untagged</div>
                  {untagged.length>0&&<button onClick={()=>setTab("Feed")} style={{fontSize:11,color:"#ffb800",fontFamily:"monospace",background:"none",border:"none",textDecoration:"underline"}}>tag now â†’</button>}
                </div>
              </>
            )}
          </div>
        )}

        {/* â”€â”€ AIRBNB â”€â”€ */}
        {tab==="Airbnb"&&(
          <div>
            <div style={{marginBottom:24}}>
              <div style={{fontSize:10,color:"#c8ff00",fontFamily:"monospace",textTransform:"uppercase",letterSpacing:"0.12em",marginBottom:3}}>â— STR Portfolio</div>
              <div style={{fontSize:22,fontWeight:700}}>Airbnb Portfolio Â· 3 Units</div>
              <div style={{fontSize:12,color:"#444",marginTop:4}}>Numbers derived from Plaid transactions tagged "Airbnb"</div>
            </div>

            {metrics.airbnbRev===0&&metrics.airbnbExp===0?(
              <div style={{textAlign:"center",padding:"60px 0",color:"#444"}}>
                <div style={{fontSize:32,marginBottom:12}}>ğŸ“Š</div>
                <div style={{fontSize:14,color:"#666",marginBottom:6}}>No Airbnb transactions tagged yet</div>
                <button onClick={()=>setTab("Feed")} style={{fontSize:12,color:"#c8ff00",fontFamily:"monospace",background:"none",border:"1px solid rgba(200,255,0,0.3)",borderRadius:6,padding:"7px 16px",cursor:"pointer"}}>Go to Feed â†’</button>
              </div>
            ):(
              <>
                <div style={g3}>
                  {[{l:"Gross Revenue",v:fmt$(metrics.airbnbRev),a:"#c8ff00"},{l:"Total Expenses",v:fmt$(metrics.airbnbExp),a:"#ff5c5c"},{l:"Net Cash Flow",v:fmt$(metrics.airbnbCF),a:metrics.airbnbCF>=0?"#c8ff00":"#ff5c5c"}].map(c=>(
                    <div key={c.l} style={{background:"rgba(255,255,255,0.03)",padding:"24px 22px",borderRight:"1px solid rgba(255,255,255,0.05)"}}>
                      <div style={{fontSize:10,color:"#555",textTransform:"uppercase",letterSpacing:"0.12em",fontFamily:"monospace",marginBottom:8}}>{c.l}</div>
                      <div style={{fontSize:28,fontWeight:800,color:c.a,fontFamily:"monospace"}}>{c.v}</div>
                    </div>
                  ))}
                </div>
                <div style={{...g4,marginTop:2}}>
                  <Tile label="Avg Monthly Revenue" value={fmt$(metrics.airbnbRev/Math.max(1,metrics.months.length))} accent="#c8ff00"/>
                  <Tile label="Avg Monthly Expense" value={fmt$(metrics.airbnbExp/Math.max(1,metrics.months.length))} accent="#ff5c5c"/>
                  <Tile label="Avg Monthly CF" value={fmt$(metrics.airbnbCF/Math.max(1,metrics.months.length))} accent={metrics.airbnbCF>=0?"#c8ff00":"#ff5c5c"}/>
                  <Tile label="Expense Ratio" value={fmtPct(metrics.airbnbRev>0?(metrics.airbnbExp/metrics.airbnbRev)*100:0)} />
                </div>

                <SectionHead label="Airbnb Transactions" />
                <TxTable txs={tagged.filter(t=>t.bucket==="airbnb")} tags={tags} tagging={tagging} setTagging={setTagging} doTag={doTag}/>
              </>
            )}
          </div>
        )}

        {/* â”€â”€ PIERCE AVE â”€â”€ */}
        {tab==="Pierce Ave"&&(
          <div>
            <div style={{marginBottom:20}}>
              <div style={{fontSize:10,color:"#60cfff",fontFamily:"monospace",textTransform:"uppercase",letterSpacing:"0.12em",marginBottom:3}}>â— Section 8</div>
              <div style={{fontSize:22,fontWeight:700}}>1703 Pierce Ave Â· Niagara Falls</div>
              <div style={{fontSize:12,color:"#444",marginTop:4}}>Numbers derived from Plaid transactions tagged "Pierce Ave"</div>
            </div>

            {metrics.pierceRev===0&&metrics.pierceExp===0?(
              <div style={{textAlign:"center",padding:"60px 0",color:"#444"}}>
                <div style={{fontSize:32,marginBottom:12}}>ğŸ </div>
                <div style={{fontSize:14,color:"#666",marginBottom:6}}>No Pierce Ave transactions tagged yet</div>
                <button onClick={()=>setTab("Feed")} style={{fontSize:12,color:"#60cfff",fontFamily:"monospace",background:"none",border:"1px solid rgba(96,207,255,0.3)",borderRadius:6,padding:"7px 16px",cursor:"pointer"}}>Go to Feed â†’</button>
              </div>
            ):(
              <>
                <div style={g3}>
                  {[{l:"Gross Rent",v:fmt$(metrics.pierceRev),a:"#60cfff"},{l:"Total Expenses",v:fmt$(metrics.pierceExp),a:"#ff5c5c"},{l:"Net Cash Flow",v:fmt$(metrics.pierceCF),a:metrics.pierceCF>=0?"#c8ff00":"#ff5c5c"}].map(c=>(
                    <div key={c.l} style={{background:"rgba(255,255,255,0.03)",padding:"24px 22px",borderRight:"1px solid rgba(255,255,255,0.05)"}}>
                      <div style={{fontSize:10,color:"#555",textTransform:"uppercase",letterSpacing:"0.12em",fontFamily:"monospace",marginBottom:8}}>{c.l}</div>
                      <div style={{fontSize:28,fontWeight:800,color:c.a,fontFamily:"monospace"}}>{c.v}</div>
                    </div>
                  ))}
                </div>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr 1fr",gap:2,marginTop:2,marginBottom:2}}>
                  <Tile label="Avg Monthly Rent"    value={fmt$(metrics.pierceRev/Math.max(1,metrics.months.length))} accent="#60cfff"/>
                  <Tile label="Avg Monthly Expense" value={fmt$(metrics.pierceExp/Math.max(1,metrics.months.length))} accent="#ff5c5c"/>
                  <Tile label="Expense Ratio"       value={fmtPct(metrics.pierceRev>0?(metrics.pierceExp/metrics.pierceRev)*100:0)}/>
                </div>

                <SectionHead label="Pierce Ave Transactions" />
                <TxTable txs={tagged.filter(t=>t.bucket==="pierce")} tags={tags} tagging={tagging} setTagging={setTagging} doTag={doTag}/>
              </>
            )}
          </div>
        )}

        {/* â”€â”€ FEED â”€â”€ */}
        {tab==="Feed"&&(
          <div>
            <div style={{display:"flex",alignItems:"flex-start",justifyContent:"space-between",marginBottom:20}}>
              <div>
                <div style={{fontSize:22,fontWeight:700}}>Transaction Feed</div>
                <div style={{fontSize:12,color:"#444",marginTop:3}}>Tag each transaction Â· drives all numbers in every tab</div>
              </div>
              <div style={{display:"flex",gap:6}}>
                {feedOptions.map(o=>(
                  <button key={o.k} onClick={()=>setFeedFilter(o.k)} style={{background:feedFilter===o.k?"rgba(255,255,255,0.08)":"transparent",color:feedFilter===o.k?"#e0e0e0":"#555",border:"1px solid",borderColor:feedFilter===o.k?"rgba(255,255,255,0.2)":"rgba(255,255,255,0.07)",borderRadius:6,padding:"6px 13px",fontSize:11,fontFamily:"monospace"}}>
                    {o.l}
                  </button>
                ))}
              </div>
            </div>

            {!hasBank&&(
              <div style={{textAlign:"center",padding:"60px 0",color:"#444"}}>
                <div style={{fontSize:40,marginBottom:12}}>ğŸ¦</div>
                <div style={{fontSize:15,fontWeight:600,color:"#666",marginBottom:6}}>No bank connected</div>
                <button onClick={connectBank} style={{background:"#c8ff00",color:"#000",border:"none",borderRadius:8,padding:"11px 24px",fontSize:13,fontWeight:700,fontFamily:"monospace"}}>Connect Bank â†’</button>
              </div>
            )}

            {hasBank&&displayTxs.length===0&&(
              <div style={{textAlign:"center",padding:"50px 0",color:"#444",fontSize:13}}>
                {feedFilter==="untagged" ? "All transactions tagged âœ“" : "No transactions yet â€” sync to pull from Plaid"}
              </div>
            )}

            {hasBank&&displayTxs.length>0&&(
              <div style={{border:"1px solid rgba(255,255,255,0.07)"}}>
                <div style={{display:"grid",gridTemplateColumns:"90px 40px 1fr 110px 120px 120px",padding:"10px 18px",background:"rgba(255,255,255,0.04)",fontSize:9,color:"#555",fontFamily:"monospace",textTransform:"uppercase",letterSpacing:"0.08em",gap:8}}>
                  <span>Date</span><span>Dir</span><span>Payee</span><span>Amount</span><span>Account</span><span>Tag</span>
                </div>
                {displayTxs.map((tx,i)=>(
                  <div key={tx.id}>
                    <div
                      onClick={()=>setTagging(tagging===tx.id?null:tx.id)}
                      style={{display:"grid",gridTemplateColumns:"90px 40px 1fr 110px 120px 120px",padding:"13px 18px",borderBottom:"1px solid rgba(255,255,255,0.04)",alignItems:"center",gap:8,cursor:"pointer",background:tagging===tx.id?"rgba(255,255,255,0.03)":"transparent",transition:"background 0.1s"}}
                      onMouseEnter={e=>{ if(tagging!==tx.id) e.currentTarget.style.background="rgba(255,255,255,0.02)"; }}
                      onMouseLeave={e=>{ if(tagging!==tx.id) e.currentTarget.style.background="transparent"; }}
                    >
                      <span style={{fontSize:11,color:"#555",fontFamily:"monospace"}}>{fmtDate(tx.date)}</span>
                      <span style={{fontSize:14,textAlign:"center"}}>{tx.type==="in"?"â†“":"â†‘"}</span>
                      <div>
                        <div style={{fontSize:13,fontFamily:"monospace"}}>{tx.payee}</div>
                        {tx.account&&<div style={{fontSize:10,color:"#444",marginTop:2}}>{tx.account}</div>}
                      </div>
                      <span style={{fontFamily:"monospace",fontWeight:700,fontSize:13,color:tx.type==="in"?"#c8ff00":"#ff5c5c"}}>
                        {tx.type==="in"?"+":"-"}{fmt$(Math.abs(tx.amount))}
                      </span>
                      <span style={{fontSize:10,color:"#444",fontFamily:"monospace",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{tx.account}</span>
                      <div onClick={e=>e.stopPropagation()}>
                        {tagging===tx.id?(
                          <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)}/>
                        ):(
                          tx.bucket ? <Badge id={tx.bucket} small/> : <button onClick={e=>{e.stopPropagation();setTagging(tx.id);}} style={{background:"rgba(255,184,0,0.1)",color:"#ffb800",border:"1px solid rgba(255,184,0,0.25)",borderRadius:5,padding:"4px 10px",fontSize:10,fontFamily:"monospace",fontWeight:700}}>Tag â†’</button>
                        )}
                      </div>
                    </div>
                    {tagging===tx.id&&(
                      <div style={{padding:"0 18px 14px",borderBottom:"1px solid rgba(255,255,255,0.04)"}}>
                        <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)}/>
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}

            {/* Auto-tag rules */}
            {Object.keys(autoTags).length>0&&(
              <div style={{marginTop:24,padding:"18px 20px",background:"rgba(255,255,255,0.02)",border:"1px solid rgba(255,255,255,0.05)"}}>
                <div style={{fontSize:9,color:"#555",fontFamily:"monospace",textTransform:"uppercase",letterSpacing:"0.12em",marginBottom:12}}>Auto-Tag Rules (learned)</div>
                <div style={{display:"flex",flexWrap:"wrap",gap:6}}>
                  {Object.entries(autoTags).map(([payee,bid])=>(
                    <div key={payee} style={{display:"flex",alignItems:"center",gap:6,background:"rgba(255,255,255,0.03)",border:"1px solid rgba(255,255,255,0.07)",borderRadius:5,padding:"4px 10px"}}>
                      <span style={{fontSize:10,fontFamily:"monospace",color:"#888"}}>{payee}</span>
                      <span style={{color:"#444",fontSize:10}}>â†’</span>
                      <Badge id={bid} small/>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        )}

      </div>
    </div>
  );
}

// â”€â”€ Reusable transaction table for property tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function TxTable({ txs, tagging, setTagging, doTag }) {
  if (!txs.length) return <div style={{color:"#444",fontSize:13,padding:"20px 0"}}>No transactions yet.</div>;
  return (
    <div style={{border:"1px solid rgba(255,255,255,0.07)"}}>
      <div style={{display:"grid",gridTemplateColumns:"90px 40px 1fr 110px 100px",padding:"10px 18px",background:"rgba(255,255,255,0.04)",fontSize:9,color:"#555",fontFamily:"monospace",textTransform:"uppercase",letterSpacing:"0.08em",gap:8}}>
        <span>Date</span><span>Dir</span><span>Payee</span><span>Amount</span><span>Re-tag</span>
      </div>
      {txs.sort((a,b)=>b.date.localeCompare(a.date)).map((tx,i)=>(
        <div key={tx.id}>
          <div onClick={()=>setTagging(tagging===tx.id?null:tx.id)} style={{display:"grid",gridTemplateColumns:"90px 40px 1fr 110px 100px",padding:"12px 18px",borderBottom:"1px solid rgba(255,255,255,0.04)",alignItems:"center",gap:8,cursor:"pointer"}}
            onMouseEnter={e=>e.currentTarget.style.background="rgba(255,255,255,0.02)"}
            onMouseLeave={e=>e.currentTarget.style.background="transparent"}
          >
            <span style={{fontSize:11,color:"#555",fontFamily:"monospace"}}>{tx.date?.slice(5)}</span>
            <span style={{fontSize:14,textAlign:"center"}}>{tx.type==="in"?"â†“":"â†‘"}</span>
            <span style={{fontSize:12,fontFamily:"monospace"}}>{tx.payee}</span>
            <span style={{fontFamily:"monospace",fontWeight:700,fontSize:13,color:tx.type==="in"?"#c8ff00":"#ff5c5c"}}>{tx.type==="in"?"+":"-"}{fmt$(Math.abs(tx.amount))}</span>
            <span style={{fontSize:10,color:"#555",fontFamily:"monospace"}}>click to re-tag</span>
          </div>
          {tagging===tx.id&&(
            <div style={{padding:"0 18px 12px",borderBottom:"1px solid rgba(255,255,255,0.04)"}}>
              <TagMenu tx={tx} onTag={doTag} onClose={()=>setTagging(null)}/>
            </div>
          )}
        </div>
      ))}
    </div>
  );
}

ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
